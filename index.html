<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ورقة</title>
    <link rel="icon" href="assets/logo.png" type="image/x-icon">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400;1,700&family=Tajawal:wght@200;300;400;500;700;800;900&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome (for icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Pickr (Color Picker) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css"/>
    
    <!-- Embedded CSS -->
    <style>
        :root {
            --font-main: 'Tajawal', sans-serif;
            --font-statement: 'Scheherazade New', serif;
            --primary-color: #2980b9;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --sidebar-bg: #ffffff;
            --page-bg: #ffffff;
            --text-color: #333;
            --border-color: #dee2e6;
            --shadow-color: rgba(0,0,0,0.1);
            --question-text-color: #212529;
            --question-num-color: #ffffff;
            --question-num-bg: #007bff;
            --statement-text-color: #555;
            --statement-bg-color: #f1f3f5;
            --answer-head-color: #495057;
            --answer-head-bg: #e9ecef;
            --answer-text-color: #343a40;
            --question-border-color: #ced4da;
            --page-num-color: #333;
            --page-num-bg-color: #cccccc;
            --page-title-text-color: #333;
            --page-title-bg-color: #ffffff;
            --page-title-border-color: #ced4da;
            --poetry-text-color: #333333; 
            --poetry-num-color: #888888; 

            /* Header/Footer Colors */
            --page-header-bg: #f8f9fa;
            --page-footer-bg: #f8f9fa;
            --header-item-bg: #ffffff;
            --footer-item-bg: #ffffff;

            --title-fs: 32px;
            --q-header-fs: 18px; 
            --passage-text-fs: 16px;
            --poetry-text-fs: 20px; 
            --poetry-num-fs: 14px; 
            --question-num-fs: 18px;
            --question-text-fs: 18px;
            --statement-fs: 20px;
            --answer-head-fs: 16px;
            --answer-text-fs: 16px;
            --page-num-fs: 12px;
            /* NEW: Header/Footer Font Sizes */
            --header-text-fs: 14px;
            --footer-text-fs: 12px;
            --page-num-circle-size: 30px;
            --answer-head-circle-size: 28px;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html:fullscreen {
            background: var(--background-color);
        }
        body {
            font-family: var(--font-main);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        .hidden {
            display: none !important;
        }
        body.header-hidden .page-header { display: none !important; }
        body.footer-hidden .page-footer { display: none !important; }
        body.footer-hidden .page-number { display: none !important; }
        
        #landing-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
        }
        .landing-content h1 {
            font-size: 3.5rem;
            color: var(--primary-color);
            margin-bottom: .5rem;
        }
        .landing-content p {
            font-size: 1.2rem;
            color: var(--secondary-color);
            margin-bottom: 2rem;
        }
        .landing-buttons button {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all .3s ease;
            margin: 0 .5rem;
            font-family: var(--font-main);
        }
        .main-btn {
            background-color: var(--primary-color);
            color: white;
        }
        .main-btn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-color);
        }
        .secondary-btn {
            background-color: #e9ecef;
            color: #333;
            border: 1px solid var(--border-color);
        }
        .secondary-btn:hover {
            background-color: #ced4da;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-color);
        }
        .main-btn i,
        .secondary-btn i {
            margin-left: 8px;
        }
        #editor-screen {
            display: flex;
        }
        #sidebar {
            width: 320px;
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            height: 100vh;
            position: fixed;
            top: 0;
            right: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
            transition: margin-right 0.3s ease;
        }
        html:fullscreen #sidebar {
            margin-right: -320px;
        }

        button {
            font-family: var(--font-main);
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .sidebar-header h3 {
             margin: 0;
        }
        #home-btn {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            padding: 5px;
            transition: color .2s ease-in-out;
        }
        #home-btn:hover {
            color: #d1e7ff;
        }
        .sidebar-content {
            padding: 1rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        #main-content {
            flex-grow: 1;
            padding: 2rem;
            margin-right: 320px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            transition: margin-right 0.3s ease;
        }
        html:fullscreen #main-content {
            margin-right: 0;
            padding: 2rem 0; /* Adjust padding in fullscreen */
            width: 100%;
        }

        #pages-container {
            width: 100%;
            max-width: 210mm;
            transition: transform 0.2s ease-in-out;
            transform-origin: top center;
        }
        .control-group {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f1f1f1;
        }
        .control-group h4 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }
        .control-btn {
            font-family: var(--font-main);
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            background: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: background-color .2s;
            margin-bottom: 8px;
        }
        .control-btn:hover:not(:disabled) {
            background-color: #e2e6ea;
        }
        .control-btn:disabled {
            cursor: not-allowed;
            opacity: .5;
        }
        /* START: Settings button beside control button */
        .control-btn-group {
            display: flex;
            gap: 0;
            align-items: center;
            margin-bottom: 8px;
        }
        .control-btn-group .control-btn {
            flex-grow: 1;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            margin-bottom: 0;
        }
        .settings-btn {
            padding: 10px;
            font-size: 1rem;
            background: #e9ecef;
            border: 1px solid var(--border-color);
            border-left: none;
            cursor: pointer;
            border-radius: 6px 0 0 6px;
            height: 42px; /* Match control-btn height */
            color: #555;
        }
        .settings-btn:hover {
            background-color: #ced4da;
        }
        /* END: Settings button */
        .undo-redo-group {
            display: flex;
            gap: 8px;
        }
        .small-btn {
            font-size: .9rem;
            padding: 8px;
        }
        .slider-control {
            margin-bottom: 10px;
        }
        .slider-control label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: .9rem;
            margin-bottom: 5px;
        }
        .slider-value {
            font-size: .85rem;
            color: #fff;
            background-color: var(--secondary-color);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        .slider-control input[type=range] {
            width: 100%;
            cursor: pointer;
        }
        .color-picker-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .color-control label {
            font-size: .9rem;
            margin-bottom: 5px;
            display: block;
        }
        .toggle-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }
        .toggle-control input[type="checkbox"] {
             margin: 0;
             width: 1.2em;
             height: 1.2em;
             accent-color: var(--primary-color);
             cursor: pointer;
        }
        .pcr-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            box-shadow: 0 2px 8px 0 var(--primary-color, #2980b9);
            display: inline-block;
            aspect-ratio: 1/1;
            padding: 0;
        }
        .page {
            background: var(--page-bg);
            width: 210mm;
            min-height: 297mm;
            padding: 16mm 20mm 20mm 20mm; 
            margin: 0 auto 2rem;
            box-shadow: 0 0 15px var(--shadow-color);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .page-header, .page-footer {
            position: absolute;
            left: 0;
            right: 0;
            height: 15mm;
            display: flex;
            align-items: center;
            padding: 0 10mm;
            box-sizing: border-box;
        }
        .page-header {
            top: 0;
            justify-content: space-around;
            background-color: var(--page-header-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .page-footer {
            bottom: 0;
            justify-content: space-between;
            background-color: var(--page-footer-bg);
            border-top: 1px solid var(--border-color);
            z-index: 0; /* Behind page number */
        }
        .header-box, .footer-box {
            background-color: var(--header-item-bg);
            padding: 5px 20px;
            border: 1px solid var(--border-color);
            border-radius: 50px; /* Pill shape */
            text-align: center;
            min-width: 150px;
            flex-shrink: 0;
            cursor: text;
        }
        .header-box { font-size: var(--header-text-fs); }
        .footer-box { font-size: var(--footer-text-fs); }
        
        .page-title {
            display: inline-block;
            text-align: center;
            font-size: var(--title-fs, 2.2rem);
            font-weight: 700;
            color: var(--page-title-text-color, #1a1a1a);
            background-color: var(--page-title-bg-color, #f9f9f9);
            border: 2px solid var(--page-title-border-color, #1a1a1a);
            padding: 0.25rem 2rem;
            border-radius: 16px;
            margin: 0 auto;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
        }


        .page-title:empty {
            display: none;
        }
        .page-number {
            position: absolute;
            bottom: 10mm;
            left: 50%;
            transform: translateX(-50%);
            font-size: var(--page-num-fs);
            color: var(--page-num-color);
            text-align: center;
            background-color: var(--page-num-bg-color);
            width: var(--page-num-circle-size);
            height: var(--page-num-circle-size);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            cursor: context-menu;
            z-index: 1; /* On top of footer */
        }
        .question-list-header {
            font-size: var(--q-header-fs);
            font-weight: bold;
            text-align: right;
            padding: 0.25rem;
            margin-bottom: 0.5rem;
            background-color: #f0f0f0;
            border-radius: 6px;
            page-break-inside: avoid;
        }
        .reading-passage-wrapper {
            border: 2px dashed #999;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            background-color: #fafafa;
            page-break-inside: avoid;
        }
        .reading-passage-text {
            font-size: var(--passage-text-fs);
            line-height: 1.7;
            white-space: pre-wrap;
        }
        .reading-passage-text p, .reading-passage-text div {
            text-indent: 2em;
            margin-top: 0;
            margin-bottom: 0.5em; 
        }
        .reading-passage-text p:last-child, .reading-passage-text div:last-child {
            margin-bottom: 0;
        }
        .poetry-wrapper {
            border: 2px dashed #999;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            background-color: #fafafa;
            page-break-inside: avoid;
            font-family: var(--font-statement);
        }
        .poetry-bait {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 0.5rem;
        }
        .poetry-bait-content {
            flex-grow: 1;
            display: flex;
            gap: 2%; 
        }
        .poetry-shatr {
            width: 49%; 
            font-size: var(--poetry-text-fs);
            color: var(--poetry-text-color);
            padding: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
        }
        .poetry-shatr[data-use-kashida="false"] {
             text-align: right;
        }
        .poetry-shatr:focus {
            outline: 1px dotted var(--primary-color);
            background-color: #fdfdfd;
        }
        .poetry-bait-number {
            font-family: var(--font-main);
            font-size: var(--poetry-num-fs);
            color: var(--poetry-num-color);
            font-weight: bold;
            min-width: 25px;
            text-align: left;
        }
        .question-wrapper {
            margin-bottom: 0.5rem;
            border: 1px solid var(--question-border-color);
            border-radius: 8px;
            padding: .5rem;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
            gap: .8rem;
            position: relative;
            background-color: #fff;
            page-break-inside: avoid;
        }
        .question-header {
            display: flex;
            flex: 1;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            width: 100%;
            box-sizing: border-box;
            display: block;
        }
        .question-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: .8rem;
        }
        .question-line {
            display: flex;
            align-items: flex-start;
            gap: .75rem;
        }
        .question-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            flex-shrink: 0;
            align-self: flex-start;
            margin-right: 0;
            margin-left: 0;
        }
        .question-number {
            font-size: var(--question-num-fs);
            background-color: var(--question-num-bg);
            color: var(--question-num-color);
            padding: 3px 9px;
            border-radius: 50px;
            font-weight: 700;
            line-height: 1;
        }
        .statement-text {
            font-family: var(--font-statement);
            font-size: var(--statement-fs);
            background-color: var(--statement-bg-color);
            color: var(--statement-text-color);
            padding: .2rem;
            border-radius: 6px;
            border-right: 4px solid var(--primary-color);
            font-style: italic;
            width: 100%;
            box-sizing: border-box;
            display: block;
            text-align: center;
        }
        .question-text {
            font-size: var(--question-text-fs);
            color: var(--question-text-color);
            font-weight: 500;
            flex-grow: 1;
            width: 100%;
            box-sizing: border-box;
            display: block;
        }
        .answers-container {
            display: flex;
            margin-top: .3rem;
            gap: .5rem;
        }
        .answers-layout-1 {
            flex-direction: column;
        }
        .answers-layout-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: .8rem;
        }
        .answers-layout-3 {
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .answer-option {
            display: flex;
            align-items: baseline;
            gap: .5rem;
        }
        .answer-head {
            font-size: var(--answer-head-fs);
            color: var(--answer-head-color);
            border-radius: 50%;
            min-width: var(--answer-head-circle-size);
            height: var(--answer-head-circle-size);
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            border: 2px solid var(--answer-head-bg);
        }
        .answer-text {
            font-size: var(--answer-text-fs);
            color: var(--answer-text-color);
        }
        .essay-answer-lines {
            padding-top: .5rem;
            display: flex;
            flex-direction: column;
            gap: var(--answer-text-fs);
            min-height: 50px;
            margin-bottom: 0.5rem;
        }
        .essay-answer-line {
            border-bottom: 1px solid #777;
            width: 100%;
            height: 1.2em;
        }
        [contenteditable]:focus {
            outline: 2px solid var(--primary-color);
            background-color: #eef6ff;
            
        }
        #custom-context-menu {
            position: absolute;
            z-index: 1000;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,.2);
            padding: 8px 0;
            min-width: 260px;
        }
        #custom-context-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #custom-context-menu li {
            padding: 10px 15px;
            cursor: pointer;
            font-size: .95rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #custom-context-menu li:hover {
            background-color: #f1f3f5;
        }
        #custom-context-menu li.danger:hover {
            background-color: #ffe3e3;
            color: #d90429;
        }
        #custom-context-menu hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 5px 0;
        }
        #custom-context-menu li#ctx-change-layout {
            position: relative;
        }
        #custom-context-menu #ctx-layout-submenu {
            position: absolute;
            right: 100%;
            top: -8px; 
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,.2);
            padding: 8px 0;
            min-width: 180px;
            list-style: none;
            display: none;
            z-index: 1001;
        }
        #custom-context-menu li#ctx-change-layout:hover > #ctx-layout-submenu {
            display: block;
        }
        #custom-context-menu #ctx-layout-submenu li {
            padding: 8px 15px;
        }
        #custom-prompt-overlay, #reading-passage-prompt-overlay, #poetry-prompt-overlay, #watermark-prompt-overlay, #question-defaults-prompt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.5);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #custom-prompt, #reading-passage-prompt, #poetry-prompt, #watermark-prompt, #question-defaults-prompt {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        #custom-prompt h4, #reading-passage-prompt h4, #poetry-prompt h4, #watermark-prompt h4, #question-defaults-prompt h4 {
            margin-bottom: 1rem;
            text-align: center;
        }
        #custom-prompt p, #reading-passage-prompt p, #poetry-prompt p {
            margin-bottom: 1rem;
            color: #666;
            text-align: center;
        }
        #custom-prompt input, #reading-passage-prompt textarea, #reading-passage-prompt input, #poetry-prompt textarea, #poetry-prompt input, #watermark-prompt input[type="text"] {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            text-align: right;
            font-family: var(--font-main);
        }
        #reading-passage-prompt textarea, #poetry-prompt textarea {
            min-height: 150px;
            resize: vertical;
        }
        .prompt-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .prompt-buttons button {
            padding: 8px 20px;
            border-radius: 5px;
            border: 1px solid transparent;
            cursor: pointer;
        }
        #prompt-ok, #passage-prompt-ok, #poetry-prompt-ok, #watermark-prompt-ok, #q-defaults-prompt-ok {
            background: var(--primary-color);
            color: white;
        }
        #prompt-cancel, #passage-prompt-cancel, #poetry-prompt-cancel, #watermark-prompt-cancel, #q-defaults-prompt-cancel {
            background: #f1f3f5;
        }

        /* START: Question Defaults Prompt Styles */
        #question-defaults-prompt { text-align: right; }
        .prompt-setting-group { margin-bottom: 1.5rem; }
        .prompt-setting-group h5 { margin-bottom: 0.75rem; color: #555; }
        #default-layout-selector {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }
        #default-layout-selector label {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        #default-layout-selector img {
            width: 48px;
            height: 32px;
            object-fit: contain;
            margin-bottom: 0.25rem;
        }
        #default-layout-selector input { display: none; }
        #default-layout-selector input:checked + label {
            border-color: var(--primary-color);
            background-color: #eef6ff;
            box-shadow: 0 0 5px rgba(41, 128, 185, 0.5);
        }
        /* END: Question Defaults Prompt Styles */

        /* START: Watermark Modal Specific Styles */
        #watermark-prompt { text-align: right; }
        .watermark-type-selector { display: flex; justify-content: center; gap: 2rem; margin-bottom: 1rem; }
         .watermark-type-selector label { display: flex; align-items: center; gap: 8px; cursor: pointer;}
        #watermark-image-control { text-align: center; padding: 1rem; border: 2px dashed var(--border-color); border-radius: 8px; margin-bottom: 1rem; }
        #watermark-prompt .slider-control { margin-top: 1rem; }
        #watermark-image-name { font-size: 0.8rem; color: #666; display: block; margin-top: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        /* END: Watermark Modal Specific Styles */

        /* START: Page Watermark Styles */
        .page-watermark { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; pointer-events: none; overflow: hidden; z-index: 2; }
        .watermark-content-wrapper { display: flex; justify-content: center; align-items: center; }
        .watermark-content { font-weight: bold; color: rgba(0, 0, 0, 1); text-align: center; user-select: none; word-break: break-all; }
        .watermark-content.is-image { object-fit: contain; }
        /* END: Page Watermark Styles */


        #poetry-prompt .kashida-toggle-container { text-align: right; margin-bottom: 1rem; display: flex; align-items: center; justify-content: flex-start; gap: 8px; }
        #text-format-toolbar { position: absolute; background: #333; padding: 5px 10px; border-radius: 6px; z-index: 1001; display: flex; gap: 8px; align-items: center; }
        #text-format-toolbar button { background: none; border: none; color: white; font-size: 16px; cursor: pointer; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; }
        #text-format-toolbar button:hover { background-color: #555; border-radius: 4px; }
        #text-format-toolbar button.active { background-color: var(--primary-color); color: white; border-radius: 4px; }
        #text-format-toolbar .pcr-button { width: 24px; height: 24px; }
        .toolbar-separator { width: 1px; height: 20px; background-color: #666; margin: 0 5px; }
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,.8); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #333; font-size: 1.2rem; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid var(--primary-color); width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* START: Floating Action Buttons (FAB) for View Control */
        #floating-controls { position: fixed; bottom: 30px; left: 30px; z-index: 500; display: flex; flex-direction: column; gap: 10px; }
        #floating-controls button { width: 50px; height: 50px; border-radius: 50%; border: none; background-color: var(--primary-color); color: white; font-size: 20px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: all 0.2s ease-in-out; }
        #floating-controls button:hover { background-color: #0056b3; transform: scale(1.1); }
        /* END: Floating Action Buttons */

    </style>
</head>
<body>

    <div id="landing-screen">
        <div class="landing-content">
            <h1>
                <img src="assets/logo.png" alt=",ورقة" width="200px">
            </h1>
           
            <div class="landing-buttons">
                <button id="upload-excel-btn" class="main-btn"> <i class="fas fa-file-excel"></i> رفع ملف Excel </button>
                <button id="start-from-scratch-btn" class="secondary-btn"> <i class="fas fa-pen-ruler"></i> البدء من الصفر </button>
            </div>
            <input type="file" id="excel-file-input" accept=".xlsx, .xls" style="display:none">
            <div class="how-to-use-container" style="text-align: center; margin-top: 15px;">
                <a href="htu.html">
                    <button id="how-to-use-btn" class="secondary-btn" title="كيفية الاستخدام" style="font-family: var(--font-main);">
                        <i class="fas fa-question-circle"></i> كيفية الاستخدام
                    </button>
                </a>
            </div>
        </div>
    </div>
    <div id="editor-screen" class="hidden">
        <aside id="sidebar">
            <div class="sidebar-header">
                <button id="home-btn" title="العودة للرئيسية"><i class="fas fa-home"></i></button>
                <h3> <i class="fas fa-sliders"></i> لوحة التحكم </h3>
            </div>
            <div class="sidebar-content">
                <div class="control-group">
                    <h4>إجراءات</h4>
                    <button id="save-pdf-btn" class="control-btn"> <i class="fas fa-file-pdf"></i> حفظ كـ PDF </button>
                    <button id="add-from-excel-btn" class="control-btn"> <i class="fas fa-file-import"></i> إضافة أسئلة من Excel </button>
                    
                    <div class="control-btn-group">
                        <button id="add-question-btn" class="control-btn"> <i class="fas fa-plus"></i> إضافة سؤال اختياري </button>
                        <button id="question-defaults-settings-btn" class="settings-btn" title="الإعدادات الافتراضية للسؤال"> <i class="fas fa-cog"></i> </button>
                    </div>

                    <button id="add-essay-question-btn" class="control-btn"> <i class="fas fa-pen-alt"></i> إضافة سؤال مقالي </button>
                    <button id="add-q-header-btn" class="control-btn"> <i class="fas fa-heading"></i> إضافة رأس للأسئلة </button>
                    <button id="add-passage-btn" class="control-btn"> <i class="fas fa-file-alt"></i> إضافة قطعة قراءة </button>
                    <button id="add-poetry-btn" class="control-btn"> <i class="fas fa-feather-alt"></i> إضافة نص شعري </button>
                    <button id="add-watermark-btn" class="control-btn"> <i class="fas fa-stamp"></i> إضافة علامة مائية </button>
                    <div class="undo-redo-group">
                        <button id="undo-btn" class="control-btn small-btn" disabled> <i class="fas fa-undo"></i> تراجع </button>
                        <button id="redo-btn" class="control-btn small-btn" disabled> <i class="fas fa-redo"></i> إعادة </button>
                    </div>
                </div>
                <!-- START: Header and Footer Control Group -->
                 <div class="control-group">
                    <h4> <i class="fas fa-window-maximize"></i> تخصيص الهيدر والفوتر </h4>
                    <div class="toggle-control"> <label for="toggle-header-visibility">عرض الهيدر</label> <input type="checkbox" id="toggle-header-visibility" checked> </div>
                    <div class="toggle-control"> <label for="toggle-footer-visibility">عرض الفوتر</label> <input type="checkbox" id="toggle-footer-visibility" checked> </div>
                     <hr style="margin: 1rem 0;">
                    <div class="color-picker-grid">
                        <div class="color-control"> <label>خلفية الهيدر</label> <div class="color-picker" id="page-header-bg"></div> </div>
                        <div class="color-control"> <label>خلفية خانة الهيدر</label> <div class="color-picker" id="header-item-bg"></div> </div>
                        <div class="color-control"> <label>خلفية الفوتر</label> <div class="color-picker" id="page-footer-bg"></div> </div>
                        <div class="color-control"> <label>خلفية خانة الفوتر</label> <div class="color-picker" id="footer-item-bg"></div> </div>
                    </div>
                </div>
                <!-- END: Header and Footer Control Group -->
                <div class="control-group">
                    <h4> <i class="fas fa-palette"></i> ألوان المحتوى </h4>
                    <div class="color-picker-grid">
                        <div class="color-control"> <label>لون نص العنوان</label> <div class="color-picker" id="page-title-text-color"></div> </div>
                        <div class="color-control"> <label>خلفية العنوان</label> <div class="color-picker" id="page-title-bg-color"></div> </div>
                        <div class="color-control"> <label>لون إطار العنوان</label> <div class="color-picker" id="page-title-border-color"></div> </div>
                        <div class="color-control"> <label>نص الشعر</label> <div class="color-picker" id="poetry-text-color"></div> </div>
                        <div class="color-control"> <label>رقم البيت</label> <div class="color-picker" id="poetry-num-color"></div> </div>
                        <div class="color-control"> <label>نص السؤال</label> <div class="color-picker" id="question-text-color"></div> </div>
                        <div class="color-control"> <label>رقم السؤال</label> <div class="color-picker" id="question-num-color"></div> </div>
                        <div class="color-control"> <label>خلفية رقم السؤال</label> <div class="color-picker" id="question-num-bg"></div> </div>
                        <div class="color-control"> <label>نص العبارة</label> <div class="color-picker" id="statement-text-color"></div> </div>
                        <div class="color-control"> <label>خلفية العبارة</label> <div class="color-picker" id="statement-bg-color"></div> </div>
                        <div class="color-control"> <label>رأس الإجابة</label> <div class="color-picker" id="answer-head-color"></div> </div>
                        <div class="color-control"> <label>خلفية رأس الإجابة</label> <div class="color-picker" id="answer-head-bg"></div> </div>
                        <div class="color-control"> <label>نص الإجابة</label> <div class="color-picker" id="answer-text-color"></div> </div>
                        <div class="color-control"> <label>إطار السؤال</label> <div class="color-picker" id="question-border-color"></div> </div>
                        <div class="color-control"> <label>لون خط رقم الصفحة</label> <div class="color-picker" id="page-num-color"></div> </div>
                        <div class="color-control"> <label>خلفية رقم الصفحة</label> <div class="color-picker" id="page-num-bg-color"></div> </div>
                        <div class="color-control"> <label>لون التظليل</label> <div class="color-picker" id="sidebar-highlight-color-picker"></div> </div>
                        <div class="color-control"> <label>لون التسطير</label> <div class="color-picker" id="sidebar-underline-color-picker"></div> </div>
                    </div>
                </div>
                <div class="control-group">
                    <h4> <i class="fas fa-text-height"></i> حجم الخطوط والأبعاد </h4>
                    <div class="slider-control"> <label for="title-fs">العنوان الرئيسي <span class="slider-value"></span></label> <input type="range" id="title-fs" min="16" max="60" value="32"> </div>
                    <div class="slider-control"> <label for="q-header-fs">نص رأس السؤال <span class="slider-value"></span></label> <input type="range" id="q-header-fs" min="12" max="40" value="18"> </div>
                    <div class="slider-control"> <label for="passage-text-fs">نص قطعة القراءة <span class="slider-value"></span></label> <input type="range" id="passage-text-fs" min="12" max="40" value="16"> </div>
                    <div class="slider-control"> <label for="poetry-text-fs">حجم نص الشعر <span class="slider-value"></span></label> <input type="range" id="poetry-text-fs" min="12" max="40" value="20"> </div>
                    <div class="slider-control"> <label for="poetry-num-fs">حجم رقم البيت <span class="slider-value"></span></label> <input type="range" id="poetry-num-fs" min="10" max="30" value="14"> </div>
                    <div class="slider-control"> <label for="question-num-fs">رقم السؤال <span class="slider-value"></span></label> <input type="range" id="question-num-fs" min="12" max="36" value="18"> </div>
                    <div class="slider-control"> <label for="question-text-fs">نص السؤال <span class="slider-value"></span></label> <input type="range" id="question-text-fs" min="12" max="36" value="18"> </div>
                    <div class="slider-control"> <label for="statement-fs">العبارة التمهيدية <span class="slider-value"></span></label> <input type="range" id="statement-fs" min="14" max="40" value="20"> </div>
                    <div class="slider-control"> <label for="answer-head-fs">رأس الإجابة (أ,ب..) <span class="slider-value"></span></label> <input type="range" id="answer-head-fs" min="12" max="32" value="16"> </div>
                    <div class="slider-control"> <label for="answer-text-fs">نص الإجابة <span class="slider-value"></span></label> <input type="range" id="answer-text-fs" min="12" max="32" value="16"> </div>
                    <div class="slider-control"> <label for="page-num-fs">رقم الصفحة <span class="slider-value"></span></label> <input type="range" id="page-num-fs" min="8" max="24" value="12"> </div>
                    <div class="slider-control"> <label for="header-text-fs">حجم خط الهيدر <span class="slider-value"></span></label> <input type="range" id="header-text-fs" min="8" max="30" value="14"> </div>
                    <div class="slider-control"> <label for="footer-text-fs">حجم خط الفوتر <span class="slider-value"></span></label> <input type="range" id="footer-text-fs" min="8" max="30" value="12"> </div>
                    <div class="slider-control"> <label for="answer-head-circle-size">حجم دائرة رأس الإجابة <span class="slider-value"></span></label> <input type="range" id="answer-head-circle-size" min="20" max="60" value="28"> </div>
                    <div class="slider-control"> <label for="page-num-circle-size">حجم دائرة رقم الصفحة <span class="slider-value"></span></label> <input type="range" id="page-num-circle-size" min="20" max="60" value="30"> </div>
                </div>
            </div>
        </aside>
        <main id="main-content">
            <div id="pages-container"></div>
            <div id="text-format-toolbar" class="hidden">
                <button id="highlight-btn" title="تظليل النص"><i class="fas fa-highlighter"></i></button> <div class="toolbar-separator"></div> <button id="underline-btn" title="تسطير النص"><i class="fas fa-underline"></i></button> <div class="toolbar-separator"></div> <button id="align-right-btn" data-align="justifyRight" title="محاذاة لليمين"><i class="fas fa-align-right"></i></button> <button id="align-center-btn" data-align="justifyCenter" title="توسيط"><i class="fas fa-align-center"></i></button> <button id="align-left-btn" data-align="justifyLeft" title="محاذاة لليسار"><i class="fas fa-align-left"></i></button> <button id="align-justify-btn" data-align="justifyFull" title="ضبط"><i class="fas fa-align-justify"></i></button>
            </div>
        </main>
        
        <!-- START: Floating Controls -->
        <div id="floating-controls">
            <button id="zoom-in-btn" title="تكبير"><i class="fas fa-search-plus"></i></button>
            <button id="zoom-out-btn" title="تصغير"><i class="fas fa-search-minus"></i></button>
            <button id="fullscreen-btn" title="وضع ملء الشاشة"><i class="fas fa-expand"></i></button>
        </div>
        <!-- END: Floating Controls -->
    </div>

    <!-- Modals and Context Menus -->
    <div id="custom-context-menu" class="hidden">
        <ul>
            <li id="ctx-delete-header" class="danger hidden"><i class="fas fa-trash"></i> <span>حذف العنوان</span></li>
            <li id="ctx-set-page-number" class="hidden"><i class="fas fa-sort-numeric-down"></i> <span>بدء ترقيم الصفحات من...</span></li>
            <li id="ctx-add-hf-box" class="hidden"><i class="fas fa-plus"></i> <span>إضافة خانة</span></li>
            <li id="ctx-delete-hf-box" class="danger hidden"><i class="fas fa-trash"></i> <span>حذف الخانة</span></li>
            <li id="ctx-hf-separator" class="hidden"><hr></li>
            <li id="ctx-upload-image" class="hidden"><i class="fas fa-upload"></i> <span>إضافة/تغيير صورة (من الجهاز)</span></li>
            <li id="ctx-add-image-url" class="hidden"><i class="fas fa-link"></i> <span>إضافة/تغيير صورة (من رابط)</span></li>
            <li id="ctx-delete-image" class="hidden"><i class="fas fa-trash-alt"></i> <span>حذف الصورة</span></li>
            <li id="ctx-add-statement" class="hidden"><i class="fas fa-quote-left"></i> <span>إضافة/تعديل عبارة</span></li>
            <li id="ctx-delete-statement" class="hidden"><i class="fas fa-trash-alt"></i> <span>حذف العبارة</span></li>
            <li id="ctx-toggle-kashida" class="hidden"><i class="fas fa-text-width"></i> <span>تفعيل/إلغاء تمديد النص/span></li>
            <li id="ctx-separator-1" class="hidden"><hr></li>
            <li id="ctx-change-layout" class="hidden"> <i class="fas fa-th-large"></i> <span>تعديل نمط الإجابات</span> <ul id="ctx-layout-submenu"> 
                <li data-layout="1">
                    <img src="assets/icons/layout1.svg" alt="نمط 1" style="width: 1em; vertical-align: middle; margin-left: 0.5em;">
                    نمط 1 (عمودي)
                </li>
                <li data-layout="2">
                    <img src="assets/icons/layout2.svg" alt="نمط 2" style="width: 1em; vertical-align: middle; margin-left: 0.5em;">
                    نمط 2 (عمودان)
                </li>
                <li data-layout="3">
                    <img src="assets/icons/layout3.svg" alt="نمط 3" style="width: 1em; vertical-align: middle; margin-left: 0.5em;">
                    نمط 3 (أفقي)
                </li>
            </ul> </li>
            <li id="ctx-set-essay-lines" class="hidden"><i class="fas fa-bars"></i> <span>تحديد عدد أسطر الإجابة</span></li>
            <li id="ctx-set-start-number" class="hidden"><i class="fas fa-sort-numeric-down"></i> <span>بدء العد من رقم محدد...</span></li>
            <li id="ctx-cancel-restart-numbering" class="hidden"><i class="fas fa-times"></i> <span>إلغاء العد المخصص</span></li>
            <li id="ctx-separator-2" class="hidden"><hr></li>
            <li id="ctx-move-up"><i class="fas fa-arrow-up"></i> <span>نقل لأعلى</span></li>
            <li id="ctx-move-down"><i class="fas fa-arrow-down"></i> <span>نقل لأسفل</span></li>
            <li id="ctx-separator-3"><hr></li>
            <li id="ctx-delete-item" class="danger"><i class="fas fa-times-circle"></i> <span>حذف العنصر</span></li>
        </ul>
    </div>
    <div id="custom-prompt-overlay" class="hidden">
        <div id="custom-prompt">
            <h4 id="prompt-title">العنوان</h4>
            <p id="prompt-text">النص</p>
            <input type="text" id="prompt-input">
            <div class="prompt-buttons">
                <button id="prompt-cancel">إلغاء</button>
                <button id="prompt-ok">موافق</button>
            </div>
        </div>
    </div>
    <div id="reading-passage-prompt-overlay" class="hidden">
        <div id="reading-passage-prompt">
            <h4>إضافة قطعة قراءة</h4>
            <p>أدخل نص القطعة وحدد عدد الأسئلة المرتبطة بها.</p>
            <textarea id="passage-prompt-text" placeholder="أدخل نص قطعة القراءة هنا..."></textarea>
            <input type="number" id="passage-prompt-q-count" placeholder="عدد الأسئلة" min="1" value="1">
            <div class="prompt-buttons">
                <button id="passage-prompt-cancel">إلغاء</button>
                <button id="passage-prompt-ok">أضف</button>
            </div>
        </div>
    </div>
    <div id="poetry-prompt-overlay" class="hidden">
        <div id="poetry-prompt">
            <h4>إضافة نص شعري</h4>
            <p>أدخل النص الشعري، افصل بين الشطرين بمسافة طويلة (مسطرة مرتين أو أكثر) وأدخل كل بيت في سطر جديد. ثم حدد عدد الأسئلة المرتبطة به.</p>
            <textarea id="poetry-prompt-text" placeholder="الشطر الأول   الشطر الثاني..."></textarea>
            <div class="kashida-toggle-container"><label for="poetry-prompt-kashida-toggle">تفعيل تمديد النص</label>
                <input type="checkbox" id="poetry-prompt-kashida-toggle" checked>
                
            </div>
            <input type="number" id="poetry-prompt-q-count" placeholder="عدد الأسئلة" min="0" value="1">
            <div class="prompt-buttons">
                <button id="poetry-prompt-cancel">إلغاء</button>
                <button id="poetry-prompt-ok">أضف</button>
            </div>
        </div>
    </div>
    <div id="watermark-prompt-overlay" class="hidden">
        <div id="watermark-prompt">
            <h4>إعدادات العلامة المائية</h4>
            <div class="watermark-type-selector">
                <label><input type="radio" name="watermark-type" value="text" checked> نص</label>
                <label><input type="radio" name="watermark-type" value="image"> صورة</label>
            </div>
            <div id="watermark-text-control">
                <input type="text" id="watermark-text-input" placeholder="أدخل نص العلامة المائية">
            </div>
            <div id="watermark-image-control" class="hidden">
                <button id="watermark-image-upload-btn" class="secondary-btn">اختر صورة...</button>
                <input type="file" id="watermark-image-input" accept="image/*" style="display:none">
                <span id="watermark-image-name">لم يتم اختيار صورة</span>
            </div>
            <div id="watermark-size-slider-control" class="slider-control">
                <label for="watermark-size"><span id="watermark-size-label">حجم الخط</span> <span class="slider-value">80</span></label>
                <input type="range" id="watermark-size" min="20" max="200" step="2" value="80" data-unit="px">
            </div>
            <div class="slider-control">
                <label for="watermark-opacity">الشفافية <span class="slider-value">0.25</span></label>
                <input type="range" id="watermark-opacity" min="0" max="1" step="0.05" value="0.25">
            </div>
            <div class="slider-control">
                <label for="watermark-rotation">زاوية الدوران <span class="slider-value">0</span></label>
                <input type="range" id="watermark-rotation" min="-90" max="90" step="1" value="0">
            </div>
            <div class="prompt-buttons">
                <button id="watermark-prompt-remove" class="secondary-btn" style="background-color: #ffe3e3; color: #d90429;">إزالة العلامة</button>
                <button id="watermark-prompt-cancel">إلغاء</button>
                <button id="watermark-prompt-ok">تطبيق</button>
            </div>
        </div>
    </div>
    <!-- START: Question Defaults Prompt -->
    <div id="question-defaults-prompt-overlay" class="hidden">
        <div id="question-defaults-prompt">
            <h4>إعدادات السؤال الافتراضية</h4>
            <div class="prompt-setting-group">
                <h5>العبارة التمهيدية</h5>
                <div class="toggle-control">
                    <label for="default-statement-toggle">إضافة عبارة تمهيدية مع كل سؤال جديد</label>
                    <input type="checkbox" id="default-statement-toggle">
                </div>
            </div>
             <div class="prompt-setting-group">
                <h5>نمط الإجابات الافتراضي</h5>
                <div id="default-layout-selector">
                    <span>
                        <input type="radio" id="default-layout-1" name="default-layout" value="1">
                        <label for="default-layout-1">
                            <img src="assets/icons/layout1.svg" alt="نمط عمودي">عمودي
                        </label>
                    </span>
                     <span>
                        <input type="radio" id="default-layout-2" name="default-layout" value="2">
                        <label for="default-layout-2">
                             <img src="assets/icons/layout2.svg" alt="نمط عمودان">عمودان
                        </label>
                    </span>
                     <span>
                        <input type="radio" id="default-layout-3" name="default-layout" value="3">
                        <label for="default-layout-3">
                             <img src="assets/icons/layout3.svg" alt="نمط أفقي">أفقي
                        </label>
                    </span>
                </div>
            </div>
            <div class="prompt-buttons">
                <button id="q-defaults-prompt-cancel">إلغاء</button>
                <button id="q-defaults-prompt-ok">حفظ</button>
            </div>
        </div>
    </div>
    <!-- END: Question Defaults Prompt -->
    
    <div id="loader-overlay" class="hidden"> <div class="loader"></div> <p>جاري تحويل الصفحات إلى صور...</p> </div>
    <input type="file" id="image-upload-input" accept="image/*" style="display:none">

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Embedded JS -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let pageContent = [];
            let history = [];
            let redoStack = [];
            let currentContextMenuTarget = null;
            let startPageNumber = 1;
            let excelImportMode = 'replace';
            let currentZoomLevel = 1.0;
            let highlightColorPicker, underlineColorPicker;

            let headerFooterState = {
                header: { visible: true, items: [{ text: 'صندوق' },{ text: 'صندوق' },{ text: 'صندوق' }] },
                footer: { visible: true, items: [{ text: 'صندوق' },{ text: 'صندوق' }] }
            };
            
            let watermarkState = { type: 'text', content: '', opacity: 0.25, rotation: 0, size: 80, visible: false, imageName: '', imageData: null };
            
            let newQuestionDefaults = {
                includeStatement: false,
                defaultLayout: '3'
            };

            let kashidaObserver;
            let canvas, ctx;
            const kashida = '\u0640';
            const diacritics = 'ًٌٍَُِّْ';
            const noKashidaBefore = "ءأإآاوىة.:،؛!؟-()[]{}'\"0123456789 ";
            const noKashidaAfter = "ءأإآادذرزوؤةى.:،؛!؟-()[]{}'\" ";

            const landingScreen = document.getElementById("landing-screen");
            const editorScreen = document.getElementById("editor-screen");
            const uploadExcelBtn = document.getElementById("upload-excel-btn");
            const fileInput = document.getElementById("excel-file-input");
            const imageUploadInput = document.getElementById("image-upload-input");
            const startFromScratchBtn = document.getElementById("start-from-scratch-btn");
            const homeBtn = document.getElementById("home-btn");
            const pagesContainer = document.getElementById("pages-container");
            const savePdfBtn = document.getElementById("save-pdf-btn");
            const addFromExcelBtn = document.getElementById("add-from-excel-btn");
            const addQuestionBtn = document.getElementById("add-question-btn");
            const qDefaultsSettingsBtn = document.getElementById('question-defaults-settings-btn');
            const addEssayQuestionBtn = document.getElementById("add-essay-question-btn");
            const addQHeaderBtn = document.getElementById("add-q-header-btn");
            const addPassageBtn = document.getElementById("add-passage-btn");
            const addPoetryBtn = document.getElementById("add-poetry-btn");
            const addWatermarkBtn = document.getElementById("add-watermark-btn");
            const undoBtn = document.getElementById("undo-btn");
            const redoBtn = document.getElementById("redo-btn");
            const contextMenu = document.getElementById("custom-context-menu");
            const loader = document.getElementById("loader-overlay");
            const loaderText = loader.querySelector("p");
            const customPromptOverlay = document.getElementById("custom-prompt-overlay");
            const passagePromptOverlay = document.getElementById("reading-passage-prompt-overlay");
            const poetryPromptOverlay = document.getElementById("poetry-prompt-overlay");
            const watermarkPromptOverlay = document.getElementById('watermark-prompt-overlay');
            const qDefaultsPromptOverlay = document.getElementById('question-defaults-prompt-overlay');
            const textFormatToolbar = document.getElementById("text-format-toolbar");
            const mainContent = document.getElementById("main-content");
            const toggleHeaderCheckbox = document.getElementById('toggle-header-visibility');
            const toggleFooterCheckbox = document.getElementById('toggle-footer-visibility');
            const colorSwatches = ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722', '#795548', '#607D8B', '#FFFFFF', '#000000'];
            
            const zoomInBtn = document.getElementById('zoom-in-btn');
            const zoomOutBtn = document.getElementById('zoom-out-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');


            function initialize() {
                // Event Listeners
                uploadExcelBtn.addEventListener("click", () => { excelImportMode = 'replace'; fileInput.click(); });
                addFromExcelBtn.addEventListener("click", () => { excelImportMode = 'append'; fileInput.click(); });
                fileInput.addEventListener("change", handleExcelFile);
                imageUploadInput.addEventListener("change", handleImageFileUpload);
                startFromScratchBtn.addEventListener("click", startFromScratch);
                homeBtn.addEventListener("click", goHome);
                savePdfBtn.addEventListener("click", saveAsPDF);
                addQuestionBtn.addEventListener("click", addNewQuestion);
                qDefaultsSettingsBtn.addEventListener('click', showQuestionDefaultsPrompt);
                addEssayQuestionBtn.addEventListener("click", addNewEssayQuestion);
                addQHeaderBtn.addEventListener("click", addQuestionHeader);
                addPassageBtn.addEventListener("click", showReadingPassagePrompt);
                addPoetryBtn.addEventListener("click", showPoetryPrompt); 
                addWatermarkBtn.addEventListener('click', showWatermarkPrompt);
                undoBtn.addEventListener("click", undo);
                redoBtn.addEventListener("click", redo);
                toggleHeaderCheckbox.addEventListener('change', toggleHeaderVisibility);
                toggleFooterCheckbox.addEventListener('change', toggleFooterVisibility);

                // View controls listeners
                zoomInBtn.addEventListener('click', () => applyZoom(currentZoomLevel + 0.1));
                zoomOutBtn.addEventListener('click', () => applyZoom(currentZoomLevel - 0.1));
                fullscreenBtn.addEventListener('click', toggleFullscreen);
                document.addEventListener('fullscreenchange', handleFullscreenChange);

                // Setups
                setupStyleControls();
                setupContextMenuListeners();
                setupAllPrompts();
                setupTextFormatToolbar();
                setupKashidaInfrastructure();
                
                // General UI Listeners
                mainContent.addEventListener('contextmenu', handleMainContentContextMenu);
                document.addEventListener("click", hideMenusOnClickOutside);
                window.addEventListener("scroll", () => textFormatToolbar.classList.add("hidden"));
            }

            function setupAllPrompts() {
                document.getElementById('passage-prompt-ok').addEventListener('click', () => { const text = document.getElementById('passage-prompt-text').value; const qCount = parseInt(document.getElementById('passage-prompt-q-count').value, 10) || 0; if(text && qCount > 0) addReadingPassage(text, qCount); passagePromptOverlay.classList.add('hidden'); });
                document.getElementById('passage-prompt-cancel').addEventListener('click', () => passagePromptOverlay.classList.add('hidden'));
                
                document.getElementById('poetry-prompt-ok').addEventListener('click', () => { const text = document.getElementById('poetry-prompt-text').value; const qCount = parseInt(document.getElementById('poetry-prompt-q-count').value, 10) || 0; const useKashida = document.getElementById('poetry-prompt-kashida-toggle').checked; if (text.trim() && qCount >= 0) addPoeticText(text, qCount, useKashida); poetryPromptOverlay.classList.add('hidden'); });
                document.getElementById('poetry-prompt-cancel').addEventListener('click', () => poetryPromptOverlay.classList.add('hidden'));

                setupWatermarkPromptListeners();

                document.getElementById('q-defaults-prompt-ok').addEventListener('click', applyQuestionDefaults);
                document.getElementById('q-defaults-prompt-cancel').addEventListener('click', () => qDefaultsPromptOverlay.classList.add('hidden'));
            }

            function showQuestionDefaultsPrompt() {
                document.getElementById('default-statement-toggle').checked = newQuestionDefaults.includeStatement;
                const layoutRadio = document.querySelector(`#default-layout-selector input[value="${newQuestionDefaults.defaultLayout}"]`);
                if (layoutRadio) {
                    layoutRadio.checked = true;
                }
                qDefaultsPromptOverlay.classList.remove('hidden');
            }

            function applyQuestionDefaults() {
                newQuestionDefaults.includeStatement = document.getElementById('default-statement-toggle').checked;
                const selectedLayout = document.querySelector('#default-layout-selector input:checked');
                if (selectedLayout) {
                    newQuestionDefaults.defaultLayout = selectedLayout.value;
                }
                qDefaultsPromptOverlay.classList.add('hidden');
            }
            
            function applyZoom(newLevel) { if (newLevel >= 0.5 && newLevel <= 2.0) { currentZoomLevel = newLevel; pagesContainer.style.transform = `scale(${currentZoomLevel})`; } }
            
            function toggleFullscreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(err => { console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`); }); } else { if(document.exitFullscreen) document.exitFullscreen(); } }
            
            function handleFullscreenChange() { const icon = fullscreenBtn.querySelector('i'); const isFullscreen = !!document.fullscreenElement; icon.classList.toggle('fa-expand', !isFullscreen); icon.classList.toggle('fa-compress', isFullscreen); fullscreenBtn.title = isFullscreen ? "الخروج من وضع ملء الشاشة" : "وضع ملء الشاشة"; }
            
            function goHome() { editorScreen.classList.add("hidden"); landingScreen.classList.remove("hidden"); }
            
            function showEditor() { landingScreen.classList.add("hidden"); editorScreen.classList.remove("hidden"); }

            function handleExcelFile(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);

                        if (excelImportMode === 'append') {
                            appendQuestions(json);
                        } else {
                            parseAndLoadQuestions(json);
                        }
                        showEditor();
                    } catch (err) {
                        console.error("Error processing Excel file:", err);
                        alert("حدث خطأ أثناء معالجة ملف Excel. يرجى التأكد من أن الملف غير تالف وبالتنسيق الصحيح.");
                    } finally { e.target.value = ''; }
                };
                reader.readAsArrayBuffer(file);
            }

            function startFromScratch() {
                pageContent = [];
                startPageNumber = 1;
                renderAll();
                showEditor();
                recordState("Initial empty state");
            }

            function mapJsonToPageContent(data) {
                 return data.map((row, index) => ({
                    elementType: 'question', id: `q-${Date.now()}-${index}`, question: row['السؤال'] || "نص السؤال فارغ",
                    answers: { a: row['الإجابة أ'] || "", b: row['الإجابة ب'] || "", c: row['الإجابة ج'] || "", d: row['الإجابة د'] || "" },
                    statement: row['العبارة'] || null, image: row['الصورة'] || null, layoutType: row['النوع'] || 3, restartNumbering: row['بدء عد جديد'] ? 1 : false
                }));
            }
            
            function parseAndLoadQuestions(data) { pageContent = mapJsonToPageContent(data); startPageNumber = 1; renderAll(); recordState("Load from Excel"); }
            function appendQuestions(data) { const newItems = mapJsonToPageContent(data); pageContent = pageContent.concat(newItems); renderAll(); recordState("Append from Excel"); }

            function renderAll() {
                pagesContainer.innerHTML = "";
                let headerText = "أضف عنواناً";
                const firstPageHeader = document.querySelector('.page-title');
                if(firstPageHeader) headerText = firstPageHeader.innerHTML;
                
                if (kashidaObserver) kashidaObserver.disconnect();
                if (pageContent.length === 0) {
                    let page = addNewPage();
                    const header = createPageHeader(headerText);
                    page.prepend(header);
                    updatePageNumbers();
                    updateAllWatermarks(); 
                    return;
                }
                
                let questionCounter = 1;
                const elements = pageContent.map((item) => {
                    let element;
                    if (item.restartNumbering !== false && !isNaN(parseInt(item.restartNumbering, 10))) questionCounter = parseInt(item.restartNumbering, 10);
                    switch(item.elementType) {
                        case 'question': element = createQuestionElement(item, questionCounter); questionCounter++; break;
                        case 'essayQuestion': element = createEssayQuestionElement(item, questionCounter); questionCounter++; break;
                        case 'questionHeader': element = createQuestionHeaderElement(item); break;
                        case 'readingPassage': element = createReadingPassageElement(item); break;
                        case 'poeticText': element = createPoeticTextElement(item); break;
                    }
                    return element;
                });

                let currentPage = addNewPage();
                const header = createPageHeader(headerText);
                currentPage.prepend(header);
                
                let currentHeight = header.offsetHeight + (parseFloat(getComputedStyle(header).marginBottom) || 0);
                const pageHeightLimit = 970;

                elements.forEach(el => {
                    if (!el) return;
                    currentPage.appendChild(el);
                    const elStyle = getComputedStyle(el);
                    const elHeight = el.offsetHeight + parseFloat(elStyle.marginTop || 0) + parseFloat(elStyle.marginBottom || 0);
                    if (currentHeight + elHeight > pageHeightLimit && currentPage.childElementCount > 5) { // title, header, footer, pageNum, watermark
                        currentPage.removeChild(el); currentPage = addNewPage(); currentPage.appendChild(el); currentHeight = el.offsetHeight;
                    } else { currentHeight += elHeight; }
                });
                updatePageNumbers();
                updateAllWatermarks();
                
                pagesContainer.querySelectorAll('.poetry-wrapper').forEach(wrapper => {
                    const item = pageContent.find(p => p.id === wrapper.dataset.itemId);
                    if (item && item.useKashida) {
                         wrapper.querySelectorAll('.poetry-shatr').forEach(shatr => kashidaObserver.observe(shatr));
                    }
                });
            }

            function createPageHeader(text) {
                const header = document.createElement("div"); header.className = "page-title"; header.setAttribute("contenteditable", "true"); header.innerHTML = text;
                return header;
            }

            function createQuestionElement(question, number) {
                const wrapper = document.createElement("div"); wrapper.className = "question-wrapper"; wrapper.id = question.id; wrapper.dataset.itemId = question.id;
                wrapper.innerHTML = `
                    <div class="question-header">
                        <div class="question-body">
                            ${question.statement ? `<div class="statement-text" contenteditable="true" data-prop="statement">${question.statement}</div>` : ''}
                            <div class="question-line"> <span class="question-number">${number}</span> <div class="question-text" contenteditable="true" data-prop="question">${question.question}</div> </div>
                        </div>
                        <div class="answers-container answers-layout-${question.layoutType}">
                            <div class="answer-option"><div class="answer-head">أ</div><div class="answer-text" contenteditable="true" data-prop="answers.a">${question.answers.a}</div></div>
                            <div class="answer-option"><div class="answer-head">ب</div><div class="answer-text" contenteditable="true" data-prop="answers.b">${question.answers.b}</div></div>
                            <div class="answer-option"><div class="answer-head">ج</div><div class="answer-text" contenteditable="true" data-prop="answers.c">${question.answers.c}</div></div>
                            <div class="answer-option"><div class="answer-head">د</div><div class="answer-text" contenteditable="true" data-prop="answers.d">${question.answers.d}</div></div>
                        </div>
                    </div>
                    ${question.image ? `<img src="${question.image}" alt="صورة السؤال" class="question-image">` : ''}`;
                wrapper.querySelectorAll("[contenteditable]").forEach(el => { el.addEventListener("blur", (e) => handleTextEdit(e, question.id)); el.addEventListener("mouseup", showFormatToolbar); });
                return wrapper;
            }
            
            function createEssayQuestionElement(question, number) {
                const wrapper = document.createElement("div"); wrapper.className = "question-wrapper"; wrapper.id = question.id; wrapper.dataset.itemId = question.id;
                let linesHtml = ''; for (let i = 0; i < (question.lines || 2); i++) linesHtml += '<div class="essay-answer-line"></div>';
                wrapper.innerHTML = `
                    <div class="question-header">
                        <div class="question-body">
                            ${question.statement ? `<div class="statement-text" contenteditable="true" data-prop="statement">${question.statement}</div>` : ''}
                            <div class="question-line"> <span class="question-number">${number}</span> <div class="question-text" contenteditable="true" data-prop="question">${question.question}</div> </div>
                            <div class="essay-answer-lines"> ${linesHtml} </div>
                        </div>
                    </div>
                    ${question.image ? `<img src="${question.image}" alt="صورة السؤال" class="question-image">` : ''}`;
                wrapper.querySelectorAll("[contenteditable]").forEach(el => { el.addEventListener("blur", (e) => handleTextEdit(e, question.id)); el.addEventListener("mouseup", showFormatToolbar); });
                return wrapper;
            }

            function createQuestionHeaderElement(item) {
                const div = document.createElement('div'); div.className = 'question-list-header'; div.innerHTML = item.text; div.id = item.id;
                div.dataset.itemId = item.id; div.setAttribute('contenteditable', 'true'); div.dataset.prop = 'text';
                div.addEventListener("blur", (e) => handleTextEdit(e, item.id)); div.addEventListener("mouseup", showFormatToolbar); return div;
            }
            
            function createReadingPassageElement(item) {
                const wrapper = document.createElement('div'); wrapper.className = 'reading-passage-wrapper'; wrapper.id = item.id; wrapper.dataset.itemId = item.id;
                const passageText = document.createElement('div'); passageText.className = 'reading-passage-text'; passageText.setAttribute('contenteditable', 'true');
                passageText.dataset.prop = 'text'; passageText.innerHTML = item.text; wrapper.appendChild(passageText);
                passageText.addEventListener("blur", (e) => handleTextEdit(e, item.id)); passageText.addEventListener("mouseup", showFormatToolbar); return wrapper;
            }

            function createPoeticTextElement(item) {
                const wrapper = document.createElement('div'); wrapper.className = 'poetry-wrapper'; wrapper.id = item.id; wrapper.dataset.itemId = item.id;
                const baits = item.text.split('\n').filter(line => line.trim() !== '');
                baits.forEach((baitText, index) => {
                    const baitContainer = document.createElement('div'); baitContainer.className = 'poetry-bait';
                    const baitContent = document.createElement('div'); baitContent.className = 'poetry-bait-content';
                    const [shatr1Text, shatr2Text = ''] = baitText.split('|').map(s => s.trim());
                    const shatr1 = document.createElement('div'); shatr1.className = 'poetry-shatr'; shatr1.setAttribute('contenteditable', 'true');
                    shatr1.dataset.useKashida = item.useKashida; shatr1.textContent = shatr1Text;
                    const shatr2 = document.createElement('div'); shatr2.className = 'poetry-shatr'; shatr2.setAttribute('contenteditable', 'true');
                    shatr2.dataset.useKashida = item.useKashida; shatr2.textContent = shatr2Text;
                    [shatr1, shatr2].forEach(shatr => { shatr.addEventListener('blur', () => handlePoetryEdit(item.id)); shatr.addEventListener("mouseup", showFormatToolbar); });
                    baitContent.appendChild(shatr1); baitContent.appendChild(shatr2);
                    const baitNumber = document.createElement('span'); baitNumber.className = 'poetry-bait-number'; baitNumber.textContent = `(${index + 1})`;
                    baitContainer.appendChild(baitNumber); baitContainer.appendChild(baitContent); wrapper.appendChild(baitContainer);
                }); return wrapper;
            }
            
            function handleHeaderFooterEdit(e) {
                const box = e.target;
                const type = box.dataset.hfType; // 'header' or 'footer'
                const index = parseInt(box.dataset.hfIndex, 10);
                const newText = box.textContent;
                headerFooterState[type].items[index].text = newText;
                document.querySelectorAll(`.${'page-' + type} [data-hf-index='${index}']`).forEach(el => {
                    if (el !== box) el.textContent = newText;
                });
                recordState("Edit Header/Footer Text");
            }
            
            function addNewPage() {
                const page = document.createElement("div"); page.className = "page";
                const header = document.createElement('div'); header.className = 'page-header';
                headerFooterState.header.items.forEach((item, index) => {
                    const box = document.createElement('div'); box.className = 'header-box'; box.textContent = item.text;
                    box.contentEditable = true; box.dataset.hfType = 'header'; box.dataset.hfIndex = index;
                    box.addEventListener('blur', handleHeaderFooterEdit); header.appendChild(box);
                });
                page.appendChild(header);
                
                const footer = document.createElement('div'); footer.className = 'page-footer';
                headerFooterState.footer.items.forEach((item, index) => {
                    const box = document.createElement('div'); box.className = 'footer-box'; box.textContent = item.text;
                    box.contentEditable = true; box.dataset.hfType = 'footer'; box.dataset.hfIndex = index;
                    box.addEventListener('blur', handleHeaderFooterEdit); footer.appendChild(box);
                });
                page.appendChild(footer);

                const pageNumDiv = document.createElement('div'); pageNumDiv.className = 'page-number';
                page.appendChild(pageNumDiv);
                pagesContainer.appendChild(page);
                return page;
            }

            function updatePageNumbers() { document.querySelectorAll(".page").forEach((page, index) => { const footer = page.querySelector(".page-number"); if (footer) footer.textContent = index + startPageNumber; }); }
            
            function addNewQuestion() { 
                const newQ = { 
                    elementType: 'question', 
                    id: `item-${Date.now()}`, 
                    question: "أضف نص السؤال هنا...", 
                    answers: { a: "إجابة أ", b: "إجابة ب", c: "إجابة ج", d: "إجابة د" }, 
                    statement: newQuestionDefaults.includeStatement ? "أضف العبارة التمهيدية هنا..." : null,
                    image: null, 
                    layoutType: newQuestionDefaults.defaultLayout,
                    restartNumbering: false 
                };
                pageContent.push(newQ);
                recordState("Add New Question");
                renderAll();
            }

            function addNewEssayQuestion() { 
                const newQ = { 
                    elementType: 'essayQuestion', 
                    id: `item-${Date.now()}`, 
                    question: "أضف نص السؤال المقالي هنا...", 
                    lines: 2, 
                    statement: newQuestionDefaults.includeStatement ? "أضف العبارة التمهيدية هنا..." : null, 
                    image: null, 
                    restartNumbering: false 
                };
                pageContent.push(newQ);
                recordState("Add Essay Question");
                renderAll();
            }

            function addQuestionHeader() { const newHeader = { elementType: 'questionHeader', id: `item-${Date.now()}`, text: 'أضف رأس الأسئلة هنا (مثال: اختر الإجابة الصحيحة)', restartNumbering: false }; pageContent.push(newHeader); recordState("Add Question Header"); renderAll(); }
            
            function toggleHeaderVisibility(event) {
                headerFooterState.header.visible = event.target.checked;
                document.body.classList.toggle('header-hidden', !headerFooterState.header.visible);
                recordState("Toggle Header Visibility");
            }
            function toggleFooterVisibility(event) {
                headerFooterState.footer.visible = event.target.checked;
                document.body.classList.toggle('footer-hidden', !headerFooterState.footer.visible);
                recordState("Toggle Footer Visibility");
            }

            function showReadingPassagePrompt() { passagePromptOverlay.classList.remove('hidden'); document.getElementById('passage-prompt-text').value = ''; document.getElementById('passage-prompt-q-count').value = '1'; document.getElementById('passage-prompt-text').focus(); }
            function showPoetryPrompt() { poetryPromptOverlay.classList.remove('hidden'); document.getElementById('poetry-prompt-text').value = ''; document.getElementById('poetry-prompt-q-count').value = '1'; document.getElementById('poetry-prompt-kashida-toggle').checked = true; document.getElementById('poetry-prompt-text').focus(); }

            let tempWatermarkImageData = null;

            function setupWatermarkPromptListeners() {
                const okBtn = document.getElementById('watermark-prompt-ok');
                const cancelBtn = document.getElementById('watermark-prompt-cancel');
                const removeBtn = document.getElementById('watermark-prompt-remove');
                const radioBtns = document.querySelectorAll('input[name="watermark-type"]');
                const imageUploadBtn = document.getElementById('watermark-image-upload-btn');
                const imageInput = document.getElementById('watermark-image-input');
                const opacitySlider = document.getElementById('watermark-opacity');
                const rotationSlider = document.getElementById('watermark-rotation');
                const sizeSlider = document.getElementById('watermark-size');

                radioBtns.forEach(radio => radio.addEventListener('change', (e) => updateWatermarkSizeSliderUI(e.target.value)));

                imageUploadBtn.addEventListener('click', () => imageInput.click());
                imageInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            tempWatermarkImageData = event.target.result;
                            document.getElementById('watermark-image-name').textContent = file.name;
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                sizeSlider.addEventListener('input', () => updateSliderValueDisplay(sizeSlider, sizeSlider.dataset.unit));
                opacitySlider.addEventListener('input', () => updateSliderValueDisplay(opacitySlider, ''));
                rotationSlider.addEventListener('input', () => updateSliderValueDisplay(rotationSlider, '°'));
                
                okBtn.addEventListener('click', handleWatermarkApply);
                removeBtn.addEventListener('click', handleWatermarkRemove);
                cancelBtn.addEventListener('click', () => watermarkPromptOverlay.classList.add('hidden'));
            }
            
            function updateWatermarkSizeSliderUI(type) {
                document.getElementById('watermark-text-control').classList.toggle('hidden', type !== 'text');
                document.getElementById('watermark-image-control').classList.toggle('hidden', type === 'text');

                const sizeSlider = document.getElementById('watermark-size');
                const sizeLabel = document.getElementById('watermark-size-label');

                if (type === 'text') {
                    sizeLabel.textContent = 'حجم الخط';
                    sizeSlider.min = 20;
                    sizeSlider.max = 200;
                    sizeSlider.step = 2;
                    sizeSlider.dataset.unit = 'px';
                } else { 
                    sizeLabel.textContent = 'حجم الصورة (%)';
                    sizeSlider.min = 10;
                    sizeSlider.max = 100;
                    sizeSlider.step = 1;
                    sizeSlider.dataset.unit = '%';
                }
                if(parseFloat(sizeSlider.value) > parseFloat(sizeSlider.max)) sizeSlider.value = sizeSlider.max;
                if(parseFloat(sizeSlider.value) < parseFloat(sizeSlider.min)) sizeSlider.value = sizeSlider.min;
                updateSliderValueDisplay(sizeSlider, sizeSlider.dataset.unit);
            }

            function showWatermarkPrompt() {
                tempWatermarkImageData = watermarkState.imageData;
                
                document.getElementById('watermark-opacity').value = watermarkState.opacity;
                document.getElementById('watermark-rotation').value = watermarkState.rotation;
                document.getElementById('watermark-size').value = watermarkState.size;
                updateSliderValueDisplay(document.getElementById('watermark-opacity'), '');
                updateSliderValueDisplay(document.getElementById('watermark-rotation'), '°');

                const currentType = watermarkState.visible ? watermarkState.type : 'text';
                document.querySelector(`input[name="watermark-type"][value="${currentType}"]`).checked = true;
                
                if (currentType === 'image') {
                    document.getElementById('watermark-text-input').value = '';
                    document.getElementById('watermark-image-name').textContent = watermarkState.imageName || 'لم يتم اختيار صورة';
                } else {
                    document.getElementById('watermark-text-input').value = watermarkState.visible ? watermarkState.content : '';
                    document.getElementById('watermark-image-name').textContent = 'لم يتم اختيار صورة';
                }
                
                updateWatermarkSizeSliderUI(currentType); 
                watermarkPromptOverlay.classList.remove('hidden');
            }

            function handleWatermarkApply() {
                const type = document.querySelector('input[name="watermark-type"]:checked').value;
                const text = document.getElementById('watermark-text-input').value;
                
                if (type === 'text' && !text.trim()) { alert('الرجاء إدخال نص للعلامة المائية.'); return; }
                if (type === 'image' && !tempWatermarkImageData) { alert('الرجاء اختيار صورة للعلامة المائية.'); return; }

                watermarkState.type = type;
                watermarkState.opacity = document.getElementById('watermark-opacity').value;
                watermarkState.rotation = document.getElementById('watermark-rotation').value;
                watermarkState.size = document.getElementById('watermark-size').value;
                watermarkState.visible = true;

                if (type === 'text') {
                    watermarkState.content = text;
                    watermarkState.imageData = null;
                    watermarkState.imageName = '';
                } else {
                    watermarkState.imageData = tempWatermarkImageData;
                    watermarkState.content = tempWatermarkImageData; 
                    watermarkState.imageName = document.getElementById('watermark-image-name').textContent;
                }

                watermarkPromptOverlay.classList.add('hidden');
                updateAllWatermarks();
                recordState('Apply Watermark');
            }

            function handleWatermarkRemove() {
                 watermarkState = { type: 'text', content: '', opacity: 0.25, rotation: 0, size: 80, visible: false, imageName: '', imageData: null };
                watermarkPromptOverlay.classList.add('hidden');
                updateAllWatermarks();
                recordState('Remove Watermark');
            }

            function updateAllWatermarks() {
                document.querySelectorAll('.page-watermark').forEach(wm => wm.remove());
                if (!watermarkState.visible || !watermarkState.content) return;
                
                document.querySelectorAll('.page').forEach(page => {
                    const watermarkContainer = document.createElement('div');
                    watermarkContainer.className = 'page-watermark';

                    const contentWrapper = document.createElement('div');
                    contentWrapper.className = 'watermark-content-wrapper';
                    contentWrapper.style.opacity = watermarkState.opacity;
                    contentWrapper.style.transform = `rotate(${watermarkState.rotation}deg)`;

                    let contentElement;
                    if (watermarkState.type === 'text') {
                        contentElement = document.createElement('div');
                        contentElement.className = 'watermark-content';
                        contentElement.textContent = watermarkState.content;
                        contentElement.style.fontSize = `${watermarkState.size}px`;
                    } else if (watermarkState.type === 'image' && watermarkState.imageData) {
                        contentElement = document.createElement('img');
                        contentElement.className = 'watermark-content is-image';
                        contentElement.src = watermarkState.imageData;
                        contentElement.style.maxWidth = `${watermarkState.size}%`;
                        contentElement.style.maxHeight = `${watermarkState.size}%`;
                    }

                    if (contentElement) {
                        contentWrapper.appendChild(contentElement);
                        watermarkContainer.appendChild(contentWrapper);
                        page.prepend(watermarkContainer);
                    }
                });
            }

            function addReadingPassage(text, qCount) {
                const passageId = `item-${Date.now()}`; const formattedText = `<p>${text.replace(/\n/g, '</p><p>')}</p>`;
                const newPassage = { elementType: 'readingPassage', id: passageId, text: formattedText, restartNumbering: 1 }; pageContent.push(newPassage);
                for(let i = 0; i < qCount; i++) { const newQ = { elementType: 'question', id: `item-${Date.now()}-${i}`, passageId: passageId, question: `سؤال ${i+1} على القطعة...`, answers: { a: "إجابة أ", b: "إجابة ب", c: "إجابة ج", d: "إجابة د" }, statement: null, image: null, layoutType: 3, restartNumbering: false }; pageContent.push(newQ); }
                recordState("Add Reading Passage"); renderAll();
            }
            
            function addPoeticText(text, qCount, useKashida) {
                const sanitizedText = text.trim().split('\n').map(line => line.trim().replace(/\s{2,}/, '|')).join('\n');
                const poetryId = `item-${Date.now()}`; const newPoetry = { elementType: 'poeticText', id: poetryId, text: sanitizedText, useKashida: useKashida, restartNumbering: 1 }; pageContent.push(newPoetry);
                for (let i = 0; i < qCount; i++) { const newQ = { elementType: 'question', id: `item-${Date.now()}-${i}`, passageId: poetryId, question: `سؤال ${i + 1} على الأبيات...`, answers: { a: "إجابة أ", b: "إجابة ب", c: "إجابة ج", d: "إجابة د" }, statement: null, image: null, layoutType: 3, restartNumbering: false }; pageContent.push(newQ); }
                recordState("Add Poetic Text"); renderAll();
            }
            
            function handlePoetryEdit(itemId) {
                const item = pageContent.find(q => q.id === itemId); if (!item || item.elementType !== 'poeticText') return;
                const wrapper = document.getElementById(itemId); if (!wrapper) return;
                let fullTextLines = []; wrapper.querySelectorAll('.poetry-bait').forEach(bait => {
                    const shatrs = bait.querySelectorAll('.poetry-shatr'); const kashidaRegex = new RegExp(kashida, 'g');
                    const shatr1Text = shatrs[0] ? shatrs[0].textContent.replace(kashidaRegex, '') : '';
                    const shatr2Text = shatrs[1] ? shatrs[1].textContent.replace(kashidaRegex, '') : '';
                    fullTextLines.push(`${shatr1Text}|${shatr2Text}`);
                }); item.text = fullTextLines.join('\n'); recordState("Poetry Text Edit");
            }

            function handleTextEdit(event, itemId) {
                const element = event.target; const prop = element.dataset.prop; const value = element.innerHTML;
                const item = pageContent.find(q => q.id === itemId); if (!item) return; let obj = item;
                const propPath = prop.split('.'); propPath.forEach((p, i) => { if (i === propPath.length - 1) obj[p] = value; else obj = obj[p]; });
                recordState("Text Edit");
            }
            
            function setupKashidaInfrastructure() {
                canvas = document.createElement('canvas'); ctx = canvas.getContext('2d');
                kashidaObserver = new ResizeObserver(entries => { for (const entry of entries) window.requestAnimationFrame(() => { if (entry.target.isConnected) justifyArabicText(entry.target); }); });
            }
            function isKashidaAllowed(text, charIndex) {
                if (charIndex < 0 || charIndex >= text.length - 1) return false;
                let followingChar = text[charIndex + 1]; if (!followingChar || diacritics.includes(followingChar)) return false;
                let j = charIndex; let basePrecedingChar = text[j]; while(diacritics.includes(basePrecedingChar) && j > 0) { j--; basePrecedingChar = text[j]; }
                if (noKashidaAfter.includes(basePrecedingChar)) return false; if (noKashidaBefore.includes(followingChar)) return false;
                return true;
            }
            function justifyArabicText(element) {
                const kashidaRegex = new RegExp(kashida, 'g'); const originalText = element.textContent.replace(kashidaRegex, '').trim();
                if (!originalText) { element.textContent = ''; return; }
                const style = window.getComputedStyle(element); ctx.font = `${style.getPropertyValue('font-style')} ${style.getPropertyValue('font-weight')} ${style.getPropertyValue('font-size')} ${style.getPropertyValue('font-family')}`;
                let insertionPoints = []; for (let i = 0; i < originalText.length - 1; i++) if (isKashidaAllowed(originalText, i)) insertionPoints.push(i + 1);
                const targetWidth = element.clientWidth - (parseFloat(style.paddingLeft) + parseFloat(style.paddingRight));
                const currentWidth = ctx.measureText(originalText).width; const widthDifference = targetWidth - currentWidth;
                if (widthDifference <= 2 || insertionPoints.length === 0) { element.textContent = originalText; return; }
                const kashidaWidth = ctx.measureText(kashida).width; if (kashidaWidth <= 0.1) { element.textContent = originalText; return; }
                let kashidasToAdd = Math.floor(widthDifference / kashidaWidth); if (kashidasToAdd <= 0) { element.textContent = originalText; return; }
                let textAsArray = originalText.split(''); const numInsertionPoints = insertionPoints.length;
                if (numInsertionPoints > 0) {
                    const baseCount = Math.floor(kashidasToAdd / numInsertionPoints); let extraCount = kashidasToAdd % numInsertionPoints;
                    for (let i = numInsertionPoints - 1; i >= 0; i--) { const index = insertionPoints[i]; let count = baseCount; if (extraCount > 0) { count++; extraCount--; } if(count > 0) textAsArray.splice(index, 0, kashida.repeat(count)); }
                }
                element.textContent = textAsArray.join('');
            }
            
            function deleteItem(itemId) { pageContent = pageContent.filter(q => q.id !== itemId); recordState("Delete Item"); renderAll(); }
            
            function moveItem(itemId, direction) {
                const index = pageContent.findIndex(q => q.id === itemId);
                if (direction === 'up' && index > 0) [pageContent[index], pageContent[index - 1]] = [pageContent[index - 1], pageContent[index]];
                else if (direction === 'down' && index < pageContent.length - 1) [pageContent[index], pageContent[index + 1]] = [pageContent[index + 1], pageContent[index]];
                recordState("Move Item"); renderAll();
            }
            
            function setEssayLines(itemId) { const item = pageContent.find(q => q.id === itemId); if (!item) return; showPrompt("عدد الأسطر", "أدخل عدد الأسطر المطلوبة للإجابة (1-15):", (num) => { let newLines = parseInt(num, 10); if (!isNaN(newLines) && newLines > 0 && newLines <= 15) { item.lines = newLines; recordState("Set Essay Lines"); renderAll(); } }, item.lines || 2, "number"); }
            
            function setupContextMenuListeners() {
                document.getElementById("ctx-delete-header").addEventListener("click", () => { if (currentContextMenuTarget) currentContextMenuTarget.innerHTML = ''; });
                document.getElementById("ctx-set-page-number").addEventListener("click", () => { showPrompt("ترقيم الصفحات", "ادخل رقم الصفحة الذي تريد البدء به:", (num) => { const newStart = parseInt(num, 10); if (!isNaN(newStart) && newStart > 0) { startPageNumber = newStart; recordState("Set Start Page Number"); updatePageNumbers(); } }, startPageNumber, "number"); });
                document.getElementById("ctx-upload-image").addEventListener("click", () => imageUploadInput.click());
                document.getElementById("ctx-add-image-url").addEventListener("click", () => changeImageFromUrl(currentContextMenuTarget.dataset.itemId));
                document.getElementById("ctx-delete-image").addEventListener("click", () => deleteImage(currentContextMenuTarget.dataset.itemId));
                document.getElementById("ctx-add-statement").addEventListener("click", () => changeStatement(currentContextMenuTarget.dataset.itemId));
                document.getElementById("ctx-delete-statement").addEventListener("click", () => deleteStatement(currentContextMenuTarget.dataset.itemId));
                document.querySelectorAll("#ctx-layout-submenu li").forEach(item => item.addEventListener("click", () => changeAnswersLayout(currentContextMenuTarget.dataset.itemId, item.getAttribute("data-layout"))));
                document.getElementById("ctx-set-essay-lines").addEventListener("click", () => setEssayLines(currentContextMenuTarget.dataset.itemId));
                document.getElementById("ctx-set-start-number").addEventListener("click", () => setStartNumber(currentContextMenuTarget.dataset.itemId));
                document.getElementById("ctx-cancel-restart-numbering").addEventListener("click", () => cancelStartNumber(currentContextMenuTarget.dataset.itemId));
                document.getElementById("ctx-move-up").addEventListener("click", () => moveItem(currentContextMenuTarget.dataset.itemId, "up"));
                document.getElementById("ctx-move-down").addEventListener("click", () => moveItem(currentContextMenuTarget.dataset.itemId, "down"));
                document.getElementById("ctx-delete-item").addEventListener("click", () => showConfirm('تأكيد الحذف', 'هل أنت متأكد من حذف هذا العنصر؟', () => deleteItem(currentContextMenuTarget.dataset.itemId)));
                document.getElementById("ctx-toggle-kashida").addEventListener("click", () => { const itemId = currentContextMenuTarget.dataset.itemId; const item = pageContent.find(p => p.id === itemId); if(item) { item.useKashida = !item.useKashida; recordState("Toggle Kashida"); renderAll(); } });
                document.getElementById("ctx-delete-hf-box").addEventListener("click", deleteHeaderFooterBox);
                document.getElementById("ctx-add-hf-box").addEventListener("click", addHeaderFooterBox);
            }

            function handleMainContentContextMenu(e) {
                e.preventDefault();
                const selection = window.getSelection();
                const isTextSelected = selection && !selection.isCollapsed;
                if (isTextSelected) {
                    contextMenu.classList.add('hidden');
                    showFormatToolbar(e);
                } else {
                    textFormatToolbar.classList.add('hidden');
                    const targetElement = e.target.closest('.question-wrapper, .reading-passage-wrapper, .poetry-wrapper, .question-list-header, .page-title, .page-number, .header-box, .footer-box');
                    if (targetElement) {
                        showContextMenu(e, targetElement);
                    } else {
                        contextMenu.classList.add('hidden');
                    }
                }
            }
            
            function hideMenusOnClickOutside(e) {
                if (!textFormatToolbar.contains(e.target)) { textFormatToolbar.classList.add("hidden"); }
                if (!contextMenu.contains(e.target)) { contextMenu.classList.add("hidden"); }
            }

            function showContextMenu(event, element) {
                currentContextMenuTarget = element;
                document.querySelectorAll('#custom-context-menu li[id^="ctx-"]').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('#custom-context-menu hr').forEach(el => el.classList.add('hidden'));

                if (element.classList.contains('header-box') || element.classList.contains('footer-box')) {
                    document.getElementById("ctx-add-hf-box").classList.remove('hidden');
                    const type = element.dataset.hfType;
                    if (headerFooterState[type].items.length > 1) {
                        document.getElementById("ctx-delete-hf-box").classList.remove('hidden');
                    }
                    document.getElementById("ctx-hf-separator").classList.remove('hidden');
                } else if (element.classList.contains('page-title')) {
                    document.getElementById("ctx-delete-header").classList.remove('hidden');
                } else if (element.classList.contains('page-number')) {
                    document.getElementById("ctx-set-page-number").classList.remove('hidden');
                } else { 
                    const itemId = element.dataset.itemId; const item = itemId ? pageContent.find(q => q.id === itemId) : null;
                    if (!item) { contextMenu.classList.add("hidden"); return; }
                    document.getElementById("ctx-move-up").classList.remove('hidden'); document.getElementById("ctx-move-down").classList.remove('hidden');
                    document.getElementById("ctx-delete-item").classList.remove('hidden'); document.getElementById("ctx-separator-3").classList.remove('hidden');
                    const isMcq = item.elementType === 'question'; const isEssay = item.elementType === 'essayQuestion'; const isPoetry = item.elementType === 'poeticText';
                    if (isMcq || isEssay || item.elementType === 'questionHeader' || item.elementType === 'readingPassage' || isPoetry) {
                        document.getElementById("ctx-set-start-number").classList.remove('hidden');
                        if (item.restartNumbering !== false) document.getElementById("ctx-cancel-restart-numbering").classList.remove('hidden');
                        document.getElementById("ctx-separator-2").classList.remove('hidden');
                    }
                    if(isPoetry) document.getElementById("ctx-toggle-kashida").classList.remove('hidden');
                    if (isMcq || isEssay) {
                        document.getElementById("ctx-upload-image").classList.remove('hidden'); document.getElementById("ctx-add-image-url").classList.remove('hidden');
                        document.getElementById("ctx-delete-image").classList.toggle("hidden", !item.image);
                        document.getElementById("ctx-add-statement").classList.remove('hidden');
                        document.getElementById("ctx-delete-statement").classList.toggle("hidden", !item.statement);
                        document.getElementById("ctx-separator-1").classList.remove('hidden');
                    }
                    if (isMcq) document.getElementById("ctx-change-layout").classList.remove('hidden');
                    if (isEssay) document.getElementById("ctx-set-essay-lines").classList.remove('hidden');
                }

                contextMenu.style.top = `${event.pageY}px`; contextMenu.style.left = `${event.pageX}px`;
                contextMenu.classList.remove("hidden");
            }
            
            function deleteHeaderFooterBox() {
                const target = currentContextMenuTarget;
                const type = target.dataset.hfType;
                const index = parseInt(target.dataset.hfIndex, 10);
                if (!type || isNaN(index) || !headerFooterState[type] || headerFooterState[type].items.length <= 1) return;
                
                headerFooterState[type].items.splice(index, 1);
                recordState("Delete Header/Footer Box");
                renderAll();
            }
            
            function addHeaderFooterBox() {
                const target = currentContextMenuTarget;
                const type = target.dataset.hfType;
                if (!type || !headerFooterState[type]) return;
                
                headerFooterState[type].items.push({ text: 'خانة جديدة' });
                recordState("Add Header/Footer Box");
                renderAll();
            }

            function setStartNumber(itemId) { const item = pageContent.find(q => q.id === itemId); if (!item) return; showPrompt("ترقيم مخصص", "أدخل الرقم الذي تريد بدء العد منه لهذا العنصر:", (num) => { const newStart = parseInt(num, 10); if (!isNaN(newStart) && newStart > 0) { item.restartNumbering = newStart; recordState("Set Custom Start Number"); renderAll(); } }, item.restartNumbering || 1, "number"); }
            function cancelStartNumber(itemId) { const item = pageContent.find(q => q.id === itemId); if (item) { item.restartNumbering = false; recordState("Cancel Custom Start Number"); renderAll(); } }
            function changeAnswersLayout(itemId, layoutType) { const question = pageContent.find(q => q.id === itemId); if (question) { question.layoutType = layoutType; recordState("Change Answer Layout"); renderAll(); } }
            function handleImageFileUpload(e) { const file = e.target.files[0]; const itemId = currentContextMenuTarget.dataset.itemId; if (!file || !itemId) return; const reader = new FileReader(); reader.onload = (event) => { const imageUrl = event.target.result; const question = pageContent.find(q => q.id === itemId); if (question) { question.image = imageUrl; recordState("Add Image from Device"); renderAll(); } }; reader.readAsDataURL(file); e.target.value = ''; }
            function deleteImage(itemId) { const question = pageContent.find(q => q.id === itemId); question.image = null; recordState("Delete Image"); renderAll(); }
            function changeStatement(itemId) { const question = pageContent.find(q => q.id === itemId); showPrompt("إضافة/تعديل عبارة", "أدخل نص العبارة:", (text) => { question.statement = text || null; recordState("Change Statement"); renderAll(); }, question.statement || ""); }
            function deleteStatement(itemId) { const question = pageContent.find(q => q.id === itemId); question.statement = null; recordState("Delete Statement"); renderAll(); }
            function changeImageFromUrl(itemId) { const question = pageContent.find(q => q.id === itemId); showPrompt("إضافة/تغيير صورة (رابط)", "الرجاء إدخال رابط الصورة:", (url) => { if (url) { question.image = url; recordState("Change Image from URL"); renderAll(); } }, question.image || ""); }

            function showConfirm(title, text, onOkCallback) { const overlay = customPromptOverlay; const promptTitle = overlay.querySelector("#prompt-title"); const promptText = overlay.querySelector("#prompt-text"); const input = overlay.querySelector("#prompt-input"); const okBtn = overlay.querySelector("#prompt-ok"); const cancelBtn = overlay.querySelector("#prompt-cancel"); overlay.classList.remove("hidden"); promptTitle.textContent = title; promptText.textContent = text; input.classList.add('hidden'); const cleanup = () => { overlay.classList.add("hidden"); input.classList.remove('hidden'); okBtn.replaceWith(okBtn.cloneNode(true)); cancelBtn.replaceWith(cancelBtn.cloneNode(true)); }; document.getElementById("prompt-ok").addEventListener("click", () => { onOkCallback(); cleanup(); }, { once: true }); document.getElementById("prompt-cancel").addEventListener("click", cleanup, { once: true }); }
            function showPrompt(title, text, callback, defaultValue = "", inputType = "text") { const overlay = customPromptOverlay; const promptTitle = overlay.querySelector("#prompt-title"); const promptText = overlay.querySelector("#prompt-text"); const input = overlay.querySelector("#prompt-input"); const okBtn = overlay.querySelector("#prompt-ok"); const cancelBtn = overlay.querySelector("#prompt-cancel"); overlay.classList.remove("hidden"); promptTitle.textContent = title; promptText.textContent = text; input.type = inputType; input.value = defaultValue; input.classList.remove('hidden'); input.focus(); const cleanup = () => { overlay.classList.add("hidden"); okBtn.replaceWith(okBtn.cloneNode(true)); cancelBtn.replaceWith(cancelBtn.cloneNode(true)); }; document.getElementById("prompt-ok").addEventListener("click", () => { callback(input.value); cleanup(); }, { once: true }); document.getElementById("prompt-cancel").addEventListener("click", cleanup, { once: true }); }
            
            function addPickerBoundsListener(pickerInstance) { pickerInstance.on('show', instance => { setTimeout(() => { const pickerApp = instance.getRoot().app; const rect = pickerApp.getBoundingClientRect(); const scrollY = window.scrollY || window.pageYOffset; if (rect.top < 0) pickerApp.style.top = `${scrollY + 5}px`; if (rect.left < 0) pickerApp.style.left = '5px'; else if (rect.right > window.innerWidth) pickerApp.style.left = `${window.innerWidth - rect.width - 5}px`; if (rect.bottom > window.innerHeight) pickerApp.style.top = `${scrollY + window.innerHeight - rect.height - 5}px`; }, 0); }); }
            
            function updateSliderValueDisplay(sliderElement, unit = 'px') {
                 const valueSpan = sliderElement.previousElementSibling.querySelector('.slider-value');
                 if (valueSpan) {
                    if (sliderElement.id === 'watermark-opacity') {
                        valueSpan.textContent = parseFloat(sliderElement.value).toFixed(2);
                    } else {
                        valueSpan.textContent = `${sliderElement.value}${unit}`;
                    }
                 }
            }

            // NEW: Iterates through all editable content and applies an update function to its HTML
            function updateHtmlInPageContent(updaterFunction) {
                pageContent.forEach(item => {
                    // Properties that can contain user-generated HTML
                    const propsToCheck = ['question', 'answers.a', 'answers.b', 'answers.c', 'answers.d', 'statement', 'text'];

                    propsToCheck.forEach(prop => {
                        const path = prop.split('.');
                        let targetObject = item;
                        let value = null;
                        let exists = true;

                        for (let i = 0; i < path.length; i++) {
                            if (targetObject && typeof targetObject === 'object' && path[i] in targetObject) {
                                if (i === path.length - 1) {
                                    value = targetObject[path[i]];
                                } else {
                                    targetObject = targetObject[path[i]];
                                }
                            } else {
                                exists = false;
                                break;
                            }
                        }

                        if (exists && typeof value === 'string' && value.includes('<')) {
                            const newValue = updaterFunction(value);

                            // Re-navigate to set the property
                            let setterObject = item;
                            for (let i = 0; i < path.length - 1; i++) {
                                setterObject = setterObject[path[i]];
                            }
                            setterObject[path[path.length - 1]] = newValue;
                        }
                    });
                });
            }
            
            function setupStyleControls() {
                const root = document.documentElement;
                const sliderControls = [ {id:"title-fs",prop:"--title-fs",unit:"px"}, {id:"q-header-fs",prop:"--q-header-fs",unit:"px"}, {id:"passage-text-fs",prop:"--passage-text-fs",unit:"px"}, {id:"poetry-text-fs",prop:"--poetry-text-fs",unit:"px"}, {id:"poetry-num-fs",prop:"--poetry-num-fs",unit:"px"}, {id:"question-num-fs",prop:"--question-num-fs",unit:"px"}, {id:"question-text-fs",prop:"--question-text-fs",unit:"px"}, {id:"statement-fs",prop:"--statement-fs",unit:"px"}, {id:"answer-head-fs",prop:"--answer-head-fs",unit:"px"}, {id:"answer-text-fs",prop:"--answer-text-fs",unit:"px"}, {id:"page-num-fs",prop:"--page-num-fs",unit:"px"},  {id:"header-text-fs",prop:"--header-text-fs",unit:"px"}, {id:"footer-text-fs",prop:"--footer-text-fs",unit:"px"}, {id:"page-num-circle-size", prop:"--page-num-circle-size", unit:"px"}, {id:"answer-head-circle-size", prop:"--answer-head-circle-size", unit:"px"} ];
                sliderControls.forEach(control => {
                    const slider = document.getElementById(control.id);
                    slider.addEventListener("input",() => { root.style.setProperty(control.prop,`${slider.value}${control.unit}`); updateSliderValueDisplay(slider, control.unit); });
                    slider.addEventListener("change",() => { recordState("Style Change"); renderAll(); });
                    updateSliderValueDisplay(slider, control.unit);
                });
                const colorControls = [
                    { id: "page-header-bg", prop: "--page-header-bg", default: "#f8f9fa" },
                    { id: "header-item-bg", prop: "--header-item-bg", default: "#ffffff" },
                    { id: "page-footer-bg", prop: "--page-footer-bg", default: "#f8f9fa" },
                    { id: "footer-item-bg", prop: "--footer-item-bg", default: "#ffffff" },
                    { id: "page-title-text-color", prop: "--page-title-text-color", default: "#333333" },
                    { id: "page-title-bg-color", prop: "--page-title-bg-color", default: "#ffffff" },
                    { id: "page-title-border-color", prop: "--page-title-border-color", default: "#ced4da" },
                    { id: "poetry-text-color", prop: "--poetry-text-color", default: "#333333" },
                    { id: "poetry-num-color", prop: "--poetry-num-color", default: "#888888" },
                    { id: "question-text-color", prop: "--question-text-color", default: "#212529" },
                    { id: "question-num-color", prop: "--question-num-color", default: "#ffffff" },
                    { id: "question-num-bg", prop: "--question-num-bg", default: "#007bff" },
                    { id: "statement-text-color", prop: "--statement-text-color", default: "#555555" },
                    { id: "statement-bg-color", prop: "--statement-bg-color", default: "#f1f3f5" },
                    { id: "answer-head-color", prop: "--answer-head-color", default: "#495057" },
                    { id: "answer-head-bg", prop: "--answer-head-bg", default: "#e9ecef" },
                    { id: "answer-text-color", prop: "--answer-text-color", default: "#343a40" },
                    { id: "question-border-color", prop: "--question-border-color", default: "#ced4da" },
                    { id: "page-num-color", prop: "--page-num-color", default: "#333333" },
                    { id: "page-num-bg-color", prop: "--page-num-bg-color", default: "#cccccc" }
                ];
                colorControls.forEach(control => {
                    const pickr = Pickr.create({
                        el: `#${control.id}`,
                        theme: "classic",
                        default: control.default,
                        swatches: colorSwatches,
                        components: {
                            preview: true,
                            opacity: true,
                            hue: true,
                            interaction: { input: true, clear: true, save: true }
                        }
                    });
                    pickr.on("save", color => {
                        root.style.setProperty(control.prop, color.toRGBA().toString());
                        recordState("Color Change");
                        pickr.hide();
                    });
                    addPickerBoundsListener(pickr);
                });
                const pickerConfig = {
                    theme: 'classic', swatches: colorSwatches,
                    components: { preview: true, opacity: true, hue: true, interaction: { input: true, clear: true, save: true } }
                };
                highlightColorPicker = Pickr.create({ ...pickerConfig, el: '#sidebar-highlight-color-picker', default: '#ffff00' });
                underlineColorPicker = Pickr.create({ ...pickerConfig, el: '#sidebar-underline-color-picker', default: '#ff0000' });
                
                addPickerBoundsListener(highlightColorPicker);
                addPickerBoundsListener(underlineColorPicker);

                highlightColorPicker.on('save', (color, instance) => {
                    if (color) {
                        const newColor = color.toRGBA().toString();
                        const updater = (htmlString) => {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = htmlString;
                            const elements = tempDiv.querySelectorAll('font[style*="background-color"], span[style*="background-color"]');
                            elements.forEach(el => el.style.backgroundColor = newColor);
                            return tempDiv.innerHTML;
                        };
                        updateHtmlInPageContent(updater);
                        recordState("Update All Highlight Colors");
                        renderAll();
                    }
                    instance.hide();
                });
                underlineColorPicker.on('save', (color, instance) => {
                    if (color) {
                        const newColor = color.toRGBA().toString();
                        const updater = (htmlString) => {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = htmlString;
                            const elements = tempDiv.querySelectorAll('u');
                            elements.forEach(el => {
                                // Only update color, preserve other text-decoration properties if they exist
                                el.style.textDecorationColor = newColor;
                             });
                            return tempDiv.innerHTML;
                        };
                        updateHtmlInPageContent(updater);
                        recordState("Update All Underline Colors");
                        renderAll();
                    }
                    instance.hide();
                });
            }

            function setupTextFormatToolbar() {
                document.getElementById("highlight-btn").addEventListener("mousedown", e => {
                    e.preventDefault();
                    if (!window.getSelection().rangeCount) return;

                    const editable = window.getSelection().anchorNode.parentElement.closest('[contenteditable]');
                    let isHighlighted = false;

                    try {
                        const currentColor = document.queryCommandValue('backColor');
                        if (currentColor && currentColor !== 'transparent' && currentColor !== 'rgba(0, 0, 0, 0)' && currentColor.toLowerCase() !== '#ffffff' && currentColor.toLowerCase() !== 'rgb(255, 255, 255)') {
                            isHighlighted = true;
                        }
                    } catch (ex) {
                        console.error("queryCommandValue for backColor failed", ex);
                    }
                    
                    if (isHighlighted) {
                        document.execCommand("backColor", false, "transparent");
                    } else {
                        document.execCommand("backColor", false, highlightColorPicker.getColor().toRGBA().toString());
                    }

                    if (editable) {
                        editable.blur();
                        editable.focus();
                    }
                });

                document.getElementById("underline-btn").addEventListener("mousedown", e => {
                    e.preventDefault();
                    const selection = window.getSelection();
                    if (!selection.rangeCount) return;
                    
                    const isCurrentlyUnderlined = document.queryCommandState('underline');
                    
                    document.execCommand("underline", false, null);

                    if (!isCurrentlyUnderlined) {
                        // If it wasn't underlined, we just added it. Let's try to color it.
                        const parentEl = selection.anchorNode.parentElement;
                        const uTag = parentEl.closest('u');
                        if (uTag) {
                           uTag.style.textDecorationColor = underlineColorPicker.getColor().toRGBA().toString();
                           uTag.style.textDecorationThickness = '2px';
                        }
                    }

                    const editable = selection.anchorNode.parentElement.closest("[contenteditable]");
                    if (editable) {
                        editable.blur();
                        editable.focus();
                    }
                });

                document.querySelectorAll("[data-align]").forEach(button => { button.addEventListener("mousedown", e => { e.preventDefault(); document.execCommand(button.dataset.align, false, null); updateToolbarActiveStates(); }); });
            }


            function updateToolbarActiveStates() {
                document.querySelectorAll("[data-align]").forEach(button => { button.classList.toggle("active", document.queryCommandState(button.dataset.align)); });
            }

            function showFormatToolbar(event) {
                const selection = window.getSelection();
                if (!selection.rangeCount || selection.isCollapsed) {
                    textFormatToolbar.classList.add("hidden"); return;
                }
                const range = selection.getRangeAt(0).getBoundingClientRect();
                textFormatToolbar.style.top = `${range.top - textFormatToolbar.offsetHeight - 5 + window.scrollY}px`;
                textFormatToolbar.style.left = `${range.left + range.width / 2 - textFormatToolbar.offsetWidth / 2 + window.scrollX}px`;
                textFormatToolbar.classList.remove("hidden");
                updateToolbarActiveStates();
            }


            function recordState(action) {
                const state = { 
                    data: JSON.parse(JSON.stringify(pageContent)), 
                    headerFooter: JSON.parse(JSON.stringify(headerFooterState)),
                    watermark: JSON.parse(JSON.stringify(watermarkState)),
                    defaults: JSON.parse(JSON.stringify(newQuestionDefaults)),
                    styles: getCssVariablesState(), pageNumber: startPageNumber, action: action 
                };
                history.push(state); redoStack = []; updateUndoRedoButtons();
            }

            function getCssVariablesState() {
                const rootStyles = getComputedStyle(document.documentElement); const styles = {};
                const propsToSave = [ "--page-header-bg", "--header-item-bg", "--page-footer-bg", "--footer-item-bg", "--title-fs","--q-header-fs","--passage-text-fs", "--poetry-text-fs", "--poetry-num-fs","--question-num-fs","--question-text-fs","--statement-fs","--answer-head-fs","--answer-text-fs","--page-num-fs", "--header-text-fs", "--footer-text-fs", "--question-text-color", "--poetry-text-color", "--poetry-num-color","--question-num-color","--question-num-bg","--statement-text-color","--statement-bg-color","--answer-head-color","--answer-head-bg","--answer-text-color","--question-border-color","--page-num-color", "--page-num-bg-color", "--page-num-circle-size", "--page-title-text-color", "--page-title-bg-color", "--page-title-border-color", "--answer-head-circle-size" ];
                propsToSave.forEach(prop => { styles[prop] = rootStyles.getPropertyValue(prop).trim(); });
                return styles;
            }
            
            function applyState(state) {
                pageContent = JSON.parse(JSON.stringify(state.data));
                headerFooterState = JSON.parse(JSON.stringify(state.headerFooter));
                watermarkState = { ...{ type: 'text', content: '', opacity: 0.25, rotation: 0, size: 80, visible: false, imageName: '', imageData: null }, ...JSON.parse(JSON.stringify(state.watermark || {})) };
                newQuestionDefaults = { ...{ includeStatement: false, defaultLayout: '3' }, ...JSON.parse(JSON.stringify(state.defaults || {})) };
                startPageNumber = state.pageNumber || 1;
                const root = document.documentElement;
                for (const prop in state.styles) root.style.setProperty(prop, state.styles[prop]);
                
                toggleHeaderCheckbox.checked = headerFooterState.header.visible;
                document.body.classList.toggle('header-hidden', !headerFooterState.header.visible);
                toggleFooterCheckbox.checked = headerFooterState.footer.visible;
                document.body.classList.toggle('footer-hidden', !headerFooterState.footer.visible);
                
                updateSidebarControls(state.styles);
                renderAll();
            }

            function updateSidebarControls(styles) {
                document.querySelectorAll('.pcr-app').forEach(app => app.remove());
                setupStyleControls(); 
                document.querySelectorAll('.slider-control input[type=range]').forEach(slider => {
                     if (!slider.id.startsWith('watermark-')) {
                        const styleProp = `--${slider.id}`;
                        if(styles[styleProp]) slider.value = parseInt(styles[styleProp]);
                        updateSliderValueDisplay(slider, 'px');
                     }
                });
            }

            function undo() { if (history.length > 1) { redoStack.push(history.pop()); applyState(history[history.length - 1]); updateUndoRedoButtons(); } }
            function redo() { if (redoStack.length > 0) { history.push(redoStack.pop()); applyState(history[history.length - 1]); updateUndoRedoButtons(); } }
            function updateUndoRedoButtons() { undoBtn.disabled = history.length <= 1; redoBtn.disabled = redoStack.length === 0; }
            
            async function saveAsPDF() {
                loader.classList.remove('hidden'); contextMenu.classList.add('hidden'); textFormatToolbar.classList.add('hidden');
                
                const originalZoom = currentZoomLevel;
                applyZoom(1.0);

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4'); 
                const pages = document.querySelectorAll('.page');
                const pdfWidth = pdf.internal.pageSize.getWidth(); 
                const pdfHeight = pdf.internal.pageSize.getHeight();
                try {
                    for (let i = 0; i < pages.length; i++) {
                        const page = pages[i];
                        loaderText.textContent = `جاري معالجة صفحة ${i + 1} من ${pages.length}...`;
                        if (document.activeElement) document.activeElement.blur();
                        const canvas = await html2canvas(page, { scale: 2, useCORS: true, logging: false });
                        const imgData = canvas.toDataURL('image/jpeg', 0.98);
                        if (i > 0) pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                    }
                    loaderText.textContent = 'جاري حفظ الملف...'; pdf.save('ورقة_الأسئلة.pdf');
                } catch (error) { 
                    console.error("Failed to generate PDF:", error); 
                    alert("عذرًا، حدث خطأ أثناء إنشاء ملف PDF.");
                } finally { 
                    applyZoom(originalZoom);
                    loader.classList.add('hidden'); 
                    loaderText.textContent = 'جاري تحويل الصفحات إلى صور...'; 
                }
            }
            
            initialize();
        });
    </script>
</body>
</html>
```