<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ورقة</title>
    <link rel="icon" href="assets/logo.png" type="image/x-icon">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400;1,700&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Tajawal';
            src: url('fonts/Tajawal-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
    </style>
    <!-- Font Awesome (for icons) -->
    <link rel="stylesheet" href="libraries/fontawesome-free-7.0.0-web/css/all.min.css">

    <!-- Pickr (Color Picker) CDN -->
    <link rel="stylesheet" href="libraries/pickr.nano.min.css"/>
    <script src="libraries/pickr.min.js"></script>
    
    <!-- Embedded CSS -->
    <style id="dynamic-text-styles">
        .text-highlight {
            background-color: var(--highlight-color, rgb(141, 186, 212));
        }
    </style>
    <style>
        /* Font Face Declarations */
        @font-face {
            font-family: 'Amiri';
            src: url('fonts/Amiri-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Scheherazade';
            src: url('fonts/ScheherazadeRegOT.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Tajawal';
            src: url('fonts/Tajawal-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        /* Additional Arabic Fonts */
        @font-face {
            font-family: 'Alfarooq';
            src: url('fonts/Alfarooq.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Arbaeen';
            src: url('fonts/Arbaeen.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Castile';
            src: url('fonts/Castile.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Castile';
            src: url('fonts/Castile-Bold.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }

        @font-face {
            font-family: 'Castile';
            src: url('fonts/Castile-Thin.otf') format('opentype');
            font-weight: 300;
            font-style: normal;
        }

        @font-face {
            font-family: 'Droid Arabic Kufi';
            src: url('fonts/Droid.Arabic.Kufi_DownloadSoftware.iR_.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Droid Arabic Kufi';
            src: url('fonts/Droid.Arabic.Kufi_.Bold_DownloadSoftware.iR_.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }

        @font-face {
            font-family: 'Droid Arabic Naskh';
            src: url('fonts/Droid.Arabic.Naskh_.Regular_DownloadSoftware.iR_.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Droid Arabic Naskh';
            src: url('fonts/Droid.Arabic.Naskh_.Bold_DownloadSoftware.iR_.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }

        @font-face {
            font-family: 'HS Al Basim A';
            src: url('fonts/HS-Al-Basim-A.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'HS Al Basim B';
            src: url('fonts/HS-Al-Basim-B.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Hasan Alquds Unicode';
            src: url('fonts/Hasan-Alquds-Unicode.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Hasan Alquds Unicode';
            src: url('fonts/Hasan-Alquds-Unicode-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }

        @font-face {
            font-family: 'Hasan Alquds Unicode';
            src: url('fonts/Hasan-Alquds-Unicode-ExtraBold.ttf') format('truetype');
            font-weight: 800;
            font-style: normal;
        }

        @font-face {
            font-family: 'Hasan Alquds Unicode';
            src: url('fonts/Hasan-Alquds-Unicode-Light.ttf') format('truetype');
            font-weight: 300;
            font-style: normal;
        }

        @font-face {
            font-family: 'Hasan Alquds Unicode';
            src: url('fonts/Hasan-Alquds-Unicode-Medium.ttf') format('truetype');
            font-weight: 500;
            font-style: normal;
        }

        @font-face {
            font-family: 'Hasan Hiba';
            src: url('fonts/Hasan_Hiba.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Nusaibah';
            src: url('fonts/Nusaibah-Regular.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Nusaibah';
            src: url('fonts/Nusaibah-Bold.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }

        @font-face {
            font-family: 'Samman';
            src: url('fonts/Samman.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Sonbili';
            src: url('fonts/Sonbili_DownloadSoftware.iR_.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Abdo Logo';
            src: url('fonts/Abdo.Fonts_Abdo.Logo_.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --font-main: 'Tajawal', sans-serif;
            --font-statement: 'Scheherazade New', serif;
            --primary-color: #2980b9;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --sidebar-bg: #ffffff;
            --page-bg: #ffffff;
            --text-color: #333;
            --border-color: #dee2e6;
            --shadow-color: rgba(0,0,0,0.1);
            --highlight-color: #ffff00;
            
            --question-text-color: #212529;
            --question-num-color: #ffffff;
            --question-num-bg: #007bff;
            --statement-text-color: #555;
            --statement-bg-color: #f1f3f5;
            --answer-head-color: #495057;
            --answer-head-bg: #e9ecef;
            --answer-text-color: #343a40;
            --question-border-color: #ced4da;
            --page-num-color: #333;
            --page-num-bg-color: #cccccc;
            --page-title-text-color: #333;
            --page-title-bg-color: #ffffff;
            --page-title-border-color: #ced4da;
            --poetry-text-color: #333333; 
            --poetry-num-color: #888888; 
            --passage-line-num-color: #666666;
            --passage-line-num-fs: 12px; 

            /* Header/Footer Colors */
            --page-header-bg: #f8f9fa;
            --page-footer-bg: #f8f9fa;
            --header-item-bg: #ffffff;
            --footer-item-bg: #ffffff;
            --header-item-text-color: #333;
            --header-logo-height: 25px;

            --title-fs: 32px;
            --q-header-fs: 18px; 
            --passage-text-fs: 16px;
            --poetry-text-fs: 20px; 
            --poetry-num-fs: 14px; 
            --question-num-fs: 18px;
            --question-text-fs: 18px;
            --statement-fs: 20px;
            --answer-head-fs: 16px;
            --answer-text-fs: 16px;
            --page-num-fs: 12px;
            --header-text-fs: 14px;
            --footer-text-fs: 12px;
            --page-num-circle-size: 30px;
            --answer-head-circle-size: 28px;

            /* Page Border */
            --page-border-color: #333333;
            --page-border-width: 2px;
            --page-border-radius: 0px;
            --page-border-style: solid;
            --border-box-bg: #ffffff;
            --border-box-text-color: #333333;
            --page-border-top-style: solid;
            --page-border-right-style: solid;
            --page-border-bottom-style: solid;
            --page-border-left-style: solid;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html:fullscreen {
            background: var(--background-color);
        }
        body {
            font-family: var(--font-main);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        .hidden {
            display: none !important;
            visibility: hidden !important;
        }
        body.header-hidden .page-header { display: none !important; }
        body.footer-hidden .page-footer { display: none !important; }
        body.border-active .page-header { display: none !important; }
        body.border-active .page-footer { display: none !important; }
        body.page-number-hidden .page-number { display: none !important; }
        
        #editor-action-buttons {
            position: fixed;
            top: 15px;
            right: 335px; /* sidebar width (320) + 15 padding */
            z-index: 101; /* Above sidebar but below its content if needed */
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        body.sidebar-collapsed #editor-action-buttons {
            right: 15px;
        }
        body.layout-sidebar-open #editor-action-buttons {
            right: 655px; /* main sidebar (320) + layout sidebar (320) + 15 padding */
        }
        body.sidebar-collapsed.layout-sidebar-open #editor-action-buttons {
            right: 335px; /* layout sidebar (320) + 15 padding */
        }
        body.colors-sidebar-open #editor-action-buttons {
            right: 655px; /* main sidebar (320) + colors sidebar (320) + 15 padding */
        }
        body.sidebar-collapsed.colors-sidebar-open #editor-action-buttons {
            right: 335px; /* colors sidebar (320) + 15 padding */
        }
        body.sizes-sidebar-open #editor-action-buttons {
            right: 655px; /* main sidebar (320) + sizes sidebar (320) + 15 padding */
        }
        body.sidebar-collapsed.sizes-sidebar-open #editor-action-buttons {
            right: 335px; /* sizes sidebar (320) + 15 padding */
        }
        .editor-control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #fff;
            color: var(--primary-color);
            border: 1px solid var(--border-color);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: all .2s ease-in-out;
        }
        .editor-control-btn:hover {
            background-color: #f1f3f5;
            transform: scale(1.1);
        }
        .editor-control-btn.active {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }
        .editor-control-btn.active:hover {
            background-color: #1e6a96;
            transform: scale(1.1);
        }

        #editor-screen {
            display: flex;
        }
        #sidebar {
            width: 320px;
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            height: 100vh;
            position: fixed;
            top: 0;
            right: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
            transition: margin-right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        body.sidebar-collapsed #sidebar {
            margin-right: -320px;
        }
        
        #layout-sidebar {
            width: 320px;
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            height: 100vh;
            position: fixed;
            top: 0;
            right: 320px;
            z-index: 99;
            display: flex;
            flex-direction: column;
            transition: margin-right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1), right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            margin-right: -320px;
        }
        
        body.layout-sidebar-open #layout-sidebar {
            margin-right: 0;
        }
        
        body.sidebar-collapsed #layout-sidebar {
            right: 0;
        }
        
        #colors-sidebar {
            width: 320px;
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            height: 100vh;
            position: fixed;
            top: 0;
            right: 320px;
            z-index: 98;
            display: flex;
            flex-direction: column;
            transition: margin-right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1), right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            margin-right: -320px;
        }
        
        body.colors-sidebar-open #colors-sidebar {
            margin-right: 0;
        }
        
        body.sidebar-collapsed #colors-sidebar {
            right: 0;
        }
        
        #sizes-sidebar {
            width: 320px;
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            height: 100vh;
            position: fixed;
            top: 0;
            right: 320px;
            z-index: 97;
            display: flex;
            flex-direction: column;
            transition: margin-right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1), right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            margin-right: -320px;
        }
        
        body.sizes-sidebar-open #sizes-sidebar {
            margin-right: 0;
        }
        
        body.sidebar-collapsed #sizes-sidebar {
            right: 0;
        }
        
        button {
            font-family: var(--font-main);
        }

        .sidebar-header {
            padding: 1.45rem 1rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .sidebar-header h3 {
             margin: 0;
        }

        .sidebar-content {
            padding: 1rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        #main-content {
            flex-grow: 1;
            padding: 2rem;
            margin-right: 320px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            transition: margin-right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
       
        body.sidebar-collapsed #main-content {
            margin-right: 0;
        }
        
        body.layout-sidebar-open #main-content {
            margin-right: 320px;
        }
        
        body.sidebar-collapsed.layout-sidebar-open #main-content {
            margin-right: 320px;
        }
        
        body.colors-sidebar-open #main-content {
            margin-right: 320px;
        }
        
        body.sidebar-collapsed.colors-sidebar-open #main-content {
            margin-right: 320px;
        }
        
        body.sizes-sidebar-open #main-content {
            margin-right: 320px;
        }
        
        body.sidebar-collapsed.sizes-sidebar-open #main-content {
            margin-right: 320px;
        }

        #pages-container {
            width: 100%;
            max-width: 210mm;
            transition: transform 0.2s ease-in-out;
            transform-origin: top center;
        }
        .control-group {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f1f1f1;
        }
        .control-group h4 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }
        .control-btn {
            font-family: var(--font-main);
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            background: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: background-color .2s;
            margin-bottom: 8px;
        }
        .control-btn:hover:not(:disabled) {
            background-color: #e2e6ea;
        }
        .control-btn:disabled {
            cursor: not-allowed;
            opacity: .5;
        }
        /* START: Settings button beside control button */
        .control-btn-group {
            display: flex;
            gap: 0;
            align-items: center;
            margin-bottom: 8px;
        }
        .control-btn-group .control-btn {
            flex-grow: 1;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            margin-bottom: 0;
        }
        .settings-btn {
            padding: 10px;
            font-size: 1rem;
            background: #e9ecef;
            border: 1px solid var(--border-color);
            border-left: none;
            cursor: pointer;
            border-radius: 6px 0 0 6px;
            height: 42px; /* Match control-btn height */
            color: #555;
        }
        .settings-btn:hover {
            background-color: #ced4da;
        }
        /* END: Settings button */
        .slider-control {
            margin-bottom: 10px;
        }
        .slider-control label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: .9rem;
            margin-bottom: 5px;
        }
        .slider-value {
            font-size: .85rem;
            color: #fff;
            background-color: var(--secondary-color);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        .slider-control input[type=range] {
            width: 100%;
            cursor: pointer;
            flex-grow: 1;
        }
        .slider-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .slider-btn {
            background: #f1f3f5;
            border: 1px solid #ced4da;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
            flex-shrink: 0;
        }
        .slider-btn:hover {
            background: #e2e6ea;
        }

        .color-picker-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .color-control label {
            font-size: .9rem;
            margin-bottom: 5px;
            display: block;
        }
        .toggle-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }
        
        /* Switch Toggle Styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        /* Kashida toggle container styling */
        .kashida-toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            font-size: 0.95rem;
        }
        .pcr-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            box-shadow: 0 2px 8px 0 var(--primary-color, #2980b9);
            display: inline-block;
            aspect-ratio: 1/1;
            padding: 0;
        }
        .page {
            background: var(--page-bg);
            width: 210mm;
            min-height: 297mm;
            padding: 16mm 20mm 20mm 20mm; 
            margin: 0 auto 2rem;
            box-shadow: 0 0 15px var(--shadow-color);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Page Border Styles - Inner Content Border */
        .page-inner-border {
            position: absolute;
            top: 7.5mm;
            left: 10mm;
            right: 10mm;
            bottom: 7.5mm;
            border-width: var(--page-border-width);
            border-color: var(--page-border-color);
            border-radius: var(--page-border-radius);
            border-top-style: var(--page-border-top-style);
            border-right-style: var(--page-border-right-style);
            border-bottom-style: var(--page-border-bottom-style);
            border-left-style: var(--page-border-left-style);
            z-index: 1;
        }
        
        body.border-active .page-inner-border {
            display: block;
        }
        
        body:not(.border-active) .page-inner-border {
            display: none;
        }
        
        .border-boxes-container {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: space-around;
            height: 15mm;
            padding: 0 10mm;
            box-sizing: border-box;
            gap: 10px;
            z-index: 10;
        }
        
        .page-border-box {
            background-color: var(--border-box-bg);
            color: var(--border-box-text-color);
            border: 1px solid var(--page-border-color);
            font-size: 12px;
            padding: 5px 20px;
            border-radius: 50px; /* Pill shape */
            text-align: center;
            min-width: 150px;
            flex-shrink: 0;
            cursor: text;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            min-height: 30px; /* To prevent collapse when empty */
        }
        
        /* Border Style Preview Icons */
        .border-style-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            margin: 10px 0;
        }
        
        .border-style-option {
            width: 30px;
            height: 30px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
        }
        
        .border-style-option:hover {
            border-color: var(--primary-color);
            background-color: #f8f9fa;
        }
        
        .border-style-option.selected {
            border-color: var(--primary-color);
            background-color: #eef6ff;
            box-shadow: 0 0 3px rgba(41, 128, 185, 0.3);
        }
        
        .border-style-preview {
            width: 20px;
            height: 12px;
            background: #f0f0f0;
            position: relative;
        }
        
        .border-style-preview::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 2px;
            right: 2px;
            height: 2px;
            background: #333;
        }
        
        .border-style-preview[data-style="solid"]::after { border-top: 1px solid #333; background: none; }
        .border-style-preview[data-style="dashed"]::after { border-top: 1px dashed #333; background: none; }
        .border-style-preview[data-style="dotted"]::after { border-top: 1px dotted #333; background: none; }
        .border-style-preview[data-style="double"]::after { border-top: 2px double #333; background: none; height: 3px; top: 4px; }
        .border-style-preview[data-style="groove"]::after { border-top: 2px groove #333; background: none; height: 3px; top: 4px; }
        .border-style-preview[data-style="ridge"]::after { border-top: 2px ridge #333; background: none; height: 3px; top: 4px; }
        .border-style-preview[data-style="inset"]::after { border-top: 2px inset #333; background: none; height: 3px; top: 4px; }
        .border-style-preview[data-style="outset"]::after { border-top: 2px outset #333; background: none; height: 3px; top: 4px; }
        
        .border-style-label {
            display: none; /* Hide labels to save space */
        }
        
        /* Frame controls dimming when disabled */
        #border-controls {
            position: relative;
            transition: opacity 0.3s ease;
        }
        
        #border-controls.disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        
        #border-controls.disabled::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(248, 249, 250, 0.7);
            z-index: 1;
            border-radius: 6px;
        }
        
        /* Header/Footer controls dimming when disabled */
        #header-footer-controls {
            position: relative;
            transition: opacity 0.3s ease;
        }
        
        #header-footer-controls.disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        
        #header-footer-controls.disabled::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(248, 249, 250, 0.7);
            z-index: 1;
            border-radius: 6px;
        }
        
        /* Page number controls dimming when disabled */
        #page-number-controls {
            position: relative;
            transition: opacity 0.3s ease;
        }
        
        #page-number-controls.disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        
        #page-number-controls.disabled::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(248, 249, 250, 0.7);
            z-index: 1;
            border-radius: 6px;
        }
        .page-header, .page-footer {
            position: absolute;
            left: 0;
            right: 0;
            height: 15mm;
            display: flex;
            align-items: center;
            padding: 0 10mm;
            box-sizing: border-box;
            z-index: 5;
        }
        .page-header {
            top: 0;
            justify-content: space-around;
            background-color: var(--page-header-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .page-footer {
            bottom: 0;
            justify-content: space-between;
            background-color: var(--page-footer-bg);
            border-top: 1px solid var(--border-color);
            z-index: 0; /* Behind page number */
        }
        .header-box, .footer-box {
            background-color: var(--header-item-bg);
            padding: 5px 20px;
            border: 1px solid var(--border-color);
            border-radius: 50px; /* Pill shape */
            text-align: center;
            min-width: 150px;
            flex-shrink: 0;
            cursor: text;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            min-height: 30px; /* To prevent collapse when empty */
        }
        .header-box { font-size: var(--header-text-fs); color: var(--header-item-text-color); }
        .footer-box { font-size: var(--footer-text-fs); }
        
        .header-box.is-logo {
            padding: 0;
            border: none;
            background: transparent;
            min-height: auto;
            flex-grow: 0;
            flex-shrink: 1;
            min-width: 0;
            cursor: context-menu;
        }

        .header-box-logo {
            height: var(--header-logo-height);
            width: auto;
            max-width: 100%;
            object-fit: contain;
        }

        .page-title {
            display: inline-block;
            text-align: center;
            font-size: var(--title-fs, 2.2rem);
            font-weight: 700;
            color: var(--page-title-text-color, #1a1a1a);
            background-color: var(--page-title-bg-color, #f9f9f9);
            border: 2px solid var(--page-title-border-color, #1a1a1a);
            padding: 0.25rem 2rem;
            border-radius: 16px;
            margin: 0 auto;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
            min-height: 1em; /* Prevent collapse when empty */
        }
        .page-number {
            position: absolute;
            bottom: 5mm;
            left: 50%;
            transform: translateX(-50%);
            font-size: var(--page-num-fs);
            color: var(--page-num-color);
            text-align: center;
            background-color: var(--page-num-bg-color);
            width: var(--page-num-circle-size);
            height: var(--page-num-circle-size);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            cursor: context-menu;
            z-index: 2; /* On top of footer */
        }
        .question-list-header {
            font-size: var(--q-header-fs);
            font-weight: bold;
            text-align: right;
            padding: 0.25rem;
            margin-bottom: 0.5rem;
            background-color: #f0f0f0;
            border-radius: 6px;
            page-break-inside: avoid;
        }
        .reading-passage-wrapper {
            border: 2px dashed #999;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            background-color: #fafafa;
            page-break-inside: avoid;
        }
        .reading-passage-text {
            font-size: var(--passage-text-fs);
            line-height: 1.7;
            white-space: pre-wrap;
            text-align: justify;
        }
        .reading-passage-text:focus {
            /* When editing, hide line structure and show raw content */
            background-color: #eef6ff;
        }
        .reading-passage-line {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.5em;
        }
        .reading-passage-line:last-child {
            margin-bottom: 0;
        }
        .passage-line-number {
            font-size: var(--passage-line-num-fs);
            color: var(--passage-line-num-color);
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            flex-shrink: 0;
            margin-top: 0.1em;
            user-select: none;
        }
        .passage-line-content {
            flex: 1;
            text-indent: 2em;
            text-align: justify;
        }
        .poetry-wrapper {
            border: 2px dashed #999;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            background-color: #fafafa;
            page-break-inside: avoid;
            font-family: var(--font-statement);
        }
        .poetry-bait {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 0.5rem;
        }
        .poetry-bait-content {
            flex-grow: 1;
            display: flex;
            gap: 2%; 
        }
        .poetry-shatr {
            width: 49%; 
            font-size: var(--poetry-text-fs);
            color: var(--poetry-text-color);
            padding: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
        }
        .poetry-shatr[data-use-kashida="false"] {
             text-align: right;
        }
        .poetry-shatr:focus {
            outline: 1px dotted var(--primary-color);
            background-color: #fdfdfd;
        }
        .poetry-bait-number {
            font-family: var(--font-main);
            font-size: var(--poetry-num-fs);
            color: var(--poetry-num-color);
            font-weight: bold;
            min-width: 25px;
            text-align: left;
        }
        .question-wrapper {
            margin-bottom: 0.5rem;
            border: 1px solid var(--question-border-color);
            border-radius: 8px;
            padding: .5rem;
            display: flex;
            flex-direction: column;
            gap: .5rem;
            position: relative;
            background-color: #fff;
            page-break-inside: avoid;
        }
        
        .question-main-content {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
            gap: .8rem;
        }
        
        .question-image-container {
            flex-shrink: 0;
            display: flex;
            align-items: flex-start;
        }
        
        .question-header {
            flex: 1;
            display: block;
        }
        .question-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: .8rem;
        }
        .question-line {
            display: flex;
            align-items: flex-start;
            gap: .75rem;
        }
        .question-image {
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            flex-shrink: 0;
            align-self: flex-start;
            margin-right: 0;
            margin-left: 0;
        }
        .question-number {
            font-size: var(--question-num-fs);
            background-color: var(--question-num-bg);
            color: var(--question-num-color);
            padding: 3px 9px;
            border-radius: 50px;
            font-weight: 700;
            line-height: 1;
        }
        .statement-text {
            font-family: var(--font-statement);
            font-size: var(--statement-fs);
            background-color: var(--statement-bg-color);
            color: var(--statement-text-color);
            padding: .2rem;
            border-radius: 6px;
            border-right: 4px solid var(--primary-color);
            font-style: italic;
            width: 100%;
            box-sizing: border-box;
            display: block;
            text-align: center;
        }
        .question-text {
            font-size: var(--question-text-fs);
            color: var(--question-text-color);
            font-weight: 500;
            flex-grow: 1;
            width: 100%;
            box-sizing: border-box;
            display: block;
        }
        .answers-container {
            display: flex;
            margin-top: .3rem;
            gap: .5rem;
        }
        .answers-layout-1 {
            flex-direction: column;
        }
        .answers-layout-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: .8rem;
        }
        .answers-layout-3 {
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .answer-option {
            display: flex;
            align-items: baseline;
            gap: .5rem;
        }
        .answer-head {
            font-size: var(--answer-head-fs);
            color: var(--answer-head-color);
            border-radius: 50%;
            min-width: var(--answer-head-circle-size);
            height: var(--answer-head-circle-size);
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            border: 2px solid var(--answer-head-bg);
        }
        .answer-text {
            font-size: var(--answer-text-fs);
            color: var(--answer-text-color);
            min-width: 100px;
        }
        .essay-answer-lines {
            padding-top: .5rem;
            display: flex;
            flex-direction: column;
            gap: var(--answer-text-fs);
            min-height: 50px;
            margin-bottom: 0.5rem;
        }
        .essay-answer-line {
            border-bottom: 1px solid #777;
            width: 100%;
            height: 1.2em;
        }
        [contenteditable]:focus {
            outline: 2px solid var(--primary-color);
            background-color: #eef6ff;
            position: relative;
            z-index: 10;
        }
        
        /* Ensure contenteditable elements can receive events and have proper stacking */
        [contenteditable] {
            position: relative;
            z-index: 10;
            pointer-events: auto !important;
            cursor: text;
        }
        
        /* Ensure contenteditable elements remain functional when focused */
        [contenteditable]:focus {
            outline: 2px solid var(--primary-color);
            background-color: #eef6ff;
            position: relative;
            z-index: 50;
            pointer-events: auto !important;
        }
        
        /* Placeholder-like styling for elements with placeholder text */
        [contenteditable].has-placeholder {
            color: #999;
            font-style: italic;
            cursor: text;
        }
        
        [contenteditable].has-placeholder:focus {
            color: var(--text-color);
            font-style: normal;
        }
        
        /* Ensure specific contenteditable elements have proper cursors */
        .question-text[contenteditable],
        .answer-text[contenteditable],
        .statement-text[contenteditable],
        .page-title[contenteditable],
        .question-list-header[contenteditable],
        .reading-passage-text[contenteditable],
        .poetry-shatr[contenteditable],
        .header-box[contenteditable],
        .footer-box[contenteditable],
        .page-border-box[contenteditable] {
            cursor: text !important;
            pointer-events: auto !important;
            position: relative;
            z-index: 15;
        }

        /* START: Enhanced Text Formatting Toolbar - Floating Fixed Top Design */
        #text-format-toolbar {
            position: fixed;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 8px 12px;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            min-width: auto;
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        
        #text-format-toolbar.show {
            display: flex;
            animation: slideDown 0.3s ease;
            pointer-events: auto;
        }
        
        /* Prevent text selection on toolbar elements */
        #text-format-toolbar * {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* Smooth transitions for toolbar interactions */
        #text-format-toolbar button {
            transition: all 0.2s ease;
        }
        
        #text-format-toolbar button:active {
            transform: scale(0.95);
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .toolbar-section {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 0 6px;
            border-right: 1px solid rgba(255,255,255,0.2);
            pointer-events: auto; /* Ensure sections can receive events */
        }

        .toolbar-section:last-child {
            border-right: none;
        }

        .toolbar-section label {
            color: #ecf0f1;
            font-size: 0.75rem;
            font-weight: 500;
            min-width: 40px;
            margin: 0;
        }

        #text-format-toolbar select,
        #text-format-toolbar input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            min-width: 80px;
            margin: 0;
        }

        #text-format-toolbar select:focus,
        #text-format-toolbar input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
        }

        #text-format-toolbar select option {
            background: #2c3e50;
            color: white;
        }

        #text-format-toolbar button {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
        }

        #text-format-toolbar button:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        #text-format-toolbar button.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .opacity-slider {
            width: 80px;
            height: 20px;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            outline: none;
            margin: 0 5px;
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }
        
        .opacity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 2px solid var(--primary-color);
        }
        
        .opacity-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 2px solid var(--primary-color);
        }

        .font-preview {
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            min-height: 28px;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .toolbar-close {
            margin-left: 6px;
            background: rgba(231, 76, 60, 0.8) !important;
            border-color: #e74c3c !important;
        }

        .toolbar-close:hover {
            background: #e74c3c !important;
        }

        /* Font dropdown with preview */
        #font-selector {
            position: relative;
        }

        #font-dropdown-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 150px;
            justify-content: space-between;
            transition: all 0.3s ease;
            margin: 0;
        }

        #font-dropdown-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        #font-dropdown-btn:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
        }

        #font-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2c3e50;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1002;
            display: none;
        }

        .font-option {
            padding: 10px 15px;
            cursor: pointer;
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: background 0.2s;
        }

        .font-option:hover {
            background: rgba(255,255,255,0.1);
        }

        .font-option:last-child {
            border-bottom: none;
        }

        /* Color picker styling */
        #text-color-picker,
        #text-highlight-picker {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0;
            padding: 0;
        }
        
        /* Pickr in toolbar styling */
        .pickr-text-color .pcr-button,
        .pickr-highlight-color .pcr-button {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
            margin: 0;
            padding: 0;
        }
        
        .pickr-text-color .pcr-button:hover,
        .pickr-highlight-color .pcr-button:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }
        
        /* Enhanced color picker app positioning and visibility */
        .pcr-app {
            z-index: 10001 !important;
            box-shadow: 0 8px 25px rgba(0,0,0,.15) !important;
            border: 1px solid #e0e0e0;
            max-width: 95vw !important;
            max-height: 95vh !important;
        }
        
        .pcr-app[data-theme=nano] {
            max-width: min(14.25em, 95vw) !important;
        }
        
        /* Ensure color picker stays within bounds */
        @media (max-width: 768px) {
            .pcr-app {
                width: calc(100vw - 20px) !important;
                max-width: calc(100vw - 20px) !important;
            }
        }
        /* END: Enhanced Text Formatting Toolbar */

        #custom-context-menu {
            position: absolute;
            z-index: 1000;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,.2);
            padding: 2px 0;
            min-width: 260px;
        }
        #custom-context-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #custom-context-menu li {
            padding: 5px 8px;
            cursor: pointer;
            font-size: .95rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #custom-context-menu li:hover {
            background-color: #f1f3f5;
        }
        #custom-context-menu li.danger:hover {
            background-color: #ffe3e3;
            color: #d90429;
        }
        #custom-context-menu hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 5px 0;
        }
        #custom-context-menu li#ctx-change-layout {
            position: relative;
        }
        #custom-context-menu #ctx-layout-submenu {
            position: absolute;
            right: 100%;
            top: -8px; 
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,.2);
            padding: 2px 0;
            min-width: 180px;
            list-style: none;
            display: none;
            z-index: 1001;
        }
        #custom-context-menu li#ctx-change-layout:hover > #ctx-layout-submenu {
            display: block;
        }
        #custom-context-menu #ctx-layout-submenu li {
            padding: 4px 8px;
        }
        /* Modal overlay styles with increased specificity */
        #custom-prompt-overlay, #reading-passage-prompt-overlay, #poetry-prompt-overlay, #watermark-prompt-overlay, #student-info-prompt-overlay, #question-defaults-prompt-overlay, #essay-defaults-prompt-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0,0,0,.5) !important;
            z-index: 10000 !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
        }
        
        /* Hidden class with high specificity */
        #custom-prompt-overlay.hidden, 
        #reading-passage-prompt-overlay.hidden, 
        #poetry-prompt-overlay.hidden, 
        #watermark-prompt-overlay.hidden, 
        #student-info-prompt-overlay.hidden, 
        #question-defaults-prompt-overlay.hidden, 
        #essay-defaults-prompt-overlay.hidden {
            display: none !important;
        }
        #custom-prompt, #reading-passage-prompt, #poetry-prompt, #watermark-prompt, #student-info-prompt, #question-defaults-prompt, #essay-defaults-prompt {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative !important;
            z-index: 10001 !important;
            pointer-events: auto !important;
        }
        #custom-prompt h4, #reading-passage-prompt h4, #poetry-prompt h4, #watermark-prompt h4, #student-info-prompt h4, #question-defaults-prompt h4, #essay-defaults-prompt h4 {
            margin-bottom: 1rem;
            text-align: center;
        }
        #custom-prompt p, #reading-passage-prompt p, #poetry-prompt p {
            margin-bottom: 1rem;
            color: #666;
            text-align: center;
        }
        #custom-prompt input, #reading-passage-prompt textarea, #reading-passage-prompt input, #poetry-prompt textarea, #poetry-prompt input, #watermark-prompt input[type="text"], #essay-defaults-prompt input[type="number"] {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            text-align: right;
            font-family: var(--font-main);
        }
        #reading-passage-prompt textarea, #poetry-prompt textarea {
            min-height: 150px;
            resize: vertical;
        }
        .prompt-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .prompt-buttons button {
            padding: 8px 20px;
            border-radius: 5px;
            border: 1px solid transparent;
            cursor: pointer;
            position: relative !important;
            z-index: 10001 !important;
            pointer-events: auto !important;
            user-select: none !important;
        }
        #prompt-ok, #passage-prompt-ok, #poetry-prompt-ok, #watermark-prompt-ok, #student-info-ok, #q-defaults-prompt-ok, #e-defaults-prompt-ok {
            background: var(--primary-color);
            color: white;
        }
        #prompt-cancel, #passage-prompt-cancel, #poetry-prompt-cancel, #watermark-prompt-cancel, #student-info-cancel, #q-defaults-prompt-cancel, #e-defaults-prompt-cancel {
            background: #f1f3f5;
        }

        /* START: Prompt Styles (Question, Essay Defaults) */
        #question-defaults-prompt, #essay-defaults-prompt { text-align: right; }
        .prompt-setting-group { margin-bottom: 1.5rem; }
        .prompt-setting-group h5 { margin-bottom: 0.75rem; color: #555; }
        .prompt-input-group label {
            display: block;
            margin-bottom: .5rem;
        }
        #default-layout-selector {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }
        #default-layout-selector label {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        #default-layout-selector img {
            width: 48px;
            height: 32px;
            object-fit: contain;
            margin-bottom: 0.25rem;
        }
        #default-layout-selector input { display: none; }
        #default-layout-selector input:checked + label {
            border-color: var(--primary-color);
            background-color: #eef6ff;
            box-shadow: 0 0 5px rgba(41, 128, 185, 0.5);
        }
        /* END: Prompt Styles */

        /* START: Watermark Modal Specific Styles */
        #watermark-prompt { text-align: right; }
        .watermark-type-selector { display: flex; justify-content: center; gap: 2rem; margin-bottom: 1rem; }
         .watermark-type-selector label { display: flex; align-items: center; gap: 8px; cursor: pointer;}
        #watermark-image-control { text-align: center; padding: 1rem; border: 2px dashed var(--border-color); border-radius: 8px; margin-bottom: 1rem; }
        #watermark-prompt .slider-control { margin-top: 1rem; }
        #watermark-image-name { font-size: 0.8rem; color: #666; display: block; margin-top: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        /* END: Watermark Modal Specific Styles */

        /* START: Student Info Modal Specific Styles */
        .student-info-options { text-align: right; margin: 1rem 0; }
        .student-info-options .toggle-control { margin-bottom: 0.8rem; }
        .student-info-options input[type="text"], 
        .student-info-options input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: var(--font-main);
            text-align: right;
            margin-top: 0.5rem;
        }
        /* END: Student Info Modal Specific Styles */

        /* START: Student Info Box Display Styles */
        .student-info-wrapper {
             margin-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
            padding: 15px;
            background-color: var(--page-bg);
            font-family: var(--font-main);
            direction: rtl;
            text-align: right;
            position: relative;
            z-index: 15;
        }

        .student-info-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .student-info-container.with-exam-score {
            display: grid;
            grid-template-columns: 1fr 100px;
            gap: 1rem;
            align-items: start;
            direction: rtl;
        }

        .student-info-container.with-exam-score .info-rows-container {
            display: contents;
        }

        .student-info-container.with-exam-score .info-row:nth-child(3),
        .student-info-container.with-exam-score .info-row:nth-child(n+3) {
            grid-column: 1 / -1;
        }

        .info-rows-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-row {
            display: flex;
            flex-direction: row;
            gap: 2rem;
            direction: rtl;
        }

        .info-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            flex: 1;
        }

        .info-name {
            font-size: 1.1rem;
            color: var(--text-color);
            white-space: nowrap;
            margin-left: 0;
        }

        .space {
            font-family: monospace;
            font-size: 0.9rem;
            flex: 1;
            margin-right: 0;
            display: inline-block;
            min-width: 100px;
              border-bottom: 1px solid #777;
            width: 100%;
            height: 1.2em;
        }

        .date-container,
        .score-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .date-space {
            flex: 0 0 auto;
        }

        .score-space {
            flex: 0 0 auto;
        }

        .date-separator,
        .score-separator {
            font-size: 1.1rem;
            color: var(--text-color);
            margin: 0 0.2rem;
        }

        .score-total {
            font-size: 1.1rem;
            color: var(--text-color);
            font-weight: bold;
        }

.exam-score-box {
    width: 80px;
    height: 80px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--text-color);
    background-color: var(--page-bg);
    flex-shrink: 0;
}

        .score-upper-half {
            flex: 1;
            border-bottom: 2px solid var(--border-color);
            border-radius: 6px 6px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-color);
            width: 100%;
        }

        .score-lower-half {
            flex: 1;
            border-radius: 0 0 6px 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--page-bg);
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary-color);
            width: 100%;
        }

        @font-face {
            font-family: 'Droid Arabic Kufi';
            src: url('fonts/Droid.Arabic.Kufi_DownloadSoftware.iR_.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Droid Arabic Kufi';
            src: url('fonts/Droid.Arabic.Kufi_.Bold_DownloadSoftware.iR_.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }

        @font-face {
            font-family: 'Droid Arabic Naskh';
            src: url('fonts/Droid.Arabic.Naskh_.Regular_DownloadSoftware.iR_.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Droid Arabic Naskh';
            src: url('fonts/Droid.Arabic.Naskh_.Bold_DownloadSoftware.iR_.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }

        @font-face {
            font-family: 'HS Al Basim A';
            src: url('fonts/HS-Al-Basim-A.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'HS Al Basim B';
            src: url('fonts/HS-Al-Basim-B.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Hasan Alquds Unicode';
            src: url('fonts/Hasan-Alquds-Unicode.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Hasan Alquds Unicode';
            src: url('fonts/Hasan-Alquds-Unicode-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }

        @font-face {
            font-family: 'Hasan Alquds Unicode';
            src: url('fonts/Hasan-Alquds-Unicode-ExtraBold.ttf') format('truetype');
            font-weight: 800;
            font-style: normal;
        }

        @font-face {
            font-family: 'Hasan Alquds Unicode';
            src: url('fonts/Hasan-Alquds-Unicode-Light.ttf') format('truetype');
            font-weight: 300;
            font-style: normal;
        }

        @font-face {
            font-family: 'Hasan Alquds Unicode';
            src: url('fonts/Hasan-Alquds-Unicode-Medium.ttf') format('truetype');
            font-weight: 500;
            font-style: normal;
        }

        @font-face {
            font-family: 'Hasan Hiba';
            src: url('fonts/Hasan_Hiba.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Nusaibah';
            src: url('fonts/Nusaibah-Regular.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Nusaibah';
            src: url('fonts/Nusaibah-Bold.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }

        @font-face {
            font-family: 'Samman';
            src: url('fonts/Samman.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Sonbili';
            src: url('fonts/Sonbili_DownloadSoftware.iR_.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Abdo Logo';
            src: url('fonts/Abdo.Fonts_Abdo.Logo_.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --font-main: 'Tajawal', sans-serif;
            --font-statement: 'Scheherazade New', serif;
            --primary-color: #2980b9;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --sidebar-bg: #ffffff;
            --page-bg: #ffffff;
            --text-color: #333;
            --border-color: #dee2e6;
            --shadow-color: rgba(0,0,0,0.1);
            --highlight-color: #ffff00;
            
            --question-text-color: #212529;
            --question-num-color: #ffffff;
            --question-num-bg: #007bff;
            --statement-text-color: #555;
            --statement-bg-color: #f1f3f5;
            --answer-head-color: #495057;
            --answer-head-bg: #e9ecef;
            --answer-text-color: #343a40;
            --question-border-color: #ced4da;
            --page-num-color: #333;
            --page-num-bg-color: #cccccc;
            --page-title-text-color: #333;
            --page-title-bg-color: #ffffff;
            --page-title-border-color: #ced4da;
            --poetry-text-color: #333333; 
            --poetry-num-color: #888888; 
            --passage-line-num-color: #666666;
            --passage-line-num-fs: 12px; 

            /* Header/Footer Colors */
            --page-header-bg: #f8f9fa;
            --page-footer-bg: #f8f9fa;
            --header-item-bg: #ffffff;
            --footer-item-bg: #ffffff;
            --header-item-text-color: #333;
            --header-logo-height: 25px;

            --title-fs: 32px;
            --q-header-fs: 18px; 
            --passage-text-fs: 16px;
            --poetry-text-fs: 20px; 
            --poetry-num-fs: 14px; 
            --question-num-fs: 18px;
            --question-text-fs: 18px;
            --statement-fs: 20px;
            --answer-head-fs: 16px;
            --answer-text-fs: 16px;
            --page-num-fs: 12px;
            --header-text-fs: 14px;
            --footer-text-fs: 12px;
            --page-num-circle-size: 30px;
            --answer-head-circle-size: 28px;

            /* Page Border */
            --page-border-color: #333333;
            --page-border-width: 2px;
            --page-border-radius: 0px;
            --page-border-style: solid;
            --border-box-bg: #ffffff;
            --border-box-text-color: #333333;
            --page-border-top-style: solid;
            --page-border-right-style: solid;
            --page-border-bottom-style: solid;
            --page-border-left-style: solid;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html:fullscreen {
            background: var(--background-color);
        }
        body {
            font-family: var(--font-main);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        .hidden {
            display: none !important;
            visibility: hidden !important;
        }
        body.header-hidden .page-header { display: none !important; }
        body.footer-hidden .page-footer { display: none !important; }
        body.border-active .page-header { display: none !important; }
        body.border-active .page-footer { display: none !important; }
        body.page-number-hidden .page-number { display: none !important; }
        
        #editor-action-buttons {
            position: fixed;
            top: 15px;
            right: 335px; /* sidebar width (320) + 15 padding */
            z-index: 101; /* Above sidebar but below its content if needed */
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        body.sidebar-collapsed #editor-action-buttons {
            right: 15px;
        }
        body.layout-sidebar-open #editor-action-buttons {
            right: 655px; /* main sidebar (320) + layout sidebar (320) + 15 padding */
        }
        body.sidebar-collapsed.layout-sidebar-open #editor-action-buttons {
            right: 335px; /* layout sidebar (320) + 15 padding */
        }
        body.colors-sidebar-open #editor-action-buttons {
            right: 655px; /* main sidebar (320) + colors sidebar (320) + 15 padding */
        }
        body.sidebar-collapsed.colors-sidebar-open #editor-action-buttons {
            right: 335px; /* colors sidebar (320) + 15 padding */
        }
        body.sizes-sidebar-open #editor-action-buttons {
            right: 655px; /* main sidebar (320) + sizes sidebar (320) + 15 padding */
        }
        body.sidebar-collapsed.sizes-sidebar-open #editor-action-buttons {
            right: 335px; /* sizes sidebar (320) + 15 padding */
        }
        .editor-control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #fff;
            color: var(--primary-color);
            border: 1px solid var(--border-color);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: all .2s ease-in-out;
        }
        .editor-control-btn:hover {
            background-color: #f1f3f5;
            transform: scale(1.1);
        }
        .editor-control-btn.active {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }
        .editor-control-btn.active:hover {
            background-color: #1e6a96;
            transform: scale(1.1);
        }

        #editor-screen {
            display: flex;
        }
        #sidebar {
            width: 320px;
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            height: 100vh;
            position: fixed;
            top: 0;
            right: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
            transition: margin-right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        body.sidebar-collapsed #sidebar {
            margin-right: -320px;
        }
        
        #layout-sidebar {
            width: 320px;
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            height: 100vh;
            position: fixed;
            top: 0;
            right: 320px;
            z-index: 99;
            display: flex;
            flex-direction: column;
            transition: margin-right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1), right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            margin-right: -320px;
        }
        
        body.layout-sidebar-open #layout-sidebar {
            margin-right: 0;
        }
        
        body.sidebar-collapsed #layout-sidebar {
            right: 0;
        }
        
        #colors-sidebar {
            width: 320px;
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            height: 100vh;
            position: fixed;
            top: 0;
            right: 320px;
            z-index: 98;
            display: flex;
            flex-direction: column;
            transition: margin-right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1), right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            margin-right: -320px;
        }
        
        body.colors-sidebar-open #colors-sidebar {
            margin-right: 0;
        }
        
        body.sidebar-collapsed #colors-sidebar {
            right: 0;
        }
        
        #sizes-sidebar {
            width: 320px;
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--border-color);
            height: 100vh;
            position: fixed;
            top: 0;
            right: 320px;
            z-index: 97;
            display: flex;
            flex-direction: column;
            transition: margin-right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1), right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            margin-right: -320px;
        }
        
        body.sizes-sidebar-open #sizes-sidebar {
            margin-right: 0;
        }
        
        body.sidebar-collapsed #sizes-sidebar {
            right: 0;
        }
        
        button {
            font-family: var(--font-main);
        }

        .sidebar-header {
            padding: 1.45rem 1rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .sidebar-header h3 {
             margin: 0;
        }

        .sidebar-content {
            padding: 1rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        #main-content {
            flex-grow: 1;
            padding: 2rem;
            margin-right: 320px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            transition: margin-right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
       
        body.sidebar-collapsed #main-content {
            margin-right: 0;
        }
        
        body.layout-sidebar-open #main-content {
            margin-right: 320px;
        }
        
        body.sidebar-collapsed.layout-sidebar-open #main-content {
            margin-right: 320px;
        }
        
        body.colors-sidebar-open #main-content {
            margin-right: 320px;
        }
        
        body.sidebar-collapsed.colors-sidebar-open #main-content {
            margin-right: 320px;
        }
        
        body.sizes-sidebar-open #main-content {
            margin-right: 320px;
        }
        
        body.sidebar-collapsed.sizes-sidebar-open #main-content {
            margin-right: 320px;
        }

        #pages-container {
            width: 100%;
            max-width: 210mm;
            transition: transform 0.2s ease-in-out;
            transform-origin: top center;
        }
        .control-group {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f1f1f1;
        }
        .control-group h4 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }
        .control-btn {
            font-family: var(--font-main);
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            background: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: background-color .2s;
            margin-bottom: 8px;
        }
        .control-btn:hover:not(:disabled) {
            background-color: #e2e6ea;
        }
        .control-btn:disabled {
            cursor: not-allowed;
            opacity: .5;
        }
        /* START: Settings button beside control button */
        .control-btn-group {
            display: flex;
            gap: 0;
            align-items: center;
            margin-bottom: 8px;
        }
        .control-btn-group .control-btn {
            flex-grow: 1;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            margin-bottom: 0;
        }
        .settings-btn {
            padding: 10px;
            font-size: 1rem;
            background: #e9ecef;
            border: 1px solid var(--border-color);
            border-left: none;
            cursor: pointer;
            border-radius: 6px 0 0 6px;
            height: 42px; /* Match control-btn height */
            color: #555;
        }
        .settings-btn:hover {
            background-color: #ced4da;
        }
        /* END: Settings button */
        .slider-control {
            margin-bottom: 10px;
        }
        .slider-control label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: .9rem;
            margin-bottom: 5px;
        }
        .slider-value {
            font-size: .85rem;
            color: #fff;
            background-color: var(--secondary-color);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        .slider-control input[type=range] {
            width: 100%;
            cursor: pointer;
            flex-grow: 1;
        }
        .slider-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .slider-btn {
            background: #f1f3f5;
            border: 1px solid #ced4da;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
            flex-shrink: 0;
        }
        .slider-btn:hover {
            background: #e2e6ea;
        }

        .color-picker-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .color-control label {
            font-size: .9rem;
            margin-bottom: 5px;
            display: block;
        }
        .toggle-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }
        
        /* Switch Toggle Styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        /* Kashida toggle container styling */
        .kashida-toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            font-size: 0.95rem;
        }
        .pcr-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            box-shadow: 0 2px 8px 0 var(--primary-color, #2980b9);
            display: inline-block;
            aspect-ratio: 1/1;
            padding: 0;
        }
        .page {
            background: var(--page-bg);
            width: 210mm;
            min-height: 297mm;
            padding: 16mm 20mm 20mm 20mm; 
            margin: 0 auto 2rem;
            box-shadow: 0 0 15px var(--shadow-color);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Page Border Styles - Inner Content Border */
        .page-inner-border {
            position: absolute;
            top: 7.5mm;
            left: 10mm;
            right: 10mm;
            bottom: 7.5mm;
            border-width: var(--page-border-width);
            border-color: var(--page-border-color);
            border-radius: var(--page-border-radius);
            border-top-style: var(--page-border-top-style);
            border-right-style: var(--page-border-right-style);
            border-bottom-style: var(--page-border-bottom-style);
            border-left-style: var(--page-border-left-style);
            z-index: 1;
        }
        
        body.border-active .page-inner-border {
            display: block;
        }
        
        body:not(.border-active) .page-inner-border {
            display: none;
        }
        
        .border-boxes-container {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: space-around;
            height: 15mm;
            padding: 0 10mm;
            box-sizing: border-box;
            gap: 10px;
            z-index: 10;
        }
        
        .page-border-box {
            background-color: var(--border-box-bg);
            color: var(--border-box-text-color);
            border: 1px solid var(--page-border-color);
            font-size: 12px;
            padding: 5px 20px;
            border-radius: 50px; /* Pill shape */
            text-align: center;
            min-width: 150px;
            flex-shrink: 0;
            cursor: text;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            min-height: 30px; /* To prevent collapse when empty */
        }
        
        /* Border Style Preview Icons */
        .border-style-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            margin: 10px 0;
        }
        
        .border-style-option {
            width: 30px;
            height: 30px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
        }
        
        .border-style-option:hover {
            border-color: var(--primary-color);
            background-color: #f8f9fa;
        }
        
        .border-style-option.selected {
            border-color: var(--primary-color);
            background-color: #eef6ff;
            box-shadow: 0 0 3px rgba(41, 128, 185, 0.3);
        }
        
        .border-style-preview {
            width: 20px;
            height: 12px;
            background: #f0f0f0;
            position: relative;
        }
        
        .border-style-preview::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 2px;
            right: 2px;
            height: 2px;
            background: #333;
        }
        
        .border-style-preview[data-style="solid"]::after { border-top: 1px solid #333; background: none; }
        .border-style-preview[data-style="dashed"]::after { border-top: 1px dashed #333; background: none; }
        .border-style-preview[data-style="dotted"]::after { border-top: 1px dotted #333; background: none; }
        .border-style-preview[data-style="double"]::after { border-top: 2px double #333; background: none; height: 3px; top: 4px; }
        .border-style-preview[data-style="groove"]::after { border-top: 2px groove #333; background: none; height: 3px; top: 4px; }
        .border-style-preview[data-style="ridge"]::after { border-top: 2px ridge #333; background: none; height: 3px; top: 4px; }
        .border-style-preview[data-style="inset"]::after { border-top: 2px inset #333; background: none; height: 3px; top: 4px; }
        .border-style-preview[data-style="outset"]::after { border-top: 2px outset #333; background: none; height: 3px; top: 4px; }
        
        .border-style-label {
            display: none; /* Hide labels to save space */
        }
        
        /* Frame controls dimming when disabled */
        #border-controls {
            position: relative;
            transition: opacity 0.3s ease;
        }
        
        #border-controls.disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        
        #border-controls.disabled::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(248, 249, 250, 0.7);
            z-index: 1;
            border-radius: 6px;
        }
        
        /* Header/Footer controls dimming when disabled */
        #header-footer-controls {
            position: relative;
            transition: opacity 0.3s ease;
        }
        
        #header-footer-controls.disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        
        #header-footer-controls.disabled::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(248, 249, 250, 0.7);
            z-index: 1;
            border-radius: 6px;
        }
        
        /* Page number controls dimming when disabled */
        #page-number-controls {
            position: relative;
            transition: opacity 0.3s ease;
        }
        
        #page-number-controls.disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        
        #page-number-controls.disabled::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(248, 249, 250, 0.7);
            z-index: 1;
            border-radius: 6px;
        }
        .page-header, .page-footer {
            position: absolute;
            left: 0;
            right: 0;
            height: 15mm;
            display: flex;
            align-items: center;
            padding: 0 10mm;
            box-sizing: border-box;
            z-index: 5;
        }
        .page-header {
            top: 0;
            justify-content: space-around;
            background-color: var(--page-header-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .page-footer {
            bottom: 0;
            justify-content: space-between;
            background-color: var(--page-footer-bg);
            border-top: 1px solid var(--border-color);
            z-index: 0; /* Behind page number */
        }
        .header-box, .footer-box {
            background-color: var(--header-item-bg);
            padding: 5px 20px;
            border: 1px solid var(--border-color);
            border-radius: 50px; /* Pill shape */
            text-align: center;
            min-width: 150px;
            flex-shrink: 0;
            cursor: text;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            min-height: 30px; /* To prevent collapse when empty */
        }
        .header-box { font-size: var(--header-text-fs); color: var(--header-item-text-color); }
        .footer-box { font-size: var(--footer-text-fs); }
        
        .header-box.is-logo {
            padding: 0;
            border: none;
            background: transparent;
            min-height: auto;
            flex-grow: 0;
            flex-shrink: 1;
            min-width: 0;
            cursor: context-menu;
        }

        .header-box-logo {
            height: var(--header-logo-height);
            width: auto;
            max-width: 100%;
            object-fit: contain;
        }

        .page-title {
            display: inline-block;
            text-align: center;
            font-size: var(--title-fs, 2.2rem);
            font-weight: 700;
            color: var(--page-title-text-color, #1a1a1a);
            background-color: var(--page-title-bg-color, #f9f9f9);
            border: 2px solid var(--page-title-border-color, #1a1a1a);
            padding: 0.25rem 2rem;
            border-radius: 16px;
            margin: 0 auto;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
            min-height: 1em; /* Prevent collapse when empty */
        }
        .page-number {
            position: absolute;
            bottom: 5mm;
            left: 50%;
            transform: translateX(-50%);
            font-size: var(--page-num-fs);
            color: var(--page-num-color);
            text-align: center;
            background-color: var(--page-num-bg-color);
            width: var(--page-num-circle-size);
            height: var(--page-num-circle-size);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            cursor: context-menu;
            z-index: 2; /* On top of footer */
        }
        .question-list-header {
            font-size: var(--q-header-fs);
            font-weight: bold;
            text-align: right;
            padding: 0.25rem;
            margin-bottom: 0.5rem;
            background-color: #f0f0f0;
            border-radius: 6px;
            page-break-inside: avoid;
        }
        .reading-passage-wrapper {
            border: 2px dashed #999;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            background-color: #fafafa;
            page-break-inside: avoid;
        }
        .reading-passage-text {
            font-size: var(--passage-text-fs);
            line-height: 1.7;
            white-space: pre-wrap;
            text-align: justify;
        }
        .reading-passage-text:focus {
            /* When editing, hide line structure and show raw content */
            background-color: #eef6ff;
        }
        .reading-passage-line {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.5em;
        }
        .reading-passage-line:last-child {
            margin-bottom: 0;
        }
        .passage-line-number {
            font-size: var(--passage-line-num-fs);
            color: var(--passage-line-num-color);
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            flex-shrink: 0;
            margin-top: 0.1em;
            user-select: none;
        }
        .passage-line-content {
            flex: 1;
            text-indent: 2em;
            text-align: justify;
        }
        .poetry-wrapper {
            border: 2px dashed #999;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            background-color: #fafafa;
            page-break-inside: avoid;
            font-family: var(--font-statement);
        }
        .poetry-bait {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 0.5rem;
        }
        .poetry-bait-content {
            flex-grow: 1;
            display: flex;
            gap: 2%; 
        }
        .poetry-shatr {
            width: 49%; 
            font-size: var(--poetry-text-fs);
            color: var(--poetry-text-color);
            padding: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
        }
        .poetry-shatr[data-use-kashida="false"] {
             text-align: right;
        }
        .poetry-shatr:focus {
            outline: 1px dotted var(--primary-color);
            background-color: #fdfdfd;
        }
        .poetry-bait-number {
            font-family: var(--font-main);
            font-size: var(--poetry-num-fs);
            color: var(--poetry-num-color);
            font-weight: bold;
            min-width: 25px;
            text-align: left;
        }
        .question-wrapper {
            margin-bottom: 0.5rem;
            border: 1px solid var(--question-border-color);
            border-radius: 8px;
            padding: .5rem;
            display: flex;
            flex-direction: column;
            gap: .5rem;
            position: relative;
            background-color: #fff;
            page-break-inside: avoid;
        }
        
        .question-main-content {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
            gap: .8rem;
        }
        
        .question-image-container {
            flex-shrink: 0;
            display: flex;
            align-items: flex-start;
        }
        
        .question-header {
            flex: 1;
            display: block;
        }
        .question-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: .8rem;
        }
        .question-line {
            display: flex;
            align-items: flex-start;
            gap: .75rem;
        }
        .question-image {
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            flex-shrink: 0;
            align-self: flex-start;
            margin-right: 0;
            margin-left: 0;
        }
        .question-number {
            font-size: var(--question-num-fs);
            background-color: var(--question-num-bg);
            color: var(--question-num-color);
            padding: 3px 9px;
            border-radius: 50px;
            font-weight: 700;
            line-height: 1;
        }
        .statement-text {
            font-family: var(--font-statement);
            font-size: var(--statement-fs);
            background-color: var(--statement-bg-color);
            color: var(--statement-text-color);
            padding: .2rem;
            border-radius: 6px;
            border-right: 4px solid var(--primary-color);
            font-style: italic;
            width: 100%;
            box-sizing: border-box;
            display: block;
            text-align: center;
        }
        .question-text {
            font-size: var(--question-text-fs);
            color: var(--question-text-color);
            font-weight: 500;
            flex-grow: 1;
            width: 100%;
            box-sizing: border-box;
            display: block;
        }
        .answers-container {
            display: flex;
            margin-top: .3rem;
            gap: .5rem;
        }
        .answers-layout-1 {
            flex-direction: column;
        }
        .answers-layout-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: .8rem;
        }
        .answers-layout-3 {
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .answer-option {
            display: flex;
            align-items: baseline;
            gap: .5rem;
        }
        .answer-head {
            font-size: var(--answer-head-fs);
            color: var(--answer-head-color);
            border-radius: 50%;
            min-width: var(--answer-head-circle-size);
            height: var(--answer-head-circle-size);
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            border: 2px solid var(--answer-head-bg);
        }
        .answer-text {
            font-size: var(--answer-text-fs);
            color: var(--answer-text-color);
            min-width: 100px;
        }
        .essay-answer-lines {
            padding-top: .5rem;
            display: flex;
            flex-direction: column;
            gap: var(--answer-text-fs);
            min-height: 50px;
            margin-bottom: 0.5rem;
        }
        .essay-answer-line {
            border-bottom: 1px solid #777;
            width: 100%;
            height: 1.2em;
        }
        [contenteditable]:focus {
            outline: 2px solid var(--primary-color);
            background-color: #eef6ff;
            position: relative;
            z-index: 10;
        }
        
        /* Ensure contenteditable elements can receive events and have proper stacking */
        [contenteditable] {
            position: relative;
            z-index: 10;
            pointer-events: auto !important;
            cursor: text;
        }
        
        /* Ensure contenteditable elements remain functional when focused */
        [contenteditable]:focus {
            outline: 2px solid var(--primary-color);
            background-color: #eef6ff;
            position: relative;
            z-index: 50;
            pointer-events: auto !important;
        }
        
        /* Placeholder-like styling for elements with placeholder text */
        [contenteditable].has-placeholder {
            color: #999;
            font-style: italic;
            cursor: text;
        }
        
        [contenteditable].has-placeholder:focus {
            color: var(--text-color);
            font-style: normal;
        }
        
        /* Ensure specific contenteditable elements have proper cursors */
        .question-text[contenteditable],
        .answer-text[contenteditable],
        .statement-text[contenteditable],
        .page-title[contenteditable],
        .question-list-header[contenteditable],
        .reading-passage-text[contenteditable],
        .poetry-shatr[contenteditable],
        .header-box[contenteditable],
        .footer-box[contenteditable],
        .page-border-box[contenteditable] {
            cursor: text !important;
            pointer-events: auto !important;
            position: relative;
            z-index: 15;
        }

        /* START: Enhanced Text Formatting Toolbar - Floating Fixed Top Design */
        #text-format-toolbar {
            position: fixed;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 8px 12px;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            min-width: auto;
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        
        #text-format-toolbar.show {
            display: flex;
            animation: slideDown 0.3s ease;
            pointer-events: auto;
        }
        
        /* Prevent text selection on toolbar elements */
        #text-format-toolbar * {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* Smooth transitions for toolbar interactions */
        #text-format-toolbar button {
            transition: all 0.2s ease;
        }
        
        #text-format-toolbar button:active {
            transform: scale(0.95);
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .toolbar-section {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 0 6px;
            border-right: 1px solid rgba(255,255,255,0.2);
            pointer-events: auto; /* Ensure sections can receive events */
        }

        .toolbar-section:last-child {
            border-right: none;
        }

        .toolbar-section label {
            color: #ecf0f1;
            font-size: 0.75rem;
            font-weight: 500;
            min-width: 40px;
            margin: 0;
        }

        #text-format-toolbar select,
        #text-format-toolbar input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            min-width: 80px;
            margin: 0;
        }

        #text-format-toolbar select:focus,
        #text-format-toolbar input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
        }

        #text-format-toolbar select option {
            background: #2c3e50;
            color: white;
        }

        #text-format-toolbar button {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
        }

        #text-format-toolbar button:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        #text-format-toolbar button.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .opacity-slider {
            width: 80px;
            height: 20px;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            outline: none;
            margin: 0 5px;
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }
        
        .opacity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 2px solid var(--primary-color);
        }
        
        .opacity-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 2px solid var(--primary-color);
        }

        .font-preview {
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            min-height: 28px;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .toolbar-close {
            margin-left: 6px;
            background: rgba(231, 76, 60, 0.8) !important;
            border-color: #e74c3c !important;
        }

        .toolbar-close:hover {
            background: #e74c3c !important;
        }

        /* Font dropdown with preview */
        #font-selector {
            position: relative;
        }

        #font-dropdown-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 150px;
            justify-content: space-between;
            transition: all 0.3s ease;
            margin: 0;
        }

        #font-dropdown-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        #font-dropdown-btn:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
        }

        #font-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2c3e50;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1002;
            display: none;
        }

        .font-option {
            padding: 10px 15px;
            cursor: pointer;
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: background 0.2s;
        }

        .font-option:hover {
            background: rgba(255,255,255,0.1);
        }

        .font-option:last-child {
            border-bottom: none;
        }

        /* Color picker styling */
        #text-color-picker,
        #text-highlight-picker {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0;
            padding: 0;
        }
        
        /* Pickr in toolbar styling */
        .pickr-text-color .pcr-button,
        .pickr-highlight-color .pcr-button {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
            margin: 0;
            padding: 0;
        }
        
        .pickr-text-color .pcr-button:hover,
        .pickr-highlight-color .pcr-button:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }
        
        /* Enhanced color picker app positioning and visibility */
        .pcr-app {
            z-index: 10001 !important;
            box-shadow: 0 8px 25px rgba(0,0,0,.15) !important;
            border: 1px solid #e0e0e0;
            max-width: 95vw !important;
            max-height: 95vh !important;
        }
        
        .pcr-app[data-theme=nano] {
            max-width: min(14.25em, 95vw) !important;
        }
        
        /* Ensure color picker stays within bounds */
        @media (max-width: 768px) {
            .pcr-app {
                width: calc(100vw - 20px) !important;
                max-width: calc(100vw - 20px) !important;
            }
        }
        /* END: Enhanced Text Formatting Toolbar */

        #custom-context-menu {
            position: absolute;
            z-index: 1000;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,.2);
            padding: 2px 0;
            min-width: 260px;
        }
        #custom-context-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #custom-context-menu li {
            padding: 5px 8px;
            cursor: pointer;
            font-size: .95rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #custom-context-menu li:hover {
            background-color: #f1f3f5;
        }
        #custom-context-menu li.danger:hover {
            background-color: #ffe3e3;
            color: #d90429;
        }
        #custom-context-menu hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 5px 0;
        }
        #custom-context-menu li#ctx-change-layout {
            position: relative;
        }
        #custom-context-menu #ctx-layout-submenu {
            position: absolute;
            right: 100%;
            top: -8px; 
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,.2);
            padding: 2px 0;
            min-width: 180px;
            list-style: none;
            display: none;
            z-index: 1001;
        }
        #custom-context-menu li#ctx-change-layout:hover > #ctx-layout-submenu {
            display: block;
        }
        #custom-context-menu #ctx-layout-submenu li {
            padding: 4px 8px;
        }
        /* Modal overlay styles with increased specificity */
        #custom-prompt-overlay, #reading-passage-prompt-overlay, #poetry-prompt-overlay, #watermark-prompt-overlay, #student-info-prompt-overlay, #question-defaults-prompt-overlay, #essay-defaults-prompt-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0,0,0,.5) !important;
            z-index: 10000 !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
        }
        
        /* Hidden class with high specificity */
        #custom-prompt-overlay.hidden, 
        #reading-passage-prompt-overlay.hidden, 
        #poetry-prompt-overlay.hidden, 
        #watermark-prompt-overlay.hidden, 
        #student-info-prompt-overlay.hidden, 
        #question-defaults-prompt-overlay.hidden, 
        #essay-defaults-prompt-overlay.hidden {
            display: none !important;
        }
        #custom-prompt, #reading-passage-prompt, #poetry-prompt, #watermark-prompt, #student-info-prompt, #question-defaults-prompt, #essay-defaults-prompt {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative !important;
            z-index: 10001 !important;
            pointer-events: auto !important;
        }
        #custom-prompt h4, #reading-passage-prompt h4, #poetry-prompt h4, #watermark-prompt h4, #student-info-prompt h4, #question-defaults-prompt h4, #essay-defaults-prompt h4 {
            margin-bottom: 1rem;
            text-align: center;
        }
        #custom-prompt p, #reading-passage-prompt p, #poetry-prompt p {
            margin-bottom: 1rem;
            color: #666;
            text-align: center;
        }
        #custom-prompt input, #reading-passage-prompt textarea, #reading-passage-prompt input, #poetry-prompt textarea, #poetry-prompt input, #watermark-prompt input[type="text"], #essay-defaults-prompt input[type="number"] {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            text-align: right;
            font-family: var(--font-main);
        }
        #reading-passage-prompt textarea, #poetry-prompt textarea {
            min-height: 150px;
            resize: vertical;
        }
        .prompt-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .prompt-buttons button {
            padding: 8px 20px;
            border-radius: 5px;
            border: 1px solid transparent;
            cursor: pointer;
            position: relative !important;
            z-index: 10001 !important;
            pointer-events: auto !important;
            user-select: none !important;
        }
        #prompt-ok, #passage-prompt-ok, #poetry-prompt-ok, #watermark-prompt-ok, #student-info-ok, #q-defaults-prompt-ok, #e-defaults-prompt-ok {
            background: var(--primary-color);
            color: white;
        }
        #prompt-cancel, #passage-prompt-cancel, #poetry-prompt-cancel, #watermark-prompt-cancel, #student-info-cancel, #q-defaults-prompt-cancel, #e-defaults-prompt-cancel {
            background: #f1f3f5;
        }

        /* START: Prompt Styles (Question, Essay Defaults) */
        #question-defaults-prompt, #essay-defaults-prompt { text-align: right; }
        .prompt-setting-group { margin-bottom: 1.5rem; }
        .prompt-setting-group h5 { margin-bottom: 0.75rem; color: #555; }
        .prompt-input-group label {
            display: block;
            margin-bottom: .5rem;
        }
        #default-layout-selector {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }
        #default-layout-selector label {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        #default-layout-selector img {
            width: 48px;
            height: 32px;
            object-fit: contain;
            margin-bottom: 0.25rem;
        }
        #default-layout-selector input { display: none; }
        #default-layout-selector input:checked + label {
            border-color: var(--primary-color);
            background-color: #eef6ff;
            box-shadow: 0 0 5px rgba(41, 128, 185, 0.5);
        }
        /* END: Prompt Styles */

        /* START: Watermark Modal Specific Styles */
        #watermark-prompt { text-align: right; }
        .watermark-type-selector { display: flex; justify-content: center; gap: 2rem; margin-bottom: 1rem; }
         .watermark-type-selector label { display: flex; align-items: center; gap: 8px; cursor: pointer;}
        #watermark-image-control { text-align: center; padding: 1rem; border: 2px dashed var(--border-color); border-radius: 8px; margin-bottom: 1rem; }
        #watermark-prompt .slider-control { margin-top: 1rem; }
        #watermark-image-name { font-size: 0.8rem; color: #666; display: block; margin-top: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        /* END: Watermark Modal Specific Styles */

        /* START: Student Info Modal Specific Styles */
        .student-info-options { text-align: right; margin: 1rem 0; }
        .student-info-options .toggle-control { margin-bottom: 0.8rem; }
        .student-info-options input[type="text"], 
        .student-info-options input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: var(--font-main);
            text-align: right;
            margin-top: 0.5rem;
        }
        /* END: Student Info Modal Specific Styles */

        /* START: Student Info Box Display Styles */
        .student-info-wrapper {
             margin-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
            padding: 15px;
            background-color: var(--page-bg);
            font-family: var(--font-main);
            direction: rtl;
            text-align: right;
            position: relative;
            z-index: 15;
        }

        .student-info-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .student-info-container.with-exam-score {
            display: grid;
            grid-template-columns: 1fr 100px;
            gap: 1rem;
            align-items: start;
            direction: rtl;
        }

        .student-info-container.with-exam-score .info-rows-container {
            display: contents;
        }

        .student-info-container.with-exam-score .info-row:nth-child(3),
        .student-info-container.with-exam-score .info-row:nth-child(n+3) {
            grid-column: 1 / -1;
        }

        .info-rows-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-row {
            display: flex;
            flex-direction: row;
            gap: 2rem;
            direction: rtl;
        }

        .info-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            flex: 1;
        }

        .info-name {
            font-size: 1.1rem;
            color: var(--text-color);
            white-space: nowrap;
            margin-left: 0;
        }

        .space {
            font-family: monospace;
            font-size: 0.9rem;
            flex: 1;
            margin-right: 0;
            display: inline-block;
            min-width: 100px;
              border-bottom: 1px solid #777;
            width: 100%;
            height: 1.2em;
        }

        .date-container,
        .score-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .date-space {
            flex: 0 0 auto;
        }

        .score-space {
            flex: 0 0 auto;
        }

        .date-separator,
        .score-separator {
            font-size: 1.1rem;
            color: var(--text-color);
            margin: 0 0.2rem;
        }

        .score-total {
            font-size: 1.1rem;
            color: var(--text-color);
            font-weight: bold;
        }

.exam-score-box {
            width: 80px;
            height: 80px;
            border: 2px solid var(--text-color);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            background-color: var(--page-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            grid-column: 2;
            grid-row: 1 / 3;
            align-self: start;
            justify-self: start;
        }

        .score-upper-half {
            flex: 1;
            border-bottom: 2px solid var(--text-color);
            border-radius: 10px 10px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-color);
        }

        .score-lower-half {
            flex: 1;
            border-radius: 0 0 10px 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--page-bg);
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        /* END: Student Info Box Display Styles */

        /* START: Page Watermark Styles */
        .page-watermark {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            overflow: hidden;
            z-index: 1;
        }
        .watermark-content-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 100%;
            max-height: 100%;
        }
        .watermark-content {
            font-weight: bold;
            color: rgba(0, 0, 0, 0.5);
            text-align: center;
            user-select: none;
            word-break: break-word;
            white-space: nowrap;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
        }
        .watermark-content.is-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            opacity: 0.5;
        }
        /* END: Page Watermark Styles */

        #poetry-prompt .kashida-toggle-container { text-align: right; margin-bottom: 1rem; display: flex; align-items: center; justify-content: flex-start; gap: 8px; }
        .toolbar-separator { width: 1px; height: 20px; background-color: #666; margin: 0 5px; }
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,.8); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #333; font-size: 1.2rem; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid var(--primary-color); width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* START: Floating Action Buttons (FAB) for View Control */
        #floating-controls { position: fixed; bottom: 30px; left: 30px; z-index: 500; display: flex; flex-direction: column; gap: 10px; }
        #floating-controls button { width: 50px; height: 50px; border-radius: 50%; border: none; background-color: var(--primary-color); color: white; font-size: 20px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: all 0.2s ease-in-out; }
        #floating-controls button:hover:not(:disabled) { background-color: #0056b3; transform: scale(1.1); }
        #floating-controls button:disabled { background-color: #6c757d; cursor: not-allowed; opacity: 0.6; }
        #floating-controls button:disabled:hover { transform: none; }
        #floating-controls button.active {
            background-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.3);
        }
        .floating-divider { width: 30px; height: 2px; background-color: var(--border-color); margin: 5px auto; border-radius: 1px; }
        
        /* Selection Mode Styles */
        body.selection-mode {
            user-select: none;
        }
        
        /* Allow contenteditable elements to remain functional in selection mode */
        body.selection-mode [contenteditable="false"][data-was-editable="true"] {
            pointer-events: none;
            user-select: none;
            opacity: 0.8;
            cursor: default !important;
        }
        
        /* But allow them to work when not in selection mode */
        body:not(.selection-mode) [contenteditable="true"] {
            pointer-events: auto !important;
            cursor: text !important;
        }
        
        /* Prevent text cursor in selection mode only for disabled elements */
        body.selection-mode [contenteditable="false"][data-was-editable="true"]:hover {
            cursor: default !important;
        }
        
        body.selection-mode .question-wrapper,
        body.selection-mode .reading-passage-wrapper,
        body.selection-mode .poetry-wrapper,
        body.selection-mode .question-list-header,
        body.selection-mode .page-title,
        body.selection-mode .student-info-wrapper {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            border: 2px solid transparent;
            z-index: 15;
        }
        
        /* Selection checkbox */
        body.selection-mode .question-wrapper::after,
        body.selection-mode .reading-passage-wrapper::after,
        body.selection-mode .poetry-wrapper::after,
        body.selection-mode .question-list-header::after,
        body.selection-mode .page-title::after,
        body.selection-mode .student-info-wrapper::after {
            content: "";
            position: absolute;
            top: 10px;
            left: 10px;
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            background-color: white;
            z-index: 20;
            transition: all 0.2s ease;
        }
        
        body.selection-mode .question-wrapper:hover,
        body.selection-mode .reading-passage-wrapper:hover,
        body.selection-mode .poetry-wrapper:hover,
        body.selection-mode .question-list-header:hover,
        body.selection-mode .page-title:hover,
        body.selection-mode .student-info-wrapper:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(41, 128, 185, 0.3);
            transform: translateY(-1px);
        }
        
        /* Hover effect on checkbox */
        body.selection-mode .question-wrapper:hover::after,
        body.selection-mode .reading-passage-wrapper:hover::after,
        body.selection-mode .poetry-wrapper:hover::after,
        body.selection-mode .question-list-header:hover::after,
        body.selection-mode .page-title:hover::after,
        body.selection-mode .student-info-wrapper:hover::after {
            background-color: rgba(41, 128, 185, 0.1);
        }
        
        .element-selected {
            background-color: rgba(41, 128, 185, 0.1) !important;
            border: 2px solid var(--primary-color) !important;
            box-shadow: 0 0 0 2px rgba(41, 128, 185, 0.3) !important;
        }
        
        /* Selected checkbox (filled) */
        .element-selected::after {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }
        
        /* Checkmark inside selected checkbox */
        .element-selected::before {
            content: "✓";
            position: absolute;
            top: 12px;
            left: 12px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            z-index: 21;
            line-height: 16px;
            text-align: center;
            width: 16px;
            height: 16px;
        }
        #selection-controls {
            position: fixed;
            bottom: 30px;
            left: 100px;
            z-index: 500;
            display: none;
            flex-direction: row;
            gap: 10px;
            align-items: center;
        }
        body.selection-mode #selection-controls {
            display: flex;
        }
        .selection-control-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background-color: var(--secondary-color);
            color: white;
            font-size: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.2s ease-in-out;
        }
        .selection-control-btn:hover:not(:disabled) {
            background-color: #5a6268;
            transform: scale(1.1);
        }
        .selection-control-btn:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .selection-control-btn:disabled:hover {
            transform: none;
        }
        .selection-info {
            background-color: var(--primary-color);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            white-space: nowrap;
        }
        
        /* Selection mode help tooltip */
        body.selection-mode::after {
            content: "انقر على العناصر لتحديدها أو مكان فارغ للخروج";
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            animation: fadeInOut 5s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            15%, 85% { opacity: 1; }
        }
        /* END: Floating Action Buttons */

        /* START: Action History Context Menu */
        #action-history-menu {
            position: absolute;
            z-index: 1000;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,.2);
            padding: 8px 0;
            min-width: 250px;
            max-width: 350px;
            max-height: 400px;
            overflow-y: auto;
            font-family: var(--font-main);
            border: 1px solid #ddd;
        }
        #action-history-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #action-history-menu li {
            padding: 8px 15px;
            cursor: pointer;
            font-size: .9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            border-right: 3px solid transparent;
            position: relative;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #action-history-menu li:hover {
            background-color: #f1f3f5;
        }
        #action-history-menu li.current {
            background-color: #e3f2fd;
            border-right-color: var(--primary-color);
            font-weight: bold;
        }
        #action-history-menu li.future {
            opacity: 0.6;
            color: #666;
        }
        #action-history-menu .action-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }
        #action-history-menu .action-text {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #action-history-menu .action-time {
            font-size: 0.75rem;
            color: #888;
            flex-shrink: 0;
        }
        
        /* Custom scrollbar for action history menu */
        #action-history-menu::-webkit-scrollbar {
            width: 6px;
        }
        #action-history-menu::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        #action-history-menu::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        #action-history-menu::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        /* END: Action History Context Menu */

        /* Save Dropdown Styles */
        .save-dropdown-container {
            position: relative;
            display: block;
            width: 100%;
        }
        
        .save-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow-color);
            z-index: 1000;
            margin-top: 5px;
        }
        
        .save-dropdown-option {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-align: right;
        }
        
        .save-dropdown-option:hover {
            background-color: #f8f9fa;
        }
        
        .save-dropdown-option:last-child {
            border-bottom: none;
            border-radius: 0 0 8px 8px;
        }
        
        .save-dropdown-option:first-child {
            border-radius: 8px 8px 0 0;
        }
        
        .save-option-title {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .save-option-desc {
            font-size: 0.8rem;
            color: var(--secondary-color);
            line-height: 1.3;
        }

    </style>
</head>
<body class=""> <!-- Start without sidebar-collapsed -->

    <div id="editor-action-buttons" class="">
        <button id="home-btn" class="editor-control-btn" title="العودة للرئيسية"><i class="fas fa-home"></i></button>
        <button id="toggle-sidebar-btn" class="editor-control-btn" title="إظهار/إخفاء الشريط الجانبي"><i class="fas fa-bars"></i></button>
        <button id="toggle-layout-sidebar-btn" class="editor-control-btn" title="إظهار/إخفاء شريط التخطيط"><i class="fas fa-th-large"></i></button>
        <button id="toggle-colors-sidebar-btn" class="editor-control-btn" title="إظهار/إخفاء شريط الألوان"><i class="fas fa-palette"></i></button>
        <button id="toggle-sizes-sidebar-btn" class="editor-control-btn" title="إظهار/إخفاء شريط الأحجام"><i class="fas fa-text-height"></i></button>
    </div>

    <div id="editor-screen">
        <aside id="sidebar">
            <div class="sidebar-header">
                <h3> <i class="fas fa-sliders"></i> لوحة التحكم </h3>
            </div>
            <div class="sidebar-content">
                <div class="control-group">
                    <h4>إجراءات</h4>
                    <div class="save-dropdown-container">
                        <button id="save-btn" class="control-btn"> <i class="fas fa-save"></i> حفظ </button>
                        <div id="save-dropdown" class="save-dropdown-menu hidden">
                            <div class="save-dropdown-option" id="save-as-pdf">
                                <div class="save-option-title">
                                    <i class="fas fa-file-pdf"></i>
                                    حفظ كـ PDF
                                </div>
                                <div class="save-option-desc">
                                    حفظ الورقة كملف PDF جاهز للطباعة
                                </div>
                            </div>
                            <div class="save-dropdown-option" id="save-as-waraqa">
                                <div class="save-option-title">
                                    <i class="fas fa-file-code"></i>
                                    حفظ وإكمال لاحقاً
                                </div>
                                <div class="save-option-desc">
                                    حفظ العمل بصيغة .waraqa للعودة إليه لاحقاً
                                </div>
                            </div>
                        </div>
                    </div>
                    <button id="add-from-excel-btn" class="control-btn"> <i class="fas fa-file-import"></i> إضافة أسئلة من Excel </button>
                    
                    <button id="add-title-btn" class="control-btn"><i class="fas fa-font"></i> إضافة عنوان رئيسي</button>
                    <button id="add-q-header-btn" class="control-btn"> <i class="fas fa-heading"></i> إضافة رأس للأسئلة </button>
                    <div class="control-btn-group">
                        <button id="add-question-btn" class="control-btn"> <i class="fas fa-plus"></i> إضافة سؤال اختياري </button>
                        <button id="question-defaults-settings-btn" class="settings-btn" title="الإعدادات الافتراضية للسؤال"> <i class="fas fa-cog"></i> </button>
                    </div>
                     <div class="control-btn-group">
                        <button id="add-essay-question-btn" class="control-btn"> <i class="fas fa-pen-alt"></i> إضافة سؤال مقالي </button>
                        <button id="essay-defaults-settings-btn" class="settings-btn" title="الإعدادات الافتراضية للسؤال المقالي"> <i class="fas fa-cog"></i> </button>
                    </div>

                    
                    <button id="add-passage-btn" class="control-btn"> <i class="fas fa-file-alt"></i> إضافة قطعة قراءة </button>
                    <button id="add-poetry-btn" class="control-btn"> <i class="fas fa-feather-alt"></i> إضافة نص شعري </button>
                    <button id="add-student-info-btn" class="control-btn"> <i class="fas fa-user-graduate"></i> إضافة صندوق معلومات الطالب </button>
                    <button id="add-watermark-btn" class="control-btn"> <i class="fas fa-stamp"></i> إضافة علامة مائية </button>

                </div>
            </div>
        </aside>
        
        <aside id="layout-sidebar">
            <div class="sidebar-header">
                <h3> <i class="fas fa-th-large"></i> إعدادات التخطيط </h3>
            </div>
            <div class="sidebar-content">
                <div class="control-group">
                    <h4> <i class="fas fa-border-style"></i> إطار الصفحة </h4>
                    <div class="toggle-control"> 
                        <label for="toggle-border-visibility">تفعيل إطار الصفحة</label> 
                        <label class="switch">
                            <input type="checkbox" id="toggle-border-visibility">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="border-controls">
                        <hr style="margin: 1rem 0;">
                        <h5 style="margin-bottom: 0.5rem; color: var(--primary-color);">نمط الإطار</h5>
                        <div class="toggle-control" style="margin-bottom: 10px;"> 
                            <label for="border-style-unified">تطبيق على جميع الحدود</label> 
                            <label class="switch">
                                <input type="checkbox" id="border-style-unified" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="unified-border-style">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem;">نمط جميع الحدود</label>
                            <div class="border-style-selector">
                                <div class="border-style-option selected" data-style="solid">
                                    <div class="border-style-preview" data-style="solid"></div>
                                    <div class="border-style-label">خط متصل</div>
                                </div>
                                <div class="border-style-option" data-style="dashed">
                                    <div class="border-style-preview" data-style="dashed"></div>
                                    <div class="border-style-label">خط متقطع</div>
                                </div>
                                <div class="border-style-option" data-style="dotted">
                                    <div class="border-style-preview" data-style="dotted"></div>
                                    <div class="border-style-label">خط نقاط</div>
                                </div>
                                <div class="border-style-option" data-style="double">
                                    <div class="border-style-preview" data-style="double"></div>
                                    <div class="border-style-label">خط مزدوج</div>
                                </div>
                                <div class="border-style-option" data-style="groove">
                                    <div class="border-style-preview" data-style="groove"></div>
                                    <div class="border-style-label">إطار غائر</div>
                                </div>
                                <div class="border-style-option" data-style="ridge">
                                    <div class="border-style-preview" data-style="ridge"></div>
                                    <div class="border-style-label">إطار بارز</div>
                                </div>
                                <div class="border-style-option" data-style="inset">
                                    <div class="border-style-preview" data-style="inset"></div>
                                    <div class="border-style-label">غاطس للداخل</div>
                                </div>
                                <div class="border-style-option" data-style="outset">
                                    <div class="border-style-preview" data-style="outset"></div>
                                    <div class="border-style-label">بارز للخارج</div>
                                </div>
                            </div>
                        </div>
                        <div id="individual-border-styles" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">الحد العلوي</label>
                                    <div class="border-style-selector" data-border-side="top">
                                        <div class="border-style-option" data-style="solid"><div class="border-style-preview" data-style="solid"></div></div>
                                        <div class="border-style-option" data-style="dashed"><div class="border-style-preview" data-style="dashed"></div></div>
                                        <div class="border-style-option" data-style="dotted"><div class="border-style-preview" data-style="dotted"></div></div>
                                        <div class="border-style-option" data-style="double"><div class="border-style-preview" data-style="double"></div></div>
                                        <div class="border-style-option" data-style="groove"><div class="border-style-preview" data-style="groove"></div></div>
                                        <div class="border-style-option" data-style="ridge"><div class="border-style-preview" data-style="ridge"></div></div>
                                        <div class="border-style-option" data-style="inset"><div class="border-style-preview" data-style="inset"></div></div>
                                        <div class="border-style-option" data-style="outset"><div class="border-style-preview" data-style="outset"></div></div>
                                    </div>
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">الحد الأيمن</label>
                                    <div class="border-style-selector" data-border-side="right">
                                        <div class="border-style-option" data-style="solid"><div class="border-style-preview" data-style="solid"></div></div>
                                        <div class="border-style-option" data-style="dashed"><div class="border-style-preview" data-style="dashed"></div></div>
                                        <div class="border-style-option" data-style="dotted"><div class="border-style-preview" data-style="dotted"></div></div>
                                        <div class="border-style-option" data-style="double"><div class="border-style-preview" data-style="double"></div></div>
                                        <div class="border-style-option" data-style="groove"><div class="border-style-preview" data-style="groove"></div></div>
                                        <div class="border-style-option" data-style="ridge"><div class="border-style-preview" data-style="ridge"></div></div>
                                        <div class="border-style-option" data-style="inset"><div class="border-style-preview" data-style="inset"></div></div>
                                        <div class="border-style-option" data-style="outset"><div class="border-style-preview" data-style="outset"></div></div>
                                    </div>
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">الحد السفلي</label>
                                    <div class="border-style-selector" data-border-side="bottom">
                                        <div class="border-style-option" data-style="solid"><div class="border-style-preview" data-style="solid"></div></div>
                                        <div class="border-style-option" data-style="dashed"><div class="border-style-preview" data-style="dashed"></div></div>
                                        <div class="border-style-option" data-style="dotted"><div class="border-style-preview" data-style="dotted"></div></div>
                                        <div class="border-style-option" data-style="double"><div class="border-style-preview" data-style="double"></div></div>
                                        <div class="border-style-option" data-style="groove"><div class="border-style-preview" data-style="groove"></div></div>
                                        <div class="border-style-option" data-style="ridge"><div class="border-style-preview" data-style="ridge"></div></div>
                                        <div class="border-style-option" data-style="inset"><div class="border-style-preview" data-style="inset"></div></div>
                                        <div class="border-style-option" data-style="outset"><div class="border-style-preview" data-style="outset"></div></div>
                                    </div>
                                </div>
                                <div>
                                    <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">الحد الأيسر</label>
                                    <div class="border-style-selector" data-border-side="left">
                                        <div class="border-style-option" data-style="solid"><div class="border-style-preview" data-style="solid"></div></div>
                                        <div class="border-style-option" data-style="dashed"><div class="border-style-preview" data-style="dashed"></div></div>
                                        <div class="border-style-option" data-style="dotted"><div class="border-style-preview" data-style="dotted"></div></div>
                                        <div class="border-style-option" data-style="double"><div class="border-style-preview" data-style="double"></div></div>
                                        <div class="border-style-option" data-style="groove"><div class="border-style-preview" data-style="groove"></div></div>
                                        <div class="border-style-option" data-style="ridge"><div class="border-style-preview" data-style="ridge"></div></div>
                                        <div class="border-style-option" data-style="inset"><div class="border-style-preview" data-style="inset"></div></div>
                                        <div class="border-style-option" data-style="outset"><div class="border-style-preview" data-style="outset"></div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr style="margin: 1rem 0;">
                        <h5 style="margin-bottom: 0.5rem; color: var(--primary-color);">ألوان الإطار</h5>
                        <div class="color-picker-grid">
                            <div class="color-control"> <label>لون الإطار</label> <div class="color-picker" id="page-border-color"></div> </div>
                            <div class="color-control"> <label>خلفية الخانات</label> <div class="color-picker" id="border-box-bg"></div> </div>
                            <div class="color-control"> <label>لون نص الخانات</label> <div class="color-picker" id="border-box-text-color"></div> </div>
                        </div>
                        <hr style="margin: 1rem 0;">
                        <h5 style="margin-bottom: 0.5rem; color: var(--primary-color);">أحجام الإطار</h5>
                        <div class="slider-control"> 
                            <label for="page-border-width">سُمك الإطار <span class="slider-value"></span></label> 
                            <div class="slider-input-group">
                                <button class="slider-btn minus">-</button>
                                <input type="range" id="page-border-width" min="1" max="10" value="2"> 
                                <button class="slider-btn plus">+</button>
                            </div>
                        </div>
                        <div class="slider-control"> 
                            <label for="page-border-radius">استدارة الأركان <span class="slider-value"></span></label> 
                            <div class="slider-input-group">
                                <button class="slider-btn minus">-</button>
                                <input type="range" id="page-border-radius" min="0" max="50" value="0"> 
                                <button class="slider-btn plus">+</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="control-group">
                    <h4> <i class="fas fa-window-maximize"></i> تخصيص الهيدر والفوتر </h4>
                    <div class="toggle-control"> 
                        <label for="toggle-header-visibility">عرض الهيدر</label> 
                        <label class="switch">
                            <input type="checkbox" id="toggle-header-visibility" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-control"> 
                        <label for="toggle-footer-visibility">عرض الفوتر</label> 
                        <label class="switch">
                            <input type="checkbox" id="toggle-footer-visibility" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="header-footer-controls">
                        <hr style="margin: 1rem 0;">
                        <h5 style="margin-bottom: 0.5rem; color: var(--primary-color);">ألوان الهيدر والفوتر</h5>
                    <div class="color-picker-grid">
                        <div class="color-control"> <label>خلفية الهيدر</label> <div class="color-picker" id="page-header-bg"></div> </div>
                        <div class="color-control"> <label>خلفية خانة الهيدر</label> <div class="color-picker" id="header-item-bg"></div> </div>
                        <div class="color-control"> <label>خلفية الفوتر</label> <div class="color-picker" id="page-footer-bg"></div> </div>
                        <div class="color-control"> <label>خلفية خانة الفوتر</label> <div class="color-picker" id="footer-item-bg"></div> </div>
                        <div class="color-control"> <label>لون نص الهيدر</label> <div class="color-picker" id="header-item-text-color"></div> </div>
                    </div>
                    <hr style="margin: 1rem 0;">
                    <h5 style="margin-bottom: 0.5rem; color: var(--primary-color);">أحجام الهيدر والفوتر</h5>
                    <div class="slider-control"> 
                        <label for="header-logo-height">ارتفاع الشعار بالهيدر<span class="slider-value"></span></label> 
                        <div class="slider-input-group">
                            <button class="slider-btn minus">-</button>
                            <input type="range" id="header-logo-height" min="15" max="50" value="25"> 
                            <button class="slider-btn plus">+</button>
                        </div>
                    </div>
                    <div class="slider-control"> 
                        <label for="header-text-fs">حجم نص الهيدر<span class="slider-value"></span></label> 
                        <div class="slider-input-group">
                            <button class="slider-btn minus">-</button>
                            <input type="range" id="header-text-fs" min="8" max="24" value="14"> 
                            <button class="slider-btn plus">+</button>
                        </div>
                    </div>
                    <div class="slider-control"> 
                        <label for="footer-text-fs">حجم نص الفوتر<span class="slider-value"></span></label> 
                        <div class="slider-input-group">
                            <button class="slider-btn minus">-</button>
                            <input type="range" id="footer-text-fs" min="8" max="20" value="12"> 
                            <button class="slider-btn plus">+</button>
                        </div>
                    </div>
                    </div>
                </div>
                <div class="control-group">
                    <h4> <i class="fas fa-hashtag"></i> عرض رقم الصفحة </h4>
                    <div class="toggle-control"> 
                        <label for="toggle-page-number-visibility">عرض رقم الصفحة</label> 
                        <label class="switch">
                            <input type="checkbox" id="toggle-page-number-visibility" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="page-number-controls">
                    <hr style="margin: 1rem 0;">
                    <h5 style="margin-bottom: 0.5rem; color: var(--primary-color);">ألوان رقم الصفحة</h5>
                    <div class="color-picker-grid">
                        <div class="color-control"> <label>لون رقم الصفحة</label> <div class="color-picker" id="page-num-color"></div> </div>
                        <div class="color-control"> <label>خلفية رقم الصفحة</label> <div class="color-picker" id="page-num-bg-color"></div> </div>
                    </div>
                    <hr style="margin: 1rem 0;">
                    <h5 style="margin-bottom: 0.5rem; color: var(--primary-color);">أحجام رقم الصفحة</h5>
                    <div class="slider-control"> 
                        <label for="page-num-fs">حجم رقم الصفحة<span class="slider-value"></span></label> 
                        <div class="slider-input-group">
                            <button class="slider-btn minus">-</button>
                            <input type="range" id="page-num-fs" min="8" max="20" value="12"> 
                            <button class="slider-btn plus">+</button>
                        </div>
                    </div>
                    <div class="slider-control"> 
                        <label for="page-num-circle-size">حجم دائرة رقم الصفحة<span class="slider-value"></span></label> 
                        <div class="slider-input-group">
                            <button class="slider-btn minus">-</button>
                            <input type="range" id="page-num-circle-size" min="20" max="50" value="30"> 
                            <button class="slider-btn plus">+</button>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </aside>
        
        <aside id="colors-sidebar">
            <div class="sidebar-header">
                <h3> <i class="fas fa-palette"></i> إعدادات الألوان </h3>
            </div>
            <div class="sidebar-content">
                <div class="control-group">
                    <h4> <i class="fas fa-font"></i> ألوان العناوين والنصوص </h4>
                    <div class="color-picker-grid">
                        <div class="color-control"> <label>لون نص العنوان</label> <div class="color-picker" id="page-title-text-color"></div> </div>
                        <div class="color-control"> <label>خلفية العنوان</label> <div class="color-picker" id="page-title-bg-color"></div> </div>
                        <div class="color-control"> <label>لون إطار العنوان</label> <div class="color-picker" id="page-title-border-color"></div> </div>
                        <div class="color-control"> <label>لون النص الشعري</label> <div class="color-picker" id="poetry-text-color"></div> </div>
                        <div class="color-control"> <label>لون رقم البيت</label> <div class="color-picker" id="poetry-num-color"></div> </div>
                        <div class="color-control"> <label>لون رقم السطر</label> <div class="color-picker" id="passage-line-num-color"></div> </div>
                    </div>
                </div>
                <div class="control-group">
                    <h4> <i class="fas fa-question-circle"></i> ألوان الأسئلة والإجابات </h4>
                    <div class="color-picker-grid">
                        <div class="color-control"> <label>لون نص السؤال</label> <div class="color-picker" id="question-text-color"></div> </div>
                        <div class="color-control"> <label>لون رقم السؤال</label> <div class="color-picker" id="question-num-color"></div> </div>
                        <div class="color-control"> <label>خلفية رقم السؤال</label> <div class="color-picker" id="question-num-bg"></div> </div>
                        <div class="color-control"> <label>لون العبارة التمهيدية</label> <div class="color-picker" id="statement-text-color"></div> </div>
                        <div class="color-control"> <label>خلفية العبارة التمهيدية</label> <div class="color-picker" id="statement-bg-color"></div> </div>
                        <div class="color-control"> <label>لون رأس الإجابة</label> <div class="color-picker" id="answer-head-color"></div> </div>
                        <div class="color-control"> <label>خلفية رأس الإجابة</label> <div class="color-picker" id="answer-head-bg"></div> </div>
                        <div class="color-control"> <label>لون نص الإجابة</label> <div class="color-picker" id="answer-text-color"></div> </div>
                        <div class="color-control"> <label>لون إطار السؤال</label> <div class="color-picker" id="question-border-color"></div> </div>
                    </div>
                </div>
                <div class="control-group">
                    <h4> <i class="fas fa-highlighter"></i> لون التظليل </h4>
                    <div class="color-control"> <label>لون تظليل النص</label> <div class="color-picker" id="sidebar-highlight-color-picker"></div> </div>
                </div>
            </div>
        </aside>
        
        <aside id="sizes-sidebar">
            <div class="sidebar-header">
                <h3> <i class="fas fa-text-height"></i> إعدادات الأحجام </h3>
            </div>
            <div class="sidebar-content">
                <div class="control-group">
                    <h4> <i class="fas fa-font"></i> أحجام العناوين والنصوص </h4>
                    <div class="slider-control"> 
                        <label for="title-fs">حجم العنوان الرئيسي<span class="slider-value"></span></label> 
                        <div class="slider-input-group">
                            <button class="slider-btn minus">-</button>
                            <input type="range" id="title-fs" min="20" max="50" value="32"> 
                            <button class="slider-btn plus">+</button>
                        </div>
                    </div>
                    <div class="slider-control"> 
                        <label for="q-header-fs">حجم رأس الأسئلة<span class="slider-value"></span></label> 
                        <div class="slider-input-group">
                            <button class="slider-btn minus">-</button>
                            <input type="range" id="q-header-fs" min="12" max="30" value="18"> 
                            <button class="slider-btn plus">+</button>
                        </div>
                    </div>
                    <div class="slider-control"> 
                        <label for="passage-text-fs">حجم نص قطعة القراءة<span class="slider-value"></span></label> 
                        <div class="slider-input-group">
                            <button class="slider-btn minus">-</button>
                            <input type="range" id="passage-text-fs" min="10" max="24" value="16"> 
                            <button class="slider-btn plus">+</button>
                        </div>
                    </div>
                    <div class="slider-control"> 
                        <label for="passage-line-num-fs">حجم رقم السطر<span class="slider-value"></span></label> 
                        <div class="slider-input-group">
                            <button class="slider-btn minus">-</button>
                            <input type="range" id="passage-line-num-fs" min="8" max="18" value="12"> 
                            <button class="slider-btn plus">+</button>
                        </div>
                    </div>
                    <div class="slider-control"> 
                        <label for="poetry-text-fs">حجم النص الشعري<span class="slider-value"></span></label> 
                        <div class="slider-input-group">
                            <button class="slider-btn minus">-</button>
                            <input type="range" id="poetry-text-fs" min="14" max="30" value="20"> 
                            <button class="slider-btn plus">+</button>
                        </div>
                    </div>
                    <div class="slider-control"> 
                        <label for="poetry-num-fs">حجم رقم البيت<span class="slider-value"></span></label> 
                        <div class="slider-input-group">
                            <button class="slider-btn minus">-</button>
                            <input type="range" id="poetry-num-fs" min="10" max="20" value="14"> 
                            <button class="slider-btn plus">+</button>
                        </div>
                    </div>
                </div>
                <div class="control-group">
                    <h4> <i class="fas fa-question-circle"></i> أحجام الأسئلة والإجابات </h4>
                    <div class="slider-control"> 
                        <label for="question-num-fs">حجم رقم السؤال<span class="slider-value"></span></label> 
                        <div class="slider-input-group">
                            <button class="slider-btn minus">-</button>
                            <input type="range" id="question-num-fs" min="12" max="28" value="18"> 
                            <button class="slider-btn plus">+</button>
                        </div>
                    </div>
                    <div class="slider-control"> 
                        <label for="question-text-fs">حجم نص السؤال<span class="slider-value"></span></label> 
                        <div class="slider-input-group">
                            <button class="slider-btn minus">-</button>
                            <input type="range" id="question-text-fs" min="12" max="28" value="18"> 
                            <button class="slider-btn plus">+</button>
                        </div>
                    </div>
                    <div class="slider-control"> 
                        <label for="statement-fs">حجم العبارة التمهيدية<span class="slider-value"></span></label> 
                        <div class="slider-input-group">
                            <button class="slider-btn minus">-</button>
                            <input type="range" id="statement-fs" min="14" max="30" value="20"> 
                            <button class="slider-btn plus">+</button>
                        </div>
                    </div>
                    <div class="slider-control"> 
                        <label for="answer-head-fs">حجم رأس الإجابة<span class="slider-value"></span></label> 
                        <div class="slider-input-group">
                            <button class="slider-btn minus">-</button>
                            <input type="range" id="answer-head-fs" min="12" max="24" value="16"> 
                            <button class="slider-btn plus">+</button>
                        </div>
                    </div>
                    <div class="slider-control"> 
                        <label for="answer-text-fs">حجم نص الإجابة<span class="slider-value"></span></label> 
                        <div class="slider-input-group">
                            <button class="slider-btn minus">-</button>
                            <input type="range" id="answer-text-fs" min="12" max="24" value="16"> 
                            <button class="slider-btn plus">+</button>
                        </div>
                    </div>
                    <div class="slider-control"> 
                        <label for="answer-head-circle-size">حجم دائرة رأس الإجابة<span class="slider-value"></span></label> 
                        <div class="slider-input-group">
                            <button class="slider-btn minus">-</button>
                            <input type="range" id="answer-head-circle-size" min="20" max="40" value="28"> 
                            <button class="slider-btn plus">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        
        <main id="main-content">
            <div id="pages-container"></div>
        </main>
        
        <!-- START: Floating Controls -->
        <div id="floating-controls">
            <button id="selection-mode-btn" title="وضع تحديد العناصر"><i class="fas fa-mouse-pointer"></i></button>
            <div class="floating-divider"></div>
            <button id="undo-btn" title="تراجع" disabled><i class="fas fa-undo"></i></button>
            <button id="redo-btn" title="إعادة" disabled><i class="fas fa-redo"></i></button>
            <div class="floating-divider"></div>
            <button id="zoom-in-btn" title="تكبير"><i class="fas fa-search-plus"></i></button>
            <button id="zoom-out-btn" title="تصغير"><i class="fas fa-search-minus"></i></button>
            <button id="fullscreen-btn" title="وضع ملء الشاشة"><i class="fas fa-expand"></i></button>
        </div>
        
        <!-- Selection Mode Controls -->
        <div id="selection-controls">
            <div class="selection-info">لم يتم تحديد عناصر</div>
            <button id="move-up-btn" class="selection-control-btn" title="نقل لأعلى" disabled><i class="fas fa-arrow-up"></i></button>
            <button id="move-down-btn" class="selection-control-btn" title="نقل لأسفل" disabled><i class="fas fa-arrow-down"></i></button>
            <button id="copy-btn" class="selection-control-btn" title="نسخ العناصر المحددة" disabled><i class="fas fa-copy"></i></button>
            <button id="delete-selected-btn" class="selection-control-btn" title="حذف العناصر المحددة" disabled><i class="fas fa-trash"></i></button>
            <button id="paste-btn" class="selection-control-btn" title="لصق العناصر" disabled><i class="fas fa-paste"></i></button>
        </div>
        <!-- END: Floating Controls -->
    </div>

    <!-- Enhanced Text Formatting Toolbar -->
    <div id="text-format-toolbar">
        <!-- Font Selection Section -->
        <div class="toolbar-section">
            <label>الخط:</label>
            <div id="font-selector">
                <button id="font-dropdown-btn" type="button">
                    <span id="current-font-name">الخط الأميري</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div id="font-dropdown">
                    <div class="font-option" data-font="Amiri" style="font-family: 'Amiri', serif;">الخط الأميري</div>
                    <div class="font-option" data-font="Scheherazade" style="font-family: 'Scheherazade', serif;">خط شهرزاد</div>
                    <div class="font-option" data-font="Tajawal" style="font-family: 'Tajawal', sans-serif;">خط تجوال</div>
                    <div class="font-option" data-font="Alfarooq" style="font-family: 'Alfarooq', serif;">خط الفاروق</div>
                    <div class="font-option" data-font="Arbaeen" style="font-family: 'Arbaeen', serif;">خط أربعين</div>
                    <div class="font-option" data-font="Castile" style="font-family: 'Castile', serif;">خط كاستيل</div>
                    <div class="font-option" data-font="Droid Arabic Kufi" style="font-family: 'Droid Arabic Kufi', serif;">درويد كوفي</div>
                    <div class="font-option" data-font="Droid Arabic Naskh" style="font-family: 'Droid Arabic Naskh', serif;">درويد نسخ</div>
                    <div class="font-option" data-font="HS Al Basim A" style="font-family: 'HS Al Basim A', serif;">الباسم أ</div>
                    <div class="font-option" data-font="HS Al Basim B" style="font-family: 'HS Al Basim B', serif;">الباسم ب</div>
                    <div class="font-option" data-font="Hasan Alquds Unicode" style="font-family: 'Hasan Alquds Unicode', serif;">حسن القدس</div>
                    <div class="font-option" data-font="Hasan Hiba" style="font-family: 'Hasan Hiba', serif;">حسن هبة</div>
                    <div class="font-option" data-font="Nusaibah" style="font-family: 'Nusaibah', serif;">نصيبة</div>
                    <div class="font-option" data-font="Samman" style="font-family: 'Samman', serif;">سمان</div>
                    <div class="font-option" data-font="Sonbili" style="font-family: 'Sonbili', serif;">سنبلي</div>
                    <div class="font-option" data-font="Abdo Logo" style="font-family: 'Abdo Logo', serif;">عبده لوجو</div>
                </div>
            </div>
        </div>

        <!-- Text Color Section -->
        <div class="toolbar-section">
            <label>اللون:</label>
            <div id="text-color-picker" class="pickr-text-color"></div>
        </div>

        <!-- Formatting Options Section -->
        <div class="toolbar-section">
            <button id="bold-btn" data-command="bold" title="غامق"><i class="fas fa-bold"></i></button>
            <button id="italic-btn" data-command="italic" title="مائل"><i class="fas fa-italic"></i></button>
            <button id="underline-btn" data-command="underline" title="تسطير"><i class="fas fa-underline"></i></button>
        </div>

        <!-- Highlight Section -->
        <div class="toolbar-section">
            <label>التظليل:</label>
            <div id="text-highlight-picker" class="pickr-highlight-color"></div>
            <button id="highlight-btn" data-command="highlight" title="تظليل"><i class="fas fa-highlighter"></i></button>
        </div>

        <!-- Opacity Section -->
        <div class="toolbar-section" style="display: flex; align-items: center; gap: 8px; min-width: 130px;">
            <label style="font-size: 0.7rem; white-space: nowrap;">الشفافية:</label>
            <input type="range" id="text-opacity-slider" class="opacity-slider" min="0" max="100" value="100" title="شفافية النص">
            <span id="opacity-value" style="color:white;font-size: 0.7rem; min-width: 30px; white-space: nowrap;">100%</span>
        </div>

        <!-- Clipboard Operations Section -->
        <div class="toolbar-section">
            <button id="copy-text-btn" title="نسخ"><i class="fas fa-copy"></i></button>
            <button id="cut-text-btn" title="قص"><i class="fas fa-cut"></i></button>
            <button id="paste-text-btn" title="لصق"><i class="fas fa-paste"></i></button>
        </div>

        <!-- Close Button -->
        <button class="toolbar-close" id="close-toolbar-btn" title="إغلاق"><i class="fas fa-times"></i></button>
    </div>
    <div id="custom-context-menu" class="hidden">
        <ul>
            <li id="ctx-delete-header" class="danger hidden"><i class="fas fa-trash"></i> <span>حذف العنوان</span></li>
            <li id="ctx-set-page-number" class="hidden"><i class="fas fa-sort-numeric-down"></i> <span>بدء ترقيم الصفحات من...</span></li>
            <li id="ctx-replace-with-logo" class="hidden"><i class="fas fa-image"></i> <span>استبدال بشعار</span></li>
            <li id="ctx-add-hf-box" class="hidden"><i class="fas fa-plus"></i> <span>إضافة خانة</span></li>
            <li id="ctx-delete-hf-box" class="danger hidden"><i class="fas fa-trash"></i> <span>حذف الخانة</span></li>
            <li id="ctx-delete-border-box" class="danger hidden"><i class="fas fa-trash"></i> <span>حذف خانة الإطار</span></li>
            <li id="ctx-add-border-text-box" class="hidden"><i class="fas fa-plus"></i> <span>إضافة خانة نص</span></li>
            <li id="ctx-hf-separator" class="hidden"><hr></li>

            <li id="ctx-upload-image" class="hidden"><i class="fas fa-upload"></i> <span>إضافة/تغيير صورة (من الجهاز)</span></li>
            <li id="ctx-add-image-url" class="hidden"><i class="fas fa-link"></i> <span>إضافة/تغيير صورة (من رابط)</span></li>
            <li id="ctx-delete-image" class="hidden"><i class="fas fa-trash-alt"></i> <span>حذف الصورة</span></li>
            <li id="ctx-add-statement" class="hidden"><i class="fas fa-quote-left"></i> <span>إضافة عبارة فارغة</span></li>
            <li id="ctx-delete-statement" class="hidden"><i class="fas fa-trash-alt"></i> <span>حذف العبارة</span></li>
            <li id="ctx-toggle-kashida" class="hidden"><i class="fas fa-text-width"></i> <span>تفعيل/إلغاء تمديد النص</span></li>
            <li id="ctx-separator-1" class="hidden"><hr></li>
            <li id="ctx-change-layout" class="hidden"> <i class="fas fa-th-large"></i> <span>تعديل نمط الإجابات</span> <ul id="ctx-layout-submenu"> 
                <li data-layout="1">
                    <img src="assets/icons/layout1.svg" alt="نمط 1" style="width: 1em; vertical-align: middle; margin-left: 0.5em;">
                    نمط 1 (عمودي)
                </li>
                <li data-layout="2">
                    <img src="assets/icons/layout2.svg" alt="نمط 2" style="width: 1em; vertical-align: middle; margin-left: 0.5em;">
                    نمط 2 (عمودان)
                </li>
                <li data-layout="3">
                    <img src="assets/icons/layout3.svg" alt="نمط 3" style="width: 1em; vertical-align: middle; margin-left: 0.5em;">
                    نمط 3 (أفقي)
                </li>
            </ul> </li>
            <li id="ctx-set-essay-lines" class="hidden"><i class="fas fa-bars"></i> <span>تحديد عدد أسطر الإجابة</span></li>
            <li id="ctx-set-start-number" class="hidden"><i class="fas fa-sort-numeric-down"></i> <span>بدء العد من رقم محدد...</span></li>
            <li id="ctx-cancel-restart-numbering" class="hidden"><i class="fas fa-times"></i> <span>إلغاء العد المخصص</span></li>
            <li id="ctx-edit-student-info" class="hidden"><i class="fas fa-edit"></i> <span>تعديل العناصر المضمنة</span></li>
            <li id="ctx-separator-2" class="hidden"><hr></li>
            <li id="ctx-move-up"><i class="fas fa-arrow-up"></i> <span>نقل لأعلى</span></li>
            <li id="ctx-move-down"><i class="fas fa-arrow-down"></i> <span>نقل لأسفل</span></li>
            <li id="ctx-separator-3"><hr></li>
            <li id="ctx-delete-item" class="danger"><i class="fas fa-times-circle"></i> <span>حذف العنصر</span></li>
        </ul>
    </div>
    
    <!-- Action History Context Menu -->
    <div id="action-history-menu" class="hidden">
        <ul id="action-history-list">
            <!-- Action history items will be populated here -->
        </ul>
    </div>
    <div id="custom-prompt-overlay" class="hidden">
        <div id="custom-prompt">
            <h4 id="prompt-title">العنوان</h4>
            <p id="prompt-text">النص</p>
            <input type="text" id="prompt-input">
            <div class="prompt-buttons">
                <button id="prompt-cancel">إلغاء</button>
                <button id="prompt-ok">موافق</button>
            </div>
        </div>
    </div>
    <div id="reading-passage-prompt-overlay" class="hidden">
        <div id="reading-passage-prompt">
            <h4>إضافة قطعة قراءة</h4>
            <p>أدخل نص القطعة وحدد عدد الأسئلة المرتبطة بها.</p>
            <textarea id="passage-prompt-text" placeholder="أدخل نص قطعة القراءة هنا..."></textarea>
            <input type="number" id="passage-prompt-q-count" placeholder="عدد الأسئلة" min="1" value="1">
            <div class="prompt-buttons">
                <button id="passage-prompt-cancel">إلغاء</button>
                <button id="passage-prompt-ok">أضف</button>
            </div>
        </div>
    </div>
    <div id="poetry-prompt-overlay" class="hidden">
        <div id="poetry-prompt">
            <h4>إضافة نص شعري</h4>
            <p>أدخل النص الشعري، افصل بين الشطرين بمسافة طويلة (مسطرة مرتين أو أكثر) وأدخل كل بيت في سطر جديد. ثم حدد عدد الأسئلة المرتبطة به.</p>
            <textarea id="poetry-prompt-text" placeholder="الشطر الأول   الشطر الثاني..."></textarea>
            <div class="kashida-toggle-container">
                <label for="poetry-prompt-kashida-toggle">تفعيل تمديد النص</label>
                <label class="switch">
                    <input type="checkbox" id="poetry-prompt-kashida-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <input type="number" id="poetry-prompt-q-count" placeholder="عدد الأسئلة" min="0" value="1">
            <div class="prompt-buttons">
                <button id="poetry-prompt-cancel">إلغاء</button>
                <button id="poetry-prompt-ok">أضف</button>
            </div>
        </div>
    </div>
    <div id="watermark-prompt-overlay" class="hidden">
        <div id="watermark-prompt">
            <h4>إعدادات العلامة المائية</h4>
            <div class="watermark-type-selector">
                <label><input type="radio" name="watermark-type" value="text" checked> نص</label>
                <label><input type="radio" name="watermark-type" value="image"> صورة</label>
            </div>
            <div id="watermark-text-control">
                <input type="text" id="watermark-text-input" placeholder="أدخل نص العلامة المائية">
            </div>
            <div id="watermark-image-control" class="hidden">
                <button id="watermark-image-upload-btn" class="secondary-btn">اختر صورة...</button>
                <input type="file" id="watermark-image-input" accept="image/*" style="display:none">
                <span id="watermark-image-name">لم يتم اختيار صورة</span>
            </div>
            <div id="watermark-size-slider-control" class="slider-control">
                <label for="watermark-size"><span id="watermark-size-label">حجم الخط</span> <span class="slider-value">80</span></label>
                <input type="range" id="watermark-size" min="20" max="200" step="2" value="80" data-unit="px">
            </div>
            <div class="slider-control">
                <label for="watermark-opacity">الشفافية <span class="slider-value">0.25</span></label>
                <input type="range" id="watermark-opacity" min="0" max="1" step="0.05" value="0.25">
            </div>
            <div class="slider-control">
                <label for="watermark-rotation">زاوية الدوران <span class="slider-value">0</span></label>
                <input type="range" id="watermark-rotation" min="-90" max="90" step="1" value="0">
            </div>
            <div class="prompt-buttons">
                <button id="watermark-prompt-remove" class="secondary-btn" style="background-color: #ffe3e3; color: #d90429;">إزالة العلامة</button>
                <button id="watermark-prompt-cancel">إلغاء</button>
                <button id="watermark-prompt-ok">تطبيق</button>
            </div>
        </div>
    </div>
    <!-- Student Information Box Prompt -->
    <div id="student-info-prompt-overlay" class="hidden">
        <div id="student-info-prompt">
            <h4>إعدادات صندوق معلومات الطالب</h4>
            <p>اختر العناصر التي تريد تضمينها في صندوق معلومات الطالب:</p>
            
            <div class="student-info-options">
                <div class="toggle-control select-all-control">
                    <label for="select-all-fields">تحديد الكل (ما عدا العنصر المخصص)</label>
                    <label class="switch">
                        <input type="checkbox" id="select-all-fields">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <hr style="margin: 1rem 0; border: 1px solid #eee;">
                
                <div class="toggle-control">
                    <label for="include-student-name">اسم الطالب (سطر فارغ)</label>
                    <label class="switch">
                        <input type="checkbox" id="include-student-name" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="toggle-control">
                    <label for="include-group-name">اسم المجموعة (سطر فارغ)</label>
                    <label class="switch">
                        <input type="checkbox" id="include-group-name">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="toggle-control">
                    <label for="include-grade-level">الصف الدراسي (سطر فارغ)</label>
                    <label class="switch">
                        <input type="checkbox" id="include-grade-level">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="toggle-control">
                    <label for="include-student-code">كود الطالب (سطر فارغ)</label>
                    <label class="switch">
                        <input type="checkbox" id="include-student-code">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="toggle-control">
                    <label for="include-date">تاريخ اليوم (__ / __ / ____)</label>
                    <label class="switch">
                        <input type="checkbox" id="include-date">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="toggle-control">
                    <label for="include-exam-score">درجة الامتحان (مربع مقسوم)</label>
                    <label class="switch">
                        <input type="checkbox" id="include-exam-score">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="toggle-control" id="exam-score-settings" style="display: none; margin-right: 20px;">
                    <label>الدرجة النهائية:</label>
                    <input type="number" id="exam-total-score" placeholder="ادخل الدرجة النهائية" min="1" value="">
                </div>
                
                <div class="toggle-control">
                    <label for="include-custom-field">عنصر مخصص (غير متضمن في النموذج)</label>
                    <label class="switch">
                        <input type="checkbox" id="include-custom-field">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="toggle-control" id="custom-field-settings" style="display: none; margin-right: 20px;">
                    <label>عنوان العنصر:</label>
                    <input type="text" id="custom-field-label" placeholder="ادخل عنوان العنصر">
                </div>
            </div>
            
            <div class="prompt-buttons">
                <button id="student-info-cancel">إلغاء</button>
                <button id="student-info-ok">إضافة</button>
            </div>
        </div>
    </div>
    <!-- START: Question Defaults Prompt -->
    <div id="question-defaults-prompt-overlay" class="hidden">
        <div id="question-defaults-prompt">
            <h4>إعدادات السؤال الاختياري الافتراضية</h4>
            <div class="prompt-setting-group">
                <h5>العبارة التمهيدية</h5>
                <div class="toggle-control">
                    <label for="default-statement-toggle">إضافة عبارة تمهيدية مع كل سؤال جديد</label>
                    <label class="switch">
                        <input type="checkbox" id="default-statement-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
             <div class="prompt-setting-group">
                <h5>نمط الإجابات الافتراضي</h5>
                <div id="default-layout-selector">
                    <span>
                        <input type="radio" id="default-layout-1" name="default-layout" value="1">
                        <label for="default-layout-1">
                            <img src="assets/icons/layout1.svg" alt="نمط عمودي">عمودي
                        </label>
                    </span>
                     <span>
                        <input type="radio" id="default-layout-2" name="default-layout" value="2">
                        <label for="default-layout-2">
                             <img src="assets/icons/layout2.svg" alt="نمط عمودان">عمودان
                        </label>
                    </span>
                     <span>
                        <input type="radio" id="default-layout-3" name="default-layout" value="3">
                        <label for="default-layout-3">
                             <img src="assets/icons/layout3.svg" alt="نمط أفقي">أفقي
                        </label>
                    </span>
                </div>
            </div>
            <div class="prompt-buttons">
                <button id="q-defaults-prompt-cancel">إلغاء</button>
                <button id="q-defaults-prompt-ok">حفظ</button>
            </div>
        </div>
    </div>
    <!-- END: Question Defaults Prompt -->

    <!-- START: Essay Question Defaults Prompt -->
    <div id="essay-defaults-prompt-overlay" class="hidden">
        <div id="essay-defaults-prompt">
            <h4>إعدادات السؤال المقالي الافتراضية</h4>
            <div class="prompt-setting-group">
                <h5>العبارة التمهيدية</h5>
                <div class="toggle-control">
                    <label for="e-default-statement-toggle">إضافة عبارة تمهيدية مع كل سؤال مقالي جديد</label>
                    <label class="switch">
                        <input type="checkbox" id="e-default-statement-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="prompt-setting-group">
                <h5>عدد أسطر الإجابة الافتراضي</h5>
                <div class="prompt-input-group">
                     <label for="e-default-lines-input">عدد الأسطر</label>
                     <input type="number" id="e-default-lines-input" min="1" max="15" value="2">
                </div>
            </div>
            <div class="prompt-buttons">
                <button id="e-defaults-prompt-cancel">إلغاء</button>
                <button id="e-defaults-prompt-ok">حفظ</button>
            </div>
        </div>
    </div>
    <!-- END: Essay Question Defaults Prompt -->
    
    <!-- START: Border Box Position Prompt -->
    <div id="border-box-position-prompt-overlay" class="hidden">
        <div id="border-box-position-prompt">
            <h4>تغيير موقع خانة الإطار</h4>
            <div class="prompt-setting-group">
                <h5>اختر موقع الخانة</h5>
                <div id="border-position-selector">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 1rem 0;">
                        <label style="padding: 10px; border: 2px solid #ccc; border-radius: 8px; text-align: center; cursor: pointer;">
                            <input type="radio" name="border-position" value="top-left" style="display: none;">
                            <i class="fas fa-arrow-up" style="transform: rotate(-45deg);"></i><br>
                            أعلى يسار
                        </label>
                        <label style="padding: 10px; border: 2px solid #ccc; border-radius: 8px; text-align: center; cursor: pointer;">
                            <input type="radio" name="border-position" value="top-center" style="display: none;">
                            <i class="fas fa-arrow-up"></i><br>
                            أعلى وسط
                        </label>
                        <label style="padding: 10px; border: 2px solid #ccc; border-radius: 8px; text-align: center; cursor: pointer;">
                            <input type="radio" name="border-position" value="top-right" style="display: none;">
                            <i class="fas fa-arrow-up" style="transform: rotate(45deg);"></i><br>
                            أعلى يمين
                        </label>
                        <label style="padding: 10px; border: 2px solid #ccc; border-radius: 8px; text-align: center; cursor: pointer;">
                            <input type="radio" name="border-position" value="bottom-left" style="display: none;">
                            <i class="fas fa-arrow-down" style="transform: rotate(45deg);"></i><br>
                            أسفل يسار
                        </label>
                        <label style="padding: 10px; border: 2px solid #ccc; border-radius: 8px; text-align: center; cursor: pointer;">
                            <input type="radio" name="border-position" value="bottom-center" style="display: none;">
                            <i class="fas fa-arrow-down"></i><br>
                            أسفل وسط
                        </label>
                        <label style="padding: 10px; border: 2px solid #ccc; border-radius: 8px; text-align: center; cursor: pointer;">
                            <input type="radio" name="border-position" value="bottom-right" style="display: none;">
                            <i class="fas fa-arrow-down" style="transform: rotate(-45deg);"></i><br>
                            أسفل يمين
                        </label>
                    </div>
                </div>
            </div>
            <div class="prompt-buttons">
                <button id="border-position-prompt-cancel">إلغاء</button>
                <button id="border-position-prompt-ok">حفظ</button>
            </div>
        </div>
    </div>
    <!-- END: Border Box Position Prompt -->
    
    <div id="loader-overlay" class="hidden"> <div class="loader"></div> <p>جاري تحويل الصفحات إلى صور...</p> </div>
    <input type="file" id="image-upload-input" accept="image/*" style="display:none">

    <!-- External Libraries -->
    <script src="libraries/xlsx.full.min.js"></script>
    <script src="libraries/pickr.min.js"></script>
    <script src="libraries/jspdf.umd.min.js"></script>
    <script src="libraries/html2canvas.min.js"></script>
    
    <!-- Embedded JS -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Reset scroll position to top on page load
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            
            let pageContent = [];
            let history = [];
            let redoStack = [];
            let actionHistory = []; // Enhanced action history with Arabic names
            let currentActionIndex = -1; // Current position in action history
            let isInitialized = false; // Flag to prevent recording during initialization
            let currentContextMenuTarget = null;
            let currentSelectionRange = null; // For the text format toolbar
            let startPageNumber = 1;
            let excelImportMode = 'replace';
            let currentZoomLevel = 1.0;
            // A temporary object to know where to place an uploaded image
            let imageUploadContext = null;
            
            // Selection mode variables
            let isSelectionMode = false;
            let selectedElementIds = new Set();
            let clipboard = null; // For storing copied elements
            const selectableTypes = ['question', 'essayQuestion', 'questionHeader', 'readingPassage', 'poeticText', 'pageTitle', 'student-info'];

            // Updated State: Header items can be 'text' or 'logo' - Start with empty headers/footers disabled by default
            let headerFooterState = {
                header: { 
                    visible: false, // Start with header disabled
                    items: [] // Start with no header boxes
                },
                footer: { 
                    visible: false, // Start with footer disabled
                    items: [] // Start with no footer boxes
                }
            };
            
            let watermarkState = { type: 'text', content: '', opacity: 0.25, rotation: 0, size: 80, visible: false, imageName: '', imageData: null };
            
            // Page Border State
            let borderState = {
                enabled: false,
                width: 2,
                color: '#333333',
                radius: 0,
                style: 'solid',
                unifiedStyle: true,
                topStyle: 'solid',
                rightStyle: 'solid',
                bottomStyle: 'solid',
                leftStyle: 'solid',
                boxes: [] // Array of border boxes with position, content, etc.
            };
            
            let pageNumberVisible = true;
            
            let mcqDefaults = {
                includeStatement: false,
                defaultLayout: '3'
            };
            
            let essayDefaults = {
                includeStatement: false,
                defaultLines: 2
            };

            let kashidaObserver;
            let canvas, ctx;
            const kashida = '\u0640';
            const diacritics = 'ًٌٍَُِّْ';
            const noKashidaBefore = "ءأإآاوىة.:،؛!؟-()[]{}'\"0123456789 ";
            const noKashidaAfter = "ءأإآادذرزوؤةى.:،؛!؟-()[]{}'\" ";

            // DOM Elements with immediate validation
            const editorActionButtons = document.getElementById("editor-action-buttons");
            const editorScreen = document.getElementById("editor-screen");
            const imageUploadInput = document.getElementById("image-upload-input");
            const homeBtn = document.getElementById("home-btn");
            const toggleSidebarBtn = document.getElementById("toggle-sidebar-btn");
            const toggleLayoutSidebarBtn = document.getElementById("toggle-layout-sidebar-btn");
            const toggleColorsSidebarBtn = document.getElementById("toggle-colors-sidebar-btn");
            const toggleSizesSidebarBtn = document.getElementById("toggle-sizes-sidebar-btn");
            const pagesContainer = document.getElementById("pages-container");
            const saveBtn = document.getElementById("save-btn");
            const saveDropdown = document.getElementById("save-dropdown");
            const saveAsPdfOption = document.getElementById("save-as-pdf");
            const saveAsWaraqaOption = document.getElementById("save-as-waraqa");
            const addFromExcelBtn = document.getElementById("add-from-excel-btn");
            const addTitleBtn = document.getElementById("add-title-btn");
            const addQuestionBtn = document.getElementById("add-question-btn");
            
            // Critical button elements with validation
            const qDefaultsSettingsBtn = document.getElementById('question-defaults-settings-btn');

            
            const addEssayQuestionBtn = document.getElementById("add-essay-question-btn");
            const essayDefaultsSettingsBtn = document.getElementById('essay-defaults-settings-btn');

            
            const addQHeaderBtn = document.getElementById("add-q-header-btn");
            
            const addPassageBtn = document.getElementById("add-passage-btn");

            
            const addPoetryBtn = document.getElementById("add-poetry-btn");

            
            const addStudentInfoBtn = document.getElementById("add-student-info-btn");

            
            const addWatermarkBtn = document.getElementById("add-watermark-btn");

            
            const undoBtn = document.getElementById("undo-btn");
            const redoBtn = document.getElementById("redo-btn");
            const textFormatToolbar = document.getElementById('text-format-toolbar');
            const contextMenu = document.getElementById("custom-context-menu");
            const actionHistoryMenu = document.getElementById("action-history-menu");
            const loader = document.getElementById("loader-overlay");
            const loaderText = loader.querySelector("p");
            
            // Modal overlays
            const customPromptOverlay = document.getElementById("custom-prompt-overlay");
            const passagePromptOverlay = document.getElementById("reading-passage-prompt-overlay");
            const poetryPromptOverlay = document.getElementById("poetry-prompt-overlay");
            const studentInfoPromptOverlay = document.getElementById("student-info-prompt-overlay");
            const watermarkPromptOverlay = document.getElementById('watermark-prompt-overlay');
            const qDefaultsPromptOverlay = document.getElementById('question-defaults-prompt-overlay');
            const essayDefaultsPromptOverlay = document.getElementById('essay-defaults-prompt-overlay');

            const mainContent = document.getElementById("main-content");
            const toggleHeaderCheckbox = document.getElementById('toggle-header-visibility');
            const toggleFooterCheckbox = document.getElementById('toggle-footer-visibility');
            const toggleBorderCheckbox = document.getElementById('toggle-border-visibility');
            const togglePageNumberCheckbox = document.getElementById('toggle-page-number-visibility');
            const borderControls = document.getElementById('border-controls');
            const addBorderBoxBtn = document.getElementById('add-border-box-btn');
            const borderStyleUnifiedCheckbox = document.getElementById('border-style-unified');
            const colorSwatches = ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722', '#795548', '#607D8B', '#FFFFFF', '#000000'];
            
            const zoomInBtn = document.getElementById('zoom-in-btn');
            const zoomOutBtn = document.getElementById('zoom-out-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            
            // Selection mode elements
            const selectionModeBtn = document.getElementById('selection-mode-btn');
            const selectionControls = document.getElementById('selection-controls');
            const selectionInfo = document.querySelector('.selection-info');
            const moveUpBtn = document.getElementById('move-up-btn');
            const moveDownBtn = document.getElementById('move-down-btn');
            const copyBtn = document.getElementById('copy-btn');
            const deleteSelectedBtn = document.getElementById('delete-selected-btn');
            const pasteBtn = document.getElementById('paste-btn');

            // Arabic action names mapping
            const actionNames = {
                'Initial empty state': 'ملف فارغ',
                'Load from Excel': 'تحميل من ملف Excel',
                'Append from Excel': 'إضافة من ملف Excel',
                'Add Page Title': 'إضافة عنوان رئيسي',
                'Add MCQ': 'إضافة سؤال اختياري',
                'Add Essay Question': 'إضافة سؤال مقالي',
                'Add Question Header': 'إضافة رأس أسئلة',
                'Add Reading Passage': 'إضافة قطعة قراءة',
                'Add Poetic Text': 'إضافة نص شعري',
                'Apply Watermark': 'تطبيق علامة مائية',
                'Remove Watermark': 'إزالة علامة مائية',
                'Delete Item': 'حذف عنصر',
                'Move Item': 'نقل عنصر',
                'Toggle Sidebar': 'إظهار/إخفاء الشريط الجانبي',
                'Toggle Layout Sidebar': 'إظهار/إخفاء شريط التخطيط',
                'Toggle Header Visibility': 'إظهار/إخفاء الرأس',
                'Toggle Footer Visibility': 'إظهار/إخفاء التذييل',
                'Toggle Kashida': 'تفعيل/إلغاء تمديد النص',
                'Set Start Page Number': 'تحديد رقم الصفحة الأولى',
                'Set Custom Start Number': 'تحديد رقم بداية مخصص',
                'Save Document': 'حفظ الملف',
                'Load Document': 'تحميل ملف',
                'Cancel Custom Start Number': 'إلغاء الرقم المخصص',
                'Change Answer Layout': 'تغيير تخطيط الإجابات',
                'Set Essay Lines': 'تحديد عدد أسطر المقال',
                'Add Question Image': 'إضافة صورة للسؤال',
                'Delete Image': 'حذف الصورة',
                'Change Image from URL': 'تغيير الصورة من رابط',
                'Change Statement': 'تغيير العبارة',
                'Delete Statement': 'حذف العبارة',
                'Add Header Logo': 'إضافة شعار للرأس',
                'Add Header/Footer Box': 'إضافة صندوق رأس/تذييل',
                'Delete Header/Footer Box': 'حذف صندوق رأس/تذييل',
                'Edit Header/Footer': 'تعديل الرأس/التذييل',
                'Update MCQ Defaults': 'تحديث إعدادات الأسئلة الاختيارية',
                'Update Essay Defaults': 'تحديث إعدادات الأسئلة المقالية',
                'Poetry Text Edit': 'تعديل النص الشعري',
                'Text Edit: question': 'تعديل نص السؤال',
                'Text Edit: statement': 'تعديل العبارة',
                'Text Edit: answers.a': 'تعديل الإجابة أ',
                'Text Edit: answers.b': 'تعديل الإجابة ب',
                'Text Edit: answers.c': 'تعديل الإجابة ج',
                'Text Edit: answers.d': 'تعديل الإجابة د',
                'Text Edit: text': 'تعديل النص',
                'Style Change: title-fs': 'تغيير حجم العنوان',
                'Style Change: question-text-fs': 'تغيير حجم نص السؤال',
                'Style Change: answer-text-fs': 'تغيير حجم نص الإجابة',
                'Style Change: passage-text-fs': 'تغيير حجم نص القطعة',
                'Style Change: poetry-text-fs': 'تغيير حجم النص الشعري',
                'Color Change: question-text-color': 'تغيير لون نص السؤال',
                'Color Change: answer-text-color': 'تغيير لون نص الإجابة',
                'Color Change: page-title-text-color': 'تغيير لون نص العنوان',
                'Highlight Color Change': 'تغيير لون التظليل',
                'Enter Selection Mode': 'دخول وضع التحديد',
                'Exit Selection Mode': 'خروج من وضع التحديد',
                'Move Elements Up': 'نقل العناصر لأعلى',
                'Move Elements Down': 'نقل العناصر لأسفل',
                'Delete Selected Element': 'حذف العنصر المحدد',
                'Delete Selected Elements': 'حذف العناصر المحددة',
                'Copy Selected Element': 'نسخ العنصر المحدد',
                'Copy Selected Elements': 'نسخ العناصر المحددة',
                'Paste Element': 'لصق عنصر',
                'Paste Elements': 'لصق عناصر',
                'Edit Reading Passage': 'تعديل قطعة القراءة',
                'Style Change: statement-fs': 'تغيير حجم العبارة التمهيدية',
                'Style Change: q-header-fs': 'تغيير حجم رأس الأسئلة',
                'Style Change: answer-head-fs': 'تغيير حجم رأس الإجابة',
                'Style Change: page-num-fs': 'تغيير حجم رقم الصفحة',
                'Style Change: header-text-fs': 'تغيير حجم نص الرأس',
                'Style Change: footer-text-fs': 'تغيير حجم نص التذييل',
                'Style Change: poetry-num-fs': 'تغيير حجم رقم البيت',
                'Style Change: passage-line-num-fs': 'تغيير حجم رقم السطر',
                'Style Change: page-num-circle-size': 'تغيير حجم دائرة رقم الصفحة',
                'Style Change: answer-head-circle-size': 'تغيير حجم دائرة رأس الإجابة',
                'Style Change: header-logo-height': 'تغيير ارتفاع شعار الرأس',
                'Color Change: statement-text-color': 'تغيير لون العبارة التمهيدية',
                'Color Change: statement-bg-color': 'تغيير لون خلفية العبارة التمهيدية',
                'Color Change: answer-head-color': 'تغيير لون رأس الإجابة',
                'Color Change: answer-head-bg': 'تغيير لون خلفية رأس الإجابة',
                'Color Change: question-border-color': 'تغيير لون حدود السؤال',
                'Color Change: page-num-color': 'تغيير لون رقم الصفحة',
                'Color Change: page-num-bg-color': 'تغيير لون خلفية رقم الصفحة',
                'Color Change: page-title-bg-color': 'تغيير لون خلفية العنوان',
                'Color Change: page-title-border-color': 'تغيير لون حدود العنوان',
                'Color Change: poetry-text-color': 'تغيير لون النص الشعري',
                'Color Change: poetry-num-color': 'تغيير لون رقم البيت',
                'Color Change: passage-line-num-color': 'تغيير لون رقم السطر',
                'Color Change: header-item-bg': 'تغيير لون خلفية عناصر الرأس',
                'Color Change: footer-item-bg': 'تغيير لون خلفية عناصر التذييل',
                'Color Change: header-item-text-color': 'تغيير لون نص عناصر الرأس',
                'Color Change: page-header-bg': 'تغيير لون خلفية الرأس',
                'Color Change: page-footer-bg': 'تغيير لون خلفية التذييل',
                'Toggle Page Border': 'تفعيل/إلغاء إطار الصفحة',
                'Add Border Box': 'إضافة خانة للإطار',
                'Delete Border Box': 'حذف خانة الإطار',
                'Edit Border Box': 'تعديل خانة الإطار',
                'Change Border Box Position': 'تغيير موقع خانة الإطار',
                'Style Change: page-border-width': 'تغيير سُمك الإطار',
                'Style Change: page-border-radius': 'تغيير استدارة الإطار',
                'Color Change: page-border-color': 'تغيير لون الإطار',
                'Color Change: border-box-bg': 'تغيير لون خلفية خانات الإطار',
                'Color Change: border-box-text-color': 'تغيير لون نص خانات الإطار',
                'Toggle Page Number Visibility': 'تفعيل/إلغاء رقم الصفحة',
                'Change Border Style Mode': 'تغيير نمط أسلوب الإطار',
                'Change Border Style': 'تغيير نمط الإطار',
                'Change top Border Style': 'تغيير نمط الحد العلوي',
                'Change right Border Style': 'تغيير نمط الحد الأيمن',
                'Change bottom Border Style': 'تغيير نمط الحد السفلي',
                'Change left Border Style': 'تغيير نمط الحد الأيسر'
            };

            // Get icon for action type
            function getActionIcon(action) {
                if (action.includes('Add') || action.includes('إضافة')) return 'fas fa-plus';
                if (action.includes('Delete') || action.includes('حذف')) return 'fas fa-trash';
                if (action.includes('Edit') || action.includes('تعديل')) return 'fas fa-edit';
                if (action.includes('Move') || action.includes('نقل')) return 'fas fa-arrows-alt';
                if (action.includes('Toggle') || action.includes('إظهار') || action.includes('تفعيل')) return 'fas fa-toggle-on';
                if (action.includes('Color') || action.includes('لون')) return 'fas fa-palette';
                if (action.includes('Style') || action.includes('تغيير حجم')) return 'fas fa-text-height';
                if (action.includes('Load') || action.includes('تحميل')) return 'fas fa-file-import';
                if (action.includes('Watermark') || action.includes('علامة مائية')) return 'fas fa-stamp';
                if (action.includes('Selection') || action.includes('تحديد')) return 'fas fa-mouse-pointer';
                if (action.includes('Copy') || action.includes('نسخ')) return 'fas fa-copy';
                if (action.includes('Paste') || action.includes('لصق')) return 'fas fa-paste';
                return 'fas fa-history';
            }


            function loadWaraqaDocument(documentState) {
                try {
                    // Restore page content
                    pageContent = JSON.parse(JSON.stringify(documentState.pageContent || []));
                    
                    // Restore header/footer state with disabled default
                    headerFooterState = JSON.parse(JSON.stringify(documentState.headerFooterState || {
                        header: { visible: false, items: [] }, // Default to disabled
                        footer: { visible: false, items: [] }  // Default to disabled
                    }));
                    
                    // Restore watermark state
                    watermarkState = {
                        type: 'text',
                        content: '',
                        opacity: 0.25,
                        rotation: 0,
                        size: 80,
                        visible: false,
                        imageName: '',
                        imageData: null,
                        ...JSON.parse(JSON.stringify(documentState.watermarkState || {}))
                    };
                    
                    // Restore border state
                    borderState = {
                        enabled: false,
                        width: 2,
                        color: '#333333',
                        radius: 0,
                        style: 'solid',
                        unifiedStyle: true,
                        topStyle: 'solid',
                        rightStyle: 'solid',
                        bottomStyle: 'solid',
                        leftStyle: 'solid',
                        boxes: [],
                        ...JSON.parse(JSON.stringify(documentState.borderState || {}))
                    };
                    
                    // Restore page number visibility
                    pageNumberVisible = documentState.pageNumberVisible !== undefined ? documentState.pageNumberVisible : true;
                    
                    // Restore MCQ defaults
                    mcqDefaults = {
                        includeStatement: false,
                        defaultLayout: '3',
                        ...JSON.parse(JSON.stringify(documentState.mcqDefaults || {}))
                    };
                    
                    // Restore essay defaults
                    essayDefaults = {
                        includeStatement: false,
                        defaultLines: 2,
                        ...JSON.parse(JSON.stringify(documentState.essayDefaults || {}))
                    };
                    
                    // Restore start page number
                    startPageNumber = documentState.startPageNumber || 1;
                    
                    // Restore CSS styles
                    if (documentState.styles) {
                        const root = document.documentElement;
                        for (const prop in documentState.styles) {
                            if (documentState.styles[prop]) {
                                root.style.setProperty(prop, documentState.styles[prop]);
                            }
                        }
                    }
                    
                    // Restore action history
                    actionHistory = JSON.parse(JSON.stringify(documentState.actionHistory || []));
                    currentActionIndex = documentState.currentActionIndex >= 0 ? documentState.currentActionIndex : -1;
                    
                    // Update header/footer visibility
                    toggleHeaderCheckbox.checked = headerFooterState.header.visible;
                    document.body.classList.toggle('header-hidden', !headerFooterState.header.visible);
                    toggleFooterCheckbox.checked = headerFooterState.footer.visible;
                    document.body.classList.toggle('footer-hidden', !headerFooterState.footer.visible);
                    
                    // Update border visibility
                    toggleBorderCheckbox.checked = borderState.enabled;
                    document.body.classList.toggle('border-active', borderState.enabled);
                    borderControls.classList.toggle('disabled', !borderState.enabled);
                    
                    // Update border style controls and visual selectors
                    updateBorderStyleVisualSelector();
                    
                    // Update border style mode
                    borderStyleUnifiedCheckbox.checked = borderState.unifiedStyle !== false;
                    document.getElementById('unified-border-style').style.display = borderState.unifiedStyle !== false ? 'block' : 'none';
                    document.getElementById('individual-border-styles').style.display = borderState.unifiedStyle !== false ? 'none' : 'block';
                    
                    // Update page number visibility
                    togglePageNumberCheckbox.checked = pageNumberVisible;
                    document.body.classList.toggle('page-number-hidden', !pageNumberVisible);
                    
                    // Initialize dimmed overlays for controls
                    const headerFooterControls = document.getElementById('header-footer-controls');
                    const pageNumberControls = document.getElementById('page-number-controls');
                    const isHeaderOrFooterVisible = headerFooterState.header.visible || headerFooterState.footer.visible;
                    headerFooterControls.classList.toggle('disabled', !isHeaderOrFooterVisible);
                    pageNumberControls.classList.toggle('disabled', !pageNumberVisible);
                    
                    // Handle mutual exclusivity between border and header/footer
                    if (borderState.enabled) {
                        toggleHeaderCheckbox.checked = false;
                        toggleFooterCheckbox.checked = false;
                        headerFooterState.header.visible = false;
                        headerFooterState.footer.visible = false;
                        document.body.classList.add('header-hidden', 'footer-hidden');
                    }
                    
                    // Update sidebar controls
                    updateSidebarControls(documentState.styles);
                    
                    // Render everything
                    renderAll();
                    
                    // Record the load action
                    recordState('Load Document');
                    
                } catch (error) {
                    console.error('Error loading Waraqa document:', error);
                    throw error;
                }
            }

            function initialize() {
                // Check if coming from index.html with data
                const excelData = sessionStorage.getItem('excelData');
                const waraqaData = sessionStorage.getItem('waraqaData');
                const importMode = sessionStorage.getItem('importMode');
                
                let hasInitializedContent = false;
                
                if (excelData && importMode === 'replace') {
                    // Load Excel data
                    try {
                        const json = JSON.parse(excelData);
                        parseAndLoadQuestions(json);
                        hasInitializedContent = true;
                        // Clear the session storage
                        sessionStorage.removeItem('excelData');
                        sessionStorage.removeItem('importMode');
                    } catch (err) {
                        console.error('Error loading Excel data from session:', err);
                    }
                } else if (waraqaData && importMode === 'waraqa') {
                    // Load Waraqa document data
                    try {
                        const documentState = JSON.parse(waraqaData);
                        loadWaraqaDocument(documentState);
                        hasInitializedContent = true;
                        // Clear the session storage
                        sessionStorage.removeItem('waraqaData');
                        sessionStorage.removeItem('importMode');
                    } catch (err) {
                        console.error('Error loading Waraqa data from session:', err);
                        alert('حدث خطأ أثناء تحميل ملف الورقة.');
                    }
                } else if (importMode === 'scratch') {
                    // Start from scratch
                    startFromScratch();
                    hasInitializedContent = true;
                    sessionStorage.removeItem('importMode');
                }
                
                // Event Listeners (removed landing screen listeners)
                imageUploadInput.addEventListener("change", handleImageFileUpload);
                homeBtn.addEventListener("click", goHome);
                addFromExcelBtn.addEventListener("click", () => {
                    // Create a temporary file input for adding Excel files
                    const tempFileInput = document.createElement('input');
                    tempFileInput.type = 'file';
                    tempFileInput.accept = '.xlsx, .xls';
                    tempFileInput.style.display = 'none';
                    document.body.appendChild(tempFileInput);
                    
                    tempFileInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const data = new Uint8Array(event.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                const sheetName = workbook.SheetNames[0];
                                const worksheet = workbook.Sheets[sheetName];
                                const json = XLSX.utils.sheet_to_json(worksheet);
                                
                                appendQuestions(json);
                            } catch (err) {
                                console.error("Error processing Excel file:", err);
                                alert("حدث خطأ أثناء معالجة ملف Excel. يرجى التأكد من أن الملف غير تالف وبالتنسيق الصحيح.");
                            } finally {
                                document.body.removeChild(tempFileInput);
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    });
                    
                    tempFileInput.click();
                });
                toggleSidebarBtn.addEventListener("click", toggleSidebar);
                
                // Layout sidebar toggle
                toggleLayoutSidebarBtn.addEventListener("click", toggleLayoutSidebar);
                
                // Colors sidebar toggle
                toggleColorsSidebarBtn.addEventListener("click", toggleColorsSidebar);
                
                // Sizes sidebar toggle
                toggleSizesSidebarBtn.addEventListener("click", toggleSizesSidebar);
                
                // Save dropdown functionality
                saveBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    saveDropdown.classList.toggle('hidden');
                });
                
                saveAsPdfOption.addEventListener("click", () => {
                    saveDropdown.classList.add('hidden');
                    saveAsPDF();
                });
                
                saveAsWaraqaOption.addEventListener("click", () => {
                    saveDropdown.classList.add('hidden');
                    saveAsWaraqa();
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.save-dropdown-container')) {
                        saveDropdown.classList.add('hidden');
                    }
                });
                
                // Event Listeners with enhanced debugging
                addTitleBtn.addEventListener("click", addPageTitle);
                addQuestionBtn.addEventListener("click", addNewQuestion);
                
                // MCQ Defaults Button
                if (qDefaultsSettingsBtn) {
                    qDefaultsSettingsBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();

                        setTimeout(() => showMCQDefaultsPrompt(), 10);
                    });

                } else {

                }
                
                addEssayQuestionBtn.addEventListener("click", addNewEssayQuestion);
                
                // Essay Defaults Button
                if (essayDefaultsSettingsBtn) {
                    essayDefaultsSettingsBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();

                        setTimeout(() => showEssayDefaultsPrompt(), 10);
                    });

                } else {

                }
                
                addQHeaderBtn.addEventListener("click", addQuestionHeader);
                
                // Reading Passage Button
                if (addPassageBtn) {
                    addPassageBtn.addEventListener("click", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();

                        setTimeout(() => showReadingPassagePrompt(), 10);
                    });

                } else {
                    console.error('❌ addPassageBtn not found!');
                }
                
                // Poetry Button
                if (addPoetryBtn) {
                    addPoetryBtn.addEventListener("click", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();

                        setTimeout(() => showPoetryPrompt(), 10);
                    });

                } else {
                    console.error('❌ addPoetryBtn not found!');
                }
                
                // Student Info Button
                if (addStudentInfoBtn) {
                    addStudentInfoBtn.addEventListener("click", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();

                        setTimeout(() => showStudentInfoPrompt(), 10);
                    });

                } else {
                    console.error('❌ addStudentInfoBtn not found!');
                }
                
                // Watermark Button
                if (addWatermarkBtn) {
                    addWatermarkBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();

                        setTimeout(() => showWatermarkPrompt(), 10);
                    });

                } else {
                    console.error('❌ addWatermarkBtn not found!');
                }
                undoBtn.addEventListener("click", undo);
                redoBtn.addEventListener("click", redo);
                
                // Right-click event listeners for action history
                undoBtn.addEventListener("contextmenu", (e) => {
                    e.preventDefault();
                    showActionHistoryMenu(e, 'undo');
                });
                redoBtn.addEventListener("contextmenu", (e) => {
                    e.preventDefault();
                    showActionHistoryMenu(e, 'redo');
                });
                toggleHeaderCheckbox.addEventListener('change', toggleHeaderVisibility);
                toggleFooterCheckbox.addEventListener('change', toggleFooterVisibility);
                toggleBorderCheckbox.addEventListener('change', toggleBorderVisibility);
                togglePageNumberCheckbox.addEventListener('change', togglePageNumberVisibility);
                if (addBorderBoxBtn) {
                    addBorderBoxBtn.addEventListener('click', addBorderBox);
                }
                
                // REMOVED: Conflicting general border style listener that was causing issues
                // The unified and individual mode handlers below are sufficient
                
                // Add event listeners for visual border style selectors
                // Unified border style selectors (when unified mode is ON)
                document.querySelectorAll('#unified-border-style .border-style-option').forEach(option => {
                    option.addEventListener('click', function() {
                        // Only apply unified styles when in unified mode
                        if (borderState.unifiedStyle !== true) return;
                            
                        // Remove selected class from all options
                        document.querySelectorAll('#unified-border-style .border-style-option').forEach(opt => opt.classList.remove('selected'));
                        // Add selected class to clicked option
                        this.classList.add('selected');
                        
                        const style = this.dataset.style;
                        // Apply to all sides when in unified mode
                        borderState.style = style;
                        borderState.topStyle = style;
                        borderState.rightStyle = style;
                        borderState.bottomStyle = style;
                        borderState.leftStyle = style;
                        updateBorderCSSVariables();
                        recordState("Change Border Style");
                    });
                });
                
                // Individual border style selectors (when unified mode is OFF)
                document.querySelectorAll('#individual-border-styles .border-style-selector').forEach(selector => {
                    const borderSide = selector.dataset.borderSide;
                    selector.querySelectorAll('.border-style-option').forEach(option => {
                        option.addEventListener('click', function() {
                            // Only apply individual styles when in individual mode
                            if (borderState.unifiedStyle === true) return;
                            
                            // Remove selected class from all options in this selector
                            selector.querySelectorAll('.border-style-option').forEach(opt => opt.classList.remove('selected'));
                            // Add selected class to clicked option
                            this.classList.add('selected');
                            
                            const style = this.dataset.style;
                            // Apply to the specific border side
                            if (borderSide === 'top') {
                                borderState.topStyle = style;
                            } else if (borderSide === 'right') {
                                borderState.rightStyle = style;
                            } else if (borderSide === 'bottom') {
                                borderState.bottomStyle = style;
                            } else if (borderSide === 'left') {
                                borderState.leftStyle = style;
                            }
                            updateBorderCSSVariables();
                            updateBorderStyleVisualSelector(); // Ensure all selectors are synced
                            recordState(`Change ${borderSide.charAt(0).toUpperCase() + borderSide.slice(1)} Border Style`);
                        });
                    });
                });
                borderStyleUnifiedCheckbox.addEventListener('change', toggleBorderStyleMode);

                // View controls listeners
                zoomInBtn.addEventListener('click', () => applyZoom(currentZoomLevel + 0.1));
                zoomOutBtn.addEventListener('click', () => applyZoom(currentZoomLevel - 0.1));
                fullscreenBtn.addEventListener('click', toggleFullscreen);
                document.addEventListener('fullscreenchange', handleFullscreenChange);
                
                // Selection mode listeners
                selectionModeBtn.addEventListener('click', toggleSelectionMode);
                moveUpBtn.addEventListener('click', moveSelectedElementsUp);
                moveDownBtn.addEventListener('click', moveSelectedElementsDown);
                copyBtn.addEventListener('click', copySelectedElements);
                deleteSelectedBtn.addEventListener('click', deleteSelectedElements);
                pasteBtn.addEventListener('click', pasteElements);
                
                // Add click listener for element selection in selection mode
                mainContent.addEventListener('click', handleElementSelection);
                
                // Add keyboard shortcuts for selection mode
                document.addEventListener('keydown', handleKeyboardShortcuts);
                
                // Enhanced Formatting toolbar listeners with improved event handling
                textFormatToolbar.addEventListener('mousedown', (e) => {
                    e.preventDefault(); // Prevent focus loss from selection
                    e.stopPropagation(); // Prevent event bubbling
                    
                    const button = e.target.closest('button');
                    if(button) {
                        const command = button.dataset.command;
                        if (command) {
                            // Add visual feedback
                            button.style.transform = 'scale(0.95)';
                            setTimeout(() => {
                                button.style.transform = '';
                            }, 150);
                            
                            applyFormat(command);
                        } else if (button.id === 'copy-text-btn') {
                            copySelectedText();
                        } else if (button.id === 'cut-text-btn') {
                            cutSelectedText();
                        } else if (button.id === 'paste-text-btn') {
                            pasteText();
                        } else if (button.id === 'close-toolbar-btn') {
                            textFormatToolbar.classList.remove('show');
                        }
                    }
                });
                
                // Prevent selection loss when interacting with toolbar elements
                textFormatToolbar.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent click outside detection
                });
                
                // Add specific handlers for color picker elements to prevent selection loss
                const textColorPicker = document.getElementById('text-color-picker');
                const textHighlightPicker = document.getElementById('text-highlight-picker');
                
                if (textColorPicker) {
                    textColorPicker.addEventListener('mousedown', (e) => {
                        e.stopPropagation(); // Prevent toolbar mousedown handler
                    });
                    textColorPicker.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent click outside detection
                    });
                }
                
                if (textHighlightPicker) {
                    textHighlightPicker.addEventListener('mousedown', (e) => {
                        e.stopPropagation(); // Prevent toolbar mousedown handler
                    });
                    textHighlightPicker.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent click outside detection
                    });
                }

                // Font dropdown functionality
                document.getElementById('font-dropdown-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                });

                document.getElementById('font-dropdown').addEventListener('click', (e) => {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                });

            // ========== COMPLETELY NEW COLOR PICKER SYSTEM ==========
            
            // Color swatches for all pickers
            const COLOR_SWATCHES = ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722', '#795548', '#607D8B', '#FFFFFF', '#000000'];
            
            // Global positioning configuration
            const PICKER_POSITIONING = {
                MARGIN: 20, // Safety margin from screen edges
                Z_INDEX: 10002,
                POSITIONS: ['right', 'bottom', 'left', 'top'] // Order of preference
            };
            
            // Track active pickers
            let activeColorPicker = null;

            

            


                // Opacity slider listener with improved handling
                const opacitySlider = document.getElementById('text-opacity-slider');
                const opacityValue = document.getElementById('opacity-value');
                
                if (opacitySlider && opacityValue) {
                    // Add multiple event listeners for better responsiveness
                    opacitySlider.addEventListener('input', (e) => {
                        const opacity = e.target.value;
                        opacityValue.textContent = opacity + '%';
                        
                        // Visual feedback: change the slider background color temporarily
                        opacitySlider.style.background = 'rgba(52, 152, 219, 0.5)';
                        setTimeout(() => {
                            opacitySlider.style.background = 'rgba(255,255,255,0.2)';
                        }, 200);
                        
                        if (currentSelectionRange) {
                            applyOpacity(opacity);
                        }
                    });
                    
                    // Also handle change event for final value
                    opacitySlider.addEventListener('change', (e) => {
                        const opacity = e.target.value;
                        opacityValue.textContent = opacity + '%';
                        
                        if (currentSelectionRange) {
                            applyOpacity(opacity);
                        }
                    });
                    
                    // Add mouse and touch events for better interaction
                    opacitySlider.addEventListener('mousedown', (e) => {
                        e.stopPropagation(); // Prevent interference

                    });
                    
                    opacitySlider.addEventListener('touchstart', (e) => {
                        e.stopPropagation(); // Prevent interference

                    });
                    

                } else {

                }

                // Close font dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#font-selector') && !e.target.closest('.pcr-app, .pickr, .pickr-text-color, .pickr-highlight-color')) {
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                });

                // Disable context menu on text selection
                document.addEventListener('contextmenu', (e) => {
                    const selection = window.getSelection();
                    if (selection && !selection.isCollapsed) {
                        e.preventDefault();
                    }
                });

                // Setups
                setupStyleControls();
                setupTextColorPickers(); // Initialize text formatting toolbar color pickers
                setupContextMenuListeners();
                setupAllPrompts();
                setupKashidaInfrastructure();
                
                // General UI Listeners
                mainContent.addEventListener('contextmenu', handleMainContentContextMenu);
                
                // Optimized selection handling - single event listener with proper debouncing
                document.addEventListener("selectionchange", handleSelectionChange);
                
                document.addEventListener("click", hideMenusOnClickOutside);
                window.addEventListener("scroll", hideMenusOnClickOutside); // Hide context menu on scroll too
                window.addEventListener("resize", handleWindowResize); // Reposition menus on resize
                
                // Mark initialization as complete
                isInitialized = true;
                

                
                // Initialize sidebar button active states
                // Set initial active state for main sidebar (main sidebar is open by default)
                if (!document.body.classList.contains('sidebar-collapsed')) {
                    toggleSidebarBtn.classList.add('active');
                } else {
                    toggleSidebarBtn.classList.remove('active');
                }
                
                // Set initial active state for layout sidebar (closed by default)
                if (document.body.classList.contains('layout-sidebar-open')) {
                    toggleLayoutSidebarBtn.classList.add('active');
                } else {
                    toggleLayoutSidebarBtn.classList.remove('active');
                }
                
                // Set initial active state for colors sidebar (closed by default)
                if (document.body.classList.contains('colors-sidebar-open')) {
                    toggleColorsSidebarBtn.classList.add('active');
                } else {
                    toggleColorsSidebarBtn.classList.remove('active');
                }
                
                // Set initial active state for sizes sidebar (closed by default)
                if (document.body.classList.contains('sizes-sidebar-open')) {
                    toggleSizesSidebarBtn.classList.add('active');
                } else {
                    toggleSizesSidebarBtn.classList.remove('active');
                }
                
                // Initialize border controls state
                if (borderControls && toggleBorderCheckbox) {
                    toggleBorderCheckbox.checked = borderState.enabled;
                    document.body.classList.toggle('border-active', borderState.enabled);
                    borderControls.classList.toggle('disabled', !borderState.enabled);
                }
                
                // Initialize header/footer state - headers and footers start disabled
                toggleHeaderCheckbox.checked = headerFooterState.header.visible;
                document.body.classList.toggle('header-hidden', !headerFooterState.header.visible);
                toggleFooterCheckbox.checked = headerFooterState.footer.visible;
                document.body.classList.toggle('footer-hidden', !headerFooterState.footer.visible);
                
                // Initialize header/footer controls dimming state
                const headerFooterControls = document.getElementById('header-footer-controls');
                const isHeaderOrFooterVisible = headerFooterState.header.visible || headerFooterState.footer.visible;
                headerFooterControls.classList.toggle('disabled', !isHeaderOrFooterVisible);
                
                // Only initialize empty state if we haven't loaded content from other sources
                if (!hasInitializedContent && pageContent.length === 0) {
                    // This happens when accessing the editor directly (not from index.html)
                    // First render the empty page
                    renderAll(); // This will create an empty page
                    // Then record the initial state for proper action history
                    recordState("Initial empty state");
                }
            }

            // Unified sidebar switching system
            let isAnimating = false;
            const ANIMATION_DURATION = 300; // 0.3s in milliseconds
            
            function closeSidebar(sidebarType) {
                switch(sidebarType) {
                    case 'main':
                        document.body.classList.add('sidebar-collapsed');
                        toggleSidebarBtn.classList.remove('active');
                        break;
                    case 'layout':
                        document.body.classList.remove('layout-sidebar-open');
                        toggleLayoutSidebarBtn.classList.remove('active');
                        break;
                    case 'colors':
                        document.body.classList.remove('colors-sidebar-open');
                        toggleColorsSidebarBtn.classList.remove('active');
                        break;
                    case 'sizes':
                        document.body.classList.remove('sizes-sidebar-open');
                        toggleSizesSidebarBtn.classList.remove('active');
                        break;
                }
            }
            
            function openSidebar(sidebarType) {
                switch(sidebarType) {
                    case 'main':
                        document.body.classList.remove('sidebar-collapsed');
                        toggleSidebarBtn.classList.add('active');
                        // Setup color pickers after animation with extra delay for DOM rendering
                        setTimeout(() => {
                            setupColorPickersOnly();
                        }, ANIMATION_DURATION + 100);
                        break;
                    case 'layout':
                        document.body.classList.add('layout-sidebar-open');
                        toggleLayoutSidebarBtn.classList.add('active');
                        // Setup color pickers after animation with extra delay for DOM rendering
                        setTimeout(() => {
                            setupColorPickersOnly();
                        }, ANIMATION_DURATION + 100);
                        break;
                    case 'colors':
                        document.body.classList.add('colors-sidebar-open');
                        toggleColorsSidebarBtn.classList.add('active');
                        // Setup color pickers after animation with extra delay for DOM rendering
                        setTimeout(() => {
                            setupColorPickersOnly();
                        }, ANIMATION_DURATION + 100);
                        break;
                    case 'sizes':
                        document.body.classList.add('sizes-sidebar-open');
                        toggleSizesSidebarBtn.classList.add('active');
                        break;
                }
            }
            
            function switchToSidebar(targetSidebar) {
                if (isAnimating) return; // Prevent rapid clicking
                
                isAnimating = true;
                
                // Get current sidebar state
                const isMainOpen = !document.body.classList.contains('sidebar-collapsed');
                const isLayoutOpen = document.body.classList.contains('layout-sidebar-open');
                const isColorsOpen = document.body.classList.contains('colors-sidebar-open');
                const isSizesOpen = document.body.classList.contains('sizes-sidebar-open');
                
                // Check if target sidebar is already open
                const isTargetOpen = (
                    (targetSidebar === 'main' && isMainOpen) ||
                    (targetSidebar === 'layout' && isLayoutOpen) ||
                    (targetSidebar === 'colors' && isColorsOpen) ||
                    (targetSidebar === 'sizes' && isSizesOpen)
                );
                
                // If target sidebar is already open, close it
                if (isTargetOpen) {
                    closeSidebar(targetSidebar);
                } else {
                    // Close all open sidebars first
                    if (isMainOpen) closeSidebar('main');
                    if (isLayoutOpen) closeSidebar('layout');
                    if (isColorsOpen) closeSidebar('colors');
                    if (isSizesOpen) closeSidebar('sizes');
                    
                    // Small delay to allow close animation to start, then open new sidebar
                    setTimeout(() => {
                        openSidebar(targetSidebar);
                    }, 50);
                }
                
                // Reset animation flag after full transition
                setTimeout(() => {
                    isAnimating = false;
                }, ANIMATION_DURATION + 100);
            }
            
            function toggleSidebar() {
                switchToSidebar('main');
                recordState('Toggle Sidebar');
            }
            
            function toggleLayoutSidebar() {
                switchToSidebar('layout');
                recordState('Toggle Layout Sidebar');
            }
            
            function toggleColorsSidebar() {
                switchToSidebar('colors');
                recordState('Toggle Colors Sidebar');
            }
            
            function toggleSizesSidebar() {
                switchToSidebar('sizes');
                recordState('Toggle Sizes Sidebar');
            }
            
            function setupSliderButtons() {
                document.querySelectorAll('.slider-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const slider = e.target.closest('.slider-input-group').querySelector('input[type=range]');
                        if (btn.classList.contains('plus')) {
                            slider.stepUp(1);
                        } else if (btn.classList.contains('minus')) {
                            slider.stepDown(1);
                        }
                        slider.dispatchEvent(new Event('input', { bubbles:true }));
                        slider.dispatchEvent(new Event('change', { bubbles:true }));
                    });
                });
            }

            // Robust modal hide function with error handling
            function hideModal(modalElement, modalName) {
                if (!modalElement) {
                    console.error(`❌ ${modalName} element not found for hiding!`);
                    return false;
                }
                
                try {
                    // Simple approach: just add hidden class and basic styles
                    modalElement.classList.add('hidden');
                    
                    // Use only essential style properties
                    modalElement.style.display = 'none';
                    modalElement.style.visibility = 'hidden';
                    
                    console.log(`✅ ${modalName} hidden successfully`);
                    return true;
                } catch (error) {
                    console.error(`❌ Error hiding ${modalName}:`, error);
                    return false;
                }
            }

            function setupAllPrompts() {
                // Simple initialization check - if already done, skip
                if (window.modalsInitialized) {
                    console.log('✅ Modals already initialized, skipping...');
                    return;
                }
                
                console.log('🔧 Setting up modal prompts...');
                
                // Simple event listeners for modal buttons - only add once
                const modalButtons = [
                    { id: 'passage-prompt-ok', handler: () => {
                        const text = document.getElementById('passage-prompt-text').value;
                        const qCount = parseInt(document.getElementById('passage-prompt-q-count').value, 10) || 0;
                        if (text && qCount > 0) {
                            addReadingPassage(text, qCount);
                            hideModal(passagePromptOverlay, 'Reading Passage Modal');
                        } else {
                            alert('يرجى إدخال نص القطعة وتحديد عدد الأسئلة');
                        }
                    }},
                    { id: 'passage-prompt-cancel', handler: () => hideModal(passagePromptOverlay, 'Reading Passage Modal') },
                    { id: 'poetry-prompt-ok', handler: () => {
                        const text = document.getElementById('poetry-prompt-text').value;
                        const qCount = parseInt(document.getElementById('poetry-prompt-q-count').value, 10) || 0;
                        const useKashida = document.getElementById('poetry-prompt-kashida-toggle').checked;
                        if (text.trim() && qCount >= 0) {
                            addPoeticText(text, qCount, useKashida);
                            hideModal(poetryPromptOverlay, 'Poetry Modal');
                        } else {
                            alert('يرجى إدخال النص الشعري');
                        }
                    }},
                    { id: 'poetry-prompt-cancel', handler: () => hideModal(poetryPromptOverlay, 'Poetry Modal') },
                    { id: 'student-info-ok', handler: () => {
                        handleStudentInfoAdd();
                        hideModal(studentInfoPromptOverlay, 'Student Info Modal');
                    }},
                    { id: 'student-info-cancel', handler: () => hideModal(studentInfoPromptOverlay, 'Student Info Modal') },
                    { id: 'q-defaults-prompt-ok', handler: () => {
                        applyMCQDefaults();
                        hideModal(qDefaultsPromptOverlay, 'MCQ Defaults Modal');
                    }},
                    { id: 'q-defaults-prompt-cancel', handler: () => hideModal(qDefaultsPromptOverlay, 'MCQ Defaults Modal') },
                    { id: 'e-defaults-prompt-ok', handler: () => {
                        applyEssayDefaults();
                        hideModal(essayDefaultsPromptOverlay, 'Essay Defaults Modal');
                    }},
                    { id: 'e-defaults-prompt-cancel', handler: () => hideModal(essayDefaultsPromptOverlay, 'Essay Defaults Modal') },
                    { id: 'watermark-prompt-ok', handler: () => handleWatermarkApply() },
                    { id: 'watermark-prompt-cancel', handler: () => {
                        resetWatermarkModalState();
                        hideModal(watermarkPromptOverlay, 'Watermark Modal');
                    }},
                    { id: 'watermark-prompt-remove', handler: () => handleWatermarkRemove() },
                    { id: 'border-position-prompt-ok', handler: () => applyBorderPosition() },
                    { id: 'border-position-prompt-cancel', handler: () => {
                        const borderPromptOverlay = document.getElementById('border-box-position-prompt-overlay');
                        if (borderPromptOverlay) {
                            borderPromptOverlay.classList.add('hidden');
                        }
                        currentBorderBoxId = null;
                    }}
                ];
                
                // Add listeners only once
                modalButtons.forEach(btn => {
                    const element = document.getElementById(btn.id);
                    if (element && !element.hasAttribute('data-listener-attached')) {
                        element.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            btn.handler();
                        });
                        element.setAttribute('data-listener-attached', 'true');
                        console.log(`✅ ${btn.id} listener attached`);
                    }
                });
                
                // Student Info Modal additional controls
                const setupStudentInfoControls = () => {
                    const examScoreToggle = document.getElementById('include-exam-score');
                    const customFieldToggle = document.getElementById('include-custom-field');
                    const selectAllToggle = document.getElementById('select-all-fields');
                    
                    if (examScoreToggle && !examScoreToggle.hasAttribute('data-listener-attached')) {
                        examScoreToggle.addEventListener('change', (e) => {
                            const examScoreSettings = document.getElementById('exam-score-settings');
                            if (examScoreSettings) {
                                examScoreSettings.style.display = e.target.checked ? 'block' : 'none';
                            }
                        });
                        examScoreToggle.setAttribute('data-listener-attached', 'true');
                    }
                    
                    if (customFieldToggle && !customFieldToggle.hasAttribute('data-listener-attached')) {
                        customFieldToggle.addEventListener('change', (e) => {
                            const customFieldSettings = document.getElementById('custom-field-settings');
                            if (customFieldSettings) {
                                customFieldSettings.style.display = e.target.checked ? 'block' : 'none';
                            }
                        });
                        customFieldToggle.setAttribute('data-listener-attached', 'true');
                    }
                    
                    if (selectAllToggle && !selectAllToggle.hasAttribute('data-listener-attached')) {
                        selectAllToggle.addEventListener('change', (e) => {
                            const isChecked = e.target.checked;
                            const fieldsToToggle = [
                                'include-student-name',
                                'include-group-name', 
                                'include-grade-level',
                                'include-student-code',
                                'include-date',
                                'include-exam-score'
                            ];
                            
                            fieldsToToggle.forEach(fieldId => {
                                const field = document.getElementById(fieldId);
                                if (field) field.checked = isChecked;
                            });
                            
                            const examScoreSettings = document.getElementById('exam-score-settings');
                            if (examScoreSettings) {
                                examScoreSettings.style.display = isChecked ? 'block' : 'none';
                            }
                        });
                        selectAllToggle.setAttribute('data-listener-attached', 'true');
                    }
                };
                
                setupStudentInfoControls();
                setupWatermarkPromptListeners();
                
                // Add radio button styling for border position
                document.querySelectorAll('input[name="border-position"]').forEach(radio => {
                    if (!radio.hasAttribute('data-listener-attached')) {
                        radio.addEventListener('change', (e) => {
                            // Reset all labels
                            document.querySelectorAll('input[name="border-position"]').forEach(r => {
                                const label = r.closest('label');
                                if (label) {
                                    label.style.borderColor = '#ccc';
                                    label.style.backgroundColor = 'transparent';
                                }
                            });
                            // Highlight selected
                            if (e.target.checked) {
                                const selectedLabel = e.target.closest('label');
                                if (selectedLabel) {
                                    selectedLabel.style.borderColor = 'var(--primary-color)';
                                    selectedLabel.style.backgroundColor = '#eef6ff';
                                }
                            }
                        });
                        radio.setAttribute('data-listener-attached', 'true');
                    }
                });
                
                // Mark as initialized
                window.modalsInitialized = true;
                console.log('✅ All modal prompts initialized successfully');
            }

            function showMCQDefaultsPrompt() {
                console.log('🔍 showMCQDefaultsPrompt called');
                
                if (showModal(qDefaultsPromptOverlay, 'MCQ Defaults Modal')) {
                    document.getElementById('default-statement-toggle').checked = mcqDefaults.includeStatement;
                    const layoutRadio = document.querySelector(`#default-layout-selector input[value="${mcqDefaults.defaultLayout}"]`);
                    if (layoutRadio) { layoutRadio.checked = true; }
                }
            }

            function applyMCQDefaults() {
                mcqDefaults.includeStatement = document.getElementById('default-statement-toggle').checked;
                const selectedLayout = document.querySelector('#default-layout-selector input:checked');
                if (selectedLayout) { mcqDefaults.defaultLayout = selectedLayout.value; }
                qDefaultsPromptOverlay.classList.add('hidden');
                recordState('Update MCQ Defaults');
            }
            
            function showEssayDefaultsPrompt() {
                console.log('🔍 showEssayDefaultsPrompt called');
                
                if (showModal(essayDefaultsPromptOverlay, 'Essay Defaults Modal')) {
                    document.getElementById('e-default-statement-toggle').checked = essayDefaults.includeStatement;
                    document.getElementById('e-default-lines-input').value = essayDefaults.defaultLines;
                }
            }

            function applyEssayDefaults() {
                essayDefaults.includeStatement = document.getElementById('e-default-statement-toggle').checked;
                const lines = parseInt(document.getElementById('e-default-lines-input').value, 10);
                if(!isNaN(lines) && lines > 0 && lines <= 15) { essayDefaults.defaultLines = lines; }
                essayDefaultsPromptOverlay.classList.add('hidden');
                recordState('Update Essay Defaults');
            }
            
            function applyBorderPosition() {
                const selectedPosition = document.querySelector('input[name="border-position"]:checked');
                
                if (selectedPosition && currentBorderBoxId) {
                    const box = borderState.boxes.find(b => b.id === currentBorderBoxId);
                    if (box && box.position !== selectedPosition.value) {
                        box.position = selectedPosition.value;
                        renderAll();
                        recordState('Change Border Box Position');
                    }
                }
                
                document.getElementById('border-box-position-prompt-overlay').classList.add('hidden');
                currentBorderBoxId = null;
            }
            
            function applyZoom(newLevel) { if (newLevel >= 0.5 && newLevel <= 2.0) { currentZoomLevel = newLevel; pagesContainer.style.transform = `scale(${currentZoomLevel})`; } }
            
            function toggleFullscreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(err => { console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`); }); } else { if(document.exitFullscreen) document.exitFullscreen(); } }
            
            function handleFullscreenChange() { const icon = fullscreenBtn.querySelector('i'); const isFullscreen = !!document.fullscreenElement; icon.classList.toggle('fa-expand', !isFullscreen); icon.classList.toggle('fa-compress', isFullscreen); fullscreenBtn.title = isFullscreen ? "الخروج من وضع ملء الشاشة" : "وضع ملء الشاشة"; }
            
            function goHome() { 
                // Redirect to index.html
                window.location.href = 'index.html';
            }
            
            // ===== SELECTION MODE FUNCTIONALITY =====
            function toggleSelectionMode() {
                isSelectionMode = !isSelectionMode;
                document.body.classList.toggle('selection-mode', isSelectionMode);
                selectionModeBtn.classList.toggle('active', isSelectionMode);
                
                if (isSelectionMode) {
                    // Entering selection mode - store current contenteditable states and disable them
                    document.querySelectorAll('[contenteditable="true"]').forEach(el => {
                        el.dataset.wasEditable = 'true';
                        el.setAttribute('contenteditable', 'false');
                        el.blur(); // Remove focus if any
                    });
                } else {
                    // Exiting selection mode - restore contenteditable states
                    document.querySelectorAll('[data-was-editable="true"]').forEach(el => {
                        el.setAttribute('contenteditable', 'true');
                        el.removeAttribute('data-was-editable');
                    });
                    clearSelection();
                }
                
                updateSelectionControls();
                recordState(isSelectionMode ? 'Enter Selection Mode' : 'Exit Selection Mode');
            }
            
            function handleElementSelection(event) {
                if (!isSelectionMode) return;
                
                // Check if we're clicking on an editable element or control button
                if (event.target.isContentEditable || 
                    event.target.closest('button') || 
                    event.target.closest('.control-btn') ||
                    event.target.closest('.editor-control-btn') ||
                    event.target.closest('#floating-controls') ||
                    event.target.closest('#selection-controls') ||
                    event.target.closest('#sidebar')) {
                    return;
                }
                
                const element = event.target.closest('.question-wrapper, .reading-passage-wrapper, .poetry-wrapper, .question-list-header, .page-title, .student-info-wrapper');
                
                // If no selectable element was clicked, it's an empty area - exit selection mode
                if (!element || !element.dataset.itemId) {
                    // Check if we're clicking on the main content area (not on other UI elements)
                    if (event.target.closest('#main-content') || event.target.closest('#pages-container')) {
                        toggleSelectionMode(); // Exit selection mode
                        return;
                    }
                    return;
                }
                
                event.preventDefault();
                event.stopPropagation();
                
                const itemId = element.dataset.itemId;
                const item = pageContent.find(q => q.id === itemId);
                
                if (!item || !selectableTypes.includes(item.elementType)) return;
                
                // Toggle selection (no Ctrl required)
                if (selectedElementIds.has(itemId)) {
                    selectedElementIds.delete(itemId);
                    element.classList.remove('element-selected');
                } else {
                    selectedElementIds.add(itemId);
                    element.classList.add('element-selected');
                }
                
                updateSelectionControls();
            }
            
            function clearSelection() {
                selectedElementIds.clear();
                document.querySelectorAll('.element-selected').forEach(el => {
                    el.classList.remove('element-selected');
                });
                updateSelectionControls();
            }
            
            function updateSelectionControls() {
                const count = selectedElementIds.size;
                const hasSelection = count > 0;
                const hasClipboard = clipboard && clipboard.length > 0;
                
                // Update info text with more helpful messages
                if (count === 0) {
                    selectionInfo.textContent = isSelectionMode ? 'انقر على عنصر أو دائرة لتحديده' : 'لم يتم تحديد عناصر';
                } else if (count === 1) {
                    selectionInfo.textContent = 'تم تحديد عنصر واحد';
                } else {
                    selectionInfo.textContent = `تم تحديد ${count} عناصر`;
                }
                
                // Update button states
                moveUpBtn.disabled = !hasSelection;
                moveDownBtn.disabled = !hasSelection;
                copyBtn.disabled = !hasSelection;
                deleteSelectedBtn.disabled = !hasSelection;
                pasteBtn.disabled = !hasClipboard;
                
                // Update paste button text to show clipboard status
                if (hasClipboard) {
                    const clipboardCount = clipboard.length;
                    pasteBtn.title = clipboardCount === 1 ? 
                        'لصق عنصر واحد' : 
                        `لصق ${clipboardCount} عناصر`;
                } else {
                    pasteBtn.title = 'لا يوجد عناصر في الحافظة';
                }
            }
            
            function getSelectedElements() {
                return Array.from(selectedElementIds)
                    .map(id => pageContent.find(item => item.id === id))
                    .filter(Boolean)
                    .sort((a, b) => {
                        const indexA = pageContent.indexOf(a);
                        const indexB = pageContent.indexOf(b);
                        return indexA - indexB;
                    });
            }
            
            function moveSelectedElementsUp() {
                const selectedElements = getSelectedElements();
                if (selectedElements.length === 0) return;
                
                let moved = false;
                const newPageContent = [...pageContent];
                
                // Sort selected elements by their current position (ascending)
                selectedElements.forEach(element => {
                    const currentIndex = newPageContent.indexOf(element);
                    if (currentIndex > 0) {
                        // Find the target position (skip over other selected elements)
                        let targetIndex = currentIndex - 1;
                        while (targetIndex > 0 && selectedElementIds.has(newPageContent[targetIndex].id)) {
                            targetIndex--;
                        }
                        
                        // Only move if target position is different and valid
                        if (targetIndex >= 0 && !selectedElementIds.has(newPageContent[targetIndex].id)) {
                            // Remove element from current position
                            newPageContent.splice(currentIndex, 1);
                            // Insert at target position
                            newPageContent.splice(targetIndex, 0, element);
                            moved = true;
                        }
                    }
                });
                
                if (moved) {
                    pageContent = newPageContent;
                    renderAll();
                    restoreSelection();
                    recordState('Move Elements Up');
                }
            }
            
            function moveSelectedElementsDown() {
                const selectedElements = getSelectedElements();
                if (selectedElements.length === 0) return;
                
                let moved = false;
                const newPageContent = [...pageContent];
                
                // Sort selected elements by their current position (descending) for down movement
                selectedElements.reverse().forEach(element => {
                    const currentIndex = newPageContent.indexOf(element);
                    if (currentIndex < newPageContent.length - 1) {
                        // Find the target position (skip over other selected elements)
                        let targetIndex = currentIndex + 1;
                        while (targetIndex < newPageContent.length - 1 && selectedElementIds.has(newPageContent[targetIndex].id)) {
                            targetIndex++;
                        }
                        
                        // Only move if target position is different and valid
                        if (targetIndex < newPageContent.length && !selectedElementIds.has(newPageContent[targetIndex].id)) {
                            // Remove element from current position
                            newPageContent.splice(currentIndex, 1);
                            // Insert at target position
                            newPageContent.splice(targetIndex, 0, element);
                            moved = true;
                        }
                    }
                });
                
                if (moved) {
                    pageContent = newPageContent;
                    renderAll();
                    restoreSelection();
                    recordState('Move Elements Down');
                }
            }
            
            function restoreSelection() {
                // Re-apply selection styles after re-rendering
                selectedElementIds.forEach(id => {
                    const element = document.querySelector(`[data-item-id="${id}"]`);
                    if (element) {
                        element.classList.add('element-selected');
                    }
                });
            }
            
            function deleteSelectedElements() {
                try {
                    console.log('🗑️ Attempting to delete selected elements...');
                    
                    const selectedElements = getSelectedElements();
                    if (selectedElements.length === 0) {
                        console.log('🔎 No elements selected for deletion');
                        return;
                    }
                    
                    console.log('📋 Selected elements for deletion:', selectedElements.length, selectedElements.map(el => ({id: el.id, type: el.elementType})));
                    
                    const count = selectedElements.length;
                    const confirmTitle = 'تأكيد الحذف';
                    const confirmMessage = count === 1 
                        ? 'هل تريد حذف هذا العنصر؟'
                        : `هل تريد حذف ${count} عناصر محددة؟`;
                    
                    showConfirm(confirmTitle, confirmMessage, () => {
                        try {
                            console.log('🔄 Starting deletion process...');
                            
                            // Store original length for verification
                            const originalLength = pageContent.length;
                            
                            // Remove selected elements from pageContent
                            let deletedCount = 0;
                            selectedElements.forEach((element, index) => {
                                const elementIndex = pageContent.indexOf(element);
                                if (elementIndex > -1) {
                                    pageContent.splice(elementIndex, 1);
                                    deletedCount++;
                                    console.log(`✅ Deleted element ${index + 1}/${selectedElements.length}:`, element.id, element.elementType);
                                } else {
                                    console.warn(`⚠️ Element not found in pageContent:`, element.id);
                                }
                            });
                            
                            // Verify deletion was successful
                            const expectedLength = originalLength - deletedCount;
                            if (pageContent.length !== expectedLength) {
                                console.error('❌ Deletion verification failed. Expected length:', expectedLength, 'Actual length:', pageContent.length);
                                alert('خطأ: فشل في حذف بعض العناصر');
                            } else {
                                console.log(`✅ Successfully deleted ${deletedCount} elements. New pageContent length:`, pageContent.length);
                            }
                            
                            // Clear selection
                            clearSelection();
                            
                            // Re-render and record state
                            renderAll();
                            recordState(count === 1 ? 'Delete Selected Element' : `Delete ${count} Selected Elements`);
                            
                        } catch (innerError) {
                            console.error('❌ Error during deletion process:', innerError);
                            alert('خطأ في عملية الحذف: ' + innerError.message);
                        }
                    });
                    
                } catch (error) {
                    console.error('❌ Critical error in deleteSelectedElements:', error);
                    alert('خطأ في حذف العناصر المحددة: ' + error.message);
                }
            }
            
            function copySelectedElements() {
                const selectedElements = getSelectedElements();
                if (selectedElements.length === 0) return;
                
                // Deep clone the selected elements to prevent reference issues
                clipboard = selectedElements.map(element => {
                    const cloned = JSON.parse(JSON.stringify(element));
                    // Generate new IDs for cloned elements to avoid conflicts
                    cloned.id = `item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    return cloned;
                });
                
                // Store in browser clipboard as well (as text)
                const textContent = selectedElements.map(element => {
                    let text = '';
                    switch(element.elementType) {
                        case 'question':
                        case 'essayQuestion':
                            text = element.question || 'سؤال';
                            break;
                        case 'questionHeader':
                            text = element.text || 'رأس أسئلة';
                            break;
                        case 'readingPassage':
                            text = 'قطعة قراءة';
                            break;
                        case 'poeticText':
                            text = 'نص شعري';
                            break;
                        case 'pageTitle':
                            text = element.text || 'عنوان الصفحة';
                            break;
                        default:
                            text = 'عنصر';
                    }
                    return text;
                }).join('\n');
                
                // Copy to system clipboard
                navigator.clipboard.writeText(textContent).catch(err => {
                    console.warn('Failed to copy to system clipboard:', err);
                });
                
                updateSelectionControls();
                
                const count = selectedElements.length;
                recordState(count === 1 ? 'Copy Selected Element' : `Copy ${count} Selected Elements`);
            }
            
            function pasteElements() {
                if (!clipboard || clipboard.length === 0) return;
                
                // Determine insertion point
                let insertIndex = pageContent.length; // Default to end
                
                if (selectedElementIds.size > 0) {
                    // Insert after the last selected element
                    const selectedElements = getSelectedElements();
                    const lastSelected = selectedElements[selectedElements.length - 1];
                    insertIndex = pageContent.indexOf(lastSelected) + 1;
                }
                
                // Generate new IDs for pasted elements to avoid conflicts
                const elementsToInsert = clipboard.map(element => {
                    const newElement = JSON.parse(JSON.stringify(element));
                    newElement.id = `item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    return newElement;
                });
                
                // Insert elements
                pageContent.splice(insertIndex, 0, ...elementsToInsert);
                
                // Clear current selection and select pasted elements
                clearSelection();
                elementsToInsert.forEach(element => {
                    selectedElementIds.add(element.id);
                });
                
                // Re-render and restore selection
                renderAll();
                restoreSelection();
                updateSelectionControls();
                
                const count = elementsToInsert.length;
                recordState(count === 1 ? 'Paste Element' : `Paste ${count} Elements`);
            }
            
            function handleKeyboardShortcuts(event) {
                // Only handle shortcuts when selection mode is active
                if (!isSelectionMode) return;
                
                // Prevent shortcuts when typing in editable elements (though they should be disabled in selection mode)
                if (event.target.isContentEditable || event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                const isCtrl = event.ctrlKey || event.metaKey;
                
                if (isCtrl && event.key === 'a') {
                    // Ctrl+A - Select all elements
                    event.preventDefault();
                    selectAllElements();
                } else if (isCtrl && event.key === 'c') {
                    // Ctrl+C - Copy selected elements
                    event.preventDefault();
                    if (selectedElementIds.size > 0) {
                        copySelectedElements();
                    }
                } else if (isCtrl && event.key === 'v') {
                    // Ctrl+V - Paste elements
                    event.preventDefault();
                    if (clipboard && clipboard.length > 0) {
                        pasteElements();
                    }
                } else if (event.key === 'Delete' || event.key === 'Backspace') {
                    // Delete/Backspace - Delete selected elements
                    event.preventDefault();
                    if (selectedElementIds.size > 0) {
                        deleteSelectedElements();
                    }
                } else if (event.key === 'ArrowUp' && isCtrl) {
                    // Ctrl+Arrow Up - Move elements up
                    event.preventDefault();
                    if (selectedElementIds.size > 0) {
                        moveSelectedElementsUp();
                    }
                } else if (event.key === 'ArrowDown' && isCtrl) {
                    // Ctrl+Arrow Down - Move elements down
                    event.preventDefault();
                    if (selectedElementIds.size > 0) {
                        moveSelectedElementsDown();
                    }
                } else if (event.key === 'Escape') {
                    // Escape - Exit selection mode or clear selection
                    event.preventDefault();
                    if (selectedElementIds.size > 0) {
                        clearSelection();
                    } else {
                        toggleSelectionMode();
                    }
                }
            }
            
            function selectAllElements() {
                // Clear current selection
                clearSelection();
                
                // Select all selectable elements
                pageContent.forEach(item => {
                    if (selectableTypes.includes(item.elementType)) {
                        selectedElementIds.add(item.id);
                        const element = document.querySelector(`[data-item-id="${item.id}"]`);
                        if (element) {
                            element.classList.add('element-selected');
                        }
                    }
                });
                
                updateSelectionControls();
            }
            
            // Debug function for selection mode (console access only)
            function debugSelection() {
                return {
                    selectionMode: isSelectionMode,
                    selectedIds: Array.from(selectedElementIds),
                    selectableTypes: selectableTypes,
                    pageContent: pageContent.map(item => ({ id: item.id, type: item.elementType })),
                    domElements: Array.from(document.querySelectorAll('[data-item-id]')).map(el => ({
                        id: el.dataset.itemId,
                        selected: el.classList.contains('element-selected'),
                        tagName: el.tagName
                    }))
                };
            }
            
            // Make debug function available globally for testing
            window.debugSelection = debugSelection;
            function startFromScratch() {
                isInitialized = false; // Disable recording during reset
                pageContent = [];
                startPageNumber = 1;
                actionHistory = []; // Reset action history
                currentActionIndex = -1; // Reset index
                history = []; // Reset main history
                redoStack = []; // Reset redo stack
                renderAll();
                
                // Initialize dimmed overlays for controls based on default states
                const headerFooterControls = document.getElementById('header-footer-controls');
                const pageNumberControls = document.getElementById('page-number-controls');
                const isHeaderOrFooterVisible = headerFooterState.header.visible || headerFooterState.footer.visible;
                headerFooterControls.classList.toggle('disabled', !isHeaderOrFooterVisible);
                pageNumberControls.classList.toggle('disabled', !pageNumberVisible);
                
                // Mark as initialized and record initial state
                isInitialized = true;
                recordState("Initial empty state");
            }

            function mapJsonToPageContent(data) {
                 return data.map((row, index) => ({
                    elementType: 'question', id: `q-${Date.now()}-${index}`, question: row['السؤال'] || "نص السؤال فارغ",
                    answers: { a: row['الإجابة أ'] || "", b: row['الإجابة ب'] || "", c: row['الإجابة ج'] || "", d: row['الإجابة د'] || "" },
                    statement: row['العبارة'] || null, image: row['الصورة'] || null, layoutType: row['النوع'] || 3, restartNumbering: row['بدء عد جديد'] ? 1 : false
                }));
            }
            
            function parseAndLoadQuestions(data) { 
                isInitialized = false; // Disable recording during load
                pageContent = mapJsonToPageContent(data); 
                startPageNumber = 1; 
                actionHistory = []; // Reset action history for new document
                currentActionIndex = -1; // Reset index
                history = []; // Reset main history
                redoStack = []; // Reset redo stack
                renderAll();
                
                // Initialize dimmed overlays for controls based on default states
                const headerFooterControls = document.getElementById('header-footer-controls');
                const pageNumberControls = document.getElementById('page-number-controls');
                const isHeaderOrFooterVisible = headerFooterState.header.visible || headerFooterState.footer.visible;
                headerFooterControls.classList.toggle('disabled', !isHeaderOrFooterVisible);
                pageNumberControls.classList.toggle('disabled', !pageNumberVisible);
                
                // Mark as initialized and record initial state
                isInitialized = true;
                recordState("Load from Excel"); 
            }
            function appendQuestions(data) { const newItems = mapJsonToPageContent(data); pageContent = pageContent.concat(newItems); recordState("Append from Excel"); renderAll(); }

            // Debug function to check contenteditable status
            function debugContentEditable() {
                console.log('=== ContentEditable Debug ===');
                console.log('isSelectionMode:', isSelectionMode);
                console.log('body.selection-mode class:', document.body.classList.contains('selection-mode'));
                
                const editableElements = document.querySelectorAll('[contenteditable], [data-was-editable]');
                console.log('Total elements with contenteditable or data-was-editable:', editableElements.length);
                
                editableElements.forEach((el, index) => {
                    console.log(`Element ${index + 1}:`, {
                        tagName: el.tagName,
                        className: el.className,
                        contenteditable: el.getAttribute('contenteditable'),
                        wasEditable: el.dataset.wasEditable,
                        isContentEditable: el.isContentEditable,
                        zIndex: window.getComputedStyle(el).zIndex,
                        pointerEvents: window.getComputedStyle(el).pointerEvents
                    });
                });
                console.log('=== End Debug ===');
            }
            
            // Add debug function to window for console access
            window.debugContentEditable = debugContentEditable;
            
            function renderAll() {
                pagesContainer.innerHTML = "";
                if (document.activeElement) document.activeElement.blur();
                
                if (kashidaObserver) kashidaObserver.disconnect();
                
                if (pageContent.length === 0) {
                    addNewPage();
                    updatePageNumbers();
                    updateAllWatermarks(); 
                    return;
                }
                
                let questionCounter = 1;
                const elements = pageContent.map((item) => {
                    let element;
                    if (item.restartNumbering !== false && !isNaN(parseInt(item.restartNumbering, 10))) {
                        questionCounter = parseInt(item.restartNumbering, 10);
                    }
                    
                    switch(item.elementType) {
                        case 'pageTitle': element = createPageTitleElement(item); break;
                        case 'question': element = createQuestionElement(item, questionCounter); questionCounter++; break;
                        case 'essayQuestion': element = createEssayQuestionElement(item, questionCounter); questionCounter++; break;
                        case 'questionHeader': element = createQuestionHeaderElement(item); break;
                        case 'readingPassage': element = createReadingPassageElement(item); break;
                        case 'poeticText': element = createPoeticTextElement(item); break;
                        case 'student-info': element = createStudentInfoElement(item); break;
                    }
                    return element;
                }).filter(Boolean);

                let currentPage = addNewPage();
                let currentHeight = 0;
                const pageHeightLimit = 1000;

                elements.forEach(el => {
                    currentPage.appendChild(el);
                    el.style.display = 'block'; // Ensure visibility for height calculation
                    const elStyle = getComputedStyle(el);
                    const elHeight = el.offsetHeight + parseFloat(elStyle.marginTop || 0) + parseFloat(elStyle.marginBottom || 0);

                    if (currentHeight > 0 && (currentHeight + elHeight) > pageHeightLimit) {
                        el.remove(); // Remove from current page
                        currentPage = addNewPage();
                        currentPage.appendChild(el);
                        currentHeight = elHeight;
                    } else {
                        currentHeight += elHeight;
                    }
                });
                
                updatePageNumbers();
                updateAllWatermarks();
                
                pagesContainer.querySelectorAll('.poetry-wrapper').forEach(wrapper => {
                    const item = pageContent.find(p => p.id === wrapper.dataset.itemId);
                    if (item && item.useKashida) {
                         wrapper.querySelectorAll('.poetry-shatr').forEach(shatr => kashidaObserver.observe(shatr));
                    }
                });
                
                // Initialize placeholder system for all contenteditable elements
                initializePlaceholderSystem();
                
                // Restore contenteditable state if we were in selection mode
                if (isSelectionMode) {
                    // Re-disable contenteditable elements after rendering
                    setTimeout(() => {
                        document.querySelectorAll('[contenteditable="true"]').forEach(el => {
                            el.dataset.wasEditable = 'true';
                            el.setAttribute('contenteditable', 'false');
                        });
                    }, 10);
                }
            }
            
            function initializePlaceholderSystem() {
                // Find all contenteditable elements that don't have placeholder system yet
                document.querySelectorAll('[contenteditable="true"]').forEach(element => {
                    // Skip if already has placeholder listeners
                    if (element.hasPlaceholderListeners) return;
                    
                    // Get the item ID from the element or its parent
                    const itemId = element.dataset.itemId || element.closest('[data-item-id]')?.dataset.itemId;
                    
                    if (itemId) {
                        // Safe event listener management without DOM manipulation
                        if (!element.hasPlaceholderListeners) {
                            setupContentEditableElement(element, itemId);
                            element.hasPlaceholderListeners = true;
                        }
                    }
                });
            }


            function createPageTitleElement(item) {
                const header = document.createElement("div"); 
                header.className = "page-title"; 
                header.id = item.id;
                header.dataset.itemId = item.id;
                header.dataset.prop = "text";
                header.setAttribute("contenteditable", "true"); 
                header.innerHTML = item.text;
                setupContentEditableElement(header, item.id);
                return header;
            }

            function createQuestionElement(question, number) {
                const wrapper = document.createElement("div");
                wrapper.className = "question-wrapper";
                wrapper.id = question.id;
                wrapper.dataset.itemId = question.id;
                
                wrapper.innerHTML = `
                    <div class="question-main-content">
                        <div class="question-header">
                            <div class="question-body">
                                ${question.statement ? `<div class="statement-text" contenteditable="true" data-prop="statement">${question.statement}</div>` : ''}
                                <div class="question-line"> <span class="question-number">${number}</span> <div class="question-text" contenteditable="true" data-prop="question">${question.question}</div> </div>
                            </div>
                            <div class="answers-container answers-layout-${question.layoutType}">
                                <div class="answer-option"><div class="answer-head">أ</div><div class="answer-text" contenteditable="true" data-prop="answers.a">${question.answers.a}</div></div>
                                <div class="answer-option"><div class="answer-head">ب</div><div class="answer-text" contenteditable="true" data-prop="answers.b">${question.answers.b}</div></div>
                                <div class="answer-option"><div class="answer-head">ج</div><div class="answer-text" contenteditable="true" data-prop="answers.c">${question.answers.c}</div></div>
                                <div class="answer-option"><div class="answer-head">د</div><div class="answer-text" contenteditable="true" data-prop="answers.d">${question.answers.d}</div></div>
                            </div>
                        </div>
                        ${question.image ? `<img src="${question.image}" alt="صورة السؤال" class="question-image">` : ''}
                    </div>`;
                
                wrapper.querySelectorAll("[contenteditable]").forEach(el => { setupContentEditableElement(el, question.id); });
                return wrapper;
            }
            
            function createEssayQuestionElement(question, number) {
                const wrapper = document.createElement("div");
                wrapper.className = "question-wrapper";
                wrapper.id = question.id;
                wrapper.dataset.itemId = question.id;
                
                let linesHtml = '';
                for (let i = 0; i < (question.lines || 2); i++) linesHtml += '<div class="essay-answer-line"></div>';
                
                wrapper.innerHTML = `
                    <div class="question-main-content">
                        <div class="question-header">
                            <div class="question-body">
                                ${question.statement ? `<div class="statement-text" contenteditable="true" data-prop="statement">${question.statement}</div>` : ''}
                                <div class="question-line"> <span class="question-number">${number}</span> <div class="question-text" contenteditable="true" data-prop="question">${question.question}</div> </div>
                                <div class="essay-answer-lines"> ${linesHtml} </div>
                            </div>
                        </div>
                        ${question.image ? `<img src="${question.image}" alt="صورة السؤال" class="question-image">` : ''}
                    </div>`;
                
                wrapper.querySelectorAll("[contenteditable]").forEach(el => { setupContentEditableElement(el, question.id); });
                return wrapper;
            }

            function createQuestionHeaderElement(item) {
                const div = document.createElement('div'); div.className = 'question-list-header'; div.innerHTML = item.text; div.id = item.id;
                div.dataset.itemId = item.id; div.setAttribute('contenteditable', 'true'); div.dataset.prop = 'text';
                setupContentEditableElement(div, item.id);
                return div;
            }
            
            function createReadingPassageElement(item) {
                const wrapper = document.createElement('div'); 
                wrapper.className = 'reading-passage-wrapper'; 
                wrapper.id = item.id; 
                wrapper.dataset.itemId = item.id;
                
                const passageText = document.createElement('div'); 
                passageText.className = 'reading-passage-text';
                passageText.setAttribute('contenteditable', 'true');
                passageText.dataset.prop = 'text';
                passageText.innerHTML = item.text;
                
                // Add blur event for complete text editing
                passageText.addEventListener("blur", (e) => {
                    handlePassageTextEdit(e, item.id);
                });
                
                // Add focus event to show full text editing
                passageText.addEventListener("focus", (e) => {
                    // Convert numbered content back to editable format
                    const lines = wrapper.querySelectorAll('.passage-line-content');
                    const textLines = Array.from(lines).map(line => line.innerHTML.trim()).filter(line => line !== '');
                    e.target.innerHTML = textLines.join('<br>');
                });
                
                wrapper.appendChild(passageText);
                
                // Apply line numbering on creation
                applyPassageLineNumbering(wrapper, item.text);
                
                return wrapper;
            }

            function createPoeticTextElement(item) {
                const wrapper = document.createElement('div'); wrapper.className = 'poetry-wrapper'; wrapper.id = item.id; wrapper.dataset.itemId = item.id;
                const baits = item.text.split('\n').filter(line => line.trim() !== '');
                baits.forEach((baitText, index) => {
                    const baitContainer = document.createElement('div'); baitContainer.className = 'poetry-bait';
                    const baitContent = document.createElement('div'); baitContent.className = 'poetry-bait-content';
                    const [shatr1Text, shatr2Text = ''] = baitText.split('|').map(s => s.trim());
                    const shatr1 = document.createElement('div'); shatr1.className = 'poetry-shatr'; shatr1.setAttribute('contenteditable', 'true');
                    shatr1.dataset.useKashida = item.useKashida; shatr1.innerHTML = shatr1Text; // Use innerHTML to preserve formats
                    const shatr2 = document.createElement('div'); shatr2.className = 'poetry-shatr'; shatr2.setAttribute('contenteditable', 'true');
                    shatr2.dataset.useKashida = item.useKashida; shatr2.innerHTML = shatr2Text; // Use innerHTML
                    [shatr1, shatr2].forEach(shatr => { shatr.addEventListener('blur', () => handlePoetryEdit(item.id)); });
                    baitContent.appendChild(shatr1); baitContent.appendChild(shatr2);
                    const baitNumber = document.createElement('span'); baitNumber.className = 'poetry-bait-number'; baitNumber.textContent = `(${index + 1})`;
                    baitContainer.appendChild(baitNumber); baitContainer.appendChild(baitContent); wrapper.appendChild(baitContainer);
                }); return wrapper;
            }
            
            function fillSpaceToEnd(text, maxLength = 50) {
                // Return non-breaking spaces instead of underscores
                const spaces = '&nbsp;'.repeat(Math.max(0, maxLength - text.length));
                return spaces;
            }

            function createStudentInfoElement(item) {
                const wrapper = document.createElement("div");
                wrapper.className = "student-info-wrapper";
                wrapper.id = item.id;
                wrapper.dataset.itemId = item.id;
                
                let rows = [];
                let hasExamScore = item.fields.some(f => f.type === 'exam-score');
                let examScoreField = hasExamScore ? item.fields.find(f => f.type === 'exam-score') : null;
                
                // Generate rows based on selected fields (excluding exam-score for separate handling)
                item.fields.forEach(field => {
                    if (field.type === 'exam-score') return; // Skip exam-score, handle separately
                    
                    switch(field.type) {
                        case 'student-name':
                            const studentNameText = 'اسم الطالب:';
                            const studentNameSpace = fillSpaceToEnd(studentNameText);
                            rows.push(`
                                <div class="info-row">
                                    <div class="info-container">
                                        <span class="info-name">${studentNameText}</span>
                                        <span class="space">${studentNameSpace}</span>
                                    </div>
                                </div>
                            `);
                            break;
                        case 'group-name':
                            const groupNameText = 'اسم المجموعة:';
                            const groupNameSpace = fillSpaceToEnd(groupNameText);
                            rows.push(`
                                <div class="info-row">
                                    <div class="info-container">
                                        <span class="info-name">${groupNameText}</span>
                                        <span class="space">${groupNameSpace}</span>
                                    </div>
                                </div>
                            `);
                            break;
                        case 'grade-level':
                            // Check if student-code is also selected to put them on same line
                            const hasStudentCode = item.fields.some(f => f.type === 'student-code');
                            if (hasStudentCode) {
                                const gradeText = 'الصف الدراسي:';
                                const gradeSpace = fillSpaceToEnd(gradeText, 20);
                                const codeText = 'كود الطالب:';
                                const codeSpace = fillSpaceToEnd(codeText, 20);
                                rows.push(`
                                    <div class="info-row">
                                        <div class="info-container">
                                            <span class="info-name">${gradeText}</span>
                                            <span class="space">${gradeSpace}</span>
                                        </div>
                                        <div class="info-container">
                                            <span class="info-name">${codeText}</span>
                                            <span class="space">${codeSpace}</span>
                                        </div>
                                    </div>
                                `);
                            } else {
                                const gradeText = 'الصف الدراسي:';
                                const gradeSpace = fillSpaceToEnd(gradeText);
                                rows.push(`
                                    <div class="info-row">
                                        <div class="info-container">
                                            <span class="info-name">${gradeText}</span>
                                            <span class="space">${gradeSpace}</span>
                                        </div>
                                    </div>
                                `);
                            }
                            break;
                        case 'student-code':
                            // Only add if grade-level is not already added (to avoid duplication)
                            const hasGradeLevel = item.fields.some(f => f.type === 'grade-level');
                            if (!hasGradeLevel) {
                                const codeText = 'كود الطالب:';
                                const codeSpace = fillSpaceToEnd(codeText);
                                rows.push(`
                                    <div class="info-row">
                                        <div class="info-container">
                                            <span class="info-name">${codeText}</span>
                                            <span class="space">${codeSpace}</span>
                                        </div>
                                    </div>
                                `);
                            }
                            break;
                        case 'date':
                            const dateText = 'التاريخ:';
                            rows.push(`
                                <div class="info-row">
                                    <div class="info-container date-container">
                                        <span class="info-name">${dateText}</span>
                                        <span class="space date-space" style="max-width: 60px;"></span>
                                        <span class="date-separator">/</span>
                                        <span class="space date-space" style="max-width: 60px;"></span>
                                        <span class="date-separator">/</span>
                                        <span class="space date-space" style="max-width: 100px;"></span>
                                    </div>
                                </div>
                            `);
                            break;
                        case 'custom-field':
                            const customText = `${field.label}:`;
                            const customSpace = fillSpaceToEnd(customText);
                            rows.push(`
                                <div class="info-row">
                                    <div class="info-container">
                                        <span class="info-name">${customText}</span>
                                        <span class="space">${customSpace}</span>
                                    </div>
                                </div>
                            `);
                            break;
                    }
                });
                
                // Create the HTML content with exam score box
                const examScoreHtml = hasExamScore ? `
                    <div class="exam-score-box">
                        <div class="score-upper-half"></div>
                        <div class="score-lower-half">${examScoreField.totalScore}</div>
                    </div>
                ` : '';
                
                wrapper.innerHTML = `
                    <div class="student-info-container ${hasExamScore ? 'with-exam-score' : ''}">
                        ${examScoreHtml}
                        <div class="info-rows-container">
                            ${rows.join('')}
                        </div>
                    </div>
                `;
                
                return wrapper;
            }
            
            function handleHeaderFooterEdit(e) {
                const box = e.target;
                const type = box.dataset.hfType;
                const index = parseInt(box.dataset.hfIndex, 10);
                const stateItem = headerFooterState[type].items[index];

                if (stateItem && stateItem.type === 'text') {
                    if (stateItem.content !== box.innerHTML) {
                        stateItem.content = box.innerHTML;
                        document.querySelectorAll(`.page-${type} [data-hf-index='${index}']`).forEach(el => {
                            if (el !== box) el.innerHTML = box.innerHTML;
                        });
                        recordState("Edit Header/Footer");
                    }
                }
            }
            
            function handleBorderBoxEdit(e, boxId) {
                const content = e.target.innerHTML;
                const box = borderState.boxes.find(b => b.id === boxId);
                
                if (box && box.content !== content) {
                    box.content = content;
                    
                    // Update all instances of this border box across all pages
                    document.querySelectorAll(`[data-border-box-id='${boxId}']`).forEach(el => {
                        if (el !== e.target) {
                            el.innerHTML = content;
                        }
                    });
                    
                    recordState("Edit Border Box");
                }
            }
            
            function addNewPage() {
                const page = document.createElement("div"); page.className = "page";
                
                // Render Header (always present, but may be empty)
                const header = document.createElement('div'); 
                header.className = 'page-header';
                
                if(headerFooterState.header.items.length > 0) {
                    headerFooterState.header.items.forEach((item, index) => {
                        const box = document.createElement('div');
                        box.className = 'header-box';
                        box.dataset.hfType = 'header';
                        box.dataset.hfIndex = index;
                        if (item.type === 'logo') {
                            box.classList.add('is-logo');
                            box.innerHTML = `<img src="${item.content}" class="header-box-logo" alt="logo">`;
                        } else {
                            box.innerHTML = item.content;
                            box.setAttribute('contenteditable', 'true');
                            box.addEventListener('blur', handleHeaderFooterEdit);
                            // Ensure proper setup for text editing toolbar
                            setupContentEditableElement(box, `header-${index}`);
                        }
                        header.appendChild(box);
                    });
                }
                page.appendChild(header);
                
                // Render Footer (always present, but may be empty)
                const footer = document.createElement('div'); 
                footer.className = 'page-footer';
                
                if(headerFooterState.footer.items.length > 0) {
                    headerFooterState.footer.items.forEach((item, index) => {
                        const box = document.createElement('div');
                        box.className = 'footer-box';
                        box.innerHTML = item.content;
                        box.setAttribute('contenteditable', 'true');
                        box.dataset.hfType = 'footer';
                        box.dataset.hfIndex = index;
                        box.addEventListener('blur', handleHeaderFooterEdit);
                        // Ensure proper setup for text editing toolbar
                        setupContentEditableElement(box, `footer-${index}`); 
                        footer.appendChild(box);
                    });
                }
                page.appendChild(footer);

                // Render Page Number
                const pageNumDiv = document.createElement('div'); pageNumDiv.className = 'page-number';
                page.appendChild(pageNumDiv);
                
                // Render Inner Border if enabled
                if (borderState.enabled) {
                    const innerBorder = document.createElement('div');
                    innerBorder.className = 'page-inner-border';
                    // Apply current border styles
                    updateBorderCSSVariables();
                    page.appendChild(innerBorder);
                }
                
                // Render Border Boxes if border is enabled
                if (borderState.enabled && borderState.boxes.length > 0) {
                    // Group boxes by position
                    const boxesByPosition = {
                        'top-left': [],
                        'top-right': [],
                        'top-center': [],
                        'bottom-left': [],
                        'bottom-right': [],
                        'bottom-center': []
                    };
                    
                    borderState.boxes.forEach((box, index) => {
                        boxesByPosition[box.position].push({ ...box, index });
                    });
                    
                    // Create containers for each position that has boxes
                    Object.keys(boxesByPosition).forEach(position => {
                        const boxes = boxesByPosition[position];
                        if (boxes.length === 0) return;
                        
                        const container = document.createElement('div');
                        container.className = 'border-boxes-container';
                        
                        // Position the container
                        const positions = {
                            'top-left': { top: '0mm', left: '10mm' },
                            'top-right': { top: '0mm', right: '10mm' },
                            'top-center': { top: '0mm', left: '50%', transform: 'translateX(-50%)' },
                            'bottom-left': { bottom: '25mm', left: '25mm' },
                            'bottom-right': { bottom: '25mm', right: '25mm' },
                            'bottom-center': { bottom: '25mm', left: '50%', transform: 'translateX(-50%)' }
                        };
                        
                        Object.assign(container.style, positions[position]);
                        
                        // For top positions, make containers span full width like headers
                        if (position.startsWith('top-')) {
                            container.style.left = '0';
                            container.style.right = '0';
                            container.style.transform = 'none'; // Remove any transform for full-width containers
                        }
                        
                        // Add all boxes for this position to the container
                        boxes.forEach(box => {
                            const borderBox = document.createElement('div');
                            borderBox.className = 'page-border-box';
                            borderBox.dataset.borderBoxId = box.id;
                            borderBox.dataset.borderBoxIndex = box.index;
                            
                            if (box.type === 'logo') {
                                // Render as logo image
                                const img = document.createElement('img');
                                img.src = box.content;
                                img.style.height = 'var(--header-logo-height)';
                                img.style.maxWidth = '100%';
                                img.style.objectFit = 'contain';
                                borderBox.appendChild(img);
                                borderBox.contentEditable = false;
                            } else {
                                // Render as text
                                borderBox.innerHTML = box.content;
                                borderBox.setAttribute('contenteditable', 'true');
                                setupContentEditableElement(borderBox, 'border-' + box.id);
                                // Additional event setup for text editing toolbar
                                borderBox.addEventListener('mouseup', () => {
                                    setTimeout(() => handleSelectionChange(), 10);
                                });
                            }
                            
                            container.appendChild(borderBox);
                        });
                        
                        page.appendChild(container);
                    });
                }
                
                pagesContainer.appendChild(page);
                return page;
            }

            function updatePageNumbers() { document.querySelectorAll(".page").forEach((page, index) => { const footer = page.querySelector(".page-number"); if (footer) footer.textContent = index + startPageNumber; }); }
            
            function addPageTitle() {
                const newTitle = { 
                    elementType: 'pageTitle', 
                    id: `title-${Date.now()}`, 
                    text: 'أضف العنوان الرئيسي هنا...'
                };
                pageContent.push(newTitle); // Add title to the end
                recordState("Add Page Title");
                renderAll();
            }
            
            function addNewQuestion() { 
                const newQ = { 
                    elementType: 'question', 
                    id: `item-${Date.now()}`, 
                    question: "أضف نص السؤال هنا...", 
                    answers: { a: "إجابة أ", b: "إجابة ب", c: "إجابة ج", d: "إجابة د" }, 
                    statement: mcqDefaults.includeStatement ? "أضف العبارة التمهيدية هنا..." : null,
                    image: null, 
                    layoutType: mcqDefaults.defaultLayout,
                    restartNumbering: false 
                };
                pageContent.push(newQ);
                recordState("Add MCQ");
                renderAll();
            }

            function addNewEssayQuestion() { 
                const newQ = { 
                    elementType: 'essayQuestion', 
                    id: `item-${Date.now()}`, 
                    question: "أضف نص السؤال المقالي هنا...", 
                    lines: essayDefaults.defaultLines, 
                    statement: essayDefaults.includeStatement ? "أضف العبارة التمهيدية هنا..." : null, 
                    image: null, 
                    restartNumbering: false 
                };
                pageContent.push(newQ);
                recordState("Add Essay Question");
                renderAll();
            }

            function addQuestionHeader() { const newHeader = { elementType: 'questionHeader', id: `item-${Date.now()}`, text: 'أضف رأس الأسئلة هنا', restartNumbering: false }; pageContent.push(newHeader); recordState("Add Question Header"); renderAll(); }
            
            function toggleHeaderVisibility(event) {
                headerFooterState.header.visible = event.target.checked;
                document.body.classList.toggle('header-hidden', !headerFooterState.header.visible);
                
                // Handle dimmed overlay for header/footer controls
                const headerFooterControls = document.getElementById('header-footer-controls');
                const isHeaderOrFooterVisible = headerFooterState.header.visible || headerFooterState.footer.visible;
                headerFooterControls.classList.toggle('disabled', !isHeaderOrFooterVisible);
                
                // Auto-disable border when header is enabled
                if (event.target.checked && borderState.enabled) {
                    borderState.enabled = false;
                    toggleBorderCheckbox.checked = false;
                    document.body.classList.remove('border-active');
                    borderControls.classList.add('disabled');
                }
                
                recordState("Toggle Header Visibility");
                renderAll(); // Re-render to apply changes
            }
            function toggleFooterVisibility(event) {
                headerFooterState.footer.visible = event.target.checked;
                document.body.classList.toggle('footer-hidden', !headerFooterState.footer.visible);
                
                // Handle dimmed overlay for header/footer controls
                const headerFooterControls = document.getElementById('header-footer-controls');
                const isHeaderOrFooterVisible = headerFooterState.header.visible || headerFooterState.footer.visible;
                headerFooterControls.classList.toggle('disabled', !isHeaderOrFooterVisible);
                
                // Auto-disable border when footer is enabled
                if (event.target.checked && borderState.enabled) {
                    borderState.enabled = false;
                    toggleBorderCheckbox.checked = false;
                    document.body.classList.remove('border-active');
                    borderControls.classList.add('disabled');
                }
                
                recordState("Toggle Footer Visibility");
                renderAll(); // Re-render to apply changes
            }
            
            function toggleBorderVisibility(event) {
                borderState.enabled = event.target.checked;
                document.body.classList.toggle('border-active', borderState.enabled);
                borderControls.classList.toggle('disabled', !borderState.enabled);
                
                // Auto-disable header and footer when border is enabled
                if (borderState.enabled) {
                    headerFooterState.header.visible = false;
                    headerFooterState.footer.visible = false;
                    toggleHeaderCheckbox.checked = false;
                    toggleFooterCheckbox.checked = false;
                    document.body.classList.add('header-hidden', 'footer-hidden');
                }
                
                renderAll(); // Re-render to apply border changes
                recordState("Toggle Page Border");
            }
            
            function togglePageNumberVisibility(event) {
                pageNumberVisible = event.target.checked;
                document.body.classList.toggle('page-number-hidden', !pageNumberVisible);
                
                // Handle dimmed overlay for page number controls
                const pageNumberControls = document.getElementById('page-number-controls');
                pageNumberControls.classList.toggle('disabled', !pageNumberVisible);
                
                recordState("Toggle Page Number Visibility");
            }
            
            function toggleBorderStyleMode(event) {
                const unifiedMode = event.target.checked;
                borderState.unifiedStyle = unifiedMode;
                
                document.getElementById('unified-border-style').style.display = unifiedMode ? 'block' : 'none';
                document.getElementById('individual-border-styles').style.display = unifiedMode ? 'none' : 'block';
                
                if (unifiedMode) {
                    // Apply unified style to all sides
                    const selectedOption = document.querySelector('.border-style-option.selected');
                    const style = selectedOption ? selectedOption.dataset.style : 'solid';
                    borderState.style = style;
                    borderState.topStyle = style;
                    borderState.rightStyle = style;
                    borderState.bottomStyle = style;
                    borderState.leftStyle = style;
                    updateBorderCSSVariables();
                }
                
                updateBorderStyleVisualSelector();
                recordState("Change Border Style Mode");
            }
            
            function updateBorderCSSVariables() {
                const root = document.documentElement;
                root.style.setProperty('--page-border-top-style', borderState.topStyle);
                root.style.setProperty('--page-border-right-style', borderState.rightStyle);
                root.style.setProperty('--page-border-bottom-style', borderState.bottomStyle);
                root.style.setProperty('--page-border-left-style', borderState.leftStyle);
            }
            
            function updateBorderStyleVisualSelector() {
                // Update visual selector for unified mode
                if (borderState.unifiedStyle) {
                    document.querySelectorAll('#unified-border-style .border-style-option').forEach(opt => opt.classList.remove('selected'));
                    const activeOption = document.querySelector(`#unified-border-style .border-style-option[data-style="${borderState.style}"]`);
                    if (activeOption) {
                        activeOption.classList.add('selected');
                    }
                }
                
                // Always update individual selectors (for proper state display)
                const sideStyles = {
                    'top': borderState.topStyle || 'solid',
                    'right': borderState.rightStyle || 'solid',
                    'bottom': borderState.bottomStyle || 'solid',
                    'left': borderState.leftStyle || 'solid'
                };
                
                Object.keys(sideStyles).forEach(side => {
                    const selector = document.querySelector(`[data-border-side="${side}"]`);
                    if (selector) {
                        selector.querySelectorAll('.border-style-option').forEach(opt => opt.classList.remove('selected'));
                        const activeOption = selector.querySelector(`[data-style="${sideStyles[side]}"]`);
                        if (activeOption) {
                            activeOption.classList.add('selected');
                        }
                    }
                });
            }
            
            function handleBorderBoxEdit(event, boxId) {
                const box = borderState.boxes.find(b => b.id === boxId);
                if (box && box.type === 'text') {
                    box.content = event.target.innerHTML;
                    recordState("Edit Border Box");
                }
            }
            
            function addBorderBox() {
                const newBox = {
                    id: `border-box-${Date.now()}`,
                    type: 'text',
                    content: 'خانة جديدة',
                    position: 'top-left', // top-left, top-right, bottom-left, bottom-right, top-center, bottom-center
                    x: 5, // offset from border edge in mm (smaller since it's within content area)
                    y: 5  // offset from border edge in mm
                };
                
                borderState.boxes.push(newBox);
                renderAll();
                recordState("Add Border Box");
            }

            // Test function for debugging - can be called from console
            window.testModals = function() {
                console.log('🧪 Testing all modal elements...');
                
                const modals = {
                    'passagePromptOverlay': passagePromptOverlay,
                    'poetryPromptOverlay': poetryPromptOverlay,
                    'studentInfoPromptOverlay': studentInfoPromptOverlay,
                    'watermarkPromptOverlay': watermarkPromptOverlay,
                    'qDefaultsPromptOverlay': qDefaultsPromptOverlay,
                    'essayDefaultsPromptOverlay': essayDefaultsPromptOverlay
                };
                
                Object.entries(modals).forEach(([name, modal]) => {
                    if (modal) {
                        console.log(`✅ ${name} exists:`, modal);
                        console.log(`   Classes:`, modal.className);
                        console.log(`   Style display:`, modal.style.display);
                        console.log(`   Computed display:`, getComputedStyle(modal).display);
                    } else {
                        console.log(`❌ ${name} does not exist`);
                    }
                });
                
                return modals;
            };
            
            // Test function to manually show a modal
            window.forceShowModal = function(modalName) {
                const modals = {
                    'passage': passagePromptOverlay,
                    'poetry': poetryPromptOverlay,
                    'studentInfo': studentInfoPromptOverlay,
                    'watermark': watermarkPromptOverlay,
                    'mcqDefaults': qDefaultsPromptOverlay,
                    'essayDefaults': essayDefaultsPromptOverlay
                };
                
                const modal = modals[modalName];
                if (modal) {
                    console.log(`🔧 Force showing ${modalName} modal...`);
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex';
                    modal.style.visibility = 'visible';
                    modal.style.zIndex = '10000';
                    console.log(`✅ ${modalName} modal should be visible now`);
                } else {
                    console.log(`❌ Modal ${modalName} not found`);
                }
            };

            // Robust modal show function with error handling
            function showModal(modalElement, modalName) {
                if (!modalElement) {
                    console.error(`❌ ${modalName} element not found!`);
                    alert(`خطأ: لم يتم العثور على عنصر ${modalName}`);
                    return false;
                }
                
                try {
                    // Simple approach: remove hidden class and set basic styles
                    modalElement.classList.remove('hidden');
                    
                    // Use only essential style properties
                    modalElement.style.display = 'flex';
                    modalElement.style.visibility = 'visible';
                    
                    console.log(`✅ ${modalName} shown successfully`);
                    return true;
                } catch (error) {
                    console.error(`❌ Error showing ${modalName}:`, error);
                    alert(`خطأ في عرض ${modalName}: ${error.message}`);
                    return false;
                }
            } 
            function showReadingPassagePrompt() { 
                console.log('🔍 showReadingPassagePrompt called');
                if (showModal(passagePromptOverlay, 'Reading Passage Modal')) {
                    document.getElementById('passage-prompt-text').value = ''; 
                    document.getElementById('passage-prompt-q-count').value = '1'; 
                    document.getElementById('passage-prompt-text').focus();
                }
            }
            function showPoetryPrompt() { 
                console.log('🔍 showPoetryPrompt called');
                if (showModal(poetryPromptOverlay, 'Poetry Modal')) {
                    document.getElementById('poetry-prompt-text').value = ''; 
                    document.getElementById('poetry-prompt-q-count').value = '1'; 
                    document.getElementById('poetry-prompt-kashida-toggle').checked = true; 
                    document.getElementById('poetry-prompt-text').focus();
                }
            }
            
            function showStudentInfoPrompt() {
                console.log('🔍 showStudentInfoPrompt called');
                
                if (showModal(studentInfoPromptOverlay, 'Student Info Modal')) {
                    // Reset all checkboxes to default state
                    document.getElementById('include-student-name').checked = true;
                    document.getElementById('include-group-name').checked = false;
                    document.getElementById('include-grade-level').checked = false;
                    document.getElementById('include-student-code').checked = false;
                    document.getElementById('include-date').checked = false;
                    document.getElementById('include-exam-score').checked = false;
                    document.getElementById('include-custom-field').checked = false;
                    
                    // Hide conditional settings
                    document.getElementById('exam-score-settings').style.display = 'none';
                    document.getElementById('custom-field-settings').style.display = 'none';
                    
                    // Clear input values
                    document.getElementById('exam-total-score').value = '';
                    document.getElementById('custom-field-label').value = '';
                }
            }
            
            function handleStudentInfoAdd() {
                const selectedFields = [];
                const editingId = studentInfoPromptOverlay.dataset.editingId;
                
                if (document.getElementById('include-student-name').checked) {
                    selectedFields.push({ type: 'student-name', label: 'اسم الطالب' });
                }
                
                if (document.getElementById('include-group-name').checked) {
                    selectedFields.push({ type: 'group-name', label: 'اسم المجموعة' });
                }
                
                if (document.getElementById('include-grade-level').checked) {
                    selectedFields.push({ type: 'grade-level', label: 'الصف الدراسي' });
                }
                
                if (document.getElementById('include-student-code').checked) {
                    selectedFields.push({ type: 'student-code', label: 'كود الطالب' });
                }
                
                if (document.getElementById('include-date').checked) {
                    selectedFields.push({ type: 'date', label: 'تاريخ اليوم' });
                }
                
                if (document.getElementById('include-exam-score').checked) {
                    const totalScore = document.getElementById('exam-total-score').value;
                    selectedFields.push({ type: 'exam-score', label: 'درجة الامتحان', totalScore: totalScore || '100' });
                }
                
                if (document.getElementById('include-custom-field').checked) {
                    const customLabel = document.getElementById('custom-field-label').value;
                    if (customLabel.trim()) {
                        selectedFields.push({ type: 'custom-field', label: customLabel.trim() });
                    }
                }
                
                if (selectedFields.length > 0) {
                    if (editingId) {
                        // Edit existing student info
                        const item = pageContent.find(q => q.id === editingId);
                        if (item) {
                            item.fields = selectedFields;
                            recordState('تعديل صندوق معلومات الطالب');
                            renderAll();
                        }
                    } else {
                        // Add new student info
                        addStudentInfoBox(selectedFields);
                    }
                }
                
                // Clear editing state
                delete studentInfoPromptOverlay.dataset.editingId;
                studentInfoPromptOverlay.classList.add('hidden');
            }
            
            function editStudentInfoElements(itemId) {
                const item = pageContent.find(q => q.id === itemId);
                if (!item || item.elementType !== 'student-info') return;
                
                // Reset all checkboxes
                document.getElementById('include-student-name').checked = false;
                document.getElementById('include-group-name').checked = false;
                document.getElementById('include-grade-level').checked = false;
                document.getElementById('include-student-code').checked = false;
                document.getElementById('include-date').checked = false;
                document.getElementById('include-exam-score').checked = false;
                document.getElementById('include-custom-field').checked = false;
                
                // Set checkboxes based on current fields
                item.fields.forEach(field => {
                    switch(field.type) {
                        case 'student-name':
                            document.getElementById('include-student-name').checked = true;
                            break;
                        case 'group-name':
                            document.getElementById('include-group-name').checked = true;
                            break;
                        case 'grade-level':
                            document.getElementById('include-grade-level').checked = true;
                            break;
                        case 'student-code':
                            document.getElementById('include-student-code').checked = true;
                            break;
                        case 'date':
                            document.getElementById('include-date').checked = true;
                            break;
                        case 'exam-score':
                            document.getElementById('include-exam-score').checked = true;
                            document.getElementById('exam-total-score').value = field.totalScore || '100';
                            document.getElementById('exam-score-settings').style.display = 'block';
                            break;
                        case 'custom-field':
                            document.getElementById('include-custom-field').checked = true;
                            document.getElementById('custom-field-label').value = field.label || '';
                            document.getElementById('custom-field-settings').style.display = 'block';
                            break;
                    }
                });
                
                // Store the ID for editing
                studentInfoPromptOverlay.dataset.editingId = itemId;
                studentInfoPromptOverlay.classList.remove('hidden');
            }

            function generateId() {
                return `item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            }

            function addStudentInfoBox(fields) {
                const studentInfoBox = {
                    id: generateId(),
                    elementType: 'student-info',
                    fields: fields
                };
                
                pageContent.push(studentInfoBox);
                recordState('إضافة صندوق معلومات الطالب');
                renderAll();
            }

            let tempWatermarkImageData = null;

            function setupWatermarkPromptListeners() {
                // Simple check - if already initialized, skip
                if (window.watermarkInitialized) {
                    console.log('✅ Watermark listeners already initialized, skipping...');
                    return;
                }
                
                console.log('🔧 Setting up watermark listeners...');
                
                // Setup radio buttons, sliders, and inputs - only once
                const elements = [
                    { selector: 'input[name="watermark-type"]', event: 'change', handler: (e) => updateWatermarkSizeSliderUI(e.target.value) },
                    { id: 'watermark-image-upload-btn', event: 'click', handler: () => document.getElementById('watermark-image-input').click() },
                    { id: 'watermark-opacity', event: 'input', handler: (e) => updateSliderValueDisplay(e.target, '') },
                    { id: 'watermark-rotation', event: 'input', handler: (e) => updateSliderValueDisplay(e.target, '°') },
                    { id: 'watermark-size', event: 'input', handler: (e) => updateSliderValueDisplay(e.target, e.target.dataset.unit) }
                ];
                
                elements.forEach(item => {
                    if (item.selector) {
                        document.querySelectorAll(item.selector).forEach(el => {
                            if (!el.hasAttribute('data-listener-attached')) {
                                el.addEventListener(item.event, item.handler);
                                el.setAttribute('data-listener-attached', 'true');
                            }
                        });
                    } else if (item.id) {
                        const el = document.getElementById(item.id);
                        if (el && !el.hasAttribute('data-listener-attached')) {
                            el.addEventListener(item.event, item.handler);
                            el.setAttribute('data-listener-attached', 'true');
                        }
                    }
                });
                
                // File input handler
                const imageInput = document.getElementById('watermark-image-input');
                if (imageInput && !imageInput.hasAttribute('data-listener-attached')) {
                    imageInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            if (!file.type.startsWith('image/')) {
                                alert('الرجاء اختيار ملف صورة صحيح.');
                                e.target.value = '';
                                return;
                            }
                            if (file.size > 5 * 1024 * 1024) {
                                alert('حجم الصورة كبير جدا. الرجاء اختيار صورة أقل من 5 ميجابايت.');
                                e.target.value = '';
                                return;
                            }
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                tempWatermarkImageData = event.target.result;
                                document.getElementById('watermark-image-name').textContent = file.name;
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                    imageInput.setAttribute('data-listener-attached', 'true');
                }
                
                window.watermarkInitialized = true;
                console.log('✅ Watermark listeners initialized successfully');
            }
            
            // Function to reset watermark modal state
            function resetWatermarkModalState() {
                console.log('🔄 Resetting watermark modal state...');
                
                // Reset temporary image data
                tempWatermarkImageData = null;
                
                // Reset file input if it exists
                const imageInput = document.getElementById('watermark-image-input');
                if (imageInput) {
                    imageInput.value = '';
                }
                
                // Reset image name display
                const imageName = document.getElementById('watermark-image-name');
                if (imageName) {
                    imageName.textContent = 'لم يتم اختيار صورة';
                }
                
                console.log('✅ Watermark modal state reset completed');
            }
            
            function updateWatermarkSizeSliderUI(type) {
                document.getElementById('watermark-text-control').classList.toggle('hidden', type !== 'text');
                document.getElementById('watermark-image-control').classList.toggle('hidden', type === 'text');

                const sizeSlider = document.getElementById('watermark-size');
                const sizeLabel = document.getElementById('watermark-size-label');

                if (type === 'text') {
                    sizeLabel.textContent = 'حجم الخط';
                    sizeSlider.min = 20;
                    sizeSlider.max = 200;
                    sizeSlider.step = 2;
                    sizeSlider.dataset.unit = 'px';
                    
                    // Ensure current value is within text range
                    const currentValue = parseInt(sizeSlider.value, 10);
                    if (currentValue < 20) sizeSlider.value = 80;
                    if (currentValue > 200) sizeSlider.value = 80;
                } else {
                    sizeLabel.textContent = 'حجم الصورة (%)';
                    sizeSlider.min = 10;
                    sizeSlider.max = 100;
                    sizeSlider.step = 1;
                    sizeSlider.dataset.unit = '%';
                    
                    // Ensure current value is within image range
                    const currentValue = parseInt(sizeSlider.value, 10);
                    if (currentValue < 10) sizeSlider.value = 50;
                    if (currentValue > 100) sizeSlider.value = 50;
                }
                
                updateSliderValueDisplay(sizeSlider, sizeSlider.dataset.unit);
            }

            function showWatermarkPrompt() {
                console.log('🔍 showWatermarkPrompt called');
                
                if (showModal(watermarkPromptOverlay, 'Watermark Modal')) {
                    // Reset modal state first to ensure clean state
                    resetWatermarkModalState();
                    
                    // Initialize temporary image data from current state
                    tempWatermarkImageData = watermarkState.imageData;
                    
                    // Set slider values from current state
                    document.getElementById('watermark-opacity').value = watermarkState.opacity || 0.25;
                    document.getElementById('watermark-rotation').value = watermarkState.rotation || 0;
                    document.getElementById('watermark-size').value = watermarkState.size || 80;
                    
                    // Update slider displays
                    updateSliderValueDisplay(document.getElementById('watermark-opacity'), '');
                    updateSliderValueDisplay(document.getElementById('watermark-rotation'), '°');
                    
                    // Set watermark type radio button
                    const currentType = watermarkState.visible ? watermarkState.type : 'text';
                    const typeRadio = document.querySelector(`input[name="watermark-type"][value="${currentType}"]`);
                    if (typeRadio) {
                        typeRadio.checked = true;
                    }
                    
                    // Set content based on type
                    if (currentType === 'image') {
                        document.getElementById('watermark-text-input').value = '';
                        if (watermarkState.imageName) {
                            document.getElementById('watermark-image-name').textContent = watermarkState.imageName;
                        }
                    } else {
                        document.getElementById('watermark-text-input').value = watermarkState.visible && watermarkState.type === 'text' ? watermarkState.content : '';
                    }
                    
                    // Update UI based on selected type
                    updateWatermarkSizeSliderUI(currentType);
                    
                    console.log('✅ Watermark modal state initialized successfully');
                }
            }

            function handleWatermarkApply() {
                const type = document.querySelector('input[name="watermark-type"]:checked').value;
                const text = document.getElementById('watermark-text-input').value;
                
                if (type === 'text') {
                    if (!text.trim()) {
                        alert('الرجاء إدخال نص للعلامة المائية.');
                        return;
                    }
                    watermarkState.content = text.trim();
                    watermarkState.imageData = null;
                    watermarkState.imageName = '';
                } else if (type === 'image') {
                    if (!tempWatermarkImageData) {
                        alert('الرجاء اختيار صورة للعلامة المائية.');
                        return;
                    }
                    watermarkState.content = tempWatermarkImageData;
                    watermarkState.imageData = tempWatermarkImageData;
                    watermarkState.imageName = document.getElementById('watermark-image-name').textContent;
                }
                
                // Update watermark properties
                watermarkState.type = type;
                watermarkState.opacity = parseFloat(document.getElementById('watermark-opacity').value);
                watermarkState.rotation = parseInt(document.getElementById('watermark-rotation').value, 10);
                watermarkState.size = parseInt(document.getElementById('watermark-size').value, 10);
                watermarkState.visible = true;

                watermarkPromptOverlay.classList.add('hidden');
                updateAllWatermarks();
                recordState('Apply Watermark');
            }

            function handleWatermarkRemove() {
                 watermarkState = { type: 'text', content: '', opacity: 0.25, rotation: 0, size: 80, visible: false, imageName: '', imageData: null };
                watermarkPromptOverlay.classList.add('hidden');
                updateAllWatermarks();
                recordState('Remove Watermark');
            }

            function updateAllWatermarks() {
                // Remove all existing watermarks
                document.querySelectorAll('.page-watermark').forEach(wm => wm.remove());
                
                // Exit if watermark is not visible or has no content
                if (!watermarkState.visible || !watermarkState.content) return;
                
                document.querySelectorAll('.page').forEach(page => {
                    const watermarkContainer = document.createElement('div');
                    watermarkContainer.className = 'page-watermark';

                    const contentWrapper = document.createElement('div');
                    contentWrapper.className = 'watermark-content-wrapper';
                    contentWrapper.style.opacity = watermarkState.opacity;
                    contentWrapper.style.transform = `rotate(${watermarkState.rotation}deg)`;

                    let contentElement;
                    if (watermarkState.type === 'text') {
                        contentElement = document.createElement('div');
                        contentElement.className = 'watermark-content';
                        contentElement.textContent = watermarkState.content;
                        contentElement.style.fontSize = `${watermarkState.size}px`;
                        contentElement.style.fontFamily = 'var(--font-main)';
                        contentElement.style.fontWeight = 'bold';
                    } else if (watermarkState.type === 'image' && watermarkState.imageData) {
                        contentElement = document.createElement('img');
                        contentElement.className = 'watermark-content is-image';
                        contentElement.src = watermarkState.imageData;
                        contentElement.style.maxWidth = `${watermarkState.size}%`;
                        contentElement.style.maxHeight = `${watermarkState.size}%`;
                        contentElement.style.objectFit = 'contain';
                        
                        // Add error handling for broken images
                        contentElement.onerror = function() {
                            console.warn('Failed to load watermark image');
                            this.style.display = 'none';
                        };
                    }

                    if (contentElement) {
                        contentWrapper.appendChild(contentElement);
                        watermarkContainer.appendChild(contentWrapper);
                        page.appendChild(watermarkContainer);
                    }
                });
            }

            function addReadingPassage(text, qCount) {
                const passageId = `item-${Date.now()}`; const formattedText = `<p>${text.replace(/\n/g, '</p><p>')}</p>`;
                const newPassage = { elementType: 'readingPassage', id: passageId, text: formattedText, restartNumbering: 1 }; pageContent.push(newPassage);
                for(let i = 0; i < qCount; i++) { const newQ = { elementType: 'question', id: `item-${Date.now()}-${i}`, passageId: passageId, question: `سؤال ${i+1} على القطعة...`, answers: { a: "إجابة أ", b: "إجابة ب", c: "إجابة ج", d: "إجابة د" }, statement: null, image: null, layoutType: 3, restartNumbering: false }; pageContent.push(newQ); }
                recordState("Add Reading Passage"); renderAll();
            }
            
            function addPoeticText(text, qCount, useKashida) {
                const sanitizedText = text.trim().split('\n').map(line => line.trim().replace(/\s{2,}/, '|')).join('\n');
                const poetryId = `item-${Date.now()}`; const newPoetry = { elementType: 'poeticText', id: poetryId, text: sanitizedText, useKashida: useKashida, restartNumbering: 1 }; pageContent.push(newPoetry);
                for (let i = 0; i < qCount; i++) { const newQ = { elementType: 'question', id: `item-${Date.now()}-${i}`, passageId: poetryId, question: `سؤال ${i + 1} على الأبيات...`, answers: { a: "إجابة أ", b: "إجابة ب", c: "إجابة ج", d: "إجابة د" }, statement: null, image: null, layoutType: 3, restartNumbering: false }; pageContent.push(newQ); }
                recordState("Add Poetic Text"); renderAll();
            }
            
            function handlePoetryEdit(itemId) {
                const item = pageContent.find(q => q.id === itemId); if (!item || item.elementType !== 'poeticText') return;
                const wrapper = document.getElementById(itemId); if (!wrapper) return;
                let fullTextLines = []; 
                let hasChanged = false;
                wrapper.querySelectorAll('.poetry-bait').forEach((bait, baitIndex) => {
                    const shatrs = bait.querySelectorAll('.poetry-shatr'); 
                    const kashidaRegex = new RegExp(kashida, 'g');
                    const shatr1Text = shatrs[0] ? shatrs[0].innerHTML : '';
                    const shatr2Text = shatrs[1] ? shatrs[1].innerHTML : '';
                    fullTextLines.push(`${shatr1Text}|${shatr2Text}`);
                }); 
                const newText = fullTextLines.join('\n');
                if (item.text !== newText) {
                    item.text = newText; 
                    recordState("Poetry Text Edit");
                }
            }
            
            function handlePassageTextEdit(e, itemId) {
                const item = pageContent.find(p => p.id === itemId);
                if (!item) return;
                
                let newText = e.target.innerHTML;
                
                // Convert the edited content to proper paragraph structure
                // Handle line breaks properly
                if (newText.includes('<br>') || newText.includes('\n')) {
                    // Split by <br> tags and newlines
                    let lines = newText.split(/<br\s*\/?>/gi);
                    lines = lines.map(line => line.trim()).filter(line => line !== '');
                    
                    // Wrap each line in a paragraph
                    newText = lines.map(line => `<p>${line}</p>`).join('');
                } else if (!newText.startsWith('<p>')) {
                    // If no paragraphs exist, wrap the content
                    newText = `<p>${newText}</p>`;
                }
                
                if (item.text !== newText) {
                    item.text = newText;
                    // Reapply line numbering after text edit
                    const wrapper = document.getElementById(itemId);
                    applyPassageLineNumbering(wrapper, newText);
                    recordState("Edit Reading Passage");
                }
            }
            
            function applyPassageLineNumbering(wrapper, htmlContent) {
                const passageText = wrapper.querySelector('.reading-passage-text');
                if (!passageText) return;
                
                // Clear current content
                passageText.innerHTML = '';
                
                // Parse the HTML content and handle line breaks properly
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                
                // Get text content and split by actual line breaks
                let textContent = tempDiv.innerHTML;
                
                // Replace <br> tags and <div> separations with newlines
                textContent = textContent.replace(/<br\s*\/?>/gi, '\n');
                textContent = textContent.replace(/<\/div><div[^>]*>/gi, '\n');
                textContent = textContent.replace(/<\/p><p[^>]*>/gi, '\n');
                
                // Remove any remaining HTML tags for line splitting
                const tempSpan = document.createElement('span');
                tempSpan.innerHTML = textContent;
                const plainText = tempSpan.textContent || tempSpan.innerText || '';
                
                // Split by newlines and filter out empty lines
                const lines = plainText.split('\n').filter(line => line.trim() !== '');
                
                let lineNumber = 1;
                
                lines.forEach(lineText => {
                    const lineWrapper = document.createElement('div');
                    lineWrapper.className = 'reading-passage-line';
                    
                    const numberSpan = document.createElement('span');
                    numberSpan.className = 'passage-line-number';
                    numberSpan.textContent = lineNumber;
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'passage-line-content';
                    contentDiv.innerHTML = lineText.trim();
                    
                    lineWrapper.appendChild(numberSpan);
                    lineWrapper.appendChild(contentDiv);
                    passageText.appendChild(lineWrapper);
                    
                    lineNumber++;
                });
                
                // If no lines were created, create a single empty line
                if (lines.length === 0) {
                    const lineWrapper = document.createElement('div');
                    lineWrapper.className = 'reading-passage-line';
                    
                    const numberSpan = document.createElement('span');
                    numberSpan.className = 'passage-line-number';
                    numberSpan.textContent = '1';
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'passage-line-content';
                    contentDiv.innerHTML = '';
                    
                    lineWrapper.appendChild(numberSpan);
                    lineWrapper.appendChild(contentDiv);
                    passageText.appendChild(lineWrapper);
                }
            }
            
            function handlePassageLineEdit(e, itemId) {
                const item = pageContent.find(p => p.id === itemId);
                if (!item) return;
                
                // Collect all line contents and rebuild the text
                const wrapper = document.getElementById(itemId);
                const lines = wrapper.querySelectorAll('.passage-line-content');
                const paragraphs = [];
                
                lines.forEach(line => {
                    if (line.innerHTML.trim()) {
                        paragraphs.push(`<p>${line.innerHTML}</p>`);
                    }
                });
                
                item.text = paragraphs.join('');
                recordState("Edit Reading Passage");
            }

            // Placeholder texts for different elements
            const placeholderTexts = {
                'question': 'أضف نص السؤال هنا...',
                'statement': 'أضف العبارة التمهيدية هنا...',
                'text': 'أضف العنوان الرئيسي هنا...',
                'answers.a': 'إجابة أ',
                'answers.b': 'إجابة ب', 
                'answers.c': 'إجابة ج',
                'answers.d': 'إجابة د'
            };
            
            function isPlaceholderText(element) {
                const prop = element.dataset.prop;
                const text = element.innerHTML.trim();
                
                // Check if current text matches any of the known placeholder texts
                const isPlaceholder = Object.values(placeholderTexts).includes(text) || 
                       text === 'أضف رأس الأسئلة هنا' ||
                       text === 'أضف نص السؤال المقالي هنا...';
                       
                // Update visual styling based on placeholder status
                if (isPlaceholder) {
                    element.classList.add('has-placeholder');
                } else {
                    element.classList.remove('has-placeholder');
                }
                
                return isPlaceholder;
            }
            
            function handleContentEditableFocus(event) {
                const element = event.target;
                if (isPlaceholderText(element)) {
                    // Clear placeholder text and styling
                    element.innerHTML = '';
                    element.classList.remove('has-placeholder');
                    // Set cursor position at the beginning
                    setTimeout(() => {
                        const range = document.createRange();
                        const selection = window.getSelection();
                        range.setStart(element, 0);
                        range.collapse(true);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }, 0);
                }
            }
            
            function handleContentEditableBlur(event, itemId) {
                const element = event.target;
                const prop = element.dataset.prop;
                const value = element.innerHTML.trim();
                
                // Handle border boxes separately
                if (itemId && itemId.startsWith('border-')) {
                    const boxId = itemId.replace('border-', '');
                    const box = borderState.boxes.find(b => b.id === boxId);
                    if (box && box.type === 'text') {
                        box.content = element.innerHTML;
                        recordState("Edit Border Box");
                    }
                    return;
                }
                
                // If the element is empty after editing, restore appropriate placeholder
                if (!value || value === '<br>' || value === '&nbsp;') {
                    const placeholderText = placeholderTexts[prop] || 
                                           (prop === 'text' && element.closest('.question-list-header') ? 'أضف رأس الأسئلة هنا' : null) ||
                                           (prop === 'question' && element.closest('.essay-answer-lines') ? 'أضف نص السؤال المقالي هنا...' : null);
                    
                    if (placeholderText) {
                        element.innerHTML = placeholderText;
                        element.classList.add('has-placeholder');
                        return; // Don't save placeholder text
                    }
                }
                
                // Update visual styling
                isPlaceholderText(element);
                
                // Continue with normal text edit handling only if it's not placeholder text
                if (!element.classList.contains('has-placeholder')) {
                    handleTextEdit(event, itemId);
                }
            }
            
            function setupContentEditableElement(element, itemId) {
                // Initialize placeholder styling
                isPlaceholderText(element);
                
                // Add focus handler to clear placeholder
                element.addEventListener('focus', handleContentEditableFocus);
                
                // Add blur handler with enhanced placeholder support
                element.addEventListener('blur', (e) => handleContentEditableBlur(e, itemId));
            }
            
            function handleTextEdit(event, itemId) {
                const element = event.target; 
                const prop = element.dataset.prop; 
                const value = element.innerHTML;
                const item = pageContent.find(q => q.id === itemId); if (!item) return; 
                
                let obj = item;
                let originalValue = obj;
                const propPath = prop.split('.'); 
                propPath.forEach((p, i) => { 
                    if (i === propPath.length - 1) { 
                       originalValue = obj[p];
                       if (originalValue !== value) {
                            obj[p] = value; 
                            recordState("Text Edit: " + prop);
                       }
                    } else { 
                        obj = obj[p]; 
                    } 
                });
            }
            
            function setupKashidaInfrastructure() {
                canvas = document.createElement('canvas'); ctx = canvas.getContext('2d');
                kashidaObserver = new ResizeObserver(entries => { for (const entry of entries) window.requestAnimationFrame(() => { if (entry.target.isConnected) justifyArabicText(entry.target); }); });
            }
            function isKashidaAllowed(text, charIndex) {
                if (charIndex < 0 || charIndex >= text.length - 1) return false;
                let followingChar = text[charIndex + 1]; if (!followingChar || diacritics.includes(followingChar)) return false;
                let j = charIndex; let basePrecedingChar = text[j]; while(diacritics.includes(basePrecedingChar) && j > 0) { j--; basePrecedingChar = text[j]; }
                if (noKashidaAfter.includes(basePrecedingChar)) return false; if (noKashidaBefore.includes(followingChar)) return false;
                return true;
            }
            function justifyArabicText(element) {
                const kashidaRegex = new RegExp(kashida, 'g'); 
                
                // Don't justify if it contains complex html
                if(element.children.length > 0) {
                     element.textContent = element.textContent.replace(kashidaRegex, '');
                     return;
                }
                const originalText = element.textContent.replace(kashidaRegex, '').trim();
                
                if (!originalText) { element.textContent = ''; return; }
                const style = window.getComputedStyle(element); ctx.font = `${style.getPropertyValue('font-style')} ${style.getPropertyValue('font-weight')} ${style.getPropertyValue('font-size')} ${style.getPropertyValue('font-family')}`;
                let insertionPoints = []; for (let i = 0; i < originalText.length - 1; i++) if (isKashidaAllowed(originalText, i)) insertionPoints.push(i + 1);
                const targetWidth = element.clientWidth - (parseFloat(style.paddingLeft) + parseFloat(style.paddingRight));
                const currentWidth = ctx.measureText(originalText).width; const widthDifference = targetWidth - currentWidth;
                if (widthDifference <= 2 || insertionPoints.length === 0) { element.textContent = originalText; return; }
                const kashidaWidth = ctx.measureText(kashida).width; if (kashidaWidth <= 0.1) { element.textContent = originalText; return; }
                let kashidasToAdd = Math.floor(widthDifference / kashidaWidth); if (kashidasToAdd <= 0) { element.textContent = originalText; return; }
                let textAsArray = originalText.split(''); const numInsertionPoints = insertionPoints.length;
                if (numInsertionPoints > 0) {
                    const baseCount = Math.floor(kashidasToAdd / numInsertionPoints); let extraCount = kashidasToAdd % numInsertionPoints;
                    for (let i = numInsertionPoints - 1; i >= 0; i--) { const index = insertionPoints[i]; let count = baseCount; if (extraCount > 0) { count++; extraCount--; } if(count > 0) textAsArray.splice(index, 0, kashida.repeat(count)); }
                }
                element.textContent = textAsArray.join('');
            }
            
            function deleteItem(itemId) {
                try {
                    console.log('🗑️ Attempting to delete item:', itemId);
                    
                    // Validate itemId
                    if (!itemId) {
                        console.error('❌ DeleteItem failed: itemId is null or undefined');
                        alert('خطأ: لا يمكن حذف العنصر - معرف العنصر غير صحيح');
                        return;
                    }
                    
                    // Find the item first to verify it exists
                    const itemToDelete = pageContent.find(q => q.id === itemId);
                    if (!itemToDelete) {
                        console.error('❌ DeleteItem failed: Item not found in pageContent', itemId);
                        alert('خطأ: العنصر المحدد غير موجود');
                        return;
                    }
                    
                    console.log('📋 Item found for deletion:', itemToDelete.elementType, itemToDelete);
                    
                    // Store original length for verification
                    const originalLength = pageContent.length;
                    
                    // Remove the item from pageContent
                    pageContent = pageContent.filter(q => q.id !== itemId);
                    
                    // Verify deletion was successful
                    if (pageContent.length === originalLength) {
                        console.error('❌ DeleteItem failed: Item was not removed from pageContent');
                        alert('خطأ: فشل في حذف العنصر');
                        return;
                    }
                    
                    console.log('✅ Item deleted successfully. New pageContent length:', pageContent.length);
                    
                    // Clear any selections that might include the deleted item
                    if (typeof selectedElementIds !== 'undefined' && selectedElementIds.has(itemId)) {
                        selectedElementIds.delete(itemId);
                        console.log('🔄 Removed deleted item from selection');
                    }
                    
                    recordState("Delete Item");
                    renderAll();
                    
                } catch (error) {
                    console.error('❌ Critical error in deleteItem:', error);
                    alert('خطأ في حذف العنصر: ' + error.message);
                }
            }
            
            function moveItem(itemId, direction) {
                const index = pageContent.findIndex(q => q.id === itemId);
                if (direction === 'up' && index > 0) {
                     [pageContent[index], pageContent[index - 1]] = [pageContent[index - 1], pageContent[index]];
                } else if (direction === 'down' && index < pageContent.length - 1) {
                    [pageContent[index], pageContent[index + 1]] = [pageContent[index + 1], pageContent[index]];
                } else { return; }
                recordState("Move Item");
                renderAll();
            }
            
            function setEssayLines(itemId) { const item = pageContent.find(q => q.id === itemId); if (!item) return; showPrompt("عدد الأسطر", "أدخل عدد الأسطر المطلوبة للإجابة (1-15):", (num) => { let newLines = parseInt(num, 10); if (!isNaN(newLines) && newLines > 0 && newLines <= 15) { item.lines = newLines; recordState("Set Essay Lines"); renderAll(); } }, item.lines || 2, "number"); }
            
            function setupContextMenuListeners() {
                document.getElementById("ctx-delete-header").addEventListener("click", (event) => {
                    try {
                        event.stopPropagation(); // Prevent event bubbling
                        contextMenu.classList.add('hidden');
                        
                        if (!currentContextMenuTarget) {
                            console.error('❌ Delete header failed: currentContextMenuTarget is null');
                            alert('خطأ: لا يمكن حذف العنوان - العنصر المحدد غير صحيح');
                            return;
                        }
                        
                        const itemId = currentContextMenuTarget.dataset.itemId;
                        if (!itemId) {
                            console.error('❌ Delete header failed: itemId is missing from currentContextMenuTarget');
                            alert('خطأ: لا يمكن حذف العنوان - معرف العنصر غير موجود');
                            return;
                        }
                        
                        console.log('📄 Deleting header directly with itemId:', itemId);
                        // Direct deletion without confirmation for single item
                        deleteItem(itemId);
                        
                    } catch (error) {
                        console.error('❌ Error in delete header handler:', error);
                        alert('خطأ في حذف العنوان: ' + error.message);
                    }
                });
                document.getElementById("ctx-set-page-number").addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    showPrompt("ترقيم الصفحات", "ادخل رقم الصفحة الذي تريد البدء به:", (num) => { const newStart = parseInt(num, 10); if (!isNaN(newStart) && newStart > 0) { startPageNumber = newStart; recordState("Set Start Page Number"); updatePageNumbers(); } }, startPageNumber, "number");
                });
                document.getElementById("ctx-upload-image").addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    imageUploadContext = { type: 'question', itemId: currentContextMenuTarget.dataset.itemId };
                    imageUploadInput.click();
                });
                 document.getElementById("ctx-replace-with-logo").addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    if (currentContextMenuTarget.classList.contains('header-box')) {
                        imageUploadContext = {
                            type: 'header-logo',
                            hfType: currentContextMenuTarget.dataset.hfType,
                            index: parseInt(currentContextMenuTarget.dataset.hfIndex, 10)
                        };
                    } else if (currentContextMenuTarget.classList.contains('page-border-box')) {
                        imageUploadContext = {
                            type: 'border-logo',
                            boxId: currentContextMenuTarget.dataset.borderBoxId
                        };
                    }
                    imageUploadInput.click();
                });
                document.getElementById("ctx-add-image-url").addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    changeImageFromUrl(currentContextMenuTarget.dataset.itemId);
                });
                document.getElementById("ctx-delete-image").addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    deleteImage(currentContextMenuTarget.dataset.itemId);
                });
                document.getElementById("ctx-add-statement").addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    addEmptyStatement(currentContextMenuTarget.dataset.itemId);
                });
                document.getElementById("ctx-delete-statement").addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    deleteStatement(currentContextMenuTarget.dataset.itemId);
                });
                document.querySelectorAll("#ctx-layout-submenu li").forEach(item => item.addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    changeAnswersLayout(currentContextMenuTarget.dataset.itemId, item.getAttribute("data-layout"));
                }));
                document.getElementById("ctx-set-essay-lines").addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    setEssayLines(currentContextMenuTarget.dataset.itemId);
                });
                document.getElementById("ctx-set-start-number").addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    setStartNumber(currentContextMenuTarget.dataset.itemId);
                });
                document.getElementById("ctx-cancel-restart-numbering").addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    cancelStartNumber(currentContextMenuTarget.dataset.itemId);
                });
                document.getElementById("ctx-move-up").addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    moveItem(currentContextMenuTarget.dataset.itemId, "up");
                });
                document.getElementById("ctx-move-down").addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    moveItem(currentContextMenuTarget.dataset.itemId, "down");
                });
                document.getElementById("ctx-delete-item").addEventListener("click", (event) => {
                    try {
                        event.stopPropagation(); // Prevent event bubbling
                        contextMenu.classList.add('hidden');
                        
                        if (!currentContextMenuTarget) {
                            console.error('❌ Delete item failed: currentContextMenuTarget is null');
                            alert('خطأ: لا يمكن حذف العنصر - العنصر المحدد غير صحيح');
                            return;
                        }
                        
                        const itemId = currentContextMenuTarget.dataset.itemId;
                        if (!itemId) {
                            console.error('❌ Delete item failed: itemId is missing from currentContextMenuTarget');
                            alert('خطأ: لا يمكن حذف العنصر - معرف العنصر غير موجود');
                            return;
                        }
                        
                        console.log('🗑️ Deleting item directly with itemId:', itemId);
                        // Direct deletion without confirmation for single item
                        deleteItem(itemId);
                        
                    } catch (error) {
                        console.error('❌ Error in delete item handler:', error);
                        alert('خطأ في حذف العنصر: ' + error.message);
                    }
                });
                document.getElementById("ctx-edit-student-info").addEventListener("click", () => {
                    try {
                        contextMenu.classList.add('hidden');
                        
                        if (!currentContextMenuTarget) {
                            console.error('❌ Edit student info failed: currentContextMenuTarget is null');
                            alert('خطأ: لا يمكن تعديل معلومات الطالب - العنصر المحدد غير صحيح');
                            return;
                        }
                        
                        const itemId = currentContextMenuTarget.dataset.itemId;
                        if (!itemId) {
                            console.error('❌ Edit student info failed: itemId is missing from currentContextMenuTarget');
                            alert('خطأ: لا يمكن تعديل معلومات الطالب - معرف العنصر غير موجود');
                            return;
                        }
                        
                        console.log('📝 Editing student info with itemId:', itemId);
                        editStudentInfoElements(itemId);
                        
                    } catch (error) {
                        console.error('❌ Error in edit student info handler:', error);
                        alert('خطأ في تعديل معلومات الطالب: ' + error.message);
                    }
                });
                document.getElementById("ctx-toggle-kashida").addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    const itemId = currentContextMenuTarget.dataset.itemId; const item = pageContent.find(p => p.id === itemId); if(item) { item.useKashida = !item.useKashida; recordState("Toggle Kashida"); renderAll(); }
                });
                document.getElementById("ctx-delete-hf-box").addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    deleteHeaderFooterBox();
                });
                document.getElementById("ctx-add-hf-box").addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    addHeaderFooterBox();
                });
                document.getElementById("ctx-delete-border-box").addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    deleteBorderBox();
                });
                document.getElementById("ctx-add-border-text-box").addEventListener("click", () => {
                    contextMenu.classList.add('hidden');
                    addBorderBox();
                });
            }

            function handleMainContentContextMenu(e) {
                // Disable context menu in selection mode
                if (isSelectionMode) {
                    e.preventDefault();
                    return;
                }
                
                const targetElement = e.target.closest('.question-wrapper, .reading-passage-wrapper, .poetry-wrapper, .question-list-header, .page-title, .student-info-wrapper, .page-number, .header-box, .footer-box, .page-header, .page-footer, .page-border-box, .page-inner-border');
                if (targetElement) {
                    e.preventDefault();
                    showStandardContextMenu(e, targetElement);
                } else {
                    contextMenu.classList.add('hidden');
                }
            }
            
            function hideMenusOnClickOutside(e) {
                // Check if e.target exists and is a valid DOM element
                if (!e || !e.target || !e.target.closest) {
                    return;
                }
                
                // Don't hide menus if we're in selection mode and clicking on selectable elements
                if (isSelectionMode && e.target.closest('.question-wrapper, .reading-passage-wrapper, .poetry-wrapper, .question-list-header, .page-title, .student-info-wrapper')) {
                    return;
                }
                
                // Hide context menu
                if (contextMenu && !contextMenu.contains(e.target)) { 
                    contextMenu.classList.add("hidden"); 
                }
                
                // Hide action history menu
                if (actionHistoryMenu && !actionHistoryMenu.contains(e.target)) {
                    actionHistoryMenu.classList.add("hidden");
                }
                
                // Hide text format toolbar if click is outside of it or the main content area
                // BUT don't hide it if clicking on Pickr color picker elements or toolbar itself
                if(textFormatToolbar && textFormatToolbar.classList.contains('show')) {
                    const isPickrElement = e.target.closest('.pcr-app, .pickr, .pickr-text-color, .pickr-highlight-color');
                    const isToolbarElement = textFormatToolbar.contains(e.target);
                    const isMainContentElement = mainContent.contains(e.target);
                    
                    // Only hide if click is outside toolbar, main content, and pickr elements
                    if (!isToolbarElement && !isMainContentElement && !isPickrElement) {
                        textFormatToolbar.classList.remove('show');
                    }
                }
                
                // Hide modal overlays when clicking outside the modal content
                const modals = [
                    { overlay: customPromptOverlay, content: '#custom-prompt' },
                    { overlay: passagePromptOverlay, content: '#reading-passage-prompt' },
                    { overlay: poetryPromptOverlay, content: '#poetry-prompt' },
                    { overlay: studentInfoPromptOverlay, content: '#student-info-prompt' },
                    { overlay: watermarkPromptOverlay, content: '#watermark-prompt' },
                    { overlay: qDefaultsPromptOverlay, content: '#question-defaults-prompt' },
                    { overlay: essayDefaultsPromptOverlay, content: '#essay-defaults-prompt' }
                ];
                
                modals.forEach(modal => {
                    if (modal.overlay && !modal.overlay.classList.contains('hidden')) {
                        const modalContent = modal.overlay.querySelector(modal.content);
                        
                        // Check if this modal was just shown (prevent immediate hiding)
                        const modalShowTime = modal.overlay._showTime || 0;
                        const timeSinceShow = Date.now() - modalShowTime;
                        const fullyShown = modal.overlay._fullyShown || false;
                        
                        // Don't hide modal if it was shown less than 200ms ago or not fully initialized
                        if (timeSinceShow < 200 || !fullyShown) {
                            return;
                        }
                        
                        // Hide modal if click is outside the modal content
                        if (modalContent && !modalContent.contains(e.target)) {
                            modal.overlay.classList.add('hidden');
                            console.log('\u2705 Modal hidden due to outside click');
                        }
                    }
                });
                
                // Hide Pickr color pickers when clicking outside them
                const visiblePickrs = document.querySelectorAll('.pcr-app.visible');
                const isClickOnPickrElement = e.target.closest('.color-picker, .pickr, .pickr-text-color, .pickr-highlight-color');
                visiblePickrs.forEach(pickerApp => {
                    if (!pickerApp.contains(e.target) && !isClickOnPickrElement) {
                        // Find the Pickr instance and hide it by closing all
                        document.querySelectorAll('.pickr').forEach(pickr => {
                            try {
                                if (pickr._pickr && pickr._pickr.hide) {
                                    pickr._pickr.hide();
                                }
                            } catch (error) {
                                // Silent error handling
                            }
                        });
                    }
                });
            }
            
            // Handle window resize to reposition visible menus
            function handleWindowResize() {
                // Reposition action history menu if visible
                if (actionHistoryMenu && !actionHistoryMenu.classList.contains('hidden')) {
                    const menuRect = actionHistoryMenu.getBoundingClientRect();
                    const scrollY = window.scrollY || window.pageYOffset;
                    const scrollX = window.scrollX || window.pageXOffset;
                    
                    let needsRepositioning = false;
                    let newTop = parseInt(actionHistoryMenu.style.top) || 0;
                    let newLeft = parseInt(actionHistoryMenu.style.left) || 0;
                    
                    // Check if menu is outside viewport
                    if (menuRect.right > window.innerWidth) {
                        newLeft = window.innerWidth - menuRect.width - 10;
                        needsRepositioning = true;
                    }
                    if (menuRect.bottom > window.innerHeight) {
                        newTop = scrollY + window.innerHeight - menuRect.height - 10;
                        needsRepositioning = true;
                    }
                    if (newLeft < 10) {
                        newLeft = 10;
                        needsRepositioning = true;
                    }
                    if (newTop < scrollY + 10) {
                        newTop = scrollY + 10;
                        needsRepositioning = true;
                    }
                    
                    if (needsRepositioning) {
                        actionHistoryMenu.style.top = `${newTop}px`;
                        actionHistoryMenu.style.left = `${newLeft}px`;
                    }
                }
                

            }

            function showStandardContextMenu(event, element) {
                currentContextMenuTarget = element;
                contextMenu.classList.add("hidden");
                textFormatToolbar.classList.add("hidden");

                document.querySelectorAll('#custom-context-menu li[id^="ctx-"]').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('#custom-context-menu hr').forEach(el => el.classList.add('hidden'));

                const isHFBox = element.classList.contains('header-box') || element.classList.contains('footer-box');
                const isBorderBox = element.classList.contains('page-border-box');
                const isInnerBorder = element.classList.contains('page-inner-border');
                const isPageNumber = element.classList.contains('page-number');
                const isEmptyHeader = element.classList.contains('page-header') && element.children.length === 0;
                const isEmptyFooter = element.classList.contains('page-footer') && element.children.length === 0;
                const isStudentInfo = element.classList.contains('student-info-wrapper');

                if (isBorderBox) {
                    document.getElementById("ctx-replace-with-logo").classList.remove('hidden');
                    document.getElementById("ctx-delete-border-box").classList.remove('hidden');
                    document.getElementById("ctx-hf-separator").classList.remove('hidden');
                } else if (isInnerBorder) {
                    // Right-click on inner border allows adding border boxes
                    document.getElementById("ctx-add-border-text-box").classList.remove('hidden');
                    document.getElementById("ctx-hf-separator").classList.remove('hidden');
                } else if (isHFBox) {
                    if (element.classList.contains('header-box')) {
                         document.getElementById("ctx-replace-with-logo").classList.remove('hidden');
                    }
                    document.getElementById("ctx-add-hf-box").classList.remove('hidden');
                    const type = element.dataset.hfType;
                    // Allow deleting the last box
                    if (headerFooterState[type] && headerFooterState[type].items.length > 0) {
                        document.getElementById("ctx-delete-hf-box").classList.remove('hidden');
                    }
                    document.getElementById("ctx-hf-separator").classList.remove('hidden');
                } else if (isEmptyHeader || isEmptyFooter) {
                    // Handle right-click on empty header/footer background
                    const type = isEmptyHeader ? 'header' : 'footer';
                    element.dataset.hfType = type; // Set the type for the add function
                    document.getElementById("ctx-add-hf-box").classList.remove('hidden');
                    document.getElementById("ctx-hf-separator").classList.remove('hidden');
                } else if (isPageNumber) {
                    document.getElementById("ctx-set-page-number").classList.remove('hidden');

                } else { 
                    const itemId = element.dataset.itemId; 
                    
                    // Enhanced validation for itemId and item lookup
                    if (!itemId) {
                        console.warn('⚠️ Context menu target missing itemId:', element);
                        contextMenu.classList.add("hidden"); 
                        return; 
                    }
                    
                    const item = pageContent.find(q => q.id === itemId);
                    if (!item) { 
                        console.warn('⚠️ Item not found in pageContent for itemId:', itemId);
                        contextMenu.classList.add("hidden"); 
                        return; 
                    }
                    
                    document.getElementById("ctx-move-up").classList.remove('hidden');
                    document.getElementById("ctx-move-down").classList.remove('hidden');
                    document.getElementById("ctx-separator-3").classList.remove('hidden');
                    
                    if (item.elementType === 'pageTitle') {
                        document.getElementById("ctx-delete-header").classList.remove('hidden');
                    } else {
                        document.getElementById("ctx-delete-item").classList.remove('hidden');
                    }
                    const isMcq = item.elementType === 'question'; const isEssay = item.elementType === 'essayQuestion'; const isPoetry = item.elementType === 'poeticText';
                    
                    if (isMcq || isEssay || item.elementType === 'questionHeader' || item.elementType === 'readingPassage' || isPoetry || item.elementType === 'pageTitle') {
                        document.getElementById("ctx-set-start-number").classList.remove('hidden');
                        if (item.restartNumbering !== false) {
                            document.getElementById("ctx-cancel-restart-numbering").classList.remove('hidden');
                        }
                        document.getElementById("ctx-separator-2").classList.remove('hidden');
                    }
                    if (isPoetry) document.getElementById("ctx-toggle-kashida").classList.remove('hidden');
                    if (item.elementType === 'student-info') {
                        document.getElementById("ctx-edit-student-info").classList.remove('hidden');
                    }
                    if (isMcq || isEssay) {
                        document.getElementById("ctx-upload-image").classList.remove('hidden'); document.getElementById("ctx-add-image-url").classList.remove('hidden');
                        document.getElementById("ctx-delete-image").classList.toggle("hidden", !item.image);
                        document.getElementById("ctx-add-statement").classList.remove('hidden');
                        document.getElementById("ctx-delete-statement").classList.toggle("hidden", !item.statement);
                        document.getElementById("ctx-separator-1").classList.remove('hidden');
                    }
                    if (isMcq) document.getElementById("ctx-change-layout").classList.remove('hidden');
                    if (isEssay) document.getElementById("ctx-set-essay-lines").classList.remove('hidden');
                }

                contextMenu.style.top = `${event.pageY}px`; contextMenu.style.left = `${event.pageX}px`;
                contextMenu.classList.remove("hidden");
            }

            function deleteHeaderFooterBox() {
                const target = currentContextMenuTarget;
                const type = target.dataset.hfType;
                const index = parseInt(target.dataset.hfIndex, 10);
                if (!type || isNaN(index) || !headerFooterState[type] || headerFooterState[type].items.length === 0) return;
                
                headerFooterState[type].items.splice(index, 1);
                recordState("Delete Header/Footer Box");
                renderAll();
            }
            
            function addHeaderFooterBox() {
                const target = currentContextMenuTarget;
                let type = target.dataset.hfType;
                
                // Handle inner border context - add border box instead
                if (target.classList.contains('page-inner-border')) {
                    addBorderBox();
                    return;
                }
                
                // If type is not set (empty header/footer), determine from class
                if (!type) {
                    if (target.classList.contains('page-header')) {
                        type = 'header';
                    } else if (target.classList.contains('page-footer')) {
                        type = 'footer';
                    }
                }
                
                if (!type || !headerFooterState[type]) return;
                
                headerFooterState[type].items.push({ type: 'text', content: 'خانة جديدة' });
                recordState("Add Header/Footer Box");
                renderAll();
            }
            
            function deleteBorderBox() {
                const target = currentContextMenuTarget;
                const boxId = target.dataset.borderBoxId;
                
                if (!boxId) return;
                
                const boxIndex = borderState.boxes.findIndex(box => box.id === boxId);
                if (boxIndex > -1) {
                    borderState.boxes.splice(boxIndex, 1);
                    recordState("Delete Border Box");
                    renderAll();
                }
            }
            
            let currentBorderBoxId = null;

            function setStartNumber(itemId) { const item = pageContent.find(q => q.id === itemId); if (!item) return; showPrompt("ترقيم مخصص", "أدخل الرقم الذي تريد بدء العد منه لهذا العنصر:", (num) => { const newStart = parseInt(num, 10); if (!isNaN(newStart) && newStart > 0) { item.restartNumbering = newStart; recordState("Set Custom Start Number"); renderAll(); } }, item.restartNumbering || 1, "number"); }
            function cancelStartNumber(itemId) { const item = pageContent.find(q => q.id === itemId); if (item) { item.restartNumbering = false; recordState("Cancel Custom Start Number"); renderAll(); } }
            function changeAnswersLayout(itemId, layoutType) { const question = pageContent.find(q => q.id === itemId); if (question) { question.layoutType = layoutType; recordState("Change Answer Layout"); renderAll(); } }
            
            function handleImageFileUpload(e) {
    const file = e.target.files[0];
    if (!file || !imageUploadContext) return;

    const reader = new FileReader();
    reader.onload = (event) => {
        const imageUrl = event.target.result;

        if (imageUploadContext.type === 'question') {
            const question = pageContent.find(q => q.id === imageUploadContext.itemId);
            if (question) {
                question.image = imageUrl;
                recordState("Add Question Image");
                renderAll();
            }
        } else if (imageUploadContext.type === 'header-logo') {
            const { hfType, index } = imageUploadContext;
            if (headerFooterState[hfType].items[index]) {
                headerFooterState[hfType].items[index] = {
                    type: 'logo',
                    content: imageUrl
                };
                recordState("Add Header Logo");
                renderAll();
            }
        } else if (imageUploadContext.type === 'border-logo') {
            const { boxId } = imageUploadContext;
            const box = borderState.boxes.find(b => b.id === boxId);
            if (box) {
                box.type = 'logo';
                box.content = imageUrl;
                recordState("Add Border Logo");
                renderAll();
            }
        }

        imageUploadContext = null;
    };

    reader.readAsDataURL(file);
    e.target.value = '';
}


            function deleteImage(itemId) { const question = pageContent.find(q => q.id === itemId); question.image = null; recordState("Delete Image"); renderAll(); }
            function addEmptyStatement(itemId) { 
                const question = pageContent.find(q => q.id === itemId); 
                if (!question.statement) {
                    question.statement = "أضف العبارة التمهيدية هنا...";
                    recordState("Add Empty Statement"); 
                    renderAll();
                }
            }
            function changeStatement(itemId) { const question = pageContent.find(q => q.id === itemId); showPrompt("إضافة/تعديل عبارة", "أدخل نص العبارة:", (text) => { question.statement = text || null; recordState("Change Statement"); renderAll(); }, question.statement || ""); }
            function deleteStatement(itemId) { const question = pageContent.find(q => q.id === itemId); question.statement = null; recordState("Delete Statement"); renderAll(); }
            function changeImageFromUrl(itemId) { const question = pageContent.find(q => q.id === itemId); showPrompt("إضافة/تغيير صورة (رابط)", "الرجاء إدخال رابط الصورة:", (url) => { if (url) { question.image = url; recordState("Change Image from URL"); renderAll(); } }, question.image || ""); }

            function showConfirm(title, text, onOkCallback) {
                try {
                    console.log('📋 ShowConfirm called:', title);
                    
                    // Validate parameters
                    if (!title || !text || typeof onOkCallback !== 'function') {
                        console.error('❌ ShowConfirm failed: Invalid parameters', { title, text, onOkCallback });
                        alert('خطأ في عرض رسالة التأكيد');
                        return;
                    }
                    
                    const overlay = customPromptOverlay;
                    if (!overlay) {
                        console.error('❌ ShowConfirm failed: customPromptOverlay not found');
                        alert('خطأ: عنصر الحوار غير موجود');
                        return;
                    }
                    
                    const promptTitle = overlay.querySelector("#prompt-title");
                    const promptText = overlay.querySelector("#prompt-text");
                    const input = overlay.querySelector("#prompt-input");
                    const okBtn = overlay.querySelector("#prompt-ok");
                    const cancelBtn = overlay.querySelector("#prompt-cancel");
                    
                    // Check if all required elements exist
                    if (!promptTitle || !promptText || !input || !okBtn || !cancelBtn) {
                        console.error('❌ ShowConfirm failed: Required dialog elements not found');
                        alert('خطأ: عناصر الحوار المطلوبة غير موجودة');
                        return;
                    }
                    
                    overlay.classList.remove("hidden");
                    overlay._showTime = Date.now(); // Track when modal was shown
                    promptTitle.textContent = title;
                    promptText.textContent = text;
                    input.classList.add('hidden');
                    
                    // Small delay to ensure modal is properly shown before enabling click outside detection
                    setTimeout(() => {
                        overlay._fullyShown = true;
                    }, 50);
                    
                    // Safe event listener management without DOM manipulation
                    const cleanup = () => {
                        try {
                            overlay.classList.add("hidden");
                            overlay._showTime = 0; // Reset timestamp
                            overlay._fullyShown = false; // Reset flag
                            input.classList.remove('hidden');
                        } catch (cleanupError) {
                            console.error('❌ Error during cleanup:', cleanupError);
                        }
                    };
                    
                    // Remove any existing listeners and add new ones with once:true
                    if (okBtn._currentHandler) {
                        okBtn.removeEventListener("click", okBtn._currentHandler);
                    }
                    if (cancelBtn._currentHandler) {
                        cancelBtn.removeEventListener("click", cancelBtn._currentHandler);
                    }
                    
                    const okHandler = () => {
                        try {
                            console.log('✅ User confirmed action');
                            onOkCallback();
                            cleanup();
                        } catch (callbackError) {
                            console.error('❌ Error in confirmation callback:', callbackError);
                            alert('خطأ في تنفيذ العملية: ' + callbackError.message);
                            cleanup();
                        }
                    };
                    
                    const cancelHandler = () => {
                        console.log('❌ User cancelled action');
                        cleanup();
                    };
                    
                    okBtn._currentHandler = okHandler;
                    cancelBtn._currentHandler = cancelHandler;
                    
                    okBtn.addEventListener("click", okHandler, { once: true });
                    cancelBtn.addEventListener("click", cancelHandler, { once: true });
                    
                } catch (error) {
                    console.error('❌ Critical error in showConfirm:', error);
                    alert('خطأ حرج في عرض رسالة التأكيد: ' + error.message);
                }
            }
            function showPrompt(title, text, callback, defaultValue = "", inputType = "text") { 
                const overlay = customPromptOverlay; 
                const promptTitle = overlay.querySelector("#prompt-title"); 
                const promptText = overlay.querySelector("#prompt-text"); 
                const input = overlay.querySelector("#prompt-input"); 
                const okBtn = overlay.querySelector("#prompt-ok"); 
                const cancelBtn = overlay.querySelector("#prompt-cancel"); 
                
                overlay.classList.remove("hidden"); 
                promptTitle.textContent = title; 
                promptText.textContent = text; 
                input.type = inputType; 
                input.value = defaultValue; 
                input.classList.remove('hidden'); 
                input.focus(); 
                
                // Safe event listener management without DOM manipulation
                const cleanup = () => { 
                    overlay.classList.add("hidden"); 
                    // No replaceWith - just clean handlers properly
                }; 
                
                // Remove any existing listeners and add new ones with once:true
                okBtn.removeEventListener("click", okBtn._currentHandler);
                cancelBtn.removeEventListener("click", cancelBtn._currentHandler);
                
                const okHandler = () => { callback(input.value); cleanup(); };
                const cancelHandler = () => { cleanup(); };
                
                okBtn._currentHandler = okHandler;
                cancelBtn._currentHandler = cancelHandler;
                
                okBtn.addEventListener("click", okHandler, { once: true }); 
                cancelBtn.addEventListener("click", cancelHandler, { once: true }); 
            }
            

            
            function updateSliderValueDisplay(sliderElement, unit = 'px') {
                 const valueSpan = sliderElement.closest('.slider-control').querySelector('.slider-value');
                 if (valueSpan) {
                    if (sliderElement.id === 'watermark-opacity') {
                        valueSpan.textContent = parseFloat(sliderElement.value).toFixed(2);
                    } else {
                        valueSpan.textContent = `${sliderElement.value}${unit}`;
                    }
                 }
            }
            
            function setupStyleControls() {
                try {
                    // Setup sliders first
                    setupSliderControlsOnly();
                    
                    // Then setup color pickers with visibility check
                    setupColorPickersOnly();
                } catch (error) {
                    console.error('Error in setupStyleControls:', error);
                }
            }
            
            function addPickerBoundsListener(pickerInstance) { 
                pickerInstance.on('show', instance => { 
                    setTimeout(() => { 
                        try {
                            // Use a safer approach to get the picker app element
                            let pickerApp = null;
                            
                            // Try different approaches to get the picker DOM element
                            if (instance && instance.getRoot && typeof instance.getRoot === 'function') {
                                try {
                                    const root = instance.getRoot();
                                    pickerApp = root.app || root;
                                } catch (e) {
                                    // Fallback approach
                                }
                            }
                            
                            // Fallback: find the last created picker app
                            if (!pickerApp) {
                                pickerApp = document.querySelector('.pcr-app:last-child');
                            }
                            
                            if (!pickerApp) return;
                            
                            const rect = pickerApp.getBoundingClientRect(); 
                            const scrollY = window.scrollY || window.pageYOffset; 
                            
                            if (rect.top < 0) {
                                pickerApp.style.top = `${scrollY + 5}px`; 
                            }
                            if (rect.left < 0) {
                                pickerApp.style.left = '5px'; 
                            } else if (rect.right > window.innerWidth) {
                                pickerApp.style.left = `${window.innerWidth - rect.width - 5}px`; 
                            }
                            if (rect.bottom > window.innerHeight) {
                                pickerApp.style.top = `${scrollY + window.innerHeight - rect.height - 5}px`; 
                            }
                        } catch (e) {
                            // Silently handle any errors - picker bounds adjustment is not critical
                        }
                    }, 0); 
                }); 
            }
            
            // Comprehensive color picker cleanup function
            function forceCleanupAllColorPickers() {
                try {
                    console.log('🧼‍♀️ Force cleaning up ALL color pickers...');
                    
                    // List of essential color picker container element IDs that must NEVER be removed
                    const essentialElementIds = [
                        'page-header-bg', 'header-item-bg', 'page-footer-bg', 'footer-item-bg',
                        'header-item-text-color', 'page-title-text-color', 'page-title-bg-color',
                        'page-title-border-color', 'poetry-text-color', 'poetry-num-color',
                        'passage-line-num-color', 'question-text-color', 'question-num-color',
                        'question-num-bg', 'statement-text-color', 'statement-bg-color',
                        'answer-head-color', 'answer-head-bg', 'answer-text-color',
                        'question-border-color', 'page-num-color', 'page-num-bg-color',
                        'page-border-color', 'border-box-bg', 'border-box-text-color',
                        'sidebar-highlight-color-picker'
                    ];
                    
                    // Destroy all Pickr instances globally if available
                    if (typeof Pickr !== 'undefined' && Pickr.instances) {
                        // Create a copy of instances array to avoid modification during iteration
                        const instancesCopy = [...Pickr.instances];
                        instancesCopy.forEach(instance => {
                            try {
                                instance.destroyAndRemove();
                            } catch (e) {
                                console.warn('Error destroying global Pickr instance:', e);
                            }
                        });
                        // Clear the instances array completely
                        Pickr.instances.length = 0;
                    }
                    
                    // Also try to access global Pickr instances through window if available
                    if (window.Pickr && window.Pickr.instances) {
                        const globalInstances = [...window.Pickr.instances];
                        globalInstances.forEach(instance => {
                            try {
                                instance.destroyAndRemove();
                            } catch (e) {
                                console.warn('Error destroying window Pickr instance:', e);
                            }
                        });
                        window.Pickr.instances.length = 0;
                    }
                    
                    // Remove all picker popup DOM elements (pcr-app elements) but NOT container elements
                    document.querySelectorAll('.pcr-app').forEach(app => {
                        try {
                            app.remove();
                        } catch (e) {
                            console.warn('Error removing picker DOM:', e);
                        }
                    });
                    
                    // Clean up picker instances from essential elements WITHOUT removing or replacing the elements
                    essentialElementIds.forEach(elementId => {
                        const el = document.getElementById(elementId);
                        if (el) {
                            // More thorough cleanup of Pickr instance
                            if (el._pickr) {
                                try {
                                    // Try multiple cleanup methods
                                    if (typeof el._pickr.destroyAndRemove === 'function') {
                                        el._pickr.destroyAndRemove();
                                    } else if (typeof el._pickr.destroy === 'function') {
                                        el._pickr.destroy();
                                    }
                                } catch (e) {
                                    console.warn(`Error destroying pickr for ${elementId}:`, e);
                                }
                                
                                // Completely remove all Pickr references
                                el._pickr = null;
                                delete el._pickr;
                                
                                // Also remove any other potential Pickr-related properties
                                Object.keys(el).forEach(key => {
                                    if (key.toLowerCase().includes('pickr') || key.startsWith('_pcr')) {
                                        try {
                                            delete el[key];
                                        } catch (e) {
                                            // Silent cleanup
                                        }
                                    }
                                });
                            }
                            
                            // Remove all Pickr-generated content more thoroughly
                            el.querySelectorAll('.pcr-button, .pcr-result, .pcr-selection, .pcr-color-preview, .pcr-current-color').forEach(pickrEl => {
                                try {
                                    pickrEl.remove();
                                } catch (e) {
                                    // Silent cleanup
                                }
                            });
                            
                            // Reset any Pickr-specific styling and classes
                            el.classList.remove('pcr-button', 'pickr', 'pcr-active');
                            if (el.style.backgroundColor && el.style.backgroundColor.includes('rgb')) {
                                el.style.backgroundColor = '';
                            }
                            if (el.style.borderColor && el.style.borderColor.includes('rgb')) {
                                el.style.borderColor = '';
                            }
                            
                            // Clear any remaining Pickr-related attributes without replacing the element
                            el.removeAttribute('aria-describedby');
                            if (el.hasAttribute('style') && el.getAttribute('style') === '') {
                                el.removeAttribute('style');
                            }
                        }
                    });
                    
                    // Clean up any other color picker related elements that are NOT essential
                    document.querySelectorAll('.color-picker:not([id]), [id*="color"]:not([id="toggle-colors-sidebar-btn"]):not([id="colors-sidebar"])').forEach(el => {
                        // Only clean non-essential elements
                        if (!essentialElementIds.includes(el.id)) {
                            if (el._pickr) {
                                try {
                                    el._pickr.destroyAndRemove();
                                } catch (e) {
                                    // Silent cleanup
                                }
                                el._pickr = null;
                                delete el._pickr;
                            }
                        }
                    });
                    
                    // Remove any orphaned Pickr DOM elements
                    const orphanedPickrElements = document.querySelectorAll('.pcr-app, .pcr-popup, .pcr-picker, .pcr-palette, .pcr-slider');
                    orphanedPickrElements.forEach(el => {
                        try {
                            el.remove();
                            console.log('🗑️ Removed orphaned Pickr element');
                        } catch (e) {
                            console.warn('Error removing orphaned element:', e);
                        }
                    });
                    
                    console.log('✅ Force cleanup completed - essential elements preserved');
                    
                    // Clear global instance tracking to allow fresh creation
                    activePickerInstances.clear();
                    console.log('🗑️ Cleared activePickerInstances set');
                    
                    // Verify essential elements still exist
                    const stillExist = essentialElementIds.filter(id => document.getElementById(id));
                    console.log(`🔎 Post-cleanup verification: ${stillExist.length}/${essentialElementIds.length} essential elements preserved`);
                    
                } catch (error) {
                    console.error('❌ Error in forceCleanupAllColorPickers:', error);
                }
            }
            
            // ========== نظام أزرار الألوان البسيط ==========
            
            function setupColorPickersOnly() {
                try {
                    // التحقق من طي الشريط الجانبي
                    const sidebarCollapsed = document.body.classList.contains('sidebar-collapsed');
                    if (sidebarCollapsed) {
                        return;
                    }
                    
                    const root = document.documentElement;
                    const colorControls = [
                        { id: "page-header-bg", prop: "--page-header-bg", default: "#f8f9fa" },
                        { id: "header-item-bg", prop: "--header-item-bg", default: "#ffffff" },
                        { id: "page-footer-bg", prop: "--page-footer-bg", default: "#f8f9fa" },
                        { id: "footer-item-bg", prop: "--footer-item-bg", default: "#ffffff" },
                        { id: "header-item-text-color", prop: "--header-item-text-color", default: "#333333" },
                        { id: "page-title-text-color", prop: "--page-title-text-color", default: "#333333" },
                        { id: "page-title-bg-color", prop: "--page-title-bg-color", default: "#ffffff" },
                        { id: "page-title-border-color", prop: "--page-title-border-color", default: "#ced4da" },
                        { id: "poetry-text-color", prop: "--poetry-text-color", default: "#333333" },
                        { id: "poetry-num-color", prop: "--poetry-num-color", default: "#888888" },
                        { id: "passage-line-num-color", prop: "--passage-line-num-color", default: "#666666" },
                        { id: "question-text-color", prop: "--question-text-color", default: "#212529" },
                        { id: "question-num-color", prop: "--question-num-color", default: "#ffffff" },
                        { id: "question-num-bg", prop: "--question-num-bg", default: "#007bff" },
                        { id: "statement-text-color", prop: "--statement-text-color", default: "#555555" },
                        { id: "statement-bg-color", prop: "--statement-bg-color", default: "#f1f3f5" },
                        { id: "answer-head-color", prop: "--answer-head-color", default: "#495057" },
                        { id: "answer-head-bg", prop: "--answer-head-bg", default: "#e9ecef" },
                        { id: "answer-text-color", prop: "--answer-text-color", default: "#343a40" },
                        { id: "question-border-color", prop: "--question-border-color", default: "#ced4da" },
                        { id: "page-num-color", prop: "--page-num-color", default: "#333333" },
                        { id: "page-num-bg-color", prop: "--page-num-bg-color", default: "#cccccc" },
                        { id: "page-border-color", prop: "--page-border-color", default: "#333333" },
                        { id: "border-box-bg", prop: "--border-box-bg", default: "#ffffff" },
                        { id: "border-box-text-color", prop: "--border-box-text-color", default: "#333333" }
                    ];
                    
                    // التحقق من وجود العناصر المطلوبة
                    const existingElements = colorControls.filter(control => document.getElementById(control.id));
                    
                    if (existingElements.length === 0) {
                        return;
                    }
                    
                    let successCount = 0;
                    colorControls.forEach(control => {
                        try {
                            const el = document.getElementById(control.id);
                            if(!el) {
                                return; // تخطي العناصر المفقودة
                            }
                            
                            // التحقق من وجود مثيل سابق للزر
                            if (el._pickr) {
                                try {
                                    el._pickr.destroyAndRemove();
                                } catch (e) {
                                    console.warn('خطأ في إزالة الزر السابق:', e);
                                }
                                el._pickr = null;
                            }
                            
                            const pickr = Pickr.create({
                                el: `#${control.id}`,
                                theme: "nano",
                                default: control.default,
                                swatches: colorSwatches,
                                components: {
                                    preview: true,
                                    opacity: true,
                                    hue: true,
                                    interaction: {
                                        input: true,
                                        clear: true,
                                        save: true
                                    }
                                },
                                i18n: {
                                    'btn:save': 'حفظ',
                                    'btn:clear': 'إزالة'
                                }
                            });
                            
                            if (pickr) {
                                el._pickr = pickr; // تخزين مرجع للتنظيف
                                pickr.on("save", color => {
                                    if (color) {
                                        root.style.setProperty(control.prop, color.toRGBA().toString());
                                        recordState("Color Change: " + control.id);
                                    }
                                    pickr.hide();
                                });
                                addPickerBoundsListener(pickr);
                                successCount++;
                            } else {
                                console.warn('setupColorPickersOnly: فشل في إنشاء زر لـ', control.id);
                            }
                        } catch (e) {
                            console.warn('خطأ في إنشاء زر اللون لـ:', control.id, e);
                        }
                    });
                    
                    // إعداد زر لون التظليل
                    try {
                        const highlightEl = document.getElementById('sidebar-highlight-color-picker');
                        if (highlightEl) {
                            if (highlightEl._pickr) {
                                try {
                                    highlightEl._pickr.destroyAndRemove();
                                } catch (e) {
                                    console.warn('خطأ في إزالة زر التظليل السابق:', e);
                                }
                                highlightEl._pickr = null;
                            }
                            
                            const highlightColorPicker = Pickr.create({ 
                                theme: 'nano', 
                                swatches: colorSwatches, 
                                el: '#sidebar-highlight-color-picker', 
                                default: '#ffff00', 
                                components: {
                                    preview: true,
                                    hue: true,
                                    interaction: {
                                        input: true,
                                        save: true
                                    }
                                },
                                i18n: {
                                    'btn:save': 'حفظ',
                                    'btn:clear': 'إزالة'
                                }
                            });
                            
                            if (highlightColorPicker) {
                                highlightEl._pickr = highlightColorPicker;
                                highlightColorPicker.on('save', (color, instance) => {
                                    if (color) {
                                        root.style.setProperty('--highlight-color', color.toHEXA().toString());
                                        recordState("Highlight Color Change");
                                    }
                                    instance.hide();
                                });
                                addPickerBoundsListener(highlightColorPicker);
                            } else {
                                console.warn('setupColorPickersOnly: فشل في إنشاء زر التظليل');
                            }
                        }
                    } catch (e) {
                        console.warn('خطأ في إنشاء زر التظليل:', e);
                    }
                } catch (error) {
                    console.error('خطأ في setupColorPickersOnly:', error);
                }
            }
            
            // ========== دوال النظام الجديد ==========
            
            // تطبيق الحالة مع إعادة إنشاء أزرار الألوان
            function applyStateWithColorPickerRecreation(state) {
                console.log('📝 تطبيق الحالة مع إعادة إنشاء أزرار الألوان...');
                
                try {
                    // تطبيق الحالة
                    applyStateWithoutColorPickers(state);
                    
                    // إعادة إنشاء أزرار الألوان
                    setTimeout(() => {
                        setupColorPickersOnly();
                    }, 100);
                    
                } catch (error) {
                    console.error('❌ خطأ في تطبيق الحالة:', error);
                }
            }
            
            // تطبيق الحالة بدون أزرار الألوان
            function applyStateWithoutColorPickers(state) {
                if (!state) return;
                
                try {
                    // تطبيق جميع التغييرات من الحالة
                    if (state.content) {
                        mainContent.innerHTML = state.content;
                    }
                    
                    if (state.styles) {
                        Object.entries(state.styles).forEach(([property, value]) => {
                            document.documentElement.style.setProperty(property, value);
                        });
                    }
                    
                    if (state.borderState) {
                        Object.assign(borderState, state.borderState);
                        updateBorderCSSVariables();
                    }
                    
                    console.log('✅ تم تطبيق الحالة بنجاح');
                    
                } catch (error) {
                    console.error('❌ خطأ في تطبيق الحالة:', error);
                }
            }
            
            // إعداد أزرار الألوان فقط - تم دمجها مع الدالة الرئيسية
            // function setupColorPickersOnly() {
            //     // استدعاء الدالة المحدثة مباشرة
            //     setupColorPickersOnly();
            // }
            
            // إعداد أزرار لون النص
            function setupTextColorPickers() {
                // أزرار لون النص تُعالج في شريط التنسيق
                return Promise.resolve();
            }
            
            // ========== PROFESSIONAL TEXT TOOLBAR SYSTEM ==========
            
            // Global state for text toolbar
            let textToolbarState = {
                isInitialized: false,
                isVisible: false,
                isPickrOpen: false,
                currentSelection: null,
                lastSelectionText: '',
                selectionTimeout: null,
                isProcessing: false
            };
            
            // Supported contenteditable selectors
            const EDITABLE_SELECTORS = [
                '.statement-text[contenteditable]',
                '.question-text[contenteditable]',
                '.answer-text[contenteditable]',
                '.page-title[contenteditable]',
                '.question-list-header[contenteditable]',
                '.reading-passage-text[contenteditable]',
                '.poetry-shatr[contenteditable]',
                '.header-box[contenteditable]',
                '.footer-box[contenteditable]',
                '.page-border-box[contenteditable]',
                '[contenteditable="true"]',
                '[contenteditable=""]'
            ];
            
            // Initialize the complete text toolbar system
            function initializeTextToolbarSystem() {
                if (textToolbarState.isInitialized) {
                    console.log('🔄 Text toolbar already initialized');
                    return;
                }
                
                try {
                    console.log('🚀 Initializing Professional Text Toolbar System...');
                    
                    // Setup color pickers
                    setupTextToolbarColorPickers();
                    
                    // Setup event listeners
                    setupTextToolbarEventListeners();
                    
                    // Setup font dropdown
                    setupFontDropdown();
                    
                    // Setup opacity slider
                    setupOpacitySlider();
                    
                    // Mark as initialized
                    textToolbarState.isInitialized = true;
                    
                    console.log('✅ Professional Text Toolbar System initialized successfully');
                    
                } catch (error) {
                    console.error('❌ Error initializing text toolbar system:', error);
                }
            }
            
            // Setup color pickers for text toolbar
            function setupTextToolbarColorPickers() {
                try {
                    const swatches = colorSwatches || ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722', '#795548', '#607D8B', '#FFFFFF', '#000000'];
                    
                    // Setup text color picker
                    const textColorEl = document.getElementById('text-color-picker');
                    if (textColorEl) {
                        if (textColorEl._pickr) {
                            textColorEl._pickr.destroyAndRemove();
                        }
                        
                        const textColorPickr = Pickr.create({
                            el: textColorEl,
                            theme: 'nano',
                            defaultRepresentation: 'HEX',
                            default: '#212529',
                            swatches: swatches,
                            components: {
                                preview: true,
                                opacity: true,
                                hue: true,
                                interaction: {
                                    hex: true,
                                    rgba: true,
                                    hsla: false,
                                    hsva: false,
                                    cmyk: false,
                                    input: true,
                                    clear: false,
                                    save: true
                                }
                            }
                        });
                        
                        textColorEl._pickr = textColorPickr;
                        
                        textColorPickr.on('save', (color, instance) => {
                            const hexColor = color.toHEXA().toString();
                            applyTextColor(hexColor);
                            instance.hide();
                        });
                        
                        textColorPickr.on('show', () => {
                            textToolbarState.isPickrOpen = true;
                        });
                        
                        textColorPickr.on('hide', () => {
                            textToolbarState.isPickrOpen = false;
                        });
                    }
                    
                    // Setup highlight color picker
                    const highlightColorEl = document.getElementById('text-highlight-picker');
                    if (highlightColorEl) {
                        if (highlightColorEl._pickr) {
                            highlightColorEl._pickr.destroyAndRemove();
                        }
                        
                        const highlightColorPickr = Pickr.create({
                            el: highlightColorEl,
                            theme: 'nano',
                            defaultRepresentation: 'HEX',
                            default: '#FFEB3B',
                            swatches: swatches,
                            components: {
                                preview: true,
                                opacity: true,
                                hue: true,
                                interaction: {
                                    hex: true,
                                    rgba: true,
                                    hsla: false,
                                    hsva: false,
                                    cmyk: false,
                                    input: true,
                                    clear: false,
                                    save: true
                                }
                            }
                        });
                        
                        highlightColorEl._pickr = highlightColorPickr;
                        
                        highlightColorPickr.on('save', (color, instance) => {
                            const hexColor = color.toHEXA().toString();
                            applyHighlightColor(hexColor);
                            instance.hide();
                        });
                        
                        highlightColorPickr.on('show', () => {
                            textToolbarState.isPickrOpen = true;
                        });
                        
                        highlightColorPickr.on('hide', () => {
                            textToolbarState.isPickrOpen = false;
                        });
                    }
                    
                    console.log('🎨 Text toolbar color pickers setup complete');
                    
                } catch (error) {
                    console.error('❌ Error setting up text toolbar color pickers:', error);
                }
            }
            
            // Setup event listeners for text toolbar
            function setupTextToolbarEventListeners() {
                const toolbar = textFormatToolbar;
                if (!toolbar) return;
                
                // Prevent toolbar from hiding when interacting with it
                toolbar.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
                
                toolbar.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    const button = e.target.closest('button');
                    if (button) {
                        const command = button.dataset.command;
                        if (command) {
                            applyTextFormat(command);
                        }
                    }
                });
                
                // Prevent selection loss for color pickers
                const textColorPicker = document.getElementById('text-color-picker');
                const textHighlightPicker = document.getElementById('text-highlight-picker');
                
                [textColorPicker, textHighlightPicker].forEach(picker => {
                    if (picker) {
                        picker.addEventListener('mousedown', (e) => e.stopPropagation());
                        picker.addEventListener('click', (e) => e.stopPropagation());
                    }
                });
                
                console.log('🎯 Text toolbar event listeners setup complete');
            }
            
            // Setup font dropdown for the clean toolbar
            function setupCleanFontDropdown() {
                const fontDropdownBtn = document.getElementById('font-dropdown-btn');
                const fontDropdown = document.getElementById('font-dropdown');
                
                if (fontDropdownBtn && fontDropdown) {
                    // Explicitly remove old event handlers that might interfere
                    // We need to create dummy handlers to remove the old ones
                    const oldDropdownClickHandler = function(e) {
                        e.preventDefault();
                        const dropdown = document.getElementById('font-dropdown');
                        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                    };
                    
                    const oldOptionClickHandler = function(e) {
                        if (e.target.classList.contains('font-option')) {
                            const fontFamily = e.target.dataset.font;
                            applyFont(fontFamily);
                            document.getElementById('current-font-name').textContent = e.target.textContent;
                            document.getElementById('font-dropdown').style.display = 'none';
                        }
                    };
                    
                    // Remove old event listeners
                    fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                    fontDropdown.removeEventListener('click', oldOptionClickHandler);
                    
                    // Remove any existing event listeners to prevent duplicates
                    fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                    fontDropdown.removeEventListener('click', handleFontOptionClick);
                    
                    // Add new event listeners
                    fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                    fontDropdown.addEventListener('click', handleFontOptionClick);
                }
                
                console.log('🔤 Clean font dropdown setup complete');
            }
            
            // Handle font dropdown button click
            function handleFontDropdownClick(e) {
                e.preventDefault();
                e.stopPropagation();
                const fontDropdown = document.getElementById('font-dropdown');
                if (fontDropdown) {
                    fontDropdown.style.display = fontDropdown.style.display === 'block' ? 'none' : 'block';
                }
            }
            
            // Handle font option click
            function handleFontOptionClick(e) {
                e.stopPropagation();
                if (e.target.classList.contains('font-option')) {
                    const fontFamily = e.target.dataset.font;
                    applyCleanFont(fontFamily);
                    const currentFontName = document.getElementById('current-font-name');
                    if (currentFontName) {
                        currentFontName.textContent = e.target.textContent;
                    }
                    const fontDropdown = document.getElementById('font-dropdown');
                    if (fontDropdown) {
                        fontDropdown.style.display = 'none';
                    }
                }
            }
            
            // Setup opacity slider
            function setupOpacitySlider() {
                const opacitySlider = document.getElementById('text-opacity-slider');
                const opacityValue = document.getElementById('opacity-value');
                
                if (opacitySlider && opacityValue) {
                    opacitySlider.addEventListener('input', (e) => {
                        const opacity = e.target.value;
                        opacityValue.textContent = opacity + '%';
                        if (textToolbarState.currentSelection) {
                            applyOpacity(opacity);
                        }
                    });
                }
                
                console.log('🎚️ Opacity slider setup complete');
            }
            
            // Main selection change handler
            function handleTextSelectionChange() {
                if (textToolbarState.isProcessing || textToolbarState.isPickrOpen) {
                    return;
                }
                
                if (textToolbarState.selectionTimeout) {
                    clearTimeout(textToolbarState.selectionTimeout);
                }
                
                textToolbarState.selectionTimeout = setTimeout(() => {
                    textToolbarState.isProcessing = true;
                    
                    try {
                        const selection = window.getSelection();
                        
                        // Hide toolbar if no selection or collapsed selection
                        if (!selection || selection.isCollapsed) {
                            hideTextToolbar();
                            return;
                        }
                        
                        // Check if selection is in editable content
                        const selectedText = selection.toString().trim();
                        if (!selectedText) {
                            hideTextToolbar();
                            return;
                        }
                        
                        // Validate selection is in supported editable element
                        const anchorNode = selection.anchorNode;
                        if (!anchorNode) {
                            hideTextToolbar();
                            return;
                        }
                        
                        const parentElement = anchorNode.nodeType === Node.TEXT_NODE ? anchorNode.parentElement : anchorNode;
                        const editableElement = findEditableElement(parentElement);
                        
                        if (!editableElement) {
                            hideTextToolbar();
                            return;
                        }
                        
                        // Check if this is the same selection
                        if (selectedText === textToolbarState.lastSelectionText && textToolbarState.currentSelection) {
                            return;
                        }
                        
                        // Store selection and show toolbar
                        textToolbarState.currentSelection = selection.getRangeAt(0).cloneRange();
                        textToolbarState.lastSelectionText = selectedText;
                        
                        showTextToolbar();
                        updateTextToolbarState(selection);
                        
                    } catch (error) {
                        console.error('❌ Error handling text selection:', error);
                        hideTextToolbar();
                    } finally {
                        textToolbarState.isProcessing = false;
                    }
                }, 100);
            }
            
            // Find editable element from parent
            function findEditableElement(element) {
                for (const selector of EDITABLE_SELECTORS) {
                    const editable = element.closest(selector);
                    if (editable && editable.getAttribute('contenteditable') !== 'false') {
                        return editable;
                    }
                }
                return null;
            }
            
            // Show text toolbar
            function showTextToolbar() {
                const toolbar = textFormatToolbar;
                if (toolbar && !textToolbarState.isVisible) {
                    toolbar.classList.add('show');
                    textToolbarState.isVisible = true;
                }
            }
            
            // Hide text toolbar
            function hideTextToolbar() {
                const toolbar = textFormatToolbar;
                if (toolbar && textToolbarState.isVisible) {
                    toolbar.classList.remove('show');
                    textToolbarState.isVisible = false;
                    textToolbarState.currentSelection = null;
                    textToolbarState.lastSelectionText = '';
                }
            }
            
            // Update toolbar state based on current selection
            function updateTextToolbarState(selection) {
                try {
                    if (!selection || !selection.anchorNode) return;
                    
                    // Update formatting buttons
                    const formatCommands = ['bold', 'italic', 'underline'];
                    formatCommands.forEach(command => {
                        const button = textFormatToolbar.querySelector(`#${command}-btn`);
                        if (button) {
                            const isActive = checkFormattingState(selection, command);
                            button.classList.toggle('active', isActive);
                        }
                    });
                    
                    // Update highlight button
                    const highlightButton = textFormatToolbar.querySelector('#highlight-btn');
                    if (highlightButton) {
                        const isHighlighted = checkHighlightState(selection);
                        highlightButton.classList.toggle('active', isHighlighted);
                    }
                    
                } catch (error) {
                    console.error('❌ Error updating toolbar state:', error);
                }
            }
            
            // Check formatting state for a specific command
            function checkFormattingState(selection, command) {
                let element = selection.anchorNode.nodeType === Node.TEXT_NODE ? selection.anchorNode.parentElement : selection.anchorNode;
                
                while (element && element !== document.body) {
                    const style = window.getComputedStyle(element);
                    
                    switch (command) {
                        case 'bold':
                            if (style.fontWeight === 'bold' || parseInt(style.fontWeight) >= 700) return true;
                            break;
                        case 'italic':
                            if (style.fontStyle === 'italic') return true;
                            break;
                        case 'underline':
                            if (style.textDecoration.includes('underline')) return true;
                            break;
                    }
                    
                    element = element.parentElement;
                }
                
                return false;
            }
            
            // Check highlight state
            function checkHighlightState(selection) {
                let element = selection.anchorNode.nodeType === Node.TEXT_NODE ? selection.anchorNode.parentElement : selection.anchorNode;
                
                while (element && element !== document.body) {
                    const style = window.getComputedStyle(element);
                    if (style.backgroundColor && style.backgroundColor !== 'rgba(0, 0, 0, 0)' && style.backgroundColor !== 'transparent') {
                        return true;
                    }
                    element = element.parentElement;
                }
                
                return false;
            }
            
            // Apply text formatting
            function applyTextFormat(command) {
                if (!textToolbarState.currentSelection) {
                    console.warn('⚠️ No selection available for formatting');
                    return;
                }
                
                try {
                    // Restore selection
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(textToolbarState.currentSelection);
                    
                    switch (command) {
                        case 'bold':
                        case 'italic':
                        case 'underline':
                            applyBasicFormatting(command);
                            break;
                        case 'highlight':
                            applyHighlight();
                            break;
                        default:
                            console.warn(`⚠️ Unknown format command: ${command}`);
                    }
                    
                    // Update toolbar state
                    setTimeout(() => {
                        const currentSelection = window.getSelection();
                        if (currentSelection && !currentSelection.isCollapsed) {
                            updateTextToolbarState(currentSelection);
                        }
                    }, 10);
                    
                } catch (error) {
                    console.error('❌ Error applying text format:', error);
                }
            }
            
            // Apply basic formatting (bold, italic, underline)
            function applyBasicFormatting(command) {
                if (!textToolbarState.currentSelection) {
                    console.warn('No selection available for basic formatting');
                    return;
                }
                
                try {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(textToolbarState.currentSelection);
                    
                    const cssProperty = command === 'bold' ? 'font-weight: bold' : 
                                      command === 'italic' ? 'font-style: italic' : 
                                      'text-decoration: underline';
                    
                    const container = textToolbarState.currentSelection.commonAncestorContainer;
                    const parentElement = container.nodeType === Node.TEXT_NODE ? container.parentElement : container;
                    const existingSpan = parentElement.closest(`span[style*="${cssProperty.split(':')[0]}"]`);
                    
                    if (existingSpan && textToolbarState.currentSelection.toString() === existingSpan.textContent) {
                        // Remove formatting
                        const wrapper = existingSpan;
                        const content = wrapper.innerHTML;
                        const fragment = document.createDocumentFragment();
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = content;
                        
                        while (tempDiv.firstChild) {
                            fragment.appendChild(tempDiv.firstChild);
                        }
                        
                        wrapper.parentNode.insertBefore(fragment, wrapper);
                        wrapper.remove();
                    } else {
                        // Apply formatting
                        const span = document.createElement('span');
                        span.style.cssText = cssProperty;
                        
                        const range = textToolbarState.currentSelection.cloneRange();
                        const contents = range.extractContents();
                        span.appendChild(contents);
                        range.insertNode(span);
                        
                        // Update selection
                        const newRange = document.createRange();
                        newRange.selectNodeContents(span);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                        textToolbarState.currentSelection = newRange.cloneRange();
                    }
                    
                    // Trigger blur event to save changes
                    const editable = selection.anchorNode?.parentElement?.closest('[contenteditable="true"]');
                    if (editable) {
                        editable.dispatchEvent(new Event('blur', { bubbles: true }));
                    }
                    
                } catch (error) {
                    console.error('Error applying basic formatting:', error);
                }
            }
            
            // Apply text color to current selection
            function applyTextColor(color) {
                if (!textToolbarState.currentSelection) return;
                
                try {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(textToolbarState.currentSelection);
                    
                    const span = document.createElement('span');
                    span.style.color = color;
                    
                    try {
                        span.appendChild(textToolbarState.currentSelection.extractContents());
                        textToolbarState.currentSelection.insertNode(span);
                        
                        // Update selection to maintain toolbar
                        selection.removeAllRanges();
                        const newRange = document.createRange();
                        newRange.selectNodeContents(span);
                        selection.addRange(newRange);
                        textToolbarState.currentSelection = newRange.cloneRange();
                    } catch (e) {
                        // Fallback to execCommand if range manipulation fails
                        document.execCommand('foreColor', false, color);
                    }
                } catch (error) {
                    console.warn('Error applying text color:', error);
                }
            }
            
            // Apply highlight color to current selection
            function applyHighlightColor(color) {
                if (!textToolbarState.currentSelection) return;
                
                try {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(textToolbarState.currentSelection);
                    
                    const span = document.createElement('span');
                    span.style.backgroundColor = color;
                    
                    try {
                        span.appendChild(textToolbarState.currentSelection.extractContents());
                        textToolbarState.currentSelection.insertNode(span);
                        
                        // Update selection to maintain toolbar
                        selection.removeAllRanges();
                        const newRange = document.createRange();
                        newRange.selectNodeContents(span);
                        selection.addRange(newRange);
                        textToolbarState.currentSelection = newRange.cloneRange();
                    } catch (e) {
                        // Fallback to execCommand if range manipulation fails
                        document.execCommand('backColor', false, color);
                    }
                } catch (error) {
                    console.warn('Error applying highlight color:', error);
                }
            }
            
            // Legacy function for backward compatibility
            function handleSelectionChange() {
                handleTextSelectionChange();
            }
            
            // Legacy function for backward compatibility
            function updateToolbarState(selection) {
                updateTextToolbarState(selection);
            }
            
            // Legacy function for backward compatibility
            function applyFormat(command) {
                applyTextFormat(command);
            }
            
            // تنظيف قوي لجميع أزرار الألوان
            function forceCleanupAllColorPickers() {
                // تنظيف بسيط - إزالة جميع أزرار Pickr
                if (typeof Pickr !== 'undefined' && Pickr.instances) {
                    Pickr.instances.forEach(instance => {
                        try {
                            instance.destroyAndRemove();
                        } catch (e) {}
                    });
                    Pickr.instances.length = 0;
                }
                
                // إزالة المراجع من عناصر DOM
                document.querySelectorAll('.color-picker').forEach(el => {
                    if (el._pickr) {
                        try {
                            el._pickr.destroyAndRemove();
                        } catch (e) {}
                        el._pickr = null;
                        delete el._pickr;
                    }
                });
            }
            
            // إعادة إنشاء طارئة لأزرار الألوان
            function emergencyRecreateColorPickers() {
                setupColorPickersOnly();
            }
            
            // جعل الدوال متاحة عالمياً للتصحيح
            window.recreateColorPickers = emergencyRecreateColorPickers;
            window.forceCleanupColorPickers = forceCleanupAllColorPickers;
            
            // ========== دوال اختبار النظام الجديد ==========
            
            window.testColorPickers = function(autoRecreate = false) {
                console.log('🧪 اختبار وظائف أزرار الألوان...');
                
                const colorElements = document.querySelectorAll('.color-picker');
                let workingCount = 0;
                
                colorElements.forEach(el => {
                    if (el._pickr && typeof el._pickr.show === 'function') {
                        workingCount++;
                    }
                });
                
                const result = { workingCount, totalCount: colorElements.length };
                console.log(`🎯 نتيجة الاختبار: ${workingCount}/${colorElements.length} زر يعمل`);
                
                if (autoRecreate && workingCount < colorElements.length) {
                    console.warn('⚠️ فشل بعض الأزرار في الاختبار. إعادة المحاولة...');
                    setTimeout(() => {
                        setupColorPickersOnly();
                    }, 1000);
                }
                
                return result;
            };
            
            window.emergencyRecreateAllColorPickers = function() {
                console.log('🆘 طارئ: إعادة إنشاء جميع أزرار الألوان...');
                setupColorPickersOnly();
            };
            
            window.initializeColorPickerSystem = function() {
                console.log('🚀 يدوي: تهيئة نظام أزرار الألوان...');
                setupColorPickersOnly();
            };
            
            window.testUndoRedo = function() {
                console.log('🧪 اختبار التراجع/الإعادة مع أزرار الألوان...');
                
                // تسجيل إجراء اختبار
                recordState('إجراء اختبار للتراجع/الإعادة');
                
                setTimeout(() => {
                    console.log('⏪ اختبار التراجع...');
                    undo();
                    
                    setTimeout(() => {
                        console.log('⏩ اختبار الإعادة...');
                        redo();
                        
                        setTimeout(() => {
                            console.log('🔍 التحقق من أزرار الألوان بعد التراجع/الإعادة...');
                            window.testColorPickers();
                        }, 1000);
                    }, 1000);
                }, 1000);
            };
            
            // دالة محسنة للتحقق من ظهور أزرار الألوان
            window.checkColorPickerVisibility = function() {
                console.log('🔍 التحقق من ظهور أزرار الألوان...');
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                
                // التحقق من جميع عناصر أزرار الألوان
                const allColorElements = document.querySelectorAll('.color-picker, [id*="color"]');
                console.log(`📊 إجمالي عناصر أزرار الألوان الموجودة: ${allColorElements.length}`);
                
                allColorElements.forEach(element => {
                    const id = element.id;
                    const hasPickr = !!element._pickr;
                    const computedStyle = window.getComputedStyle(element);
                    const isVisible = computedStyle.display !== 'none' && computedStyle.visibility !== 'hidden' && computedStyle.opacity !== '0';
                    const hasContent = element.children.length > 0 || element.textContent.trim().length > 0;
                    const rect = element.getBoundingClientRect();
                    const hasSize = rect.width > 0 && rect.height > 0;
                    
                    console.log(`🎨 ${id}:`);
                    console.log(`   - لديه Pickr: ${hasPickr ? '✅' : '❌'}`);
                    console.log(`   - مرئي: ${isVisible ? '✅' : '❌'}`);
                    console.log(`   - لديه محتوى: ${hasContent ? '✅' : '❌'}`);
                    console.log(`   - لديه حجم: ${hasSize ? '✅' : '❌'} (${rect.width}x${rect.height})`);
                    console.log(`   - العرض: ${computedStyle.display}`);
                    console.log(`   - الفئات: ${element.className}`);
                    
                    if (hasPickr) {
                        const pickrButton = element.querySelector('.pcr-button');
                        if (pickrButton) {
                            const buttonRect = pickrButton.getBoundingClientRect();
                            console.log(`   - زر Pickr: ✅ (${buttonRect.width}x${buttonRect.height})`);
                        } else {
                            console.log(`   - زر Pickr: ❌ مفقود`);
                        }
                    }
                });
                
                // التحقق من حالات الشريط الجانبي
                console.log('\n📊 حالات الشريط الجانبي:');
                console.log(`- الشريط الجانبي للتخطيط مفتوح: ${document.body.classList.contains('layout-sidebar-open')}`);
                console.log(`- الشريط الجانبي للألوان مفتوح: ${document.body.classList.contains('colors-sidebar-open')}`);
                console.log(`- الشريط الجانبي الرئيسي مطوي: ${document.body.classList.contains('sidebar-collapsed')}`);
                
                return {
                    totalElements: allColorElements.length,
                    visibleElements: Array.from(allColorElements).filter(el => {
                        const style = window.getComputedStyle(el);
                        return style.display !== 'none' && style.visibility !== 'hidden';
                    }).length
                };
            };
            
            // دالة لإخفاء رسائل التصحيح
            window.hideAllColorPickerMessages = function() {
                console.log('🔇 تم إخفاء رسائل أزرار الألوان');
            };
            
            // دالة لاستعادة رسائل التصحيح
            window.showAllColorPickerMessages = function() {
                console.log('🔊 تم استعادة رسائل التصحيح');
            };
            
            // تعليمات نهائية للمستخدم
            console.log('🎯 نظام أزرار الألوان البسيط جاهز!');
            console.log('💡 دوال الاختبار المتاحة:');
            console.log('   window.testColorPickers()       // اختبار عمل جميع الأزرار');
            console.log('   window.emergencyRecreateAllColorPickers()  // إعادة إنشاء طارئة');
            console.log('   window.initializeColorPickerSystem()       // تهيئة يدوية');
            
            // دالة تطبيق الحالة الرئيسية (للتوافق مع الكود القديم)
            function applyState(state) {
                if (DEBUG_MODE) console.log('📝 تطبيق الحالة: تفويض إلى النظام الجديد...');
                return applyStateWithColorPickerRecreation(state);
            }
            
            // دوال التحكم في وضع التصحيح (مبسطة)
            window.enableColorPickerDebug = function() {
                console.log('🔧 تم تفعيل وضع تصحيح أزرار الألوان');
            };
            
            window.disableColorPickerDebug = function() {
                console.log('🔧 تم إلغاء تفعيل وضع تصحيح أزرار الألوان');
            };
            
            window.toggleColorPickerDebug = function() {
                console.log('🔧 تبديل وضع تصحيح أزرار الألوان');
            };
            
            // Function to fix color picker visibility issues
            window.fixColorPickerVisibility = function() {
                console.log('🔧 FIXING COLOR PICKER VISIBILITY...');
                
                const allColorElements = document.querySelectorAll('.color-picker, [id*="color"]');
                let fixedCount = 0;
                
                allColorElements.forEach(element => {
                    const id = element.id;
                    const hasPickr = !!element._pickr;
                    
                    if (hasPickr) {
                        // Ensure element is visible
                        if (element.style.display === 'none') {
                            element.style.display = 'block';
                            fixedCount++;
                            console.log(`✅ Fixed display for ${id}`);
                        }
                        
                        if (element.style.visibility === 'hidden') {
                            element.style.visibility = 'visible';
                            fixedCount++;
                            console.log(`✅ Fixed visibility for ${id}`);
                        }
                        
                        // Ensure minimum size
                        const rect = element.getBoundingClientRect();
                        if (rect.width === 0 || rect.height === 0) {
                            element.style.minWidth = '30px';
                            element.style.minHeight = '30px';
                            fixedCount++;
                            console.log(`✅ Fixed size for ${id}`);
                        }
                        
                        // Check if Pickr button exists
                        const pickrButton = element.querySelector('.pcr-button');
                        if (!pickrButton) {
                            console.log(`⚠️ ${id}: Pickr instance exists but button missing - recreating...`);
                            element._pickr.destroyAndRemove();
                            delete element._pickr;
                            // Trigger recreation
                            setupColorPickersOnly();
                            fixedCount++;
                        }
                    } else if (element.id && element.classList.contains('color-picker')) {
                        console.log(`⚠️ ${id}: No Pickr instance - creating...`);
                        setupColorPickersOnly();
                        fixedCount++;
                    }
                });
                
                console.log(`🎯 Fixed ${fixedCount} color picker visibility issues`);
                return fixedCount;
            };
            window.debugColorPickers = function() {
                const pickerElements = document.querySelectorAll('.color-picker, [id*="color"]');
                const activePickrs = document.querySelectorAll('.pcr-app');
                const expectedIds = [
                    'page-header-bg', 'header-item-bg', 'page-footer-bg', 'footer-item-bg',
                    'header-item-text-color', 'page-title-text-color', 'page-title-bg-color',
                    'page-title-border-color', 'poetry-text-color', 'poetry-num-color',
                    'passage-line-num-color', 'question-text-color', 'question-num-color',
                    'question-num-bg', 'statement-text-color', 'statement-bg-color',
                    'answer-head-color', 'answer-head-bg', 'answer-text-color',
                    'question-border-color', 'page-num-color', 'page-num-bg-color',
                    'page-border-color', 'border-box-bg', 'border-box-text-color',
                    'sidebar-highlight-color-picker'
                ];
                
                console.log('🔍 DEBUG COLOR PICKER STATUS:');
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('- Picker elements found:', pickerElements.length);
                console.log('- Active Pickr instances:', activePickrs.length);
                
                console.log('\n📊 SIDEBAR VISIBILITY:');
                console.log('- Main sidebar collapsed:', document.body.classList.contains('sidebar-collapsed'));
                console.log('- Layout sidebar open:', document.body.classList.contains('layout-sidebar-open'));
                console.log('- Colors sidebar open:', document.body.classList.contains('colors-sidebar-open'));
                console.log('- Sizes sidebar open:', document.body.classList.contains('sizes-sidebar-open'));
                
                console.log('\n🗂️ SIDEBAR DOM ELEMENTS:');
                console.log('- #sidebar exists:', !!document.getElementById('sidebar'));
                console.log('- #layout-sidebar exists:', !!document.getElementById('layout-sidebar'));
                console.log('- #colors-sidebar exists:', !!document.getElementById('colors-sidebar'));
                console.log('- #sizes-sidebar exists:', !!document.getElementById('sizes-sidebar'));
                
                console.log('\n🎯 COLOR PICKER ELEMENTS BY LOCATION:');
                
                // Check Layout Sidebar elements
                const layoutElements = ['page-header-bg', 'header-item-bg', 'page-footer-bg', 'footer-item-bg', 'header-item-text-color', 'page-border-color', 'border-box-bg', 'border-box-text-color', 'page-num-color', 'page-num-bg-color'];
                console.log('📄 Layout Sidebar:');
                layoutElements.forEach(id => {
                    const el = document.getElementById(id);
                    const status = el ? '✅ EXISTS' : '❌ MISSING';
                    const pickr = el && el._pickr ? '(has Pickr)' : '(no Pickr)';
                    console.log(`  ${id}: ${status} ${pickr}`);
                });
                
                // Check Colors Sidebar elements
                const colorElements = ['page-title-text-color', 'page-title-bg-color', 'page-title-border-color', 'poetry-text-color', 'poetry-num-color', 'passage-line-num-color', 'question-text-color', 'question-num-color', 'question-num-bg', 'statement-text-color', 'statement-bg-color', 'answer-head-color', 'answer-head-bg', 'answer-text-color', 'question-border-color', 'sidebar-highlight-color-picker'];
                console.log('🎨 Colors Sidebar:');
                colorElements.forEach(id => {
                    const el = document.getElementById(id);
                    const status = el ? '✅ EXISTS' : '❌ MISSING';
                    const pickr = el && el._pickr ? '(has Pickr)' : '(no Pickr)';
                    console.log(`  ${id}: ${status} ${pickr}`);
                });
                
                // Check Text Toolbar elements
                const textElements = ['text-color-picker', 'text-highlight-picker'];
                console.log('📝 Text Toolbar:');
                textElements.forEach(id => {
                    const el = document.getElementById(id);
                    const status = el ? '✅ EXISTS' : '❌ MISSING';
                    const pickr = el && el._pickr ? '(has Pickr)' : '(no Pickr)';
                    console.log(`  ${id}: ${status} ${pickr}`);
                });
                
                console.log('\n💡 RECOMMENDATIONS:');
                if (!document.body.classList.contains('layout-sidebar-open') && !document.body.classList.contains('colors-sidebar-open')) {
                    console.log('- Open the Layout or Colors sidebar to see color picker elements');
                    console.log('- Click the palette icon (🎨) or layout icon (📄) in the toolbar');
                }
                
                return {
                    totalElements: pickerElements.length,
                    activeInstances: activePickrs.length,
                    sidebarCollapsed: document.body.classList.contains('sidebar-collapsed'),
                    layoutOpen: document.body.classList.contains('layout-sidebar-open'),
                    colorsOpen: document.body.classList.contains('colors-sidebar-open'),
                    sizesOpen: document.body.classList.contains('sizes-sidebar-open'),
                    missingElements: expectedIds.filter(id => !document.getElementById(id))
                };
            };
            

            
            function setupSliderControlsOnly() {
                try {
                    const root = document.documentElement;
                    const sliderControls = [ {id:"title-fs",prop:"--title-fs",unit:"px"}, {id:"q-header-fs",prop:"--q-header-fs",unit:"px"}, {id:"passage-text-fs",prop:"--passage-text-fs",unit:"px"}, {id:"passage-line-num-fs",prop:"--passage-line-num-fs",unit:"px"}, {id:"poetry-text-fs",prop:"--poetry-text-fs",unit:"px"}, {id:"poetry-num-fs",prop:"--poetry-num-fs",unit:"px"}, {id:"question-num-fs",prop:"--question-num-fs",unit:"px"}, {id:"question-text-fs",prop:"--question-text-fs",unit:"px"}, {id:"statement-fs",prop:"--statement-fs",unit:"px"}, {id:"answer-head-fs",prop:"--answer-head-fs",unit:"px"}, {id:"answer-text-fs",prop:"--answer-text-fs",unit:"px"}, {id:"page-num-fs",prop:"--page-num-fs",unit:"px"},  {id:"header-text-fs",prop:"--header-text-fs",unit:"px"}, {id:"footer-text-fs",prop:"--footer-text-fs",unit:"px"}, {id:"page-num-circle-size", prop:"--page-num-circle-size", unit:"px"}, {id:"answer-head-circle-size", prop:"--answer-head-circle-size", unit:"px"}, {id:"header-logo-height",prop:"--header-logo-height",unit:"px"}, {id:"page-border-width",prop:"--page-border-width",unit:"px"}, {id:"page-border-radius",prop:"--page-border-radius",unit:"px"} ];
                    sliderControls.forEach(control => {
                        try {
                            const slider = document.getElementById(control.id);
                            if(!slider) return;
                            // Only add event listeners if they don't already exist
                            if (!slider.hasAttribute('data-setup')) {
                                slider.addEventListener("input",() => { root.style.setProperty(control.prop,`${slider.value}${control.unit}`); updateSliderValueDisplay(slider, control.unit); });
                                slider.addEventListener("change",() => { recordState("Style Change: " + control.id); });
                                slider.setAttribute('data-setup', 'true');
                            }
                            updateSliderValueDisplay(slider, control.unit);
                        } catch (e) {
                            console.warn('Error setting up slider control:', control.id, e);
                        }
                    });
                    
                    setupSliderButtons();
                    
                    // Setup individual border style controls
                    ['top', 'right', 'bottom', 'left'].forEach(side => {
                        const select = document.getElementById(`border-style-${side}`);
                        if (select && !select.hasAttribute('data-setup')) {
                            select.addEventListener('change', (e) => {
                                borderState[`${side}Style`] = e.target.value;
                                updateBorderCSSVariables();
                                recordState(`Change ${side} Border Style`);
                            });
                            select.setAttribute('data-setup', 'true');
                        }
                    });
                } catch (error) {
                    console.error('Error in setupSliderControlsOnly:', error);
                }
            }
            
            // --- Enhanced Text Formatting Functions ---
            
            let isUpdatingPickr = false; // Flag to prevent circular calls
            let isPickrOpen = false; // Flag to track if any Pickr is currently open
            
            // Setup text formatting toolbar color pickers
            function setupTextColorPickers() {
                try {
                    // Use the colorSwatches variable that's already defined in the scope
                    const swatches = colorSwatches;
                    
                    // Setup text color picker
                    const textColorEl = document.getElementById('text-color-picker');
                    if (textColorEl) {
                        // Destroy existing picker if it exists
                        if (textColorEl._pickr) {
                            try {
                                textColorEl._pickr.destroyAndRemove();
                            } catch (e) {
                                console.warn('Error destroying existing text color picker:', e);
                            }
                            textColorEl._pickr = null;
                        }
                        
                        const textColorPickr = Pickr.create({
                            el: '#text-color-picker',
                            theme: 'nano',
                            default: '#000000',
                            swatches: swatches,
                            components: {
                                preview: true,
                                hue: true,
                                interaction: {
                                    input: true,
                                    save: true
                                }
                            },
                            i18n: {
                                'btn:save': 'حفظ',
                                'btn:clear': 'إزالة'
                            }
                        });
                        
                        if (textColorPickr) {
                            textColorEl._pickr = textColorPickr;
                            window.textColorPickr = textColorPickr; // Store globally for toolbar updates
                            
                            textColorPickr.on('save', (color, instance) => {
                                if (color && currentSelectionRange) {
                                    applyTextColor(color.toHEXA().toString());
                                    recordState("Text Color Change");
                                }
                                instance.hide();
                            });
                            
                            textColorPickr.on('show', () => {
                                isPickrOpen = true;
                            });
                            
                            textColorPickr.on('hide', () => {
                                isPickrOpen = false;
                            });
                            
                            addPickerBoundsListener(textColorPickr);
                        }
                    }
                    
                    // Setup text highlight picker
                    const textHighlightEl = document.getElementById('text-highlight-picker');
                    if (textHighlightEl) {
                        // Destroy existing picker if it exists
                        if (textHighlightEl._pickr) {
                            try {
                                textHighlightEl._pickr.destroyAndRemove();
                            } catch (e) {
                                console.warn('Error destroying existing text highlight picker:', e);
                            }
                            textHighlightEl._pickr = null;
                        }
                        
                        const textHighlightPickr = Pickr.create({
                            el: '#text-highlight-picker',
                            theme: 'nano',
                            default: '#ffff00',
                            swatches: colorSwatches,
                            components: {
                                preview: true,
                                hue: true,
                                interaction: {
                                    input: true,
                                    save: true
                                }
                            },
                            i18n: {
                                'btn:save': 'حفظ',
                                'btn:clear': 'إزالة'
                            }
                        });
                        
                        if (textHighlightPickr) {
                            textHighlightEl._pickr = textHighlightPickr;
                            window.textHighlightPickr = textHighlightPickr; // Store globally for toolbar updates
                            
                            textHighlightPickr.on('save', (color, instance) => {
                                if (color && currentSelectionRange) {
                                    applyTextHighlight(color.toHEXA().toString());
                                    recordState("Text Highlight Change");
                                }
                                instance.hide();
                            });
                            
                            textHighlightPickr.on('show', () => {
                                isPickrOpen = true;
                            });
                            
                            textHighlightPickr.on('hide', () => {
                                isPickrOpen = false;
                            });
                            
                            addPickerBoundsListener(textHighlightPickr);
                        }
                    }
                } catch (error) {
                    console.error('Error in setupTextColorPickers:', error);
                }
            }
            
            // Apply text color to current selection
            function applyTextColor(color) {
                if (!currentSelectionRange) return;
                
                try {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(currentSelectionRange);
                    
                    const span = document.createElement('span');
                    span.style.color = color;
                    
                    try {
                        span.appendChild(currentSelectionRange.extractContents());
                        currentSelectionRange.insertNode(span);
                        
                        // Update selection to maintain toolbar
                        selection.removeAllRanges();
                        const newRange = document.createRange();
                        newRange.selectNodeContents(span);
                        selection.addRange(newRange);
                        currentSelectionRange = newRange.cloneRange();
                    } catch (e) {
                        // Fallback to execCommand if range manipulation fails
                        document.execCommand('foreColor', false, color);
                    }
                } catch (error) {
                    console.warn('Error applying text color:', error);
                }
            }
            
            // Apply text highlight to current selection
            function applyTextHighlight(color) {
                if (!currentSelectionRange) return;
                
                try {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(currentSelectionRange);
                    
                    const span = document.createElement('span');
                    span.style.backgroundColor = color;
                    
                    try {
                        span.appendChild(currentSelectionRange.extractContents());
                        currentSelectionRange.insertNode(span);
                        
                        // Update selection to maintain toolbar
                        selection.removeAllRanges();
                        const newRange = document.createRange();
                        newRange.selectNodeContents(span);
                        selection.addRange(newRange);
                        currentSelectionRange = newRange.cloneRange();
                    } catch (e) {
                        // Fallback to execCommand if range manipulation fails
                        document.execCommand('backColor', false, color);
                    }
                } catch (error) {
                    console.warn('Error applying text highlight:', error);
                }
            }

            
            let selectionTimeout = null;
            let lastSelectionText = '';
            let isSelectionProcessing = false;
            
            function handleSelectionChange() {
                // Prevent recursive calls
                if (isSelectionProcessing) {
                    return;
                }
                
                // Don't process if toolbar is not initialized
                if (!textFormatToolbar) {
                    return;
                }
                
                const selection = window.getSelection();
                const toolbar = textFormatToolbar;
                
                // Don't process if Pickr is currently open
                if (isPickrOpen && currentSelectionRange) {
                    return;
                }
                
                // Don't process if user is actively interacting with toolbar
                if (toolbar.matches(':hover') || toolbar.contains(document.activeElement)) {
                    return;
                }
                
                // Clear existing timeout
                if (selectionTimeout) {
                    clearTimeout(selectionTimeout);
                }
                
                // Enhanced debouncing with longer delay for smoother experience
                selectionTimeout = setTimeout(() => {
                    isSelectionProcessing = true;
                    
                    try {
                        const currentSelection = window.getSelection();
                        
                        // Handle collapsed selection (no text selected)
                        if (!currentSelection || currentSelection.isCollapsed) {
                            toolbar.classList.remove('show');
                            currentSelectionRange = null;
                            lastSelectionText = '';
                            return;
                        }
                        
                        // Additional check: ensure selection is not empty after trimming
                        const selectedText = currentSelection.toString().trim();
                        if (!selectedText) {
                            toolbar.classList.remove('show');
                            currentSelectionRange = null;
                            lastSelectionText = '';
                            return;
                        }
                        
                        // Validate selection is in editable content
                        const anchorNode = currentSelection.anchorNode;
                        if (!anchorNode) {
                            toolbar.classList.remove('show');
                            currentSelectionRange = null;
                            lastSelectionText = '';
                            return;
                        }
                        
                        // Find the closest editable element
                        const parentElement = anchorNode.nodeType === Node.TEXT_NODE ? anchorNode.parentElement : anchorNode;
                        const editable = parentElement.closest('[contenteditable]:not([contenteditable="false"]), [contenteditable=""], [contenteditable="true"]');
                        
                        if (!editable) {
                            toolbar.classList.remove('show');
                            currentSelectionRange = null;
                            lastSelectionText = '';
                            return;
                        }
                        
                        // Check if this is the same selection to avoid redundant processing
                        const currentText = currentSelection.toString().trim();
                        if (currentText === lastSelectionText && currentSelectionRange && currentText.length > 0) {
                            return; // Same selection, no need to process
                        }
                        
                        // Ensure we have a valid range and meaningful text
                        if (currentText.length === 0) {
                            toolbar.classList.remove('show');
                            currentSelectionRange = null;
                            lastSelectionText = '';
                            return;
                        }
                        
                        // Store the selection range and text
                        currentSelectionRange = currentSelection.getRangeAt(0).cloneRange();
                        lastSelectionText = currentText;
                        
                        // Show toolbar with smooth animation
                        if (!toolbar.classList.contains('show')) {
                            toolbar.classList.add('show');
                        }
                        
                        // Update toolbar state based on current selection
                        updateToolbarState(currentSelection);
                        
                    } catch (e) {
                        console.warn('Error handling selection:', e);
                        toolbar.classList.remove('show');
                        currentSelectionRange = null;
                        lastSelectionText = '';
                    } finally {
                        isSelectionProcessing = false;
                    }
                }, 100); // Increased debounce time for smoother experience
            }

            function updateToolbarState(selection) {
                try {
                    // Validate selection before processing
                    if (!selection || !selection.anchorNode) {
                        return;
                    }
                    
                    // Update formatting button states with modern CSS detection
                    const formatChecks = {
                        'bold': 'font-weight',
                        'italic': 'font-style', 
                        'underline': 'text-decoration'
                    };
                    
                    Object.keys(formatChecks).forEach(command => {
                        const button = textFormatToolbar.querySelector(`#${command}-btn`);
                        if (button) {
                            let isActive = false;
                            
                            // Check CSS property in parent elements
                            let element = selection.anchorNode.nodeType === Node.TEXT_NODE ? selection.anchorNode.parentElement : selection.anchorNode;
                            while (element && element !== document.body) {
                                const style = window.getComputedStyle(element);
                                if (command === 'bold' && (style.fontWeight === 'bold' || parseInt(style.fontWeight) >= 700)) {
                                    isActive = true;
                                    break;
                                } else if (command === 'italic' && style.fontStyle === 'italic') {
                                    isActive = true;
                                    break;
                                } else if (command === 'underline' && style.textDecoration.includes('underline')) {
                                    isActive = true;
                                    break;
                                }
                                element = element.parentElement;
                            }
                            
                            button.classList.toggle('active', isActive);
                        }
                    });
                    
                    // Update highlight button state
                    const highlightButton = textFormatToolbar.querySelector('#highlight-btn');
                    if (highlightButton) {
                        const node = selection.anchorNode;
                        const isHighlighted = node && node.parentElement.closest('.text-highlight');
                        highlightButton.classList.toggle('active', !!isHighlighted);
                    }

                    // Update font family
                    const computedStyle = window.getComputedStyle(selection.anchorNode.parentElement);
                    const fontFamily = computedStyle.fontFamily;
                    updateCurrentFont(fontFamily);

                    // Update text color with better detection
                    let textColor = '#000000'; // default
                    try {
                        let element = selection.anchorNode.nodeType === Node.TEXT_NODE ? selection.anchorNode.parentElement : selection.anchorNode;
                        while (element && element !== document.body) {
                            const elementStyle = window.getComputedStyle(element);
                            const elementColor = elementStyle.color;
                            if (elementColor && elementColor !== 'rgb(0, 0, 0)' && elementColor !== 'rgba(0, 0, 0, 1)') {
                                textColor = rgb2hex(elementColor);
                                break;
                            }
                            element = element.parentElement;
                        }
                        
                        if (window.textColorPickr && !isUpdatingPickr) {
                            isUpdatingPickr = true;
                            window.textColorPickr.setColor(textColor);
                            isUpdatingPickr = false;
                        }
                    } catch (error) {
                        // Silent error handling for color update
                    }

                    // Update opacity with better detection
                    let opacity = 100; // default
                    try {
                        // Check for opacity in the selection's parent elements
                        let element = selection.anchorNode.nodeType === Node.TEXT_NODE ? selection.anchorNode.parentElement : selection.anchorNode;
                        
                        // Walk up the DOM tree to find opacity
                        while (element && element !== document.body) {
                            const elementStyle = window.getComputedStyle(element);
                            const elementOpacity = parseFloat(elementStyle.opacity);
                            if (elementOpacity < 1) {
                                opacity = Math.round(elementOpacity * 100);
                                break;
                            }
                            element = element.parentElement;
                        }
                        
                        const opacitySlider = document.getElementById('text-opacity-slider');
                        const opacityValueSpan = document.getElementById('opacity-value');
                        
                        if (opacitySlider && opacityValueSpan) {
                            opacitySlider.value = opacity;
                            opacityValueSpan.textContent = opacity + '%';
                        }
                    } catch (error) {
                        // Silent error handling for opacity update
                        const opacitySlider = document.getElementById('text-opacity-slider');
                        const opacityValueSpan = document.getElementById('opacity-value');
                        if (opacitySlider && opacityValueSpan) {
                            opacitySlider.value = 100;
                            opacityValueSpan.textContent = '100%';
                        }
                    }
                } catch (error) {
                    // Silent error handling for overall toolbar update
                }
            }
            
            // Legacy function for backward compatibility
            function applyFormat(command) {
                applyTextFormat(command);
            }

            function applyTextColor(color) {
                if (!currentSelectionRange) {
                    console.warn('No selection range available for text color');
                    return;
                }
                
                try {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(currentSelectionRange);
                    
                    // Check if selection is within an existing span with color
                    const container = currentSelectionRange.commonAncestorContainer;
                    const parentElement = container.nodeType === Node.TEXT_NODE ? container.parentElement : container;
                    const existingColorSpan = parentElement.closest('span[style*="color"]');
                    
                    if (existingColorSpan && currentSelectionRange.toString() === existingColorSpan.textContent) {
                        // Update existing color span
                        const currentStyle = existingColorSpan.style.cssText;
                        const newStyle = currentStyle.replace(/color:\s*[^;]+/g, `color: ${color}`);
                        existingColorSpan.style.cssText = newStyle.includes('color:') ? newStyle : `${currentStyle}; color: ${color}`;
                    } else {
                        // Create new color span using modern approach
                        wrapSelectionWithStyle('span', `color: ${color}`);
                    }
                    
                    const editable = selection.anchorNode.parentElement.closest('[contenteditable="true"]');
                    if(editable) editable.dispatchEvent(new Event('blur', { bubbles: true }));
                    

                } catch (error) {
                    console.error('Error applying text color:', error);
                }
            }

            function applyFont(fontFamily) {
                if (!currentSelectionRange) {
                    console.warn('No selection range available for font');
                    return;
                }
                
                try {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(currentSelectionRange);
                    
                    // Check if selection is within an existing span with font-family
                    const container = currentSelectionRange.commonAncestorContainer;
                    const parentElement = container.nodeType === Node.TEXT_NODE ? container.parentElement : container;
                    const existingFontSpan = parentElement.closest('span[style*="font-family"]');
                    
                    if (existingFontSpan && currentSelectionRange.toString() === existingFontSpan.textContent) {
                        // Update existing font span
                        const currentStyle = existingFontSpan.style.cssText;
                        const newStyle = currentStyle.replace(/font-family:\s*[^;]+/g, `font-family: ${fontFamily}`);
                        existingFontSpan.style.cssText = newStyle.includes('font-family:') ? newStyle : `${currentStyle}; font-family: ${fontFamily}`;
                    } else {
                        // Create new font span using modern approach
                        wrapSelectionWithStyle('span', `font-family: ${fontFamily}`);
                    }
                    
                    const editable = selection.anchorNode.parentElement.closest('[contenteditable="true"]');
                    if(editable) editable.dispatchEvent(new Event('blur', { bubbles: true }));
                    
                    console.log(`Applied font: ${fontFamily}`);
                } catch (error) {
                    console.error('Error applying font:', error);
                }
            }

            function applyOpacity(opacity) {
                if (!currentSelectionRange) {
                    console.warn('No selection range available for opacity');
                    return;
                }
                
                try {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(currentSelectionRange);
                    
                    const opacityValue = opacity / 100;
                    
                    // Check if selection is within an existing span with opacity
                    const container = currentSelectionRange.commonAncestorContainer;
                    const parentElement = container.nodeType === Node.TEXT_NODE ? container.parentElement : container;
                    const existingOpacitySpan = parentElement.closest('span[style*="opacity"]');
                    
                    if (existingOpacitySpan && currentSelectionRange.toString() === existingOpacitySpan.textContent) {
                        // Update existing opacity span
                        const currentStyle = existingOpacitySpan.style.cssText;
                        const newStyle = currentStyle.replace(/opacity:\s*[0-9.]+/g, `opacity: ${opacityValue}`);
                        existingOpacitySpan.style.cssText = newStyle.includes('opacity:') ? newStyle : `${currentStyle}; opacity: ${opacityValue}`;
                    } else {
                        // Create new opacity span
                        wrapSelectionWithStyle('span', `opacity: ${opacityValue}`);
                    }
                    
                    const editable = selection.anchorNode.parentElement.closest('[contenteditable="true"]');
                    if(editable) editable.dispatchEvent(new Event('blur', { bubbles: true }));
                    
                    console.log(`Applied opacity: ${opacity}% (${opacityValue})`);
                } catch (error) {
                    console.error('Error applying opacity:', error);
                }
            }

            function applyHighlight() {
                if (!textToolbarState.currentSelection) return;
                
                try {
                    const highlightColor = window.currentHighlightColor || '#ffff00';
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(textToolbarState.currentSelection);
                    
                    // Check if already highlighted
                    let isHighlighted = false;
                    let container = textToolbarState.currentSelection.commonAncestorContainer;
                    if(container.nodeType === 3) container = container.parentNode;
                    if (container.closest('.text-highlight, [style*="background-color"]')) isHighlighted = true;
                    
                    if (isHighlighted) {
                        // Remove highlight
                        const wrapper = container.closest('.text-highlight, [style*="background-color"]');
                        if (wrapper) {
                            const content = wrapper.innerHTML;
                            const fragment = document.createDocumentFragment();
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = content;
                            
                            while (tempDiv.firstChild) {
                                fragment.appendChild(tempDiv.firstChild);
                            }
                            
                            wrapper.parentNode.insertBefore(fragment, wrapper);
                            wrapper.remove();
                        }
                    } else {
                        // Apply highlight
                        const span = document.createElement('span');
                        span.className = 'text-highlight';
                        span.style.backgroundColor = highlightColor;
                        
                        const range = textToolbarState.currentSelection.cloneRange();
                        const contents = range.extractContents();
                        span.appendChild(contents);
                        range.insertNode(span);
                        
                        // Update selection
                        const newRange = document.createRange();
                        newRange.selectNodeContents(span);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                        textToolbarState.currentSelection = newRange.cloneRange();
                    }
                    
                    const editable = selection.anchorNode?.parentElement?.closest('[contenteditable="true"]');
                    if(editable) editable.dispatchEvent(new Event('blur', { bubbles: true }));
                    
                } catch (error) {
                    console.error('Error applying highlight:', error);
                }
            }

            function wrapSelectionWithStyle(tagName, style, className = '') {
                if (!textToolbarState.currentSelection) {
                    console.warn('No selection range available for wrapping');
                    return;
                }
                
                try {
                    const wrapper = document.createElement(tagName);
                    if (className) wrapper.className = className;
                    wrapper.style.cssText = style;
                    
                    // Clone range to avoid modifying original
                    const range = textToolbarState.currentSelection.cloneRange();
                    
                    // Extract and wrap contents
                    const contents = range.extractContents();
                    wrapper.appendChild(contents);
                    range.insertNode(wrapper);
                    
                    // Update selection to wrap the new element
                    const newRange = document.createRange();
                    newRange.selectNodeContents(wrapper);
                    textToolbarState.currentSelection = newRange;
                    
                    console.log(`Wrapped selection with ${tagName}, style: ${style}`);
                } catch(e) { 
                    console.error("Could not wrap selection:", e); 
                }
            }

            function updateCurrentFont(fontFamily) {
                let fontName = 'الخط الأميري'; // default
                
                if (fontFamily.includes('Amiri')) fontName = 'الخط الأميري';
                else if (fontFamily.includes('Scheherazade')) fontName = 'خط شهرزاد';
                else if (fontFamily.includes('Tajawal')) fontName = 'خط تجوال';
                else if (fontFamily.includes('Alfarooq')) fontName = 'خط الفاروق';
                else if (fontFamily.includes('Arbaeen')) fontName = 'خط أربعين';
                else if (fontFamily.includes('Castile')) fontName = 'خط كاستيل';
                else if (fontFamily.includes('Droid Arabic Kufi')) fontName = 'درويد كوفي';
                else if (fontFamily.includes('Droid Arabic Naskh')) fontName = 'درويد نسخ';
                else if (fontFamily.includes('HS Al Basim A')) fontName = 'الباسم أ';
                else if (fontFamily.includes('HS Al Basim B')) fontName = 'الباسم ب';
                else if (fontFamily.includes('Hasan Alquds Unicode')) fontName = 'حسن القدس';
                else if (fontFamily.includes('Hasan Hiba')) fontName = 'حسن هبة';
                else if (fontFamily.includes('Nusaibah')) fontName = 'نصيبة';
                else if (fontFamily.includes('Samman')) fontName = 'سمان';
                else if (fontFamily.includes('Sonbili')) fontName = 'سنبلي';
                else if (fontFamily.includes('Abdo Logo')) fontName = 'عبده لوجو';
                
                document.getElementById('current-font-name').textContent = fontName;
            }

            function rgb2hex(rgb) {
                if (rgb.indexOf('#') === 0) return rgb;
                
                const matches = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
                if (!matches) return '#000000';
                
                function hex(x) {
                    return ("0" + parseInt(x).toString(16)).slice(-2);
                }
                
                return "#" + hex(matches[1]) + hex(matches[2]) + hex(matches[3]);
            }

            function copySelectedText() {
                if (!currentSelectionRange) return;
                
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(currentSelectionRange);
                
                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error('Copy failed:', err);
                }
            }

            function cutSelectedText() {
                if (!currentSelectionRange) return;
                
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(currentSelectionRange);
                
                try {
                    document.execCommand('cut');
                    const editable = selection.anchorNode.parentElement.closest('[contenteditable="true"]');
                    if(editable) editable.dispatchEvent(new Event('blur', { bubbles: true }));
                } catch (err) {
                    console.error('Cut failed:', err);
                }
            }

            function pasteText() {
                if (!currentSelectionRange) return;
                
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(currentSelectionRange);
                
                try {
                    document.execCommand('paste');
                    const editable = selection.anchorNode.parentElement.closest('[contenteditable="true"]');
                    if(editable) editable.dispatchEvent(new Event('blur', { bubbles: true }));
                } catch (err) {
                    console.error('Paste failed:', err);
                }
            }
            
            function unwrapSelection(selector) {
                if (!textToolbarState.currentSelection) {
                    console.warn('No selection range available for unwrapping');
                    return;
                }
                
                try {
                    const ancestor = textToolbarState.currentSelection.commonAncestorContainer;
                    const wrapper = ancestor.nodeType === 1 ? ancestor.closest(selector) : ancestor.parentElement.closest(selector);
                    
                    if (wrapper) {
                        console.log(`Unwrapping element with selector: ${selector}`);
                        
                        // Get the content before unwrapping
                        const content = wrapper.innerHTML;
                        
                        // Create a document fragment with the content
                        const fragment = document.createDocumentFragment();
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = content;
                        
                        // Move all child nodes to the fragment
                        while (tempDiv.firstChild) {
                            fragment.appendChild(tempDiv.firstChild);
                        }
                        
                        // Replace the wrapper with the fragment
                        wrapper.parentNode.insertBefore(fragment, wrapper);
                        wrapper.remove();
                        
                        console.log(`Successfully unwrapped ${selector}`);
                    } else {
                        console.log(`No element found with selector: ${selector}`);
                    }
                } catch(e) { 
                    console.error("Could not unwrap selection:", e); 
                }
            }

            // --- END NEW Formatting Functions ---


            function recordState(action) {
                // Don't record state during initialization to prevent inaccurate tracking
                if (!isInitialized) return;
                
                // Ensure no inputs are focused before saving state
                if (document.activeElement) document.activeElement.blur();

                const state = { 
                    data: JSON.parse(JSON.stringify(pageContent)), 
                    headerFooter: JSON.parse(JSON.stringify(headerFooterState)),
                    watermark: JSON.parse(JSON.stringify(watermarkState)),
                    borderState: JSON.parse(JSON.stringify(borderState)),
                    pageNumberVisible: pageNumberVisible,
                    mcqDefaults: JSON.parse(JSON.stringify(mcqDefaults)),
                    essayDefaults: JSON.parse(JSON.stringify(essayDefaults)),
                    styles: getCssVariablesState(), 
                    pageNumber: startPageNumber, 
                    action: action 
                };
                // Avoid pushing duplicate states - check all relevant state components
                if(history.length > 0) {
                    const lastState = history[history.length-1];
                    const isDuplicateData = JSON.stringify(lastState.data) === JSON.stringify(state.data);
                    const isDuplicateStyles = JSON.stringify(lastState.styles) === JSON.stringify(state.styles);
                    const isDuplicateHeaderFooter = JSON.stringify(lastState.headerFooter) === JSON.stringify(state.headerFooter);
                    const isDuplicateWatermark = JSON.stringify(lastState.watermark) === JSON.stringify(state.watermark);
                    const isDuplicateBorder = JSON.stringify(lastState.borderState) === JSON.stringify(state.borderState);
                    
                    if (isDuplicateData && isDuplicateStyles && isDuplicateHeaderFooter && isDuplicateWatermark && isDuplicateBorder) {
                        return; // Skip recording duplicate state
                    }
                }
                
                // Clear any future actions from redo stack when recording new action
                if (currentActionIndex < actionHistory.length - 1) {
                    actionHistory = actionHistory.slice(0, currentActionIndex + 1);
                }
                
                // Add to action history with Arabic name and timestamp
                const actionHistoryItem = {
                    action: action,
                    arabicName: actionNames[action] || action,
                    timestamp: new Date(),
                    icon: getActionIcon(action)
                };
                
                actionHistory.push(actionHistoryItem);
                currentActionIndex = actionHistory.length - 1;
                
                // Keep only last 50 actions to prevent memory issues
                if (actionHistory.length > 50) {
                    actionHistory = actionHistory.slice(-50);
                    currentActionIndex = actionHistory.length - 1;
                }

                history.push(state); 
                redoStack = []; 
                updateUndoRedoButtons();
            }

            function getCssVariablesState() {
                const rootStyles = getComputedStyle(document.documentElement); 
                const styles = {};
                const propsToSave = [ 
                    "--page-header-bg", "--header-item-bg", "--page-footer-bg", "--footer-item-bg", 
                    "--title-fs","--q-header-fs","--passage-text-fs", "--passage-line-num-fs", "--poetry-text-fs", "--poetry-num-fs",
                    "--question-num-fs","--question-text-fs","--statement-fs","--answer-head-fs",
                    "--answer-text-fs","--page-num-fs", "--header-text-fs", "--footer-text-fs", 
                    "--question-text-color", "--poetry-text-color", "--poetry-num-color", "--passage-line-num-color",
                    "--question-num-color","--question-num-bg","--statement-text-color","--statement-bg-color",
                    "--answer-head-color","--answer-head-bg","--answer-text-color","--question-border-color",
                    "--page-num-color", "--page-num-bg-color", "--page-num-circle-size", 
                    "--page-title-text-color", "--page-title-bg-color", "--page-title-border-color", 
                    "--answer-head-circle-size", "--header-item-text-color", "--header-logo-height",
                    "--highlight-color", "--page-border-color", "--page-border-width", "--page-border-radius",
                    "--border-box-bg", "--border-box-text-color"
                ];
                propsToSave.forEach(prop => { styles[prop] = rootStyles.getPropertyValue(prop).trim(); });
                return styles;
            }
            
            function applyState(state) {
                console.log('🔄 Applying state from history...');
                
                pageContent = JSON.parse(JSON.stringify(state.data));
                headerFooterState = JSON.parse(JSON.stringify(state.headerFooter));
                watermarkState = { ...{ type: 'text', content: '', opacity: 0.25, rotation: 0, size: 80, visible: false, imageName: '', imageData: null }, ...JSON.parse(JSON.stringify(state.watermark || {})) };
                borderState = { ...{ enabled: false, width: 2, color: '#333333', radius: 0, style: 'solid', unifiedStyle: true, topStyle: 'solid', rightStyle: 'solid', bottomStyle: 'solid', leftStyle: 'solid', boxes: [] }, ...JSON.parse(JSON.stringify(state.borderState || {})) };
                pageNumberVisible = state.pageNumberVisible !== undefined ? state.pageNumberVisible : true;
                mcqDefaults = { ...{ includeStatement: false, defaultLayout: '3' }, ...JSON.parse(JSON.stringify(state.mcqDefaults || {})) };
                essayDefaults = { ...{ includeStatement: false, defaultLines: 2 }, ...JSON.parse(JSON.stringify(state.essayDefaults || {})) };
                startPageNumber = state.pageNumber || 1;
                const root = document.documentElement;
                
                // Apply CSS styles carefully
                if(state.styles) {
                    console.log('🎨 Applying CSS styles from state...');
                    for (const prop in state.styles) {
                        root.style.setProperty(prop, state.styles[prop]);
                    }
                }
                
                toggleHeaderCheckbox.checked = headerFooterState.header.visible;
                document.body.classList.toggle('header-hidden', !headerFooterState.header.visible);
                toggleFooterCheckbox.checked = headerFooterState.footer.visible;
                document.body.classList.toggle('footer-hidden', !headerFooterState.footer.visible);
                
                // Apply border state
                toggleBorderCheckbox.checked = borderState.enabled;
                document.body.classList.toggle('border-active', borderState.enabled);
                borderControls.classList.toggle('disabled', !borderState.enabled);
                
                // Apply page number visibility
                togglePageNumberCheckbox.checked = pageNumberVisible;
                document.body.classList.toggle('page-number-hidden', !pageNumberVisible);
                
                // Initialize dimmed overlays for controls
                const headerFooterControls = document.getElementById('header-footer-controls');
                const pageNumberControls = document.getElementById('page-number-controls');
                const isHeaderOrFooterVisible = headerFooterState.header.visible || headerFooterState.footer.visible;
                headerFooterControls.classList.toggle('disabled', !isHeaderOrFooterVisible);
                pageNumberControls.classList.toggle('disabled', !pageNumberVisible);
                
                // Update border style controls
                if (borderStyleUnifiedCheckbox) {
                    borderStyleUnifiedCheckbox.checked = borderState.unifiedStyle || true;
                    toggleBorderStyleMode({ target: { checked: borderState.unifiedStyle || true } });
                }
                updateBorderCSSVariables();
                
                // Render content first
                renderAll();
                
                // Update sidebar controls with a small delay to prevent interference
                // This timing fix prevents color picker paralysis after undo/redo
                setTimeout(() => {
                    updateSidebarControls(state.styles);
                }, 50);
                
                console.log('✅ State applied successfully');
            }

            // ========== SIMPLIFIED SIDEBAR CONTROLS UPDATE ==========
            // The old updateSidebarControls is no longer needed since our new system handles everything
            
            function updateSidebarControls(styles) {
                            console.log('📝 تحديث عناصر التحكم في الشريط الجانبي: تفويض إلى النظام الجديد...');
            // النظام الجديد في applyStateWithColorPickerRecreation يتعامل مع كل شيء
                // This function is kept for compatibility but does minimal work
                return Promise.resolve();
            }

            // ========== نظام التراجع/الإعادة المحسن ==========
            // هذا النظام يضمن عمل أزرار الألوان بنسبة 100% بعد عمليات التراجع/الإعادة
            
            function undo() {
                if (history.length > 1) {
                    console.log('⏪ التراجع: بدء عملية التراجع...');
                    redoStack.push(history.pop());
                    currentActionIndex--;
                    
                    // تطبيق الحالة مع إعادة إنشاء أزرار الألوان
                    applyStateWithColorPickerRecreation(history[history.length - 1]);
                    updateUndoRedoButtons();
                }
            }
            
            function redo() {
                if (redoStack.length > 0) {
                    console.log('⏩ الإعادة: بدء عملية الإعادة...');
                    history.push(redoStack.pop());
                    currentActionIndex++;
                    
                    // تطبيق الحالة مع إعادة إنشاء أزرار الألوان
                    applyStateWithColorPickerRecreation(history[history.length - 1]);
                    updateUndoRedoButtons();
                }
            }
            
            function undoToAction(actionIndex) {
                actionHistoryMenu.classList.add('hidden'); // Hide the menu immediately
                
                if (actionIndex < 0 || actionIndex >= actionHistory.length || actionIndex > currentActionIndex) return;
                
                console.log(`⏪ التراجع إلى الإجراء: التراجع إلى فهرس الإجراء ${actionIndex}...`);
                
                // حساب عدد الخطوات للتراجع
                const stepsToUndo = currentActionIndex - actionIndex;
                
                for (let i = 0; i < stepsToUndo; i++) {
                    if (history.length > 1) {
                        redoStack.push(history.pop());
                    }
                }
                
                currentActionIndex = actionIndex;
                if (history.length > 0) {
                    // تطبيق الحالة مع إعادة إنشاء أزرار الألوان
                    applyStateWithColorPickerRecreation(history[history.length - 1]);
                }
                updateUndoRedoButtons();
            }
            
            /**
             * تطبيق الحالة المحسن
             * هذه الدالة تطبق الحالة وتضمن عمل أزرار الألوان بشكل كامل
             */
            async function applyStateWithColorPickerRecreation(state) {
                console.log('🔄 تطبيق الحالة مع إعادة إنشاء أزرار الألوان...');
                
                try {
                    // الخطوة 1: تطبيق الحالة الأساسية (نفس applyState القديمة)
                    console.log('🔄 تطبيق الحالة من التاريخ...');
                    
                    pageContent = JSON.parse(JSON.stringify(state.data));
                    headerFooterState = JSON.parse(JSON.stringify(state.headerFooter));
                    watermarkState = { ...{ type: 'text', content: '', opacity: 0.25, rotation: 0, size: 80, visible: false, imageName: '', imageData: null }, ...JSON.parse(JSON.stringify(state.watermark || {})) };
                    borderState = { ...{ enabled: false, width: 2, color: '#333333', radius: 0, style: 'solid', unifiedStyle: true, topStyle: 'solid', rightStyle: 'solid', bottomStyle: 'solid', leftStyle: 'solid', boxes: [] }, ...JSON.parse(JSON.stringify(state.borderState || {})) };
                    pageNumberVisible = state.pageNumberVisible !== undefined ? state.pageNumberVisible : true;
                    mcqDefaults = { ...{ includeStatement: false, defaultLayout: '3' }, ...JSON.parse(JSON.stringify(state.mcqDefaults || {})) };
                    essayDefaults = { ...{ includeStatement: false, defaultLines: 2 }, ...JSON.parse(JSON.stringify(state.essayDefaults || {})) };
                    startPageNumber = state.pageNumber || 1;
                    
                    // Apply styles to CSS
                    if (state.styles) {
                        const root = document.documentElement;
                        Object.entries(state.styles).forEach(([prop, value]) => {
                            if (value) root.style.setProperty(prop, value);
                        });
                    }
                    
                    // Update body classes
                    document.body.classList.toggle('header-hidden', !headerFooterState.header.visible);
                    document.body.classList.toggle('footer-hidden', !headerFooterState.footer.visible);
                    document.body.classList.toggle('border-active', borderState.enabled);
                    document.body.classList.toggle('page-number-hidden', !pageNumberVisible);
                    
                    // Initialize dimmed overlays for controls
                    const headerFooterControls = document.getElementById('header-footer-controls');
                    const pageNumberControls = document.getElementById('page-number-controls');
                    const isHeaderOrFooterVisible = headerFooterState.header.visible || headerFooterState.footer.visible;
                    headerFooterControls.classList.toggle('disabled', !isHeaderOrFooterVisible);
                    pageNumberControls.classList.toggle('disabled', !pageNumberVisible);
                    
                    // Update border style controls
                    if (borderStyleUnifiedCheckbox) {
                        borderStyleUnifiedCheckbox.checked = borderState.unifiedStyle || true;
                        toggleBorderStyleMode({ target: { checked: borderState.unifiedStyle || true } });
                    }
                        updateBorderCSSVariables();
                    
                    // Render content first
                    renderAll();
                    
                    console.log('✅ Base state applied successfully');
                    
                    // Step 2: Update sidebar controls (sliders)
                    if (state.styles) {
                        console.log('🎯 Updating slider values...');
                        document.querySelectorAll('.slider-control input[type=range]').forEach(slider => {
                            try {
                                if (!slider.id.startsWith('watermark-')) {
                                    const styleProp = `--${slider.id}`;
                                    if (state.styles[styleProp]) {
                                        const newValue = parseFloat(state.styles[styleProp]);
                                        if (!isNaN(newValue) && slider.value !== newValue.toString()) {
                                            slider.value = newValue;
                                            updateSliderValueDisplay(slider, slider.dataset.unit || 'px');
                                            console.log('✅ Updated slider:', slider.id, 'to', newValue);
                                        }
                                    }
                                }
                            } catch (e) {
                                console.warn('Error updating slider:', slider.id, e);
                            }
                        });
                    }
                    
                    // الخطوة 3: إعادة إنشاء أزرار الألوان المحسنة
                    console.log('🚀 بدء إعادة إنشاء أزرار الألوان المحسنة...');
                    
                    // انتظار استقرار DOM بالكامل
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                                                        // استخدام نظام أزرار الألوان البسيط
                        setupColorPickersOnly();
                    
                    console.log('🎉 اكتمل تطبيق الحالة مع إعادة إنشاء أزرار الألوان بنجاح!');
                    
                } catch (error) {
                    console.error('❌ خطأ حرج في applyStateWithColorPickerRecreation:', error);
                    
                    // الحل الاحتياطي الطارئ: محاولة إعادة إنشاء أساسية
                    try {
                        setupColorPickersOnly();
                    } catch (emergencyError) {
                        console.error('❌ فشلت إعادة الإنشاء الطارئة أيضاً:', emergencyError);
                    }
                }
            }
            function updateUndoRedoButtons() { 
                undoBtn.disabled = history.length <= 1; 
                redoBtn.disabled = redoStack.length === 0; 
            }
            
            function showActionHistoryMenu(event, buttonType) {
                actionHistoryMenu.classList.add('hidden');
                
                if (actionHistory.length === 0) return;
                
                const actionList = document.getElementById('action-history-list');
                actionList.innerHTML = '';
                
                // Determine which actions to show based on button type
                let actionsToShow = [];
                
                if (buttonType === 'undo') {
                    // Show last 10 undoable actions (current and previous)
                    const startIndex = Math.max(0, currentActionIndex - 9);
                    actionsToShow = actionHistory.slice(startIndex, currentActionIndex + 1).reverse();
                } else if (buttonType === 'redo') {
                    // Show next 10 redoable actions
                    const endIndex = Math.min(actionHistory.length, currentActionIndex + 11);
                    actionsToShow = actionHistory.slice(currentActionIndex + 1, endIndex);
                }
                
                if (actionsToShow.length === 0) return;
                
                actionsToShow.forEach((actionItem, index) => {
                    const li = document.createElement('li');
                    
                    // Find the actual index in the full history
                    const actualIndex = actionHistory.indexOf(actionItem);
                    
                    if (actualIndex === currentActionIndex) {
                        li.classList.add('current');
                    } else if (actualIndex > currentActionIndex) {
                        li.classList.add('future');
                    }
                    
                    const timeString = formatActionTime(actionItem.timestamp);
                    
                    li.innerHTML = `
                        <div class="action-icon"><i class="${actionItem.icon}"></i></div>
                        <div class="action-text">${actionItem.arabicName}</div>
                        <div class="action-time">${timeString}</div>
                    `;
                    
                    // Add click handler
                    if (buttonType === 'undo' && actualIndex <= currentActionIndex) {
                        li.style.cursor = 'pointer';
                        li.addEventListener('click', () => {
                            actionHistoryMenu.classList.add('hidden');
                            undoToAction(actualIndex);
                        });
                    }
                    
                    actionList.appendChild(li);
                });
                
                // Position the menu with improved viewport awareness
                const rect = event.target.getBoundingClientRect();
                
                // Show menu temporarily to get dimensions
                actionHistoryMenu.style.visibility = 'hidden';
                actionHistoryMenu.classList.remove('hidden');
                const menuRect = actionHistoryMenu.getBoundingClientRect();
                actionHistoryMenu.style.visibility = 'visible';
                
                // Calculate optimal position
                let top = rect.bottom + window.scrollY + 5;
                let left = rect.left + window.scrollX;
                
                // Adjust horizontal position if menu goes off-screen
                if (left + menuRect.width > window.innerWidth) {
                    // Try positioning to the left of the trigger
                    left = rect.right + window.scrollX - menuRect.width;
                    
                    // If still off-screen, align to right edge of viewport
                    if (left < 0) {
                        left = window.innerWidth - menuRect.width - 10;
                    }
                }
                
                // Ensure minimum left margin
                if (left < 10) {
                    left = 10;
                }
                
                // Adjust vertical position if menu goes off-screen
                if (top + menuRect.height > window.innerHeight + window.scrollY) {
                    // Try positioning above the trigger
                    top = rect.top + window.scrollY - menuRect.height - 5;
                    
                    // If still off-screen, position at bottom of viewport
                    if (top < window.scrollY) {
                        top = window.scrollY + window.innerHeight - menuRect.height - 10;
                    }
                }
                
                // Ensure minimum top margin
                if (top < window.scrollY + 10) {
                    top = window.scrollY + 10;
                }
                
                // Apply final position
                actionHistoryMenu.style.top = `${top}px`;
                actionHistoryMenu.style.left = `${left}px`;
            }
            
            function formatActionTime(timestamp) {
                const now = new Date();
                const diff = now - timestamp;
                const seconds = Math.floor(diff / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);
                
                if (seconds < 60) return 'الآن';
                if (minutes < 60) return `منذ ${minutes} دقيقة`;
                if (hours < 24) return `منذ ${hours} ساعة`;
                if (days < 7) return `منذ ${days} يوم`;
                
                return timestamp.toLocaleDateString('ar-SA', { 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            async function saveAsPDF() {
                loader.classList.remove('hidden'); 
                contextMenu.classList.add('hidden');
                textFormatToolbar.classList.remove('show');
                if (document.activeElement) document.activeElement.blur(); // remove focus from contenteditables
                
                await new Promise(resolve => setTimeout(resolve, 200)); // allow blur to complete

                const originalZoom = currentZoomLevel;
                applyZoom(1.0); // Reset zoom for accurate rendering

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4'); 
                const pages = document.querySelectorAll('.page');
                const pdfWidth = pdf.internal.pageSize.getWidth(); 
                const pdfHeight = pdf.internal.pageSize.getHeight();
                try {
                    for (let i = 0; i < pages.length; i++) {
                        const page = pages[i];
                        loaderText.textContent = `جاري معالجة صفحة ${i + 1} من ${pages.length}...`;
                        
                        const canvas = await html2canvas(page, { scale: 2, useCORS: true, logging: false, removeContainer: true });
                        const imgData = canvas.toDataURL('image/jpeg', 0.98);
                        
                        if (i > 0) pdf.addPage();
                        
                        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight, undefined, 'FAST');
                    }
                    loaderText.textContent = 'جاري حفظ الملف...'; 
                    pdf.save('ورقة_الأسئلة.pdf');
                } catch (error) { 
                    console.error("Failed to generate PDF:", error); 
                    alert("عذرًا، حدث خطأ أثناء إنشاء ملف PDF.");
                } finally { 
                    applyZoom(originalZoom); // Restore original zoom
                    loader.classList.add('hidden'); 
                    loaderText.textContent = 'جاري تحويل الصفحات إلى صور...'; 
                }
            }
            
            function saveAsWaraqa() {
                try {
                    // Create complete document state
                    const documentState = {
                        version: '1.0',
                        timestamp: new Date().toISOString(),
                        pageContent: JSON.parse(JSON.stringify(pageContent)),
                        headerFooterState: JSON.parse(JSON.stringify(headerFooterState)),
                        watermarkState: JSON.parse(JSON.stringify(watermarkState)),
                        borderState: JSON.parse(JSON.stringify(borderState)),
                        pageNumberVisible: pageNumberVisible,
                        mcqDefaults: JSON.parse(JSON.stringify(mcqDefaults)),
                        essayDefaults: JSON.parse(JSON.stringify(essayDefaults)),
                        startPageNumber: startPageNumber,
                        styles: getCssVariablesState(),
                        actionHistory: JSON.parse(JSON.stringify(actionHistory)),
                        currentActionIndex: currentActionIndex
                    };
                    
                    // Convert to JSON string
                    const jsonString = JSON.stringify(documentState, null, 2);
                    
                    // Create blob and download
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    // Create download link
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ورقة_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.waraqa`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    // Clean up
                    URL.revokeObjectURL(url);
                    
                    // Record this action
                    recordState('Save Document');
                    
                } catch (error) {
                    console.error('Failed to save document:', error);
                    alert('عذراً، حدث خطأ أثناء حفظ الملف.');
                }
            }
            
            // Initialize the main system first
            console.log('Initializing main system...');
            initialize();
            
            // Then initialize our new clean text toolbar system to override any old handlers
            // Use a delay to ensure all DOM elements are ready
            console.log('Scheduling clean text toolbar initialization...');
            setTimeout(() => {
                try {
                    console.log('Initializing clean text toolbar...');
                    initializeCleanTextToolbar();
                    console.log('Clean text toolbar initialization completed');
                } catch (error) {
                    console.error('Error initializing clean text toolbar:', error);
                }
            }, 500);
        });
        
        // ==================== NEW CLEAN TEXT TOOLBAR SYSTEM ====================
        
        // Global state for the new clean text toolbar
        const cleanTextToolbarState = {
            isVisible: false,
            currentSelection: null,
            isProcessing: false,
            colorPickers: {
                textColor: null,
                highlightColor: null
            }
        };
        
        // Initialize the clean text toolbar system
        function initializeCleanTextToolbar() {
            console.log('🚀 Initializing Clean Text Toolbar System...');
            
            try {
                // Setup all components
                console.log('Setting up clean toolbar event listeners...');
                setupCleanToolbarEventListeners();
                
                console.log('Setting up clean color pickers...');
                setupCleanColorPickers();
                
                console.log('Setting up clean font dropdown...');
                setupCleanFontDropdown();
                
                console.log('Setting up clean opacity slider...');
                setupCleanOpacitySlider();
                
                console.log('Setting up clean text selection handling...');
                setupCleanTextSelectionHandling();
                
                console.log('✅ Clean Text Toolbar System initialized successfully');
            } catch (error) {
                console.error('❌ Error initializing clean text toolbar system:', error);
            }
        }
        
        // Setup event listeners for the clean toolbar
        function setupCleanToolbarEventListeners() {
            const toolbar = document.getElementById('text-format-toolbar');
            if (!toolbar) return;
            
            // Prevent toolbar from hiding when interacting with it
            toolbar.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
            
            // Handle button clicks
            toolbar.addEventListener('click', (e) => {
                e.stopPropagation();
                
                const button = e.target.closest('button');
                if (!button) return;
                
                // Handle command buttons
                const command = button.dataset.command;
                if (command) {
                    applyCleanTextFormat(command);
                    return;
                }
                
                // Handle special buttons
                switch (button.id) {
                    case 'copy-text-btn':
                        copySelectedText();
                        break;
                    case 'cut-text-btn':
                        cutSelectedText();
                        break;
                    case 'paste-text-btn':
                        pasteText();
                        break;
                    case 'highlight-btn':
                        applyCleanTextFormat('highlight');
                        break;
                    case 'close-toolbar-btn':
                        hideCleanTextToolbar();
                        break;
                }
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                try {
                    console.log('Document click event - checking if should close dropdown:', {
                        target: e.target.id || e.target.tagName,
                        closestFontSelector: !!e.target.closest('#font-selector'),
                        closestColorPicker: !!e.target.closest('.pcr-app, .pickr, .pickr-text-color, .pickr-highlight-color')
                    });
                    
                    // Close font dropdown when clicking outside
                    if (!e.target.closest('#font-selector')) {
                        const fontDropdown = document.getElementById('font-dropdown');
                        if (fontDropdown && fontDropdown.style.display === 'block') {
                            console.log('Closing font dropdown (clicked outside)');
                            fontDropdown.style.display = 'none';
                        }
                    }
                    
                    // Don't close color pickers when clicking on them or their apps
                    if (!e.target.closest('.pcr-app, .pickr, .pickr-text-color, .pickr-highlight-color')) {
                        // Color pickers will close automatically
                    }
                } catch (error) {
                    console.error('Error handling click outside:', error);
                }
            });
            
            console.log('🎯 Clean toolbar event listeners setup complete');
        }
        
        // Setup color pickers for the clean toolbar
        function setupCleanColorPickers() {
            try {
                const swatches = ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722', '#795548', '#607D8B', '#FFFFFF', '#000000'];
                
                // Setup text color picker
                const textColorEl = document.getElementById('text-color-picker');
                if (textColorEl && typeof Pickr !== 'undefined') {
                    // Destroy existing instance if any
                    if (textColorEl._pickr) {
                        textColorEl._pickr.destroyAndRemove();
                    }
                    
                    const textColorPickr = Pickr.create({
                        el: textColorEl,
                        theme: 'nano',
                        defaultRepresentation: 'HEX',
                        default: '#212529',
                        swatches: swatches,
                        components: {
                            preview: true,
                            opacity: true,
                            hue: true,
                            interaction: {
                                hex: true,
                                rgba: true,
                                hsla: false,
                                hsva: false,
                                cmyk: false,
                                input: true,
                                clear: false,
                                save: true
                            }
                        }
                    });
                    
                    cleanTextToolbarState.colorPickers.textColor = textColorPickr;
                    
                    textColorPickr.on('save', (color, instance) => {
                        const hexColor = color.toHEXA().toString();
                        applyCleanTextColor(hexColor);
                        instance.hide();
                    });
                }
                
                // Setup highlight color picker
                const highlightColorEl = document.getElementById('text-highlight-picker');
                if (highlightColorEl && typeof Pickr !== 'undefined') {
                    // Destroy existing instance if any
                    if (highlightColorEl._pickr) {
                        highlightColorEl._pickr.destroyAndRemove();
                    }
                    
                    const highlightColorPickr = Pickr.create({
                        el: highlightColorEl,
                        theme: 'nano',
                        defaultRepresentation: 'HEX',
                        default: '#FFEB3B',
                        swatches: swatches,
                        components: {
                            preview: true,
                            opacity: true,
                            hue: true,
                            interaction: {
                                hex: true,
                                rgba: true,
                                hsla: false,
                                hsva: false,
                                cmyk: false,
                                input: true,
                                clear: false,
                                save: true
                            }
                        }
                    });
                    
                    cleanTextToolbarState.colorPickers.highlightColor = highlightColorPickr;
                    
                    highlightColorPickr.on('save', (color, instance) => {
                        const hexColor = color.toHEXA().toString();
                        applyCleanHighlightColor(hexColor);
                        instance.hide();
                    });
                }
                
                console.log('🎨 Clean text toolbar color pickers setup complete');
            } catch (error) {
                console.error('❌ Error setting up clean text toolbar color pickers:', error);
            }
        }
        
        // Setup font dropdown for the clean toolbar
        function setupCleanFontDropdown() {
            console.log('Setting up clean font dropdown');
            
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('🔤 Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked');
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('🔤 Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked');
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('🔤 Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked');
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('🔤 Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked');
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('🔤 Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked');
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('🔤 Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked');
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Setup font dropdown for the clean toolbar
        function setupCleanFontDropdown() {
            console.log('Setting up clean font dropdown');
            
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Verify the event listeners are attached
                console.log('Event listeners attached to:', {
                    buttonListeners: fontDropdownBtn.eventListeners ? 'Available' : 'Not available',
                    dropdownListeners: fontDropdown.eventListeners ? 'Available' : 'Not available'
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('🔤 Clean font dropdown setup complete');
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('ülü Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked');
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('ülü Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked');
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('ülü Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked');
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('ülü Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked');
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('ülü Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked');
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('ülü Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked');
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('ülü Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked');
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('ülü Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked - Event details:', {
                type: e.type,
                target: e.target.id,
                currentTarget: e.currentTarget.id,
                timeStamp: e.timeStamp
            });
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('ülü Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked');
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('ülü Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked');
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('ülü Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked');
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('ülü Clean font dropdown setup complete');
        }
        
        // Handle font dropdown button click
        function handleFontDropdownClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Font dropdown button clicked');
            
            const fontDropdown = document.getElementById('font-dropdown');
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            
            console.log('Elements found:', { fontDropdown, fontDropdownBtn });
            
            if (fontDropdown && fontDropdownBtn) {
                try {
                    // Get the computed style to properly check visibility
                    const computedStyle = window.getComputedStyle(fontDropdown);
                    const currentDisplay = computedStyle.display;
                    console.log('Current display state:', currentDisplay);
                    
                    if (currentDisplay === 'block') {
                        fontDropdown.style.display = 'none';
                        console.log('Font dropdown display set to: none');
                    } else {
                        // Show the dropdown
                        fontDropdown.style.display = 'block';
                        console.log('Font dropdown display set to: block');
                        
                        // Ensure dropdown is positioned correctly with high priority styles
                        fontDropdown.style.cssText += '; position: absolute !important; z-index: 1002 !important; left: 0 !important; right: 0 !important; top: 100% !important; visibility: visible !important; background: #2c3e50 !important; border: 1px solid rgba(255,255,255,0.3) !important; border-radius: 6px !important; max-height: 200px !important; overflow-y: auto !important;';
                        
                        // Force reflow to ensure the element is rendered
                        fontDropdown.offsetHeight;
                        
                        // Scroll into view if needed
                        const rect = fontDropdown.getBoundingClientRect();
                        if (rect.bottom > window.innerHeight) {
                            fontDropdown.scrollIntoView({ behavior: 'smooth', block: 'end' });
                        }
                        
                        console.log('Dropdown dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            top: rect.top,
                            bottom: rect.bottom,
                            windowHeight: window.innerHeight
                        });
                    }
                } catch (error) {
                    console.error('Error toggling font dropdown:', error);
                }
            } else {
                console.warn('Font dropdown elements not found');
            }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                applyFont(fontFamily);
                document.getElementById('current-font-name').textContent = e.target.textContent;
                document.getElementById('font-dropdown').style.display = 'none';
            }
        }
        
        // Apply font to the editor
        function applyFont(fontFamily) {
            document.getElementById('editor').style.fontFamily = fontFamily;
        }
        
        // Initialize the font dropdown
        function setupFontDropdown() {
            const fontDropdownBtn = document.getElementById('font-dropdown-btn');
            const fontDropdown = document.getElementById('font-dropdown');
            
            console.log('Font dropdown elements:', { fontDropdownBtn, fontDropdown });
            
            if (fontDropdownBtn && fontDropdown) {
                // Explicitly remove old event handlers that might interfere
                // We need to create dummy handlers to remove the old ones
                const oldDropdownClickHandler = function(e) {
                    e.preventDefault();
                    const dropdown = document.getElementById('font-dropdown');
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                
                const oldOptionClickHandler = function(e) {
                    if (e.target.classList.contains('font-option')) {
                        const fontFamily = e.target.dataset.font;
                        applyFont(fontFamily);
                        document.getElementById('current-font-name').textContent = e.target.textContent;
                        document.getElementById('font-dropdown').style.display = 'none';
                    }
                };
                
                // Remove old event listeners
                fontDropdownBtn.removeEventListener('click', oldDropdownClickHandler);
                fontDropdown.removeEventListener('click', oldOptionClickHandler);
                
                // Remove any existing event listeners to prevent duplicates
                fontDropdownBtn.removeEventListener('click', handleFontDropdownClick);
                fontDropdown.removeEventListener('click', handleFontOptionClick);
                
                // Add new event listeners
                fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                fontDropdown.addEventListener('click', handleFontOptionClick);
                
                console.log('Font dropdown event listeners added');
                
                // Test if the event listeners are working
                console.log('Testing event listener registration...');
                fontDropdownBtn.addEventListener('click', function test() {
                    console.log('Test click handler fired');
                    fontDropdownBtn.removeEventListener('click', test); // Remove test handler
                });
            } else {
                console.warn('Font dropdown elements not found');
            }
            
            console.log('ülü Clean font dropdown setup complete');
        }
        }
        
        // Handle font option click
        function handleFontOptionClick(e) {
            e.stopPropagation();
            
            console.log('Font option clicked:', e.target);
            
            if (e.target.classList.contains('font-option')) {
                const fontFamily = e.target.dataset.font;
                console.log('Applying font:', fontFamily);
                
                applyCleanFont(fontFamily);
                const currentFontName = document.getElementById('current-font-name');
                if (currentFontName) {
                    currentFontName.textContent = e.target.textContent;
                }
                const fontDropdown = document.getElementById('font-dropdown');
                if (fontDropdown) {
                    fontDropdown.style.display = 'none';
                }
            }
        }
        
        // Setup opacity slider for the clean toolbar
        function setupCleanOpacitySlider() {
            const opacitySlider = document.getElementById('text-opacity-slider');
            const opacityValue = document.getElementById('opacity-value');
            
            if (opacitySlider && opacityValue) {
                opacitySlider.addEventListener('input', (e) => {
                    const opacity = e.target.value;
                    opacityValue.textContent = opacity + '%';
                    if (cleanTextToolbarState.currentSelection) {
                        applyCleanOpacity(opacity);
                    }
                });
            }
            
            console.log('🎚️ Clean opacity slider setup complete');
        }
        
        // Setup text selection handling
        function setupCleanTextSelectionHandling() {
            document.addEventListener('selectionchange', handleCleanTextSelectionChange);
            document.addEventListener('mousedown', (e) => {
                // Delay to allow selection to be processed
                setTimeout(() => {
                    const selection = window.getSelection();
                    if (!selection || selection.isCollapsed) {
                        hideCleanTextToolbar();
                    }
                }, 10);
            });
        }
        
        // Setup the clean text toolbar
        function setupCleanTextToolbar() {
            const toolbar = document.getElementById('text-format-toolbar');
            const toolbarButtons = toolbar.querySelectorAll('.toolbar-btn');
            
            if (toolbar && toolbarButtons) {
                toolbarButtons.forEach((btn) => {
                    btn.addEventListener('click', handleToolbarButtonClick);
                });
                
                const fontDropdownBtn = document.getElementById('font-dropdown-btn');
                if (fontDropdownBtn) {
                    fontDropdownBtn.addEventListener('click', handleFontDropdownClick);
                }
                
                const fontOptions = document.querySelectorAll('.font-option');
                if (fontOptions) {
                    fontOptions.forEach((option) => {
                        option.addEventListener('click', handleFontOptionClick);
                    });
                }
                
                setupCleanOpacitySlider();
                setupCleanTextSelectionHandling();
                
                console.log('Clean text toolbar setup complete');
            } else {
                console.warn('Clean text toolbar not found');
            }
        }
        
        // Initialize the clean text toolbar
        function initCleanTextToolbar() {
            console.log('Initializing clean text toolbar...');
            setupCleanTextToolbar();
        }
                }, 100);
            });
            
            console.log('🖱️ Clean text selection handling setup complete');
        }
        
        // Handle text selection changes
        function handleCleanTextSelectionChange() {
            if (cleanTextToolbarState.isProcessing) return;
            
            cleanTextToolbarState.isProcessing = true;
            
            try {
                const selection = window.getSelection();
                
                // Hide toolbar if no selection or collapsed selection
                if (!selection || selection.isCollapsed) {
                    hideCleanTextToolbar();
                    return;
                }
                
                // Check if selection is in editable content
                const selectedText = selection.toString().trim();
                if (!selectedText) {
                    hideCleanTextToolbar();
                    return;
                }
                
                // Validate selection is in supported editable element
                const anchorNode = selection.anchorNode;
                if (!anchorNode) {
                    hideCleanTextToolbar();
                    return;
                }
                
                const parentElement = anchorNode.nodeType === Node.TEXT_NODE ? anchorNode.parentElement : anchorNode;
                const editableElement = findCleanEditableElement(parentElement);
                
                if (!editableElement) {
                    hideCleanTextToolbar();
                    return;
                }
                
                // Store selection and show toolbar
                cleanTextToolbarState.currentSelection = selection.getRangeAt(0).cloneRange();
                showCleanTextToolbar();
                updateCleanToolbarState(selection);
                
            } catch (error) {
                console.error('❌ Error handling clean text selection:', error);
                hideCleanTextToolbar();
            } finally {
                cleanTextToolbarState.isProcessing = false;
            }
        }
        
        // Find editable element from parent
        function findCleanEditableElement(element) {
            const EDITABLE_SELECTORS = [
                '.statement-text[contenteditable]',
                '.question-text[contenteditable]',
                '.answer-text[contenteditable]',
                '.page-title[contenteditable]',
                '.question-list-header[contenteditable]',
                '.reading-passage-text[contenteditable]',
                '.poetry-shatr[contenteditable]',
                '.header-box[contenteditable]',
                '.footer-box[contenteditable]',
                '.page-border-box[contenteditable]',
                '[contenteditable="true"]',
                '[contenteditable=""]'
            ];
            
            for (const selector of EDITABLE_SELECTORS) {
                const editable = element.closest(selector);
                if (editable && editable.getAttribute('contenteditable') !== 'false') {
                    return editable;
                }
            }
            return null;
        }
        
        // Show the clean text toolbar
        function showCleanTextToolbar() {
            const toolbar = document.getElementById('text-format-toolbar');
            if (toolbar && !cleanTextToolbarState.isVisible) {
                toolbar.classList.add('show');
                cleanTextToolbarState.isVisible = true;
                positionCleanToolbar();
            }
        }
        
        // Hide the clean text toolbar
        function hideCleanTextToolbar() {
            const toolbar = document.getElementById('text-format-toolbar');
            if (toolbar && cleanTextToolbarState.isVisible) {
                toolbar.classList.remove('show');
                cleanTextToolbarState.isVisible = false;
                cleanTextToolbarState.currentSelection = null;
            }
        }
        
        // Position the toolbar near the selection
        function positionCleanToolbar() {
            const toolbar = document.getElementById('text-format-toolbar');
            if (!toolbar || !cleanTextToolbarState.currentSelection) return;
            
            try {
                const range = cleanTextToolbarState.currentSelection;
                const rect = range.getBoundingClientRect();
                
                // Position toolbar above the selection
                const toolbarRect = toolbar.getBoundingClientRect();
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                // Position horizontally centered above selection
                let left = rect.left + (rect.width / 2) - (toolbarRect.width / 2);
                let top = rect.top - toolbarRect.height - 10 + scrollTop;
                
                // Ensure toolbar stays within viewport
                if (left < 10) left = 10;
                if (left + toolbarRect.width > window.innerWidth - 10) {
                    left = window.innerWidth - toolbarRect.width - 10;
                }
                
                if (top < 10 + scrollTop) {
                    // Position below selection if not enough space above
                    top = rect.bottom + 10 + scrollTop;
                }
                
                toolbar.style.left = left + 'px';
                toolbar.style.top = top + 'px';
                toolbar.style.transform = 'none'; // Remove the default centering transform
                
            } catch (error) {
                console.warn('⚠️ Could not position toolbar precisely, using default position');
                // Fallback to default center position
                toolbar.style.left = '50%';
                toolbar.style.top = '40px';
                toolbar.style.transform = 'translateX(-50%)';
            }
        }
        
        // Update toolbar state based on current selection
        function updateCleanToolbarState(selection) {
            try {
                if (!selection || !selection.anchorNode) return;
                
                // Update formatting buttons
                const formatCommands = ['bold', 'italic', 'underline'];
                formatCommands.forEach(command => {
                    const button = document.querySelector(`#${command}-btn`);
                    if (button) {
                        const isActive = checkCleanFormattingState(selection, command);
                        button.classList.toggle('active', isActive);
                    }
                });
                
                // Update highlight button
                const highlightButton = document.querySelector('#highlight-btn');
                if (highlightButton) {
                    const isHighlighted = checkCleanHighlightState(selection);
                    highlightButton.classList.toggle('active', isHighlighted);
                }
                
            } catch (error) {
                console.error('❌ Error updating clean toolbar state:', error);
            }
        }
        
        // Check formatting state for a specific command
        function checkCleanFormattingState(selection, command) {
            let element = selection.anchorNode.nodeType === Node.TEXT_NODE ? selection.anchorNode.parentElement : selection.anchorNode;
            
            while (element && element !== document.body) {
                const style = window.getComputedStyle(element);
                
                switch (command) {
                    case 'bold':
                        if (style.fontWeight === 'bold' || parseInt(style.fontWeight) >= 700) return true;
                        break;
                    case 'italic':
                        if (style.fontStyle === 'italic') return true;
                        break;
                    case 'underline':
                        if (style.textDecoration.includes('underline')) return true;
                        break;
                }
                
                element = element.parentElement;
            }
            
            return false;
        }
        
        // Check highlight state
        function checkCleanHighlightState(selection) {
            if (!selection || !selection.anchorNode) return false;
            
            let element = selection.anchorNode.nodeType === Node.TEXT_NODE ? selection.anchorNode.parentElement : selection.anchorNode;
            
            // Check if the selected text is already wrapped in a highlighted span
            while (element && element !== document.body) {
                const style = window.getComputedStyle(element);
                if (style.backgroundColor && style.backgroundColor !== 'rgba(0, 0, 0, 0)' && style.backgroundColor !== 'transparent') {
                    return true;
                }
                element = element.parentElement;
            }
            
            return false;
        }
        
        // Apply text formatting
        function applyCleanTextFormat(command) {
            if (!cleanTextToolbarState.currentSelection) {
                console.warn('⚠️ No selection available for formatting');
                return;
            }
            
            try {
                // Restore selection
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(cleanTextToolbarState.currentSelection);
                
                switch (command) {
                    case 'bold':
                    case 'italic':
                    case 'underline':
                        applyCleanBasicFormatting(command);
                        break;
                    case 'highlight':
                        applyCleanHighlight();
                        break;
                    default:
                        console.warn(`⚠️ Unknown format command: ${command}`);
                }
                
                // Update toolbar state
                setTimeout(() => {
                    const currentSelection = window.getSelection();
                    if (currentSelection && !currentSelection.isCollapsed) {
                        updateCleanToolbarState(currentSelection);
                    }
                }, 10);
                
            } catch (error) {
                console.error('❌ Error applying clean text format:', error);
            }
        }
        
        // Apply basic formatting (bold, italic, underline)
        function applyCleanBasicFormatting(command) {
            if (!cleanTextToolbarState.currentSelection) {
                console.warn('No selection available for basic formatting');
                return;
            }
            
            try {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(cleanTextToolbarState.currentSelection);
                
                const cssProperty = command === 'bold' ? 'font-weight: bold' : 
                                  command === 'italic' ? 'font-style: italic' : 
                                  'text-decoration: underline';
                
                const container = cleanTextToolbarState.currentSelection.commonAncestorContainer;
                const parentElement = container.nodeType === Node.TEXT_NODE ? container.parentElement : container;
                const existingSpan = parentElement.closest(`span[style*="${cssProperty.split(':')[0]}"]`);
                
                if (existingSpan && cleanTextToolbarState.currentSelection.toString() === existingSpan.textContent) {
                    // Remove formatting
                    const wrapper = existingSpan;
                    const content = wrapper.innerHTML;
                    const fragment = document.createDocumentFragment();
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    
                    while (tempDiv.firstChild) {
                        fragment.appendChild(tempDiv.firstChild);
                    }
                    
                    wrapper.parentNode.insertBefore(fragment, wrapper);
                    wrapper.remove();
                } else {
                    // Apply formatting
                    const span = document.createElement('span');
                    span.style.cssText = cssProperty;
                    
                    const range = cleanTextToolbarState.currentSelection.cloneRange();
                    const contents = range.extractContents();
                    span.appendChild(contents);
                    range.insertNode(span);
                    
                    // Update selection
                    const newRange = document.createRange();
                    newRange.selectNodeContents(span);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                    cleanTextToolbarState.currentSelection = newRange.cloneRange();
                }
                
                // Trigger blur event to save changes
                const editable = selection.anchorNode?.parentElement?.closest('[contenteditable="true"]');
                if (editable) {
                    editable.dispatchEvent(new Event('blur', { bubbles: true }));
                }
                
            } catch (error) {
                console.error('Error applying clean basic formatting:', error);
            }
        }
        
        // Apply text color
        function applyCleanTextColor(color) {
            if (!cleanTextToolbarState.currentSelection) return;
            
            try {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(cleanTextToolbarState.currentSelection);
                
                const span = document.createElement('span');
                span.style.color = color;
                
                try {
                    span.appendChild(cleanTextToolbarState.currentSelection.extractContents());
                    cleanTextToolbarState.currentSelection.insertNode(span);
                    
                    // Update selection to maintain toolbar
                    selection.removeAllRanges();
                    const newRange = document.createRange();
                    newRange.selectNodeContents(span);
                    selection.addRange(newRange);
                    cleanTextToolbarState.currentSelection = newRange.cloneRange();
                } catch (e) {
                    // Fallback to execCommand if range manipulation fails
                    document.execCommand('foreColor', false, color);
                }
            } catch (error) {
                console.warn('Error applying clean text color:', error);
            }
        }
        
        // Apply highlight color
        function applyCleanHighlightColor(color) {
            if (!cleanTextToolbarState.currentSelection) return;
            
            try {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(cleanTextToolbarState.currentSelection);
                
                const span = document.createElement('span');
                span.style.backgroundColor = color;
                
                try {
                    span.appendChild(cleanTextToolbarState.currentSelection.extractContents());
                    cleanTextToolbarState.currentSelection.insertNode(span);
                    
                    // Update selection to maintain toolbar
                    selection.removeAllRanges();
                    const newRange = document.createRange();
                    newRange.selectNodeContents(span);
                    selection.addRange(newRange);
                    cleanTextToolbarState.currentSelection = newRange.cloneRange();
                } catch (e) {
                    // Fallback to execCommand if range manipulation fails
                    document.execCommand('backColor', false, color);
                }
            } catch (error) {
                console.warn('Error applying clean highlight color:', error);
            }
        }
        
        // Apply font family
        function applyCleanFont(fontFamily) {
            if (!cleanTextToolbarState.currentSelection) return;
            
            try {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(cleanTextToolbarState.currentSelection);
                
                const span = document.createElement('span');
                span.style.fontFamily = fontFamily;
                
                try {
                    span.appendChild(cleanTextToolbarState.currentSelection.extractContents());
                    cleanTextToolbarState.currentSelection.insertNode(span);
                    
                    // Update selection to maintain toolbar
                    selection.removeAllRanges();
                    const newRange = document.createRange();
                    newRange.selectNodeContents(span);
                    selection.addRange(newRange);
                    cleanTextToolbarState.currentSelection = newRange.cloneRange();
                } catch (e) {
                    // Fallback to execCommand if range manipulation fails
                    document.execCommand('fontName', false, fontFamily);
                }
            } catch (error) {
                console.warn('Error applying clean font:', error);
            }
        }
        
        // Apply opacity
        function applyCleanOpacity(opacity) {
            if (!cleanTextToolbarState.currentSelection) return;
            
            try {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(cleanTextToolbarState.currentSelection);
                
                const span = document.createElement('span');
                span.style.opacity = opacity / 100;
                
                try {
                    span.appendChild(cleanTextToolbarState.currentSelection.extractContents());
                    cleanTextToolbarState.currentSelection.insertNode(span);
                    
                    // Update selection to maintain toolbar
                    selection.removeAllRanges();
                    const newRange = document.createRange();
                    newRange.selectNodeContents(span);
                    selection.addRange(newRange);
                    cleanTextToolbarState.currentSelection = newRange.cloneRange();
                } catch (e) {
                    console.warn('Opacity application requires more complex implementation');
                }
            } catch (error) {
                console.warn('Error applying clean opacity:', error);
            }
        }
        
        // Apply highlight
        function applyCleanHighlight() {
            if (!cleanTextToolbarState.currentSelection) return;
            
            try {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(cleanTextToolbarState.currentSelection);
                
                // Get current highlight color from picker or default
                let highlightColor = '#FFEB3B'; // Default yellow
                if (cleanTextToolbarState.colorPickers.highlightColor) {
                    const color = cleanTextToolbarState.colorPickers.highlightColor.getColor();
                    if (color) {
                        highlightColor = color.toHEXA().toString();
                    }
                }
                
                // Check if we're removing highlight or applying it
                const selectedText = cleanTextToolbarState.currentSelection.toString();
                const container = cleanTextToolbarState.currentSelection.commonAncestorContainer;
                const parentElement = container.nodeType === Node.TEXT_NODE ? container.parentElement : container;
                const existingHighlight = parentElement.closest('span[style*="background-color"]');
                
                if (existingHighlight && selectedText === existingHighlight.textContent) {
                    // Remove highlight by unwrapping the content
                    const content = existingHighlight.innerHTML;
                    const fragment = document.createDocumentFragment();
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    
                    while (tempDiv.firstChild) {
                        fragment.appendChild(tempDiv.firstChild);
                    }
                    
                    existingHighlight.parentNode.insertBefore(fragment, existingHighlight);
                    existingHighlight.remove();
                } else {
                    // Apply highlight
                    const span = document.createElement('span');
                    span.style.backgroundColor = highlightColor;
                    
                    try {
                        span.appendChild(cleanTextToolbarState.currentSelection.extractContents());
                        cleanTextToolbarState.currentSelection.insertNode(span);
                        
                        // Update selection to maintain toolbar
                        selection.removeAllRanges();
                        const newRange = document.createRange();
                        newRange.selectNodeContents(span);
                        selection.addRange(newRange);
                        cleanTextToolbarState.currentSelection = newRange.cloneRange();
                    } catch (e) {
                        // Fallback to execCommand if range manipulation fails
                        document.execCommand('backColor', false, highlightColor);
                    }
                }
                
                // Trigger blur event to save changes
                const editable = selection.anchorNode?.parentElement?.closest('[contenteditable=\"true\"]');
                if (editable) {
                    editable.dispatchEvent(new Event('blur', { bubbles: true }));
                }
                
            } catch (error) {
                console.warn('Error applying clean highlight:', error);
            }
        }
        
        // Copy selected text
        function copySelectedText() {
            try {
                document.execCommand('copy');
            } catch (error) {
                console.warn('Error copying text:', error);
                // Fallback to clipboard API
                if (navigator.clipboard && cleanTextToolbarState.currentSelection) {
                    const text = cleanTextToolbarState.currentSelection.toString();
                    navigator.clipboard.writeText(text).catch(err => {
                        console.warn('Clipboard API failed:', err);
                    });
                }
            }
        }
        
        // Cut selected text
        function cutSelectedText() {
            try {
                document.execCommand('cut');
                hideCleanTextToolbar();
            } catch (error) {
                console.warn('Error cutting text:', error);
            }
        }
        
        // Paste text
        function pasteText() {
            try {
                document.execCommand('paste');
            } catch (error) {
                console.warn('Error pasting text:', error);
                // Modern browsers don't allow programmatic paste for security reasons
            }
        }
        
        // Cleanup function to properly destroy the toolbar system
        function cleanupCleanTextToolbar() {
            // Destroy color pickers
            if (cleanTextToolbarState.colorPickers.textColor) {
                cleanTextToolbarState.colorPickers.textColor.destroyAndRemove();
                cleanTextToolbarState.colorPickers.textColor = null;
            }
            
            if (cleanTextToolbarState.colorPickers.highlightColor) {
                cleanTextToolbarState.colorPickers.highlightColor.destroyAndRemove();
                cleanTextToolbarState.colorPickers.highlightColor = null;
            }
            
            // Remove event listeners
            const toolbar = document.getElementById('text-format-toolbar');
            if (toolbar) {
                toolbar.removeEventListener('mousedown', null);
                toolbar.removeEventListener('click', null);
            }
            
            // Clean up state
            cleanTextToolbarState.currentSelection = null;
            cleanTextToolbarState.isVisible = false;
            cleanTextToolbarState.isProcessing = false;
            
            console.log('🧹 Clean Text Toolbar System cleaned up');
        }
        
        // Make the clean toolbar functions globally available for debugging
        window.cleanTextToolbar = {
            state: cleanTextToolbarState,
            show: showCleanTextToolbar,
            hide: hideCleanTextToolbar,
            initialize: initializeCleanTextToolbar,
            cleanup: cleanupCleanTextToolbar
        };
        
        console.log('✨ Clean Text Toolbar System loaded and ready');
        
    </script>
</body>
</html>